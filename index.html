<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MyHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-elevated: #11131b;
      --bg-elevated-soft: #151826;
      --accent: #4caf50;
      --accent-soft: rgba(76, 175, 80, 0.18);
      --accent-alt: #00bcd4;
      --danger: #f44336;
      --text: #f5f5f5;
      --text-muted: #a0a4b8;
      --border-subtle: #26293a;
      --radius-lg: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #151827 0, #050608 45%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      display: flex;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }

    .sidebar {
      width: 70px;
      background: linear-gradient(180deg, #11131b 0%, #050608 100%);
      border-right: 1px solid var(--border-subtle);
      padding: 16px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      transition: width 0.2s ease;
    }

    /* Slight expansion only, not huge */
    .sidebar.expanded {
      width: 110px;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(circle at 20% 0, #00e676, #00bcd4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #020308;
      box-shadow: 0 0 20px rgba(0, 188, 212, 0.6);
    }

    .nav-toggle {
      border: none;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      margin-top: 4px;
      transition: 0.18s ease;
    }

    .nav-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--accent-alt);
    }

    .nav {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      width: 100%;
    }

    .nav-item {
      width: 100%;
      border-radius: 999px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-muted);
      display: flex;
      flex-direction: column; /* icon + label vertical by default too */
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: 0.18s ease;
      padding: 8px 0;
      gap: 4px;
    }

    .nav-emoji {
      flex-shrink: 0;
    }

    .nav-label {
      display: none;
      font-size: 11px;
      white-space: nowrap;
    }

    /* When expanded, show labels under icons */
    .sidebar.expanded .nav-item {
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding-inline: 0;
    }

    .sidebar.expanded .nav-label {
      display: block;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.03);
      color: var(--accent-alt);
      transform: translateY(-1px);
    }

    .nav-item.nav-active {
      background: var(--accent-soft);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(76, 175, 80, 0.4);
    }

    .version {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
    }

    .main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: var(--radius-lg);
      background: linear-gradient(90deg, #141827, #0b0d14);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    }

    #pageTitle {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.03em;
    }

    .page {
      flex: 1;
      border-radius: var(--radius-lg);
      background: rgba(8, 10, 18, 0.96);
      border: 1px solid var(--border-subtle);
      padding: 16px;
      display: none;
      overflow-y: auto;
    }

    .page.active {
      display: block;
    }

    .hidden {
      display: none !important;
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
    }

    .card {
      border-radius: var(--radius-lg);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #151826;
      border: 1px solid #26293a;
      color: var(--text-muted);
    }

    .chip-highlight {
      background: rgba(0, 188, 212, 0.12);
      color: #e0f7fa;
      border-color: rgba(0, 188, 212, 0.5);
    }

    .input-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-row-inline {
      display: flex;
      gap: 8px;
    }

    .input-row-inline > * {
      flex: 1;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: 0.16s ease;
    }

    textarea {
      border-radius: 10px;
      resize: vertical;
      min-height: 70px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.4);
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      transition: 0.16s ease;
    }

    .btn:hover {
      background: rgba(76, 175, 80, 0.32);
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    .btn-secondary {
      background: rgba(0, 188, 212, 0.12);
      color: #b2ebf2;
    }

    .btn-secondary:hover {
      background: rgba(0, 188, 212, 0.24);
    }

    .btn-icon {
      padding-inline: 10px;
      font-size: 16px;
    }

    .btn-danger {
      background: rgba(244, 67, 54, 0.14);
      color: #ffcdd2;
    }

    .btn-danger:hover {
      background: rgba(244, 67, 54, 0.25);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .empty-msg {
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    .item {
      border-radius: 12px;
      padding: 8px 9px;
      background: var(--bg-elevated-soft);
      border: 1px solid #25283a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .item-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .item-checkbox {
      flex-shrink: 0;
    }

    .item-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .item-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .item-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      cursor: pointer;
    }

    .item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .item-actions {
      display: flex;
      flex-shrink: 0;
      gap: 4px;
    }

    .icon-btn {
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-muted);
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.07);
      color: var(--accent-alt);
    }

    .icon-btn.danger {
      color: #ff8a80;
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #181b2a;
      color: var(--text-muted);
    }

    .tag-income {
      background: rgba(76, 175, 80, 0.16);
      color: #c8e6c9;
    }

    .tag-expense {
      background: rgba(244, 67, 54, 0.16);
      color: #ffcdd2;
    }

    .selected-account {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.6);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .filter-pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #121622;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .filter-pill label {
      font-size: 11px;
    }

    .filter-pill select,
    .filter-pill input {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
    }

    /* Workout rows */
    .workout-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      border-radius: 10px;
      padding: 6px 8px;
      background: #101320;
    }

    .workout-row-top {
      width: 100%;
    }

    .workout-row-bottom {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workout-row-bottom input[type="number"] {
      padding: 6px 7px;
      font-size: 12px;
    }

    .workout-row-bottom .workout-done {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .workout-row-bottom .icon-btn {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
      font-size: 14px;
    }

    /* Workout favorites grid */
    .favorites-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .favorite-card {
      flex: 1 1 calc(50% - 8px);
      min-width: 110px;
      height: 70px;
      border-radius: 14px;
      border: 1px solid #273041;
      background: radial-gradient(circle at top, rgba(0, 188, 212, 0.25), #101320);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 13px;
      color: #e0f7fa;
      cursor: pointer;
      padding: 4px;
      box-shadow: 0 0 12px rgba(0, 188, 212, 0.3);
      transition: 0.16s ease;
    }

    .favorite-card:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 0 18px rgba(0, 188, 212, 0.6);
    }

    @media (min-width: 600px) {
      .favorite-card {
        flex-basis: calc(33.33% - 8px);
      }
    }

    .favorites-empty {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-bottom: 8px;
    }

    @media (min-width: 900px) {
      .sidebar.expanded {
        width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">H</div>
      <button id="navToggle" class="nav-toggle" title="Expand menu">‚ò∞</button>
      <nav class="nav">
        <button class="nav-item nav-active" data-page="home" title="Home">
          <span class="nav-emoji">üè†</span><span class="nav-label">Home</span>
        </button>
        <button class="nav-item" data-page="todo" title="To-Do">
          <span class="nav-emoji">‚úÖ</span><span class="nav-label">To-Do</span>
        </button>
        <button class="nav-item" data-page="shopping" title="Shopping">
          <span class="nav-emoji">üõí</span><span class="nav-label">Shopping</span>
        </button>
        <button class="nav-item" data-page="workouts" title="Workouts">
          <span class="nav-emoji">üèãÔ∏è</span><span class="nav-label">Workouts</span>
        </button>
        <button class="nav-item" data-page="finance" title="Finances">
          <span class="nav-emoji">üí∞</span><span class="nav-label">Finances</span>
        </button>
        <button class="nav-item" data-page="notes" title="Notes">
          <span class="nav-emoji">üìù</span><span class="nav-label">Notes</span>
        </button>
        <button class="nav-item" data-page="meals" title="Meals">
          <span class="nav-emoji">üçΩÔ∏è</span><span class="nav-label">Meals</span>
        </button>
        <button class="nav-item" data-page="calendar" title="Calendar">
          <span class="nav-emoji">üìÖ</span><span class="nav-label">Calendar</span>
        </button>
        <button class="nav-item" data-page="analytics" title="Analytics">
          <span class="nav-emoji">üìä</span><span class="nav-label">Analytics</span>
        </button>
      </nav>
      <div class="version">v<span id="appVersion">0.8.0</span></div>
    </aside>

    <main class="main">
      <header class="header">
        <h1 id="pageTitle">Home</h1>
      </header>

      <!-- HOME -->
      <section class="page active" data-page="home">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Quick task</div>
          </div>
          <div class="input-grid">
            <div class="input-row">
              <label for="homeQuickTaskInput">Task</label>
              <input id="homeQuickTaskInput" type="text" placeholder="e.g. Buy vegetables, send email‚Ä¶" />
            </div>
          </div>
          <button id="homeQuickTaskBtn" class="btn">
            ‚ûï Add quick task
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Overview</div>
          </div>
          <div class="chip-row">
            <span class="chip">‚úÖ To-do</span>
            <span class="chip">üõí Shopping</span>
            <span class="chip">üèãÔ∏è Workouts</span>
            <span class="chip">üí∞ Finance</span>
            <span class="chip chip-highlight">More coming soon‚Ä¶</span>
          </div>
        </div>
      </section>

      <!-- TO-DO -->
      <section class="page hidden" data-page="todo">
        <h2 class="section-title">To-do lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- Row 1: list dropdown -->
            <div class="input-row">
              <label for="todoListSelect">List</label>
              <select id="todoListSelect"></select>
            </div>

            <!-- Row 2: new list name + + button -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoListName">New list</label>
                <input id="todoListName" type="text" placeholder="e.g. Work, Personal‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="todoNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Row 3: Task title -->
            <div class="input-row">
              <label for="todoTitleInput">Task</label>
              <input id="todoTitleInput" type="text" placeholder="What do you need to do?" />
            </div>

            <!-- Row 4: Priority + due date -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoPrioritySelect">Priority</label>
                <select id="todoPrioritySelect">
                  <option value="high">High</option>
                  <option value="medium" selected>Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="input-row">
                <label for="todoDueDate">Due date</label>
                <input id="todoDueDate" type="date" />
              </div>
            </div>

            <!-- Row 5: Add button -->
            <div class="input-row" style="align-items: flex-end;">
              <button id="addTodoBtn" class="btn">‚ûï Add task</button>
            </div>
          </div>

          <!-- Filters toggle -->
          <div class="input-row" style="margin-bottom: 8px;">
            <button id="todoFiltersToggle" class="btn btn-secondary btn-icon">
              ‚öôÔ∏è Filters
            </button>
          </div>

          <!-- Filters panel (hidden by default) -->
          <div id="todoFiltersPanel" style="display: none;">
            <div class="pill-row">
              <div class="filter-pill">
                <label for="todoSearchInput">Search</label>
                <input id="todoSearchInput" type="text" placeholder="Text‚Ä¶" />
              </div>
              <div class="filter-pill">
                <label for="todoFilterPriority">Priority</label>
                <select id="todoFilterPriority">
                  <option value="all">All</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="filter-pill">
                <label for="todoFilterStatus">Status</label>
                <select id="todoFilterStatus">
                  <option value="all">All</option>
                  <option value="open">Open</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Done</option>
                </select>
              </div>
              <div class="filter-pill">
                <label for="todoFilterList">List</label>
                <select id="todoFilterList">
                  <option value="all">All</option>
                </select>
              </div>
            </div>
          </div>

          <div id="noTodosMsg" class="empty-msg">
            No tasks yet. Add your first one above.
          </div>
          <div id="todoList" class="list"></div>
        </div>
      </section>

      <!-- SHOPPING -->
      <section class="page hidden" data-page="shopping">
        <h2 class="section-title">Shopping lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- Row 1: list dropdown -->
            <div class="input-row">
              <label for="shoppingListSelect">List</label>
              <select id="shoppingListSelect"></select>
            </div>

            <!-- Row 2: new list name + + button -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="shoppingListName">New list</label>
                <input id="shoppingListName" type="text" placeholder="e.g. Weekly, Work‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="shoppingNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Row 3: item -->
            <div class="input-row">
              <label for="shoppingItemInput">Item</label>
              <input id="shoppingItemInput" type="text" placeholder="e.g. Chicken, yogurt, vegetables‚Ä¶" />
            </div>

            <!-- Row 4: Add button -->
            <div class="input-row" style="align-items: flex-end;">
              <button id="addShoppingBtn" class="btn">‚ûï Add item</button>
            </div>
          </div>

          <div id="shoppingEmptyMsg" class="empty-msg">
            No items yet. Add something above.
          </div>
          <div id="shoppingList" class="list"></div>
        </div>
      </section>

      <!-- WORKOUTS -->
      <section class="page hidden" data-page="workouts">
        <h2 class="section-title">Workouts</h2>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Current workout</div>
          </div>

          <!-- Favorite workouts grid -->
          <div id="workoutFavoritesContainer">
            <div id="workoutFavoritesEmpty" class="favorites-empty">
              No favorites yet. Tap ‚òÖ on a logged workout to save it here.
            </div>
            <div id="workoutFavorites" class="favorites-grid"></div>
          </div>

          <div class="input-grid">
            <div class="input-row">
              <label for="workoutName">Workout name</label>
              <input id="workoutName" type="text" placeholder="e.g. Push day, Legs B‚Ä¶" />
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label>Start</label>
                <div id="workoutStartLabel" class="empty-msg">Not started</div>
              </div>
              <div class="input-row">
                <label>Duration</label>
                <div id="workoutDurationLabel" class="empty-msg">‚Äì</div>
              </div>
            </div>
          </div>

          <div class="input-row-inline" style="margin-bottom: 8px;">
            <button id="startWorkoutBtn" class="btn btn-secondary">‚ñ∂ Start workout</button>
            <button id="saveWorkoutBtn" class="btn">üíæ Finish & save</button>
            <button id="addExerciseRowBtn" class="btn btn-secondary">‚ûï Add exercise row</button>
          </div>

          <div id="workoutExercises" class="list"></div>

          <!-- Notes moved to bottom -->
          <div class="input-grid">
            <div class="input-row">
              <label for="workoutNotes">Notes</label>
              <textarea id="workoutNotes" placeholder="Extra notes for this workout‚Ä¶"></textarea>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Logged workouts</div>
          </div>
          <div id="noWorkoutMsg" class="empty-msg">
            No workouts logged yet.
          </div>
          <div id="workoutList" class="list"></div>
        </div>
      </section>

      <!-- FINANCE -->
      <section class="page hidden" data-page="finance">
        <h2 class="section-title">Finances</h2>

        <!-- New transaction card FIRST -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">New transaction</div>
          </div>

          <div class="input-grid">
            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAccount">Account</label>
                <select id="financeAccount"></select>
              </div>
              <div class="input-row">
                <label for="financeType">Type</label>
                <select id="financeType">
                  <option value="expense" selected>Expense</option>
                  <option value="income">Income</option>
                </select>
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAmount">Amount</label>
                <input id="financeAmount" type="number" step="0.01" min="0" placeholder="0.00" />
              </div>
              <div class="input-row">
                <label for="financeDate">Date</label>
                <input id="financeDate" type="date" />
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeCategory">Category</label>
                <input id="financeCategory" type="text" placeholder="e.g. Food, Transport‚Ä¶" />
              </div>
              <div class="input-row">
                <label for="financeMethod">Method</label>
                <input id="financeMethod" type="text" placeholder="Cash, card, scan‚Ä¶" />
              </div>
            </div>

            <div class="input-row">
              <label for="financeNote">Note</label>
              <input id="financeNote" type="text" placeholder="Optional note‚Ä¶" />
            </div>

            <div class="input-row" style="align-items: flex-end;">
              <button id="addFinanceBtn" class="btn">
                ‚ûï Add transaction
              </button>
            </div>
          </div>

          <div class="pill-row">
            <div class="filter-pill">
              <label for="financeFilterCategory">Category filter</label>
              <select id="financeFilterCategory">
                <option value="all">All</option>
                <option value="Food">Food</option>
                <option value="Transport">Transport</option>
                <option value="Rent">Rent</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div id="financeSummary" class="empty-msg"></div>

          <div id="noFinanceMsg" class="empty-msg">
            No transactions yet.
          </div>
          <div id="financeList" class="list"></div>
        </div>

        <!-- Accounts card moved to bottom -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Accounts</div>
            <button id="addAccountBtn" class="btn btn-secondary btn-icon">
              ‚ûï
            </button>
          </div>
          <div id="noAccountsMsg" class="empty-msg">
            No accounts yet. Add one above (e.g. THB main, BRL savings, USD).
          </div>
          <div id="accountsList" class="list"></div>
        </div>
      </section>

      <!-- NOTES (placeholder) -->
      <section class="page hidden" data-page="notes">
        <h2 class="section-title">Notes</h2>
      </section>

      <!-- MEALS (placeholder) -->
      <section class="page hidden" data-page="meals">
        <h2 class="section-title">Meals</h2>
      </section>

      <!-- CALENDAR (placeholder) -->
      <section class="page hidden" data-page="calendar">
        <h2 class="section-title">Calendar</h2>
      </section>

      <!-- ANALYTICS (placeholder) -->
      <section class="page hidden" data-page="analytics">
        <h2 class="section-title">Analytics</h2>
      </section>
    </main>
  </div>
  <script>
  // MyHub App - v0.9.1
  window.addEventListener("DOMContentLoaded", () => {
    // ==============================
    // NAVIGATION & LAYOUT
    // ==============================
    const sidebar = document.querySelector(".sidebar");
    const navToggle = document.getElementById("navToggle");
    const navItems = document.querySelectorAll(".nav-item");
    const pages = document.querySelectorAll(".page");
    const pageTitleEl = document.getElementById("pageTitle");
    const versionEl = document.getElementById("appVersion");
  
    if (versionEl) versionEl.textContent = "0.9.1";
  
    function showPage(pageId) {
      pages.forEach((p) => {
        if (p.dataset.page === pageId) {
          p.classList.add("active");
          p.classList.remove("hidden");
        } else {
          p.classList.remove("active");
          p.classList.add("hidden");
        }
      });
  
      navItems.forEach((btn) => {
        if (btn.dataset.page === pageId) {
          btn.classList.add("nav-active");
        } else {
          btn.classList.remove("nav-active");
        }
      });
  
      if (pageTitleEl) {
        const activeItem = Array.from(navItems).find((btn) => btn.dataset.page === pageId);
        if (activeItem && activeItem.title) {
          pageTitleEl.textContent = activeItem.title;
        } else {
          pageTitleEl.textContent = pageId.charAt(0).toUpperCase() + pageId.slice(1);
        }
      }
    }
  
    navItems.forEach((btn) => {
      btn.addEventListener("click", () => {
        const pageId = btn.dataset.page;
        if (pageId) showPage(pageId);
      });
    });
  
    if (navToggle && sidebar) {
      navToggle.addEventListener("click", () => {
        sidebar.classList.toggle("expanded");
      });
    }
  
    // ==============================
    // HOME QUICK TASK
    // ==============================
    const homeQuickTaskInput = document.getElementById("homeQuickTaskInput");
    const homeQuickTaskBtn = document.getElementById("homeQuickTaskBtn");
  
    function addQuickTaskFromHome() {
      if (!homeQuickTaskInput) return;
      const text = homeQuickTaskInput.value.trim();
      if (!text) return;
      window.__myhubQuickTaskBuffer = text;
      homeQuickTaskInput.value = "";
      showPage("todo");
    }
  
    if (homeQuickTaskBtn && homeQuickTaskInput) {
      homeQuickTaskBtn.addEventListener("click", addQuickTaskFromHome);
      homeQuickTaskInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addQuickTaskFromHome();
        }
      });
    }
  
    // ==============================
    // TO-DO MODULE
    // ==============================
    const TODO_STORAGE_KEY = "myhub_todo_v2";
  
    const todoListSelect = document.getElementById("todoListSelect");
    const todoListNameInput = document.getElementById("todoListName");
    const todoNewListBtn = document.getElementById("todoNewListBtn");
    const todoTitleInput = document.getElementById("todoTitleInput");
    const todoPrioritySelect = document.getElementById("todoPrioritySelect");
    const todoDueDateInput = document.getElementById("todoDueDate");
    const addTodoBtn = document.getElementById("addTodoBtn");
    const todoFiltersToggle = document.getElementById("todoFiltersToggle");
    const todoFiltersPanel = document.getElementById("todoFiltersPanel");
    const todoSearchInput = document.getElementById("todoSearchInput");
    const todoFilterPriority = document.getElementById("todoFilterPriority");
    const todoFilterStatus = document.getElementById("todoFilterStatus");
    const todoFilterList = document.getElementById("todoFilterList");
    const noTodosMsg = document.getElementById("noTodosMsg");
    const todoListEl = document.getElementById("todoList");
  
    let todoState = {
      lists: [],
      tasks: []
    };
  
    function loadTodoState() {
      try {
        const raw = localStorage.getItem(TODO_STORAGE_KEY);
        if (raw) {
          todoState = JSON.parse(raw);
        }
      } catch (err) {
        console.error("Error loading todo state", err);
      }
      if (!todoState || typeof todoState !== "object") {
        todoState = { lists: [], tasks: [] };
      }
      if (!Array.isArray(todoState.lists)) todoState.lists = [];
      if (!Array.isArray(todoState.tasks)) todoState.tasks = [];
  
      if (!todoState.lists.length) {
        const defaultList = { id: "default", name: "General" };
        todoState.lists.push(defaultList);
      }
  
      // Ensure linking fields exist
      todoState.tasks.forEach((t) => {
        if (typeof t.shoppingListId === "undefined") t.shoppingListId = "";
        if (typeof t.financeTxId === "undefined") t.financeTxId = "";
      });
    }
  
    function saveTodoState() {
      try {
        localStorage.setItem(TODO_STORAGE_KEY, JSON.stringify(todoState));
      } catch (err) {
        console.error("Error saving todo state", err);
      }
      if (window.__myhubRebuildCalendar) window.__myhubRebuildCalendar();
    }
  
    function getTodoListNameById(id) {
      const list = todoState.lists.find((l) => l.id === id);
      return list ? list.name : "";
    }
  
    function ensureTodoListOptions() {
      if (!todoListSelect || !todoFilterList) return;
      todoListSelect.innerHTML = "";
      todoFilterList.innerHTML = "";
  
      todoState.lists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        todoListSelect.appendChild(opt);
      });
  
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "All";
      todoFilterList.appendChild(allOpt);
      todoState.lists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        todoFilterList.appendChild(opt);
      });
    }
  
    function addTodoList(name) {
      const trimmed = name.trim();
      if (!trimmed) return;
      const id = "list_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
      todoState.lists.push({ id, name: trimmed });
      saveTodoState();
      ensureTodoListOptions();
      if (todoListSelect) todoListSelect.value = id;
    }
  
    function addTodoTaskFromInputs(extraTitle) {
      if (!todoListSelect || !todoTitleInput || !todoPrioritySelect) return;
      const titleRaw = extraTitle != null ? extraTitle : todoTitleInput.value;
      const title = titleRaw.trim();
      if (!title) return;
      const listId = todoListSelect.value || (todoState.lists[0] && todoState.lists[0].id) || "default";
      const priority = todoPrioritySelect.value || "medium";
      const dueDate = todoDueDateInput && todoDueDateInput.value ? todoDueDateInput.value : "";
      const now = Date.now();
  
      const tasksInList = todoState.tasks.filter((t) => t.listId === listId);
      const maxOrder = tasksInList.reduce((max, t) => (typeof t.order === "number" && t.order > max ? t.order : max), 0);
  
      const newTask = {
        id: "todo_" + now + "_" + Math.floor(Math.random() * 100000),
        title,
        listId,
        priority,
        dueDate,
        status: "open",
        createdAt: now,
        updatedAt: now,
        order: maxOrder + 1,
        shoppingListId: "",
        financeTxId: ""
      };
  
      todoState.tasks.push(newTask);
      saveTodoState();
      renderTodoList();
  
      if (extraTitle == null) {
        todoTitleInput.value = "";
        if (todoDueDateInput) todoDueDateInput.value = "";
        if (todoPrioritySelect) todoPrioritySelect.value = "medium";
      }
    }
  
    function priorityWeight(p) {
      if (p === "high") return 0;
      if (p === "medium") return 1;
      if (p === "low") return 2;
      return 3;
    }
  
    function statusWeight(s) {
      if (s === "open") return 0;
      if (s === "inprogress") return 1;
      if (s === "done") return 2;
      return 3;
    }
  
    function getFilteredTodoTasks() {
      const search = (todoSearchInput && todoSearchInput.value.trim().toLowerCase()) || "";
      const filterPriority = todoFilterPriority ? todoFilterPriority.value : "all";
      const filterStatus = todoFilterStatus ? todoFilterStatus.value : "all";
      const filterListVal = todoFilterList ? todoFilterList.value : "all";
  
      let tasks = [...todoState.tasks];
  
      if (filterListVal && filterListVal !== "all") {
        tasks = tasks.filter((t) => t.listId === filterListVal);
      }
  
      if (filterPriority && filterPriority !== "all") {
        tasks = tasks.filter((t) => t.priority === filterPriority);
      }
  
      if (filterStatus && filterStatus !== "all") {
        tasks = tasks.filter((t) => t.status === filterStatus);
      }
  
      if (search) {
        tasks = tasks.filter((t) => t.title && t.title.toLowerCase().includes(search));
      }
  
      tasks.sort((a, b) => {
        const sDiff = statusWeight(a.status) - statusWeight(b.status);
        if (sDiff !== 0) return sDiff;
  
        const pDiff = priorityWeight(a.priority) - priorityWeight(b.priority);
        if (pDiff !== 0) return pDiff;
  
        if (a.dueDate && b.dueDate && a.dueDate !== b.dueDate) {
          return a.dueDate.localeCompare(b.dueDate);
        } else if (a.dueDate && !b.dueDate) {
          return -1;
        } else if (!a.dueDate && b.dueDate) {
          return 1;
        }
  
        if (typeof a.order === "number" && typeof b.order === "number" && a.order !== b.order) {
          return a.order - b.order;
        }
  
        return (a.createdAt || 0) - (b.createdAt || 0);
      });
  
      return tasks;
    }
  
    let todoDragId = null;
  
    // Helpers for linking display (will use shoppingState / financeState later)
    function getShoppingListNameByIdLink(id) {
      try {
        if (!id || !window.__myhubShoppingState) return "";
        const list = window.__myhubShoppingState.lists.find((l) => l.id === id);
        return list ? list.name : "";
      } catch {
        return "";
      }
    }
  
    function getFinanceTxShortLabel(id) {
      try {
        if (!id || !window.__myhubFinanceState) return "";
        const tx = window.__myhubFinanceState.transactions.find((t) => t.id === id);
        if (!tx) return "";
        const acc = window.__myhubGetAccountById
          ? window.__myhubGetAccountById(tx.accountId)
          : null;
        const currency = acc ? acc.currency || "" : "";
        const amount = typeof tx.amount === "number" ? tx.amount.toFixed(2) : tx.amount;
        return `${tx.category || ""} ${amount} ${currency}`.trim();
      } catch {
        return "";
      }
    }
  
    function renderTodoList() {
      if (!todoListEl || !noTodosMsg) return;
      todoListEl.innerHTML = "";
      const tasks = getFilteredTodoTasks();
  
      if (!tasks.length) {
        noTodosMsg.classList.remove("hidden");
        return;
      }
      noTodosMsg.classList.add("hidden");
  
      for (const task of tasks) {
        const item = document.createElement("div");
        item.className = "item";
        item.dataset.id = task.id;
        item.draggable = true;
  
        const listName = getTodoListNameById(task.listId);
        const dueText = task.dueDate ? new Date(task.dueDate + "T00:00:00").toLocaleDateString() : "No date";
        const statusLabel = task.status === "inprogress" ? "In progress" : task.status === "done" ? "Done" : "Open";
  
        let priorityLabel = "";
        if (task.priority === "high") priorityLabel = "üî• High";
        else if (task.priority === "medium") priorityLabel = "Medium";
        else if (task.priority === "low") priorityLabel = "Low";
  
        const linkedShopping = task.shoppingListId ? getShoppingListNameByIdLink(task.shoppingListId) : "";
        const linkedFinance = task.financeTxId ? getFinanceTxShortLabel(task.financeTxId) : "";
  
        item.innerHTML = `
          <div class="item-main">
            <div class="item-checkbox">
              <input type="checkbox" ${task.status === "done" ? "checked" : ""} />
            </div>
            <div class="item-text">
              <div class="item-title">${task.title}</div>
              <div class="item-meta">
                <span class="tag">${priorityLabel || "No priority"}</span>
                <span class="tag">${dueText}</span>
                <span class="tag">${listName}</span>
                <span class="tag">${statusLabel}</span>
                ${linkedShopping ? `<span class="tag">üõí ${linkedShopping}</span>` : ""}
                ${linkedFinance ? `<span class="tag">üí∞ ${linkedFinance}</span>` : ""}
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="icon-btn" data-action="link-shopping" title="Link to shopping list">üõí</button>
            <button class="icon-btn" data-action="link-finance" title="Link to transaction">üí∞</button>
            <button class="icon-btn" data-action="status" title="Toggle in progress">‚è≥</button>
            <button class="icon-btn" data-action="edit" title="Edit task">‚úèÔ∏è</button>
            <button class="icon-btn danger" data-action="delete" title="Delete task">üóë</button>
          </div>
        `;
  
        item.addEventListener("dragstart", (e) => {
          todoDragId = task.id;
          e.dataTransfer.effectAllowed = "move";
        });
  
        item.addEventListener("dragover", (e) => {
          e.preventDefault();
        });
  
        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const targetId = item.dataset.id;
          if (!todoDragId || todoDragId === targetId) return;
          reorderTodoTasks(todoDragId, targetId);
          todoDragId = null;
        });
  
        todoListEl.appendChild(item);
      }
  
      // checkbox changes
      todoListEl.addEventListener("change", (e) => {
        const checkbox = e.target.closest("input[type='checkbox']");
        if (!checkbox) return;
        const itemEl = checkbox.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const task = todoState.tasks.find((t) => t.id === id);
        if (!task) return;
        task.status = checkbox.checked ? "done" : "open";
        task.updatedAt = Date.now();
        saveTodoState();
        renderTodoList();
      }, { once: true });
  
      // buttons (edit/delete/status/link)
      todoListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const itemEl = btn.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const task = todoState.tasks.find((t) => t.id === id);
        if (!task) return;
  
        if (action === "delete") {
          if (!confirm("Delete this task?")) return;
          todoState.tasks = todoState.tasks.filter((t) => t.id !== id);
          saveTodoState();
          renderTodoList();
        } else if (action === "edit") {
          const newTitle = prompt("Edit task title:", task.title || "") ?? task.title;
          const newPriority = prompt("Priority (high, medium, low):", task.priority || "medium") ?? task.priority;
          const newDue = prompt("Due date (YYYY-MM-DD or empty):", task.dueDate || "") ?? task.dueDate;
          task.title = (newTitle || "").trim();
          const p = (newPriority || "").toLowerCase();
          if (p === "high" || p === "medium" || p === "low") {
            task.priority = p;
          }
          task.dueDate = (newDue || "").trim();
          task.updatedAt = Date.now();
          saveTodoState();
          renderTodoList();
        } else if (action === "status") {
          if (task.status === "open") task.status = "inprogress";
          else if (task.status === "inprogress") task.status = "open";
          else if (task.status === "done") task.status = "inprogress";
          task.updatedAt = Date.now();
          saveTodoState();
          renderTodoList();
        } else if (action === "link-shopping") {
          linkTodoToShopping(task);
        } else if (action === "link-finance") {
          linkTodoToFinance(task);
        }
      }, { once: true });
    }
  
    function reorderTodoTasks(dragId, targetId) {
      const visible = getFilteredTodoTasks();
      const fromIndex = visible.findIndex((t) => t.id === dragId);
      const toIndex = visible.findIndex((t) => t.id === targetId);
      if (fromIndex < 0 || toIndex < 0) return;
      const [moved] = visible.splice(fromIndex, 1);
      visible.splice(toIndex, 0, moved);
      visible.forEach((t, index) => {
        const original = todoState.tasks.find((x) => x.id === t.id);
        if (original) original.order = index + 1;
      });
      saveTodoState();
      renderTodoList();
    }
  
    function linkTodoToShopping(task) {
      if (!window.__myhubShoppingState || !window.__myhubShoppingState.lists.length) {
        alert("No shopping lists yet. Create one in the Shopping tab first.");
        return;
      }
      const lists = window.__myhubShoppingState.lists;
      const lines = lists.map((l, i) => `${i + 1}) ${l.name}`);
      const resp = prompt(
        "Link to which shopping list?\n" +
        lines.join("\n") +
        "\n\nType the number, or leave empty to clear the link."
      );
      if (resp === null) return;
      const trimmed = resp.trim();
      if (!trimmed) {
        task.shoppingListId = "";
        task.updatedAt = Date.now();
        saveTodoState();
        renderTodoList();
        return;
      }
      const num = parseInt(trimmed, 10);
      if (isNaN(num) || num < 1 || num > lists.length) {
        alert("Invalid choice.");
        return;
      }
      task.shoppingListId = lists[num - 1].id;
      task.updatedAt = Date.now();
      saveTodoState();
      renderTodoList();
    }
  
    function linkTodoToFinance(task) {
      if (!window.__myhubFinanceState || !window.__myhubFinanceState.transactions.length) {
        alert("No finance transactions yet. Add one in the Finance tab first.");
        return;
      }
      const txs = [...window.__myhubFinanceState.transactions]
        .sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0))
        .slice(0, 10);
      const lines = txs.map((tx, i) => {
        const acc = window.__myhubGetAccountById ? window.__myhubGetAccountById(tx.accountId) : null;
        const currency = acc ? acc.currency || "" : "";
        const amount = typeof tx.amount === "number" ? tx.amount.toFixed(2) : tx.amount;
        const cat = tx.category || "(no category)";
        return `${i + 1}) ${cat} - ${amount} ${currency}`;
      });
      const resp = prompt(
        "Link to which transaction? (last 10)\n" +
        lines.join("\n") +
        "\n\nType the number, or leave empty to clear the link."
      );
      if (resp === null) return;
      const trimmed = resp.trim();
      if (!trimmed) {
        task.financeTxId = "";
        task.updatedAt = Date.now();
        saveTodoState();
        renderTodoList();
        return;
      }
      const num = parseInt(trimmed, 10);
      if (isNaN(num) || num < 1 || num > txs.length) {
        alert("Invalid choice.");
        return;
      }
      task.financeTxId = txs[num - 1].id;
      task.updatedAt = Date.now();
      saveTodoState();
      renderTodoList();
    }
  
    if (todoNewListBtn) {
      todoNewListBtn.addEventListener("click", () => {
        if (!todoListNameInput) return;
        if (!todoListNameInput.value.trim()) return;
        addTodoList(todoListNameInput.value);
        todoListNameInput.value = "";
      });
    }
  
    if (addTodoBtn) {
      addTodoBtn.addEventListener("click", () => {
        addTodoTaskFromInputs();
      });
    }
  
    if (todoTitleInput) {
      todoTitleInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addTodoTaskFromInputs();
        }
      });
    }
  
    if (todoFiltersToggle && todoFiltersPanel) {
      todoFiltersToggle.addEventListener("click", () => {
        const isHidden = todoFiltersPanel.style.display === "none" || !todoFiltersPanel.style.display;
        todoFiltersPanel.style.display = isHidden ? "block" : "none";
      });
    }
  
    [todoSearchInput, todoFilterPriority, todoFilterStatus, todoFilterList].forEach((el) => {
      if (!el) return;
      el.addEventListener("input", () => {
        renderTodoList();
      });
      el.addEventListener("change", () => {
        renderTodoList();
      });
    });
  
    loadTodoState();
    ensureTodoListOptions();
  
    if (window.__myhubQuickTaskBuffer) {
      addTodoTaskFromInputs(window.__myhubQuickTaskBuffer);
      window.__myhubQuickTaskBuffer = null;
    }
  
    renderTodoList();
  
    // ==============================
    // SHOPPING MODULE
    // ==============================
    const SHOPPING_STORAGE_KEY = "myhub_shopping_v2";
  
    const shoppingListSelect = document.getElementById("shoppingListSelect");
    const shoppingListNameInput = document.getElementById("shoppingListName");
    const shoppingNewListBtn = document.getElementById("shoppingNewListBtn");
    const shoppingItemInput = document.getElementById("shoppingItemInput");
    const addShoppingBtn = document.getElementById("addShoppingBtn");
    const shoppingEmptyMsg = document.getElementById("shoppingEmptyMsg");
    const shoppingListEl = document.getElementById("shoppingList");
  
    let shoppingState = {
      lists: [],
      items: []
    };
    window.__myhubShoppingState = shoppingState; // expose for linking
  
    function loadShoppingState() {
      try {
        const raw = localStorage.getItem(SHOPPING_STORAGE_KEY);
        if (raw) shoppingState = JSON.parse(raw);
      } catch (err) {
        console.error("Error loading shopping state", err);
      }
      if (!shoppingState || typeof shoppingState !== "object") {
        shoppingState = { lists: [], items: [] };
      }
      if (!Array.isArray(shoppingState.lists)) shoppingState.lists = [];
      if (!Array.isArray(shoppingState.items)) shoppingState.items = [];
  
      if (!shoppingState.lists.length) {
        const defaultList = { id: "shop_default", name: "Regular" };
        shoppingState.lists.push(defaultList);
      }
  
      window.__myhubShoppingState = shoppingState;
    }
  
    function saveShoppingState() {
      try {
        localStorage.setItem(SHOPPING_STORAGE_KEY, JSON.stringify(shoppingState));
      } catch (err) {
        console.error("Error saving shopping state", err);
      }
    }
  
    function ensureShoppingListOptions() {
      if (!shoppingListSelect) return;
      shoppingListSelect.innerHTML = "";
      shoppingState.lists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        shoppingListSelect.appendChild(opt);
      });
    }
  
    function addShoppingList(name) {
      const trimmed = name.trim();
      if (!trimmed) return;
      const id = "shoplist_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
      shoppingState.lists.push({ id, name: trimmed });
      saveShoppingState();
      ensureShoppingListOptions();
      if (shoppingListSelect) shoppingListSelect.value = id;
    }
  
    function getCurrentShoppingListId() {
      if (!shoppingListSelect || !shoppingListSelect.value) {
        return shoppingState.lists[0] && shoppingState.lists[0].id;
      }
      return shoppingListSelect.value;
    }
  
    function addShoppingItemFromInput() {
      if (!shoppingItemInput) return;
      const name = shoppingItemInput.value.trim();
      if (!name) return;
      const listId = getCurrentShoppingListId();
      const now = Date.now();
      const itemsInList = shoppingState.items.filter((it) => it.listId === listId);
      const maxOrder = itemsInList.reduce((max, it) => (typeof it.order === "number" && it.order > max ? it.order : max), 0);
  
      const newItem = {
        id: "shop_" + now + "_" + Math.floor(Math.random() * 100000),
        name,
        listId,
        checked: false,
        note: "",
        createdAt: now,
        order: maxOrder + 1
      };
  
      shoppingState.items.push(newItem);
      saveShoppingState();
      renderShoppingItems();
      shoppingItemInput.value = "";
    }
  
    let shoppingDragId = null;
  
    function renderShoppingItems() {
      if (!shoppingListEl || !shoppingEmptyMsg) return;
      shoppingListEl.innerHTML = "";
      const listId = getCurrentShoppingListId();
      const items = shoppingState.items
        .filter((it) => it.listId === listId)
        .sort((a, b) => {
          if (typeof a.order === "number" && typeof b.order === "number" && a.order !== b.order) {
            return a.order - b.order;
          }
          return (a.createdAt || 0) - (b.createdAt || 0);
        });
  
      if (!items.length) {
        shoppingEmptyMsg.classList.remove("hidden");
        return;
      }
      shoppingEmptyMsg.classList.add("hidden");
  
      for (const it of items) {
        const item = document.createElement("div");
        item.className = "item";
        item.dataset.id = it.id;
        item.draggable = true;
  
        item.innerHTML = `
          <div class="item-main">
            <div class="item-checkbox">
              <input type="checkbox" ${it.checked ? "checked" : ""} />
            </div>
            <div class="item-text">
              <div class="item-title">${it.name}</div>
              ${it.note ? `<div class="item-meta"><span class="tag">${it.note}</span></div>` : ""}
            </div>
          </div>
          <div class="item-actions">
            <button class="icon-btn" data-action="note" title="Add/edit note">üìù</button>
            <button class="icon-btn danger" data-action="delete" title="Delete item">üóë</button>
          </div>
        `;
  
        item.addEventListener("dragstart", (e) => {
          shoppingDragId = it.id;
          e.dataTransfer.effectAllowed = "move";
        });
  
        item.addEventListener("dragover", (e) => {
          e.preventDefault();
        });
  
        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const targetId = item.dataset.id;
          if (!shoppingDragId || shoppingDragId === targetId) return;
          reorderShoppingItems(shoppingDragId, targetId);
          shoppingDragId = null;
        });
  
        shoppingListEl.appendChild(item);
      }
  
      shoppingListEl.addEventListener("change", (e) => {
        const checkbox = e.target.closest("input[type='checkbox']");
        if (!checkbox) return;
        const itemEl = checkbox.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const it = shoppingState.items.find((x) => x.id === id);
        if (!it) return;
        it.checked = checkbox.checked;
        saveShoppingState();
      }, { once: true });
  
      shoppingListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const itemEl = btn.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const it = shoppingState.items.find((x) => x.id === id);
        if (!it) return;
  
        if (action === "delete") {
          if (!confirm("Delete this item?")) return;
          shoppingState.items = shoppingState.items.filter((x) => x.id !== id);
          saveShoppingState();
          renderShoppingItems();
        } else if (action === "note") {
          const newNote = prompt("Note for this item:", it.note || "") ?? it.note;
          it.note = (newNote || "").trim();
          saveShoppingState();
          renderShoppingItems();
        }
      }, { once: true });
    }
  
    function reorderShoppingItems(dragId, targetId) {
      const listId = getCurrentShoppingListId();
      const visible = shoppingState.items
        .filter((it) => it.listId === listId)
        .sort((a, b) => {
          if (typeof a.order === "number" && typeof b.order === "number" && a.order !== b.order) {
            return a.order - b.order;
          }
          return (a.createdAt || 0) - (b.createdAt || 0);
        });
  
      const fromIndex = visible.findIndex((it) => it.id === dragId);
      const toIndex = visible.findIndex((it) => it.id === targetId);
      if (fromIndex < 0 || toIndex < 0) return;
      const [moved] = visible.splice(fromIndex, 1);
      visible.splice(toIndex, 0, moved);
      visible.forEach((it, index) => {
        const original = shoppingState.items.find((x) => x.id === it.id);
        if (original) original.order = index + 1;
      });
      saveShoppingState();
      renderShoppingItems();
    }
  
    if (shoppingNewListBtn) {
      shoppingNewListBtn.addEventListener("click", () => {
        if (!shoppingListNameInput) return;
        if (!shoppingListNameInput.value.trim()) return;
        addShoppingList(shoppingListNameInput.value);
        shoppingListNameInput.value = "";
      });
    }
  
    if (addShoppingBtn) {
      addShoppingBtn.addEventListener("click", () => {
        addShoppingItemFromInput();
      });
    }
  
    if (shoppingItemInput) {
      shoppingItemInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addShoppingItemFromInput();
        }
      });
    }
  
    if (shoppingListSelect) {
      shoppingListSelect.addEventListener("change", () => {
        renderShoppingItems();
      });
    }
  
    loadShoppingState();
    ensureShoppingListOptions();
    renderShoppingItems();
  
    // ==============================
    // WORKOUTS MODULE
    // ==============================
    const WORKOUT_STORAGE_KEY = "myhub_workouts_v1";
  
    const workoutFavoritesEmpty = document.getElementById("workoutFavoritesEmpty");
    const workoutFavoritesEl = document.getElementById("workoutFavorites");
    const workoutNameInput = document.getElementById("workoutName");
    const workoutStartLabel = document.getElementById("workoutStartLabel");
    const workoutDurationLabel = document.getElementById("workoutDurationLabel");
    const startWorkoutBtn = document.getElementById("startWorkoutBtn");
    const saveWorkoutBtn = document.getElementById("saveWorkoutBtn");
    const addExerciseRowBtn = document.getElementById("addExerciseRowBtn");
    const workoutExercisesEl = document.getElementById("workoutExercises");
    const workoutNotesInput = document.getElementById("workoutNotes");
    const noWorkoutMsg = document.getElementById("noWorkoutMsg");
    const workoutListEl = document.getElementById("workoutList");
  
    let workoutState = {
      workouts: []
    };
    window.__myhubWorkoutState = workoutState;
  
    let currentWorkoutStart = null;
  
    function loadWorkoutState() {
      try {
        const raw = localStorage.getItem(WORKOUT_STORAGE_KEY);
        if (raw) workoutState = JSON.parse(raw);
      } catch (err) {
        console.error("Error loading workouts", err);
      }
      if (!workoutState || typeof workoutState !== "object") {
        workoutState = { workouts: [] };
      }
      if (!Array.isArray(workoutState.workouts)) workoutState.workouts = [];
      window.__myhubWorkoutState = workoutState;
    }
  
    function saveWorkoutState() {
      try {
        localStorage.setItem(WORKOUT_STORAGE_KEY, JSON.stringify(workoutState));
      } catch (err) {
        console.error("Error saving workouts", err);
      }
      if (window.__myhubRebuildCalendar) window.__myhubRebuildCalendar();
    }
  
    function formatDuration(ms) {
      if (!ms || ms <= 0) return "‚Äì";
      const totalSeconds = Math.floor(ms / 1000);
      const minutes = Math.floor(totalSeconds / 60);
      const seconds = totalSeconds % 60;
      if (minutes >= 60) {
        const hours = Math.floor(minutes / 60);
        const mins = minutes % 60;
        return `${hours}h ${mins}m`;
      }
      return `${minutes}m ${seconds}s`;
    }
  
    function formatDateTime(ts) {
      if (!ts) return "";
      try {
        const d = new Date(ts);
        return d.toLocaleString();
      } catch {
        return "";
      }
    }
  
    function addExerciseRow(prefill) {
      if (!workoutExercisesEl) return;
      const row = document.createElement("div");
      row.className = "workout-row";
  
      const exerciseName = prefill && prefill.name ? prefill.name : "";
      const sets = prefill && prefill.sets ? prefill.sets : "";
      const reps = prefill && prefill.reps ? prefill.reps : "";
      const weight = prefill && prefill.weight ? prefill.weight : "";
      const done = prefill && prefill.done ? true : false;
  
      row.innerHTML = `
        <div class="workout-row-top">
          <input type="text" class="workout-ex-name" placeholder="Exercise name" value="${exerciseName}" />
        </div>
        <div class="workout-row-bottom">
          <input type="number" class="workout-ex-sets" placeholder="Sets" min="0" value="${sets}" />
          <input type="number" class="workout-ex-reps" placeholder="Reps" min="0" value="${reps}" />
          <input type="number" class="workout-ex-weight" placeholder="Weight" min="0" value="${weight}" />
          <input type="checkbox" class="workout-done" ${done ? "checked" : ""} />
          <button class="icon-btn danger workout-remove" title="Remove exercise">üóë</button>
        </div>
      `;
  
      workoutExercisesEl.appendChild(row);
  
      const removeBtn = row.querySelector(".workout-remove");
      if (removeBtn) {
        removeBtn.addEventListener("click", () => {
          if (!confirm("Remove this exercise row?")) return;
          row.remove();
        });
      }
    }
  
    function gatherCurrentWorkoutExercises() {
      if (!workoutExercisesEl) return [];
      const rows = workoutExercisesEl.querySelectorAll(".workout-row");
      const exercises = [];
      rows.forEach((row, index) => {
        const nameInput = row.querySelector(".workout-ex-name");
        const setsInput = row.querySelector(".workout-ex-sets");
        const repsInput = row.querySelector(".workout-ex-reps");
        const weightInput = row.querySelector(".workout-ex-weight");
        const doneCheckbox = row.querySelector(".workout-done");
  
        const name = nameInput && nameInput.value.trim();
        if (!name) return;
  
        exercises.push({
          id: "ex_" + Date.now() + "_" + index,
          name,
          sets: setsInput && setsInput.value ? Number(setsInput.value) : null,
          reps: repsInput && repsInput.value ? Number(repsInput.value) : null,
          weight: weightInput && weightInput.value ? Number(weightInput.value) : null,
          done: !!(doneCheckbox && doneCheckbox.checked)
        });
      });
      return exercises;
    }
  
    function clearCurrentWorkoutForm() {
      if (workoutNameInput) workoutNameInput.value = "";
      if (workoutExercisesEl) workoutExercisesEl.innerHTML = "";
      if (workoutNotesInput) workoutNotesInput.value = "";
      currentWorkoutStart = null;
      if (workoutStartLabel) workoutStartLabel.textContent = "Not started";
      if (workoutDurationLabel) workoutDurationLabel.textContent = "‚Äì";
    }
  
    function renderWorkoutFavorites() {
      if (!workoutFavoritesEl || !workoutFavoritesEmpty) return;
      workoutFavoritesEl.innerHTML = "";
  
      const favorites = workoutState.workouts.filter((w) => w.favorite);
      if (!favorites.length) {
        workoutFavoritesEmpty.classList.remove("hidden");
        return;
      }
      workoutFavoritesEmpty.classList.add("hidden");
  
      favorites.slice(-6).forEach((w) => {
        const card = document.createElement("div");
        card.className = "favorite-card";
        card.dataset.id = w.id;
        card.textContent = w.name || "(no name)";
        card.title = "Tap to load this workout as template";
  
        card.addEventListener("click", () => {
          if (workoutNameInput) workoutNameInput.value = w.name || "";
          if (workoutExercisesEl) workoutExercisesEl.innerHTML = "";
          if (Array.isArray(w.exercises)) {
            w.exercises.forEach((ex) => {
              addExerciseRow(ex);
            });
          }
          if (workoutNotesInput) workoutNotesInput.value = w.notes || "";
          currentWorkoutStart = null;
          if (workoutStartLabel) workoutStartLabel.textContent = "Not started";
          if (workoutDurationLabel) workoutDurationLabel.textContent = "‚Äì";
        });
  
        workoutFavoritesEl.appendChild(card);
      });
    }
  
    function renderWorkoutList() {
      if (!workoutListEl || !noWorkoutMsg) return;
      workoutListEl.innerHTML = "";
  
      const workouts = [...workoutState.workouts].sort((a, b) => (b.startTime || b.createdAt || 0) - (a.startTime || a.createdAt || 0));
      if (!workouts.length) {
        noWorkoutMsg.classList.remove("hidden");
        return;
      }
      noWorkoutMsg.classList.add("hidden");
  
      workouts.forEach((w) => {
        const item = document.createElement("div");
        item.className = "item";
        item.dataset.id = w.id;
  
        const duration = formatDuration(w.durationMs);
        const dateLabel = formatDateTime(w.startTime || w.createdAt);
        const exCount = Array.isArray(w.exercises) ? w.exercises.length : 0;
  
        item.innerHTML = `
          <div class="item-main">
            <div class="item-text">
              <div class="item-title">${w.name || "(no name)"}</div>
              <div class="item-meta">
                <span class="tag">${dateLabel}</span>
                <span class="tag">${duration}</span>
                <span class="tag">${exCount} exercises</span>
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="icon-btn" data-action="favorite" title="Toggle favorite">${w.favorite ? "‚≠ê" : "‚òÜ"}</button>
            <button class="icon-btn danger" data-action="delete" title="Delete workout">üóë</button>
          </div>
        `;
  
        workoutListEl.appendChild(item);
      });
  
      workoutListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const itemEl = btn.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const w = workoutState.workouts.find((x) => x.id === id);
        if (!w) return;
  
        if (action === "delete") {
          if (!confirm("Delete this workout?")) return;
          workoutState.workouts = workoutState.workouts.filter((x) => x.id !== id);
          saveWorkoutState();
          renderWorkoutList();
          renderWorkoutFavorites();
        } else if (action === "favorite") {
          w.favorite = !w.favorite;
          saveWorkoutState();
          renderWorkoutList();
          renderWorkoutFavorites();
        }
      }, { once: true });
    }
  
    if (startWorkoutBtn) {
      startWorkoutBtn.addEventListener("click", () => {
        const now = Date.now();
        currentWorkoutStart = now;
        if (workoutStartLabel) workoutStartLabel.textContent = formatDateTime(now);
        if (workoutDurationLabel) workoutDurationLabel.textContent = "0m 0s";
      });
    }
  
    if (saveWorkoutBtn) {
      saveWorkoutBtn.addEventListener("click", () => {
        const name = workoutNameInput && workoutNameInput.value.trim();
        const exercises = gatherCurrentWorkoutExercises();
        const notes = workoutNotesInput ? workoutNotesInput.value.trim() : "";
  
        if (!name && !exercises.length) {
          alert("Add at least a workout name or one exercise.");
          return;
        }
  
        const now = Date.now();
        const startTime = currentWorkoutStart || now;
        const durationMs = currentWorkoutStart ? now - currentWorkoutStart : 0;
  
        const workout = {
          id: "wo_" + now + "_" + Math.floor(Math.random() * 100000),
          name: name || "(no name)",
          exercises,
          notes,
          startTime,
          durationMs,
          createdAt: now,
          favorite: false
        };
  
        workoutState.workouts.push(workout);
        saveWorkoutState();
        clearCurrentWorkoutForm();
        renderWorkoutList();
        renderWorkoutFavorites();
      });
    }
  
    if (addExerciseRowBtn) {
      addExerciseRowBtn.addEventListener("click", () => {
        addExerciseRow();
      });
    }
  
    loadWorkoutState();
    renderWorkoutList();
    renderWorkoutFavorites();
  
    // ==============================
    // FINANCE MODULE
    // ==============================
    const FINANCE_STORAGE_KEY = "myhub_finance_v1";
  
    const financeAccountSelect = document.getElementById("financeAccount");
    const financeTypeSelect = document.getElementById("financeType");
    const financeAmountInput = document.getElementById("financeAmount");
    const financeDateInput = document.getElementById("financeDate");
    const financeCategoryInput = document.getElementById("financeCategory");
    const financeMethodInput = document.getElementById("financeMethod");
    const financeNoteInput = document.getElementById("financeNote");
    const addFinanceBtn = document.getElementById("addFinanceBtn");
    const financeFilterCategorySelect = document.getElementById("financeFilterCategory");
    const financeSummaryEl = document.getElementById("financeSummary");
    const noFinanceMsg = document.getElementById("noFinanceMsg");
    const financeListEl = document.getElementById("financeList");
    const addAccountBtn = document.getElementById("addAccountBtn");
    const noAccountsMsg = document.getElementById("noAccountsMsg");
    const accountsListEl = document.getElementById("accountsList");
  
    let financeState = {
      accounts: [],
      transactions: []
    };
    window.__myhubFinanceState = financeState;
  
    function loadFinanceState() {
      try {
        const raw = localStorage.getItem(FINANCE_STORAGE_KEY);
        if (raw) financeState = JSON.parse(raw);
      } catch (err) {
        console.error("Error loading finance state", err);
      }
  
      if (!financeState || typeof financeState !== "object") {
        financeState = { accounts: [], transactions: [] };
      }
      if (!Array.isArray(financeState.accounts)) financeState.accounts = [];
      if (!Array.isArray(financeState.transactions)) financeState.transactions = [];
  
      if (!financeState.accounts.length) {
        financeState.accounts.push({ id: "acc_main", name: "Main (THB)", currency: "THB" });
      }
  
      window.__myhubFinanceState = financeState;
    }
  
    function saveFinanceState() {
      try {
        localStorage.setItem(FINANCE_STORAGE_KEY, JSON.stringify(financeState));
      } catch (err) {
        console.error("Error saving finance state", err);
      }
      if (window.__myhubRebuildCalendar) window.__myhubRebuildCalendar();
    }
  
    function ensureFinanceAccountOptions() {
      if (!financeAccountSelect) return;
      financeAccountSelect.innerHTML = "";
      financeState.accounts.forEach((acc) => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        opt.textContent = acc.name;
        financeAccountSelect.appendChild(opt);
      });
    }
  
    function addFinanceAccount() {
      const name = prompt("Account name (e.g. THB main, BRL savings, USD):");
      if (!name) return;
      const currency = prompt("Currency (e.g. THB, BRL, USD):", "THB") || "THB";
      const id = "acc_" + Date.now() + "_" + Math.floor(Math.random() * 100000);
      financeState.accounts.push({ id, name: name.trim(), currency: currency.trim() });
      saveFinanceState();
      ensureFinanceAccountOptions();
      renderAccounts();
    }
  
    function getAccountById(id) {
      return financeState.accounts.find((a) => a.id === id) || null;
    }
    window.__myhubGetAccountById = getAccountById;
  
    function addFinanceTransaction() {
      if (!financeAccountSelect || !financeAmountInput || !financeTypeSelect) return;
      const accountId = financeAccountSelect.value;
      const type = financeTypeSelect.value === "income" ? "income" : "expense";
      const amountVal = parseFloat(financeAmountInput.value);
      if (!accountId || isNaN(amountVal) || amountVal <= 0) return;
  
      const date = financeDateInput && financeDateInput.value ? financeDateInput.value : "";
      const category = financeCategoryInput && financeCategoryInput.value.trim();
      const method = financeMethodInput && financeMethodInput.value.trim();
      const note = financeNoteInput && financeNoteInput.value.trim();
      const now = Date.now();
  
      const tx = {
        id: "tx_" + now + "_" + Math.floor(Math.random() * 100000),
        accountId,
        type,
        amount: amountVal,
        date,
        category: category || "",
        method: method || "",
        note: note || "",
        createdAt: now
      };
  
      financeState.transactions.push(tx);
      saveFinanceState();
      renderFinanceList();
      renderFinanceSummary();
  
      financeAmountInput.value = "";
      if (financeNoteInput) financeNoteInput.value = "";
    }
  
    function getFilteredTransactions() {
      let txs = [...financeState.transactions];
      const catFilter = financeFilterCategorySelect ? financeFilterCategorySelect.value : "all";
      if (catFilter && catFilter !== "all") {
        txs = txs.filter((tx) => (tx.category || "").toLowerCase() === catFilter.toLowerCase());
      }
      txs.sort((a, b) => (b.createdAt || 0) - (a.createdAt || 0));
      return txs;
    }
  
    function renderFinanceSummary() {
      if (!financeSummaryEl) return;
      const txs = getFilteredTransactions();
      let income = 0;
      let expense = 0;
      txs.forEach((tx) => {
        if (tx.type === "income") income += tx.amount;
        else expense += tx.amount;
      });
      const net = income - expense;
      financeSummaryEl.textContent = `Income: ${income.toFixed(2)}  |  Expenses: ${expense.toFixed(2)}  |  Net: ${net.toFixed(2)}`;
    }
  
    function renderFinanceList() {
      if (!financeListEl || !noFinanceMsg) return;
      financeListEl.innerHTML = "";
      const txs = getFilteredTransactions();
      if (!txs.length) {
        noFinanceMsg.classList.remove("hidden");
        return;
      }
      noFinanceMsg.classList.add("hidden");
  
      txs.forEach((tx) => {
        const item = document.createElement("div");
        item.className = "item";
        item.dataset.id = tx.id;
  
        const acc = getAccountById(tx.accountId);
        const accName = acc ? acc.name : "Unknown account";
        const currency = acc ? (acc.currency || "") : "";
        const dateText = tx.date
          ? new Date(tx.date + "T00:00:00").toLocaleDateString()
          : new Date(tx.createdAt || Date.now()).toLocaleDateString();
        const typeTagClass = tx.type === "income" ? "tag-income" : "tag-expense";
        const typeLabel = tx.type === "income" ? "Income" : "Expense";
  
        item.innerHTML = `
          <div class="item-main">
            <div class="item-text">
              <div class="item-title">${tx.category || "(no category)"} - ${tx.amount.toFixed(2)} ${currency}</div>
              <div class="item-meta">
                <span class="tag ${typeTagClass}">${typeLabel}</span>
                <span class="tag">${accName}</span>
                <span class="tag">${dateText}</span>
                ${tx.method ? `<span class="tag">${tx.method}</span>` : ""}
                ${tx.note ? `<span class="tag">${tx.note}</span>` : ""}
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="icon-btn" data-action="edit" title="Edit transaction">‚úèÔ∏è</button>
            <button class="icon-btn danger" data-action="delete" title="Delete transaction">üóë</button>
          </div>
        `;
  
        financeListEl.appendChild(item);
      });
  
      financeListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const itemEl = btn.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const tx = financeState.transactions.find((t) => t.id === id);
        if (!tx) return;
  
        if (action === "delete") {
          if (!confirm("Delete this transaction?")) return;
          financeState.transactions = financeState.transactions.filter((t) => t.id !== id);
          saveFinanceState();
          renderFinanceList();
          renderFinanceSummary();
        } else if (action === "edit") {
          const newAmountStr = prompt("Amount:", tx.amount.toString());
          const newCategory = prompt("Category:", tx.category || "") ?? tx.category;
          const newMethod = prompt("Method:", tx.method || "") ?? tx.method;
          const newNote = prompt("Note:", tx.note || "") ?? tx.note;
          const newDate = prompt("Date (YYYY-MM-DD or empty):", tx.date || "") ?? tx.date;
  
          const amountNum = parseFloat(newAmountStr || "");
          if (!isNaN(amountNum) && amountNum > 0) {
            tx.amount = amountNum;
          }
          tx.category = (newCategory || "").trim();
          tx.method = (newMethod || "").trim();
          tx.note = (newNote || "").trim();
          tx.date = (newDate || "").trim();
  
          saveFinanceState();
          renderFinanceList();
          renderFinanceSummary();
        }
      }, { once: true });
    }
  
    function renderAccounts() {
      if (!accountsListEl || !noAccountsMsg) return;
      accountsListEl.innerHTML = "";
  
      if (!financeState.accounts.length) {
        noAccountsMsg.classList.remove("hidden");
        return;
      }
      noAccountsMsg.classList.add("hidden");
  
      const balances = {};
      financeState.accounts.forEach((acc) => {
        balances[acc.id] = 0;
      });
      financeState.transactions.forEach((tx) => {
        if (!balances.hasOwnProperty(tx.accountId)) return;
        if (tx.type === "income") balances[tx.accountId] += tx.amount;
        else balances[tx.accountId] -= tx.amount;
      });
  
      financeState.accounts.forEach((acc) => {
        const item = document.createElement("div");
        item.className = "item";
        item.dataset.id = acc.id;
  
        const balance = balances[acc.id] || 0;
  
        item.innerHTML = `
          <div class="item-main">
            <div class="item-text">
              <div class="item-title">${acc.name}</div>
              <div class="item-meta">
                <span class="tag">Currency: ${acc.currency || ""}</span>
                <span class="tag">Balance: ${balance.toFixed(2)}</span>
              </div>
            </div>
          </div>
          <div class="item-actions">
            <button class="icon-btn danger" data-action="delete" title="Delete account">üóë</button>
          </div>
        `;
  
        accountsListEl.appendChild(item);
      });
  
      accountsListEl.addEventListener("click", (e) => {
        const btn = e.target.closest("button[data-action]");
        if (!btn) return;
        const action = btn.dataset.action;
        const itemEl = btn.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const acc = financeState.accounts.find((a) => a.id === id);
        if (!acc) return;
  
        if (action === "delete") {
          if (!confirm("Delete this account? All related transactions will remain but may show 'Unknown account'.")) {
            return;
          }
          financeState.accounts = financeState.accounts.filter((a) => a.id !== id);
          saveFinanceState();
          ensureFinanceAccountOptions();
          renderAccounts();
          renderFinanceList();
          renderFinanceSummary();
        }
      }, { once: true });
    }
  
    loadFinanceState();
    ensureFinanceAccountOptions();
    renderAccounts();
    renderFinanceList();
    renderFinanceSummary();
  
    if (addFinanceBtn) {
      addFinanceBtn.addEventListener("click", () => {
        addFinanceTransaction();
      });
    }
  
    if (financeAmountInput) {
      financeAmountInput.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          addFinanceTransaction();
        }
      });
    }
  
    if (financeFilterCategorySelect) {
      financeFilterCategorySelect.addEventListener("change", () => {
        renderFinanceList();
        renderFinanceSummary();
      });
    }
  
    if (addAccountBtn) {
      addAccountBtn.addEventListener("click", () => {
        addFinanceAccount();
      });
    }
  
    // ==============================
    // NOTES MODULE (TEXT + CANVAS)
    // ==============================
    (function setupNotes() {
      const notesPage = document.querySelector('.page[data-page="notes"]');
      if (!notesPage) return;
  
      notesPage.innerHTML = `
        <h2 class="section-title">Notes</h2>
  
        <div class="pill-row" style="margin-bottom: 10px;">
          <button id="notesTabText" class="btn btn-secondary">üìù Text notes</button>
          <button id="notesTabCanvas" class="btn btn-secondary">‚úçÔ∏è Canvas</button>
        </div>
  
        <div id="notesTextPanel" class="card">
          <div class="card-header">
            <div class="card-title">Text notes</div>
          </div>
  
          <div class="input-grid">
            <div class="input-row">
              <label for="textNoteTitle">Title</label>
              <input id="textNoteTitle" type="text" placeholder="e.g. Ideas, reminders, class notes‚Ä¶" />
            </div>
            <div class="input-row">
              <label for="textNoteBody">Note</label>
              <textarea id="textNoteBody" placeholder="Write your note here‚Ä¶"></textarea>
            </div>
            <div class="input-row" style="align-items: flex-end;">
              <button id="addTextNoteBtn" class="btn">‚ûï Save note</button>
            </div>
          </div>
  
          <div id="noTextNotesMsg" class="empty-msg">
            No notes yet. Write something and save.
          </div>
          <div id="textNotesList" class="list"></div>
        </div>
  
        <div id="notesCanvasPanel" class="card hidden">
          <div class="card-header">
            <div class="card-title">Canvas</div>
          </div>
  
          <div class="input-row-inline" style="margin-bottom: 8px;">
            <button id="clearCanvasBtn" class="btn btn-secondary">üßπ Clear</button>
            <button id="saveCanvasBtn" class="btn">üíæ Save image</button>
          </div>
  
          <div style="border-radius: 12px; overflow: hidden; background: #ffffff; border: 1px solid #26293a;">
            <canvas
              id="notesCanvas"
              width="360"
              height="360"
              style="display:block; touch-action:none; background:#ffffff;"
            ></canvas>
          </div>
  
          <div class="empty-msg" style="margin-top:6px;">
            Draw with your finger or mouse. Use ‚ÄúSave image‚Äù to download a PNG.
          </div>
        </div>
      `;
  
      const notesTabText = document.getElementById("notesTabText");
      const notesTabCanvas = document.getElementById("notesTabCanvas");
      const notesTextPanel = document.getElementById("notesTextPanel");
      const notesCanvasPanel = document.getElementById("notesCanvasPanel");
  
      function activateTextTab() {
        notesTextPanel.classList.remove("hidden");
        notesCanvasPanel.classList.add("hidden");
      }
  
      function activateCanvasTab() {
        notesCanvasPanel.classList.remove("hidden");
        notesTextPanel.classList.add("hidden");
      }
  
      notesTabText.addEventListener("click", activateTextTab);
      notesTabCanvas.addEventListener("click", activateCanvasTab);
  
      const textTitleInput = document.getElementById("textNoteTitle");
      const textBodyInput = document.getElementById("textNoteBody");
      const addTextNoteBtn = document.getElementById("addTextNoteBtn");
      const textNotesList = document.getElementById("textNotesList");
      const noTextNotesMsg = document.getElementById("noTextNotesMsg");
  
      const NOTES_STORAGE_KEY = "myhub_notes_text_v1";
      let textNotes = [];
  
      function loadTextNotes() {
        try {
          const raw = localStorage.getItem(NOTES_STORAGE_KEY);
          textNotes = raw ? JSON.parse(raw) : [];
        } catch (err) {
          console.error("Failed to load notes", err);
          textNotes = [];
        }
      }
  
      function saveTextNotes() {
        try {
          localStorage.setItem(NOTES_STORAGE_KEY, JSON.stringify(textNotes));
        } catch (err) {
          console.error("Failed to save notes", err);
        }
      }
  
      function escapeHtml(str) {
        if (!str) return "";
        return String(str)
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/"/g, "&quot;")
          .replace(/'/g, "&#039;");
      }
  
      function formatNoteDate(ts) {
        if (!ts) return "";
        try {
          const d = new Date(ts);
          return d.toLocaleDateString(undefined, {
            year: "numeric",
            month: "short",
            day: "numeric"
          });
        } catch {
          return "";
        }
      }
  
      function renderTextNotes() {
        textNotesList.innerHTML = "";
        if (!textNotes.length) {
          noTextNotesMsg.classList.remove("hidden");
          return;
        }
        noTextNotesMsg.classList.add("hidden");
  
        const sorted = [...textNotes].sort((a, b) => (b.updatedAt || b.createdAt) - (a.updatedAt || a.createdAt));
  
        for (const note of sorted) {
          const item = document.createElement("div");
          item.className = "item";
          item.dataset.id = note.id;
  
          const title = escapeHtml(note.title || "(no title)");
          const body = escapeHtml(note.body || "");
  
          item.innerHTML = `
            <div class="item-main">
              <div class="item-text">
                <div class="item-title">${title}</div>
                <div class="item-body" style="font-size:12px;color:var(--text-muted);white-space:pre-wrap;max-height:6em;overflow:auto;margin-top:2px;">
                  ${body || "<span style='font-style:italic;'>Empty note</span>"}
                </div>
                <div class="item-meta">
                  <span class="tag">${formatNoteDate(note.updatedAt || note.createdAt)}</span>
                </div>
              </div>
            </div>
            <div class="item-actions">
              <button class="icon-btn" data-action="edit" title="Edit note">‚úèÔ∏è</button>
              <button class="icon-btn danger" data-action="delete" title="Delete note">üóë</button>
            </div>
          `;
  
          textNotesList.appendChild(item);
        }
      }
  
      addTextNoteBtn.addEventListener("click", () => {
        const title = textTitleInput.value.trim();
        const body = textBodyInput.value.trim();
        if (!title && !body) return;
  
        const now = Date.now();
        const newNote = {
          id: now.toString(),
          title,
          body,
          createdAt: now,
          updatedAt: now
        };
  
        textNotes.push(newNote);
        saveTextNotes();
        renderTextNotes();
  
        textTitleInput.value = "";
        textBodyInput.value = "";
      });
  
      textNotesList.addEventListener("click", (e) => {
        const actionBtn = e.target.closest("button[data-action]");
        if (!actionBtn) return;
  
        const action = actionBtn.dataset.action;
        const itemEl = actionBtn.closest(".item");
        if (!itemEl) return;
        const id = itemEl.dataset.id;
        const note = textNotes.find((n) => n.id === id);
        if (!note) return;
  
        if (action === "delete") {
          if (!confirm("Delete this note?")) return;
          textNotes = textNotes.filter((n) => n.id !== id);
          saveTextNotes();
          renderTextNotes();
        } else if (action === "edit") {
          const newTitle = prompt("Edit title:", note.title || "") ?? note.title;
          const newBody = prompt("Edit note text:", note.body || "") ?? note.body;
          note.title = (newTitle || "").trim();
          note.body = (newBody || "").trim();
          note.updatedAt = Date.now();
          saveTextNotes();
          renderTextNotes();
        }
      });
  
      loadTextNotes();
      renderTextNotes();
  
      const canvas = document.getElementById("notesCanvas");
      const ctx = canvas.getContext("2d");
      const clearCanvasBtn = document.getElementById("clearCanvasBtn");
      const saveCanvasBtn = document.getElementById("saveCanvasBtn");
  
      function initCanvasBackground() {
        ctx.fillStyle = "#ffffff";
        ctx.fillRect(0, 0, canvas.width, canvas.height);
      }
      initCanvasBackground();
  
      let drawing = false;
      let lastX = 0;
      let lastY = 0;
  
      function getCanvasPos(evt) {
        const rect = canvas.getBoundingClientRect();
        if (evt.touches && evt.touches.length > 0) {
          const t = evt.touches[0];
          return {
            x: t.clientX - rect.left,
            y: t.clientY - rect.top
          };
        } else {
          return {
            x: evt.clientX - rect.left,
            y: evt.clientY - rect.top
          };
        }
      }
  
      function startDrawing(evt) {
        evt.preventDefault();
        const pos = getCanvasPos(evt);
        drawing = true;
        lastX = pos.x;
        lastY = pos.y;
      }
  
      function draw(evt) {
        if (!drawing) return;
        evt.preventDefault();
        const pos = getCanvasPos(evt);
        ctx.strokeStyle = "#000000";
        ctx.lineWidth = 3;
        ctx.lineCap = "round";
        ctx.beginPath();
        ctx.moveTo(lastX, lastY);
        ctx.lineTo(pos.x, pos.y);
        ctx.stroke();
        lastX = pos.x;
        lastY = pos.y;
      }
  
      function stopDrawing(evt) {
        if (evt) evt.preventDefault();
        drawing = false;
      }
  
      canvas.addEventListener("mousedown", startDrawing);
      canvas.addEventListener("mousemove", draw);
      canvas.addEventListener("mouseup", stopDrawing);
      canvas.addEventListener("mouseleave", stopDrawing);
  
      canvas.addEventListener("touchstart", startDrawing, { passive: false });
      canvas.addEventListener("touchmove", draw, { passive: false });
      canvas.addEventListener("touchend", stopDrawing, { passive: false });
      canvas.addEventListener("touchcancel", stopDrawing, { passive: false });
  
      clearCanvasBtn.addEventListener("click", () => {
        if (!confirm("Clear the canvas?")) return;
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        initCanvasBackground();
      });
  
      saveCanvasBtn.addEventListener("click", () => {
        try {
          const dataUrl = canvas.toDataURL("image/png");
          const a = document.createElement("a");
          const timestamp = new Date().toISOString().slice(0, 19).replace(/[:T]/g, "-");
          a.href = dataUrl;
          a.download = `myhub-note-${timestamp}.png`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
        } catch (err) {
          console.error("Error saving canvas image", err);
          alert("Could not save image in this browser.");
        }
      });
    })();
  
    // ==============================
    // BASIC CALENDAR (NEXT 7 DAYS)
    // ==============================
    (function setupCalendar() {
      const calPage = document.querySelector('.page[data-page="calendar"]');
      if (!calPage) return;
  
      calPage.innerHTML = `
        <h2 class="section-title">Calendar</h2>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Next 7 days</div>
          </div>
          <div class="empty-msg" id="calTodayLabel"></div>
          <div id="calDaysContainer" style="margin-top:10px; display:flex; flex-direction:column; gap:8px;"></div>
        </div>
      `;
  
      const calTodayLabel = document.getElementById("calTodayLabel");
      const calDaysContainer = document.getElementById("calDaysContainer");
  
      function getISODate(d) {
        return d.toISOString().slice(0, 10);
      }
  
      function buildCalendar() {
        const now = new Date();
        if (calTodayLabel) {
          calTodayLabel.textContent = `Today: ${now.toLocaleDateString()}`;
        }
        if (!calDaysContainer) return;
        calDaysContainer.innerHTML = "";
  
        for (let offset = 0; offset < 7; offset++) {
          const d = new Date();
          d.setDate(now.getDate() + offset);
          const iso = getISODate(d);
          const label = d.toLocaleDateString(undefined, {
            weekday: "short",
            day: "numeric",
            month: "short"
          });
  
          const dayCard = document.createElement("div");
          dayCard.className = "card";
  
          const header = document.createElement("div");
          header.className = "card-header";
          header.innerHTML = `<div class="card-title">${label}${offset === 0 ? " (Today)" : ""}</div>`;
          dayCard.appendChild(header);
  
          const list = document.createElement("div");
          list.className = "list";
  
          // To-dos by dueDate
          const dayTodos = todoState.tasks.filter((t) => t.dueDate === iso);
          dayTodos.forEach((t) => {
            const item = document.createElement("div");
            item.className = "item";
            item.innerHTML = `
              <div class="item-main">
                <div class="item-text">
                  <div class="item-title">‚úÖ ${t.title}</div>
                  <div class="item-meta">
                    <span class="tag">${getTodoListNameById(t.listId)}</span>
                    <span class="tag">${t.priority || "medium"}</span>
                    <span class="tag">${t.status || "open"}</span>
                  </div>
                </div>
              </div>
            `;
            list.appendChild(item);
          });
  
          // Finance by date
          const dayTxs = financeState.transactions.filter((tx) => tx.date === iso);
          dayTxs.forEach((tx) => {
            const acc = getAccountById(tx.accountId);
            const currency = acc ? (acc.currency || "") : "";
            const amount = typeof tx.amount === "number" ? tx.amount.toFixed(2) : tx.amount;
            const item = document.createElement("div");
            item.className = "item";
            item.innerHTML = `
              <div class="item-main">
                <div class="item-text">
                  <div class="item-title">üí∞ ${tx.category || "(no category)"} - ${amount} ${currency}</div>
                  <div class="item-meta">
                    <span class="tag">${tx.type === "income" ? "Income" : "Expense"}</span>
                    <span class="tag">${acc ? acc.name : "Unknown account"}</span>
                  </div>
                </div>
              </div>
            `;
            list.appendChild(item);
          });
  
          // Workouts by start date
          const dayWorkouts = workoutState.workouts.filter((w) => {
            if (!w.startTime && !w.createdAt) return false;
            const wd = new Date(w.startTime || w.createdAt);
            return getISODate(wd) === iso;
          });
          dayWorkouts.forEach((w) => {
            const item = document.createElement("div");
            item.className = "item";
            const exCount = Array.isArray(w.exercises) ? w.exercises.length : 0;
            item.innerHTML = `
              <div class="item-main">
                <div class="item-text">
                  <div class="item-title">üèãÔ∏è ${w.name || "(no name)"}</div>
                  <div class="item-meta">
                    <span class="tag">${exCount} exercises</span>
                    <span class="tag">${formatDuration(w.durationMs)}</span>
                  </div>
                </div>
              </div>
            `;
            list.appendChild(item);
          });
  
          if (!dayTodos.length && !dayTxs.length && !dayWorkouts.length) {
            const empty = document.createElement("div");
            empty.className = "empty-msg";
            empty.textContent = "No items yet.";
            list.appendChild(empty);
          }
  
          dayCard.appendChild(list);
          calDaysContainer.appendChild(dayCard);
        }
      }
  
      window.__myhubRebuildCalendar = buildCalendar;
      buildCalendar();
    })();
  });
  </script>
</body>
</html>



