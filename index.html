<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MyHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-elevated: #11131b;
      --bg-elevated-soft: #151826;
      --accent: #4caf50;
      --accent-soft: rgba(76, 175, 80, 0.18);
      --accent-alt: #00bcd4;
      --danger: #f44336;
      --text: #f5f5f5;
      --text-muted: #a0a4b8;
      --border-subtle: #26293a;
      --radius-lg: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #151827 0, #050608 45%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      display: flex;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }

    .sidebar {
      width: 70px;
      background: linear-gradient(180deg, #11131b 0%, #050608 100%);
      border-right: 1px solid var(--border-subtle);
      padding: 16px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      transition: width 0.2s ease;
    }

    .sidebar.expanded {
      width: 210px;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(circle at 20% 0, #00e676, #00bcd4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #020308;
      box-shadow: 0 0 20px rgba(0, 188, 212, 0.6);
    }

    .nav-toggle {
      border: none;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      margin-top: 4px;
      transition: 0.18s ease;
    }

    .nav-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--accent-alt);
    }

    .nav {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      width: 100%;
    }

    .nav-item {
      width: 100%;
      border-radius: 999px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-muted);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: 0.18s ease;
      padding: 8px 0;
      gap: 8px;
    }

    .nav-emoji {
      flex-shrink: 0;
    }

    .nav-label {
      display: none;
      font-size: 13px;
      white-space: nowrap;
    }

    .sidebar.expanded .nav-item {
      justify-content: flex-start;
      padding-inline: 10px;
    }

    .sidebar.expanded .nav-label {
      display: inline;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.03);
      color: var(--accent-alt);
      transform: translateY(-1px);
    }

    .nav-item.nav-active {
      background: var(--accent-soft);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(76, 175, 80, 0.4);
    }

    .version {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
    }

    .main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: var(--radius-lg);
      background: linear-gradient(90deg, #141827, #0b0d14);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    }

    #pageTitle {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.03em;
    }

    .page {
      flex: 1;
      border-radius: var(--radius-lg);
      background: rgba(8, 10, 18, 0.96);
      border: 1px solid var(--border-subtle);
      padding: 16px;
      display: none;
      overflow-y: auto;
    }

    .page.active {
      display: block;
    }

    .hidden {
      display: none !important;
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
    }

    .card {
      border-radius: var(--radius-lg);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #151826;
      border: 1px solid #26293a;
      color: var(--text-muted);
    }

    .chip-highlight {
      background: rgba(0, 188, 212, 0.12);
      color: #e0f7fa;
      border-color: rgba(0, 188, 212, 0.5);
    }

    .input-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-row-inline {
      display: flex;
      gap: 8px;
    }

    .input-row-inline > * {
      flex: 1;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: 0.16s ease;
    }

    textarea {
      border-radius: 10px;
      resize: vertical;
      min-height: 70px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.4);
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      transition: 0.16s ease;
    }

    .btn:hover {
      background: rgba(76, 175, 80, 0.32);
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    .btn-secondary {
      background: rgba(0, 188, 212, 0.12);
      color: #b2ebf2;
    }

    .btn-secondary:hover {
      background: rgba(0, 188, 212, 0.24);
    }

    .btn-icon {
      padding-inline: 10px;
      font-size: 16px;
    }

    .btn-danger {
      background: rgba(244, 67, 54, 0.14);
      color: #ffcdd2;
    }

    .btn-danger:hover {
      background: rgba(244, 67, 54, 0.25);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .empty-msg {
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    .item {
      border-radius: 12px;
      padding: 8px 9px;
      background: var(--bg-elevated-soft);
      border: 1px solid #25283a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .item-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .item-checkbox {
      flex-shrink: 0;
    }

    .item-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .item-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .item-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      cursor: pointer;
    }

    .item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .item-actions {
      display: flex;
      flex-shrink: 0;
      gap: 4px;
    }

    .icon-btn {
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-muted);
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.07);
      color: var(--accent-alt);
    }

    .icon-btn.danger {
      color: #ff8a80;
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #181b2a;
      color: var(--text-muted);
    }

    .tag-income {
      background: rgba(76, 175, 80, 0.16);
      color: #c8e6c9;
    }

    .tag-expense {
      background: rgba(244, 67, 54, 0.16);
      color: #ffcdd2;
    }

    .selected-account {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.6);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .filter-pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #121622;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .filter-pill label {
      font-size: 11px;
    }

    .filter-pill select,
    .filter-pill input {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
    }

    /* Workout rows */
    .workout-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      border-radius: 10px;
      padding: 6px 8px;
      background: #101320;
    }

    .workout-row-top {
      width: 100%;
    }

    .workout-row-bottom {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workout-row-bottom input[type="number"] {
      padding: 6px 7px;
      font-size: 12px;
    }

    .workout-row-bottom .workout-done {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .workout-row-bottom .icon-btn {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
      font-size: 14px;
    }

    @media (min-width: 900px) {
      .sidebar.expanded {
        width: 230px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">H</div>
      <button id="navToggle" class="nav-toggle" title="Expand menu">‚ò∞</button>
      <nav class="nav">
        <button class="nav-item nav-active" data-page="home" title="Home">
          <span class="nav-emoji">üè†</span><span class="nav-label">Home</span>
        </button>
        <button class="nav-item" data-page="todo" title="To-Do">
          <span class="nav-emoji">‚úÖ</span><span class="nav-label">To-Do</span>
        </button>
        <button class="nav-item" data-page="shopping" title="Shopping">
          <span class="nav-emoji">üõí</span><span class="nav-label">Shopping</span>
        </button>
        <button class="nav-item" data-page="workouts" title="Workouts">
          <span class="nav-emoji">üèãÔ∏è</span><span class="nav-label">Workouts</span>
        </button>
        <button class="nav-item" data-page="finance" title="Finances">
          <span class="nav-emoji">üí∞</span><span class="nav-label">Finances</span>
        </button>
        <button class="nav-item" data-page="notes" title="Notes">
          <span class="nav-emoji">üìù</span><span class="nav-label">Notes</span>
        </button>
        <button class="nav-item" data-page="meals" title="Meals">
          <span class="nav-emoji">üçΩÔ∏è</span><span class="nav-label">Meals</span>
        </button>
        <button class="nav-item" data-page="calendar" title="Calendar">
          <span class="nav-emoji">üìÖ</span><span class="nav-label">Calendar</span>
        </button>
        <button class="nav-item" data-page="analytics" title="Analytics">
          <span class="nav-emoji">üìä</span><span class="nav-label">Analytics</span>
        </button>
      </nav>
      <div class="version">v<span id="appVersion">0.7.1</span></div>
    </aside>

    <main class="main">
      <header class="header">
        <h1 id="pageTitle">Home</h1>
      </header>

      <!-- HOME -->
      <section class="page active" data-page="home">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Quick task</div>
          </div>
          <div class="input-grid">
            <div class="input-row">
              <label for="homeQuickTaskInput">Task</label>
              <input id="homeQuickTaskInput" type="text" placeholder="e.g. Buy vegetables, send email‚Ä¶" />
            </div>
          </div>
          <button id="homeQuickTaskBtn" class="btn">
            ‚ûï Add quick task
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Overview</div>
          </div>
          <div class="chip-row">
            <span class="chip">‚úÖ To-do</span>
            <span class="chip">üõí Shopping</span>
            <span class="chip">üèãÔ∏è Workouts</span>
            <span class="chip">üí∞ Finance</span>
            <span class="chip chip-highlight">More coming soon‚Ä¶</span>
          </div>
        </div>
      </section>

      <!-- TO-DO -->
      <section class="page hidden" data-page="todo">
        <h2 class="section-title">To-do lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- List selection + new list -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoListSelect">List</label>
                <select id="todoListSelect"></select>
              </div>
              <div class="input-row">
                <label for="todoListName">New list</label>
                <input id="todoListName" type="text" placeholder="e.g. Work, Personal‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="todoNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Task title -->
            <div class="input-row">
              <label for="todoTitleInput">Task</label>
              <input id="todoTitleInput" type="text" placeholder="What do you need to do?" />
            </div>

            <!-- Priority + due date -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoPrioritySelect">Priority</label>
                <select id="todoPrioritySelect">
                  <option value="high">High</option>
                  <option value="medium" selected>Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="input-row">
                <label for="todoDueDate">Due date</label>
                <input id="todoDueDate" type="date" />
              </div>
            </div>

            <!-- Add button row -->
            <div class="input-row" style="align-items: flex-end;">
              <button id="addTodoBtn" class="btn">‚ûï Add task</button>
            </div>
          </div>

          <div class="pill-row">
            <div class="filter-pill">
              <label for="todoSearchInput">Search</label>
              <input id="todoSearchInput" type="text" placeholder="Text‚Ä¶" />
            </div>
            <div class="filter-pill">
              <label for="todoFilterPriority">Priority</label>
              <select id="todoFilterPriority">
                <option value="all">All</option>
                <option value="high">High</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div class="filter-pill">
              <label for="todoFilterStatus">Status</label>
              <select id="todoFilterStatus">
                <option value="all">All</option>
                <option value="open">Open</option>
                <option value="inprogress">In progress</option>
                <option value="done">Done</option>
              </select>
            </div>
            <div class="filter-pill">
              <label for="todoFilterList">List</label>
              <select id="todoFilterList">
                <option value="all">All</option>
              </select>
            </div>
          </div>

          <div id="noTodosMsg" class="empty-msg">
            No tasks yet. Add your first one above.
          </div>
          <div id="todoList" class="list"></div>
        </div>
      </section>

      <!-- SHOPPING -->
      <section class="page hidden" data-page="shopping">
        <h2 class="section-title">Shopping lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- List selection + new list -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="shoppingListSelect">List</label>
                <select id="shoppingListSelect"></select>
              </div>
              <div class="input-row">
                <label for="shoppingListName">New list</label>
                <input id="shoppingListName" type="text" placeholder="e.g. Weekly, Work‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="shoppingNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Item -->
            <div class="input-row">
              <label for="shoppingItemInput">Item</label>
              <input id="shoppingItemInput" type="text" placeholder="e.g. Chicken, yogurt, vegetables‚Ä¶" />
            </div>

            <!-- Add button -->
            <div class="input-row" style="align-items: flex-end;">
              <button id="addShoppingBtn" class="btn">‚ûï Add item</button>
            </div>
          </div>

          <div id="shoppingEmptyMsg" class="empty-msg">
            No items yet. Add something above.
          </div>
          <div id="shoppingList" class="list"></div>
        </div>
      </section>

      <!-- WORKOUTS -->
      <section class="page hidden" data-page="workouts">
        <h2 class="section-title">Workouts</h2>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Current workout</div>
          </div>

          <div class="input-grid">
            <div class="input-row">
              <label for="workoutName">Workout name</label>
              <input id="workoutName" type="text" placeholder="e.g. Push day, Legs B‚Ä¶" />
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label>Start</label>
                <div id="workoutStartLabel" class="empty-msg">Not started</div>
              </div>
              <div class="input-row">
                <label>Duration</label>
                <div id="workoutDurationLabel" class="empty-msg">‚Äì</div>
              </div>
            </div>

            <div class="input-row">
              <label for="workoutNotes">Notes</label>
              <textarea id="workoutNotes" placeholder="Extra notes for this workout‚Ä¶"></textarea>
            </div>
          </div>

          <div class="input-row-inline" style="margin-bottom: 8px;">
            <button id="startWorkoutBtn" class="btn btn-secondary">‚ñ∂ Start workout</button>
            <button id="saveWorkoutBtn" class="btn">üíæ Finish & save</button>
            <button id="addExerciseRowBtn" class="btn btn-secondary">‚ûï Add exercise row</button>
          </div>

          <div id="workoutExercises" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Logged workouts</div>
          </div>
          <div id="noWorkoutMsg" class="empty-msg">
            No workouts logged yet.
          </div>
          <div id="workoutList" class="list"></div>
        </div>
      </section>

      <!-- FINANCE -->
      <section class="page hidden" data-page="finance">
        <h2 class="section-title">Finances</h2>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Accounts</div>
            <button id="addAccountBtn" class="btn btn-secondary btn-icon">
              ‚ûï
            </button>
          </div>
          <div id="noAccountsMsg" class="empty-msg">
            No accounts yet. Add one above (e.g. THB main, BRL savings, USD).
          </div>
          <div id="accountsList" class="list"></div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">New transaction</div>
          </div>

          <div class="input-grid">
            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAccount">Account</label>
                <select id="financeAccount"></select>
              </div>
              <div class="input-row">
                <label for="financeType">Type</label>
                <select id="financeType">
                  <option value="expense" selected>Expense</option>
                  <option value="income">Income</option>
                </select>
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAmount">Amount</label>
                <input id="financeAmount" type="number" step="0.01" min="0" placeholder="0.00" />
              </div>
              <div class="input-row">
                <label for="financeDate">Date</label>
                <input id="financeDate" type="date" />
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeCategory">Category</label>
                <input id="financeCategory" type="text" placeholder="e.g. Food, Transport‚Ä¶" />
              </div>
              <div class="input-row">
                <label for="financeMethod">Method</label>
                <input id="financeMethod" type="text" placeholder="Cash, card, scan‚Ä¶" />
              </div>
            </div>

            <div class="input-row">
              <label for="financeNote">Note</label>
              <input id="financeNote" type="text" placeholder="Optional note‚Ä¶" />
            </div>

            <div class="input-row" style="align-items: flex-end;">
              <button id="addFinanceBtn" class="btn">
                ‚ûï Add transaction
              </button>
            </div>
          </div>

          <div class="pill-row">
            <div class="filter-pill">
              <label for="financeFilterCategory">Category filter</label>
              <select id="financeFilterCategory">
                <option value="all">All</option>
                <option value="Food">Food</option>
                <option value="Transport">Transport</option>
                <option value="Rent">Rent</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div id="financeSummary" class="empty-msg"></div>

          <div id="noFinanceMsg" class="empty-msg">
            No transactions yet.
          </div>
          <div id="financeList" class="list"></div>
        </div>
      </section>

      <!-- NOTES (placeholder) -->
      <section class="page hidden" data-page="notes">
        <h2 class="section-title">Notes</h2>
      </section>

      <!-- MEALS (placeholder) -->
      <section class="page hidden" data-page="meals">
        <h2 class="section-title">Meals</h2>
      </section>

      <!-- CALENDAR (placeholder) -->
      <section class="page hidden" data-page="calendar">
        <h2 class="section-title">Calendar</h2>
      </section>

      <!-- ANALYTICS (placeholder) -->
      <section class="page hidden" data-page="analytics">
        <h2 class="section-title">Analytics</h2>
      </section>
    </main>
  </div>
  <script>
    // MyHub v0.7.1 ‚Äì single-file front-end logic

    const $ = (id) => document.getElementById(id);
    const $$ = (sel) => Array.from(document.querySelectorAll(sel));
    const STORAGE_KEY = "myhub-state-v07-1";

    function formatDate(iso) {
      if (!iso) return "No date";
      const d = new Date(iso);
      if (Number.isNaN(d.getTime())) return "No date";
      return d.toLocaleDateString();
    }

    function confirmDelete() {
      return confirm("Delete this item? This action cannot be undone.");
    }

    function calcDurationMinutes(startIso, endIso) {
      if (!startIso || !endIso) return null;
      const s = new Date(startIso);
      const e = new Date(endIso);
      if (Number.isNaN(s.getTime()) || Number.isNaN(e.getTime())) return null;
      const ms = e.getTime() - s.getTime();
      if (ms <= 0) return null;
      return Math.round(ms / 60000);
    }

    // ---------- State ----------
    const defaultState = {
      theme: "dark",
      currentPage: "home",
      // To-do
      todoLists: [
        { id: "list-personal", name: "Personal", createdAt: new Date().toISOString() }
      ],
      todos: [],
      // Shopping
      shoppingLists: [
        { id: "shop-main", name: "Main list", createdAt: new Date().toISOString() }
      ],
      shoppingItems: [],
      // Workouts
      workouts: [],
      // Finance
      accounts: [],
      finance: [],
      activeFinanceAccountId: null
    };

    let state;

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) {
          state = structuredClone(defaultState);
          return;
        }
        const parsed = JSON.parse(raw);
        state = Object.assign(structuredClone(defaultState), parsed);
      } catch (e) {
        console.error("Error loading state", e);
        state = structuredClone(defaultState);
      }
    }

    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }

    // ---------- Navigation ----------
    function setPage(page) {
      state.currentPage = page;
      saveState();

      $$(".page").forEach((el) => {
        if (el.dataset.page === page) {
          el.classList.add("active");
          el.classList.remove("hidden");
        } else {
          el.classList.remove("active");
          el.classList.add("hidden");
        }
      });

      $$(".nav-item").forEach((el) => {
        if (el.dataset.page === page) {
          el.classList.add("nav-active");
        } else {
          el.classList.remove("nav-active");
        }
      });

      const headerTitle = $("pageTitle");
      if (headerTitle) {
        const mapping = {
          home: "Home",
          todo: "To-Do",
          shopping: "Shopping",
          workouts: "Workouts",
          finance: "Finances",
          notes: "Notes",
          meals: "Meals",
          calendar: "Calendar",
          analytics: "Analytics"
        };
        headerTitle.textContent = mapping[page] || "MyHub";
      }
    }

    function setupNav() {
      const sidebar = document.querySelector(".sidebar");
      const navToggle = $("navToggle");

      navToggle?.addEventListener("click", () => {
        sidebar.classList.toggle("expanded");
      });

      $$(".nav-item").forEach((btn) => {
        btn.addEventListener("click", () => {
          const page = btn.dataset.page;
          if (page) setPage(page);
        });
      });

      const homeQuick = $("homeQuickTaskBtn");
      if (homeQuick) {
        homeQuick.addEventListener("click", () => {
          const input = $("homeQuickTaskInput");
          if (!input) return;
          const text = input.value.trim();
          if (!text) return;
          addTodoFromHome(text);
          input.value = "";
        });
      }

      $("homeQuickTaskInput")?.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
          e.preventDefault();
          const text = e.target.value.trim();
          if (!text) return;
          addTodoFromHome(text);
          e.target.value = "";
        }
      });
    }

    // ---------- To-do ----------
    const todoListSelect = $("todoListSelect");
    const todoListNameInput = $("todoListName");
    const todoNewListBtn = $("todoNewListBtn");
    const todoTitleInput = $("todoTitleInput");
    const todoPrioritySelect = $("todoPrioritySelect");
    const todoDueDateInput = $("todoDueDate");
    const todoListContainer = $("todoList");
    const todoEmptyMsg = $("noTodosMsg");
    const todoSearchInput = $("todoSearchInput");
    const todoFilterPriority = $("todoFilterPriority");
    const todoFilterStatus = $("todoFilterStatus");
    const todoFilterList = $("todoFilterList");

    function getActiveTodoListId() {
      return todoListSelect?.value || (state.todoLists[0] && state.todoLists[0].id);
    }

    function renderTodoListOptions() {
      const selects = [todoListSelect, todoFilterList].filter(Boolean);
      selects.forEach((sel) => {
        sel.innerHTML = "";
        state.todoLists.forEach((list) => {
          const opt = document.createElement("option");
          opt.value = list.id;
          opt.textContent = list.name;
          sel.appendChild(opt);
        });

        if (sel === todoFilterList) {
          const allOpt = document.createElement("option");
          allOpt.value = "all";
          allOpt.textContent = "All";
          sel.insertBefore(allOpt, sel.firstChild);
        }
      });

      if (!state.todoLists.length) return;
      if (todoListSelect && !todoListSelect.value) {
        todoListSelect.value = state.todoLists[0].id;
      }
    }

    function addTodoList() {
      const name = todoListNameInput.value.trim();
      if (!name) return;
      const id = "list-" + Date.now();
      state.todoLists.push({ id, name, createdAt: new Date().toISOString() });
      saveState();
      todoListNameInput.value = "";
      renderTodoListOptions();
      if (todoListSelect) todoListSelect.value = id;
      renderTodos();
    }

    todoNewListBtn?.addEventListener("click", addTodoList);

    function addTodo() {
      const title = todoTitleInput.value.trim();
      if (!title) return;
      const listId = getActiveTodoListId();
      const priority = todoPrioritySelect.value || "medium";
      let dueIso = null;
      if (todoDueDateInput.value) {
        dueIso = new Date(todoDueDateInput.value + "T00:00:00").toISOString();
      }
      const todo = {
        id: "todo-" + Date.now(),
        listId,
        title,
        priority,
        dueDate: dueIso,
        status: "open",
        createdAt: new Date().toISOString(),
        completedAt: null
      };
      state.todos.unshift(todo);
      saveState();
      todoTitleInput.value = "";
      renderTodos();
    }

    todoTitleInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addTodo();
      }
    });
    $("addTodoBtn")?.addEventListener("click", addTodo);

    function updateTodoStatus(id, newStatus) {
      const t = state.todos.find((x) => x.id === id);
      if (!t) return;
      t.status = newStatus;
      t.completedAt = newStatus === "done" ? new Date().toISOString() : null;
      saveState();
      renderTodos();
    }

    function openEditTodo(todo) {
      const newTitle = prompt("Edit task title:", todo.title);
      if (newTitle === null) return;
      const trimmed = newTitle.trim();
      if (trimmed) todo.title = trimmed;

      const newDate = prompt(
        "Edit due date (YYYY-MM-DD) or leave blank:",
        todo.dueDate ? todo.dueDate.slice(0, 10) : ""
      );
      if (newDate !== null) {
        if (newDate.trim()) {
          todo.dueDate = new Date(newDate.trim() + "T00:00:00").toISOString();
        } else {
          todo.dueDate = null;
        }
      }

      const newPriority = prompt(
        "Priority (high / medium / low):",
        todo.priority
      );
      if (newPriority !== null) {
        const p = newPriority.trim().toLowerCase();
        if (["high", "medium", "low"].includes(p)) {
          todo.priority = p;
        }
      }

      saveState();
      renderTodos();
    }

    function deleteTodo(id) {
      if (!confirmDelete()) return;
      state.todos = state.todos.filter((t) => t.id !== id);
      saveState();
      renderTodos();
    }

    function applyTodoFilters(arr) {
      let result = [...arr];

      const q = (todoSearchInput?.value || "").trim().toLowerCase();
      if (q) {
        result = result.filter((t) => t.title.toLowerCase().includes(q));
      }

      const prio = todoFilterPriority?.value || "all";
      if (prio !== "all") {
        result = result.filter((t) => t.priority === prio);
      }

      const stat = todoFilterStatus?.value || "all";
      if (stat !== "all") {
        result = result.filter((t) => t.status === stat);
      }

      const listId = todoFilterList?.value || "all";
      if (listId !== "all") {
        result = result.filter((t) => t.listId === listId);
      }

      result.sort((a, b) => {
        const prioOrder = { high: 0, medium: 1, low: 2 };
        const pa = prioOrder[a.priority] ?? 1;
        const pb = prioOrder[b.priority] ?? 1;
        if (pa !== pb) return pa - pb;

        const da = a.dueDate ? new Date(a.dueDate).getTime() : Infinity;
        const db = b.dueDate ? new Date(b.dueDate).getTime() : Infinity;
        if (da !== db) return da - db;

        const statusOrder = { open: 0, inprogress: 1, done: 2 };
        return (statusOrder[a.status] ?? 0) - (statusOrder[b.status] ?? 0);
      });

      return result;
    }

    function renderTodos() {
      if (!todoListContainer) return;
      const all = state.todos;
      const filtered = applyTodoFilters(all);

      if (!filtered.length) {
        todoListContainer.innerHTML = "";
        if (todoEmptyMsg) todoEmptyMsg.style.display = "block";
        return;
      }
      if (todoEmptyMsg) todoEmptyMsg.style.display = "none";

      todoListContainer.innerHTML = "";
      filtered.forEach((t) => {
        const row = document.createElement("div");
        row.className = "item";

        const main = document.createElement("div");
        main.className = "item-main";

        const left = document.createElement("div");
        left.className = "item-checkbox";

        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = t.status === "done";
        cb.addEventListener("change", () => {
          updateTodoStatus(t.id, cb.checked ? "done" : "open");
        });
        left.appendChild(cb);

        const textWrap = document.createElement("div");
        textWrap.className = "item-text";

        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = t.title;
        if (t.status === "done") {
          title.style.textDecoration = "line-through";
          title.style.opacity = "0.7";
        }
        title.addEventListener("click", () => openEditTodo(t));

        const meta = document.createElement("div");
        meta.className = "item-meta";

        const prioTag = document.createElement("span");
        prioTag.className = "tag";
        prioTag.textContent =
          t.priority === "high"
            ? "High"
            : t.priority === "low"
            ? "Low"
            : "Medium";
        meta.appendChild(prioTag);

        if (t.dueDate) {
          const due = document.createElement("span");
          due.className = "tag";
          due.textContent = "Due " + formatDate(t.dueDate);
          meta.appendChild(due);
        }

        const listRef = state.todoLists.find((l) => l.id === t.listId);
        if (listRef) {
          const listTag = document.createElement("span");
          listTag.className = "tag";
          listTag.textContent = listRef.name;
          meta.appendChild(listTag);
        }

        if (t.status === "inprogress") {
          const st = document.createElement("span");
          st.className = "tag";
          st.textContent = "In progress";
          meta.appendChild(st);
        }

        textWrap.appendChild(title);
        textWrap.appendChild(meta);

        main.appendChild(left);
        main.appendChild(textWrap);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const inProgBtn = document.createElement("button");
        inProgBtn.className = "icon-btn";
        inProgBtn.textContent = "‚è≥";
        inProgBtn.title = "Mark in progress";
        inProgBtn.addEventListener("click", () =>
          updateTodoStatus(t.id, "inprogress")
        );

        const editBtn = document.createElement("button");
        editBtn.className = "icon-btn";
        editBtn.textContent = "‚úèÔ∏è";
        editBtn.title = "Edit";
        editBtn.addEventListener("click", () => openEditTodo(t));

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete";
        delBtn.addEventListener("click", () => deleteTodo(t.id));

        actions.appendChild(inProgBtn);
        actions.appendChild(editBtn);
        actions.appendChild(delBtn);

        row.appendChild(main);
        row.appendChild(actions);

        todoListContainer.appendChild(row);
      });
    }

    todoListSelect?.addEventListener("change", renderTodos);
    todoSearchInput?.addEventListener("input", renderTodos);
    todoFilterPriority?.addEventListener("change", renderTodos);
    todoFilterStatus?.addEventListener("change", renderTodos);
    todoFilterList?.addEventListener("change", renderTodos);

    function addTodoFromHome(text) {
      const listId = state.todoLists[0]?.id;
      if (!listId) return;
      const todo = {
        id: "todo-" + Date.now(),
        listId,
        title: text,
        priority: "medium",
        dueDate: null,
        status: "open",
        createdAt: new Date().toISOString(),
        completedAt: null
      };
      state.todos.unshift(todo);
      saveState();
      renderTodos();
    }

    // ---------- Shopping ----------
    const shoppingListSelect = $("shoppingListSelect");
    const shoppingListNameInput = $("shoppingListName");
    const shoppingNewListBtn = $("shoppingNewListBtn");
    const shoppingItemInput = $("shoppingItemInput");
    const shoppingListEl = $("shoppingList");
    const shoppingEmptyMsg = $("shoppingEmptyMsg");
    let draggingShoppingId = null;

    function getActiveShoppingListId() {
      return shoppingListSelect?.value || (state.shoppingLists[0] && state.shoppingLists[0].id);
    }

    function renderShoppingListOptions() {
      if (!shoppingListSelect) return;
      shoppingListSelect.innerHTML = "";
      state.shoppingLists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        shoppingListSelect.appendChild(opt);
      });
      if (!state.shoppingLists.length) return;
      if (!shoppingListSelect.value) {
        shoppingListSelect.value = state.shoppingLists[0].id;
      }
    }

    function addShoppingList() {
      const name = shoppingListNameInput.value.trim();
      if (!name) return;
      const id = "shop-" + Date.now();
      state.shoppingLists.push({ id, name, createdAt: new Date().toISOString() });
      saveState();
      shoppingListNameInput.value = "";
      renderShoppingListOptions();
      if (shoppingListSelect) shoppingListSelect.value = id;
      renderShopping();
    }

    shoppingNewListBtn?.addEventListener("click", addShoppingList);

    function addShoppingItem() {
      const title = shoppingItemInput.value.trim();
      if (!title) return;
      const listId = getActiveShoppingListId();
      const item = {
        id: "shop-item-" + Date.now(),
        listId,
        title,
        checked: false,
        note: "",
        createdAt: new Date().toISOString()
      };
      state.shoppingItems.push(item);
      saveState();
      shoppingItemInput.value = "";
      renderShopping();
    }

    shoppingItemInput?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addShoppingItem();
      }
    });
    $("addShoppingBtn")?.addEventListener("click", addShoppingItem);

    function deleteShoppingItem(listId, itemId) {
      if (!confirmDelete()) return;
      state.shoppingItems = state.shoppingItems.filter(
        (i) => i.id !== itemId
      );
      saveState();
      renderShopping();
    }

    function toggleShoppingItem(id) {
      const item = state.shoppingItems.find((i) => i.id === id);
      if (!item) return;
      item.checked = !item.checked;
      saveState();
      renderShopping();
    }

    function openModalShoppingNote(item) {
      const newNote = prompt("Note for this item:", item.note || "");
      if (newNote === null) return;
      item.note = newNote.trim();
      saveState();
      renderShopping();
    }

    function reorderShopping(listId, fromId, toId) {
      if (!fromId || !toId || fromId === toId) return;
      const arr = state.shoppingItems;
      const fromIdx = arr.findIndex(
        (i) => i.id === fromId && i.listId === listId
      );
      const toIdx = arr.findIndex(
        (i) => i.id === toId && i.listId === listId
      );
      if (fromIdx === -1 || toIdx === -1) return;
      const [moved] = arr.splice(fromIdx, 1);
      arr.splice(toIdx, 0, moved);
      saveState();
      renderShopping();
    }

    function renderShopping() {
      if (!shoppingListEl) return;
      const listId = getActiveShoppingListId();
      const items = state.shoppingItems.filter((i) => i.listId === listId);

      if (!items.length) {
        shoppingListEl.innerHTML = "";
        if (shoppingEmptyMsg) shoppingEmptyMsg.style.display = "block";
        return;
      }
      if (shoppingEmptyMsg) shoppingEmptyMsg.style.display = "none";

      shoppingListEl.innerHTML = "";
      items.forEach((item) => {
        const row = document.createElement("div");
        row.className = "item";
        row.dataset.itemId = item.id;
        row.draggable = true;

        row.addEventListener("dragstart", () => {
          draggingShoppingId = item.id;
        });
        row.addEventListener("dragover", (e) => {
          e.preventDefault();
        });
        row.addEventListener("drop", (e) => {
          e.preventDefault();
          const targetId = row.dataset.itemId;
          reorderShopping(listId, draggingShoppingId, targetId);
          draggingShoppingId = null;
        });

        const main = document.createElement("div");
        main.className = "item-main";

        const left = document.createElement("div");
        left.className = "item-checkbox";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = item.checked;
        cb.addEventListener("change", () => toggleShoppingItem(item.id));
        left.appendChild(cb);

        const textWrap = document.createElement("div");
        textWrap.className = "item-text";

        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = item.title;
        if (item.checked) {
          title.style.textDecoration = "line-through";
          title.style.opacity = "0.7";
        }

        const meta = document.createElement("div");
        meta.className = "item-meta";
        if (item.note) {
          const noteTag = document.createElement("span");
          noteTag.className = "tag";
          noteTag.textContent = "Note";
          meta.appendChild(noteTag);
        }

        textWrap.appendChild(title);
        textWrap.appendChild(meta);

        main.appendChild(left);
        main.appendChild(textWrap);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const noteBtn = document.createElement("button");
        noteBtn.className = "icon-btn";
        noteBtn.textContent = "üìù";
        noteBtn.title = "Add / edit note";
        noteBtn.addEventListener("click", () =>
          openModalShoppingNote(item)
        );

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete item";
        delBtn.addEventListener("click", () =>
          deleteShoppingItem(listId, item.id)
        );

        actions.appendChild(noteBtn);
        actions.appendChild(delBtn);

        row.appendChild(main);
        row.appendChild(actions);

        shoppingListEl.appendChild(row);
      });
    }

    shoppingListSelect?.addEventListener("change", renderShopping);

    // ---------- Workouts ----------
    const workoutListEl = $("workoutList");
    const noWorkoutMsg = $("noWorkoutMsg");
    const workoutNameInput = $("workoutName");
    const workoutNotesInput = $("workoutNotes");
    const workoutExercisesEl = $("workoutExercises");
    const workoutStartLabel = $("workoutStartLabel");
    const workoutDurationLabel = $("workoutDurationLabel");
    const startWorkoutBtn = $("startWorkoutBtn");
    const saveWorkoutBtn = $("saveWorkoutBtn");
    const addExerciseRowBtn = $("addExerciseRowBtn");

    let currentWorkoutStartTime = null;

    function createExerciseRow(data) {
      if (!workoutExercisesEl) return;
      const row = document.createElement("div");
      row.className = "workout-row";
      row.dataset.note = "";

      const top = document.createElement("div");
      top.className = "workout-row-top";

      const bottom = document.createElement("div");
      bottom.className = "workout-row-bottom";

      const nameInput = document.createElement("input");
      nameInput.type = "text";
      nameInput.placeholder = "Exercise";
      nameInput.className = "ex-name";

      const setsInput = document.createElement("input");
      setsInput.type = "number";
      setsInput.placeholder = "Sets";
      setsInput.min = "0";
      setsInput.className = "ex-sets";

      const repsInput = document.createElement("input");
      repsInput.type = "number";
      repsInput.placeholder = "Reps";
      repsInput.min = "0";
      repsInput.className = "ex-reps";

      const weightInput = document.createElement("input");
      weightInput.type = "number";
      weightInput.placeholder = "Weight";
      weightInput.min = "0";
      weightInput.className = "ex-weight";

      const doneCb = document.createElement("input");
      doneCb.type = "checkbox";
      doneCb.className = "workout-done";

      const noteBtn = document.createElement("button");
      noteBtn.className = "icon-btn";
      noteBtn.textContent = "üìù";
      noteBtn.title = "Add note";

      noteBtn.addEventListener("click", () => {
        const currentNote = row.dataset.note || "";
        const newNote = prompt("Note for this exercise:", currentNote);
        if (newNote === null) return;
        row.dataset.note = newNote.trim();
        noteBtn.textContent = newNote.trim() ? "üìù*" : "üìù";
      });

      if (data) {
        if (data.name) nameInput.value = data.name;
        if (data.sets != null) setsInput.value = data.sets;
        if (data.reps != null) repsInput.value = data.reps;
        if (data.weight != null) weightInput.value = data.weight;
        if (data.done) doneCb.checked = true;
        if (data.note) {
          row.dataset.note = data.note;
          noteBtn.textContent = "üìù*";
        }
      }

      top.appendChild(nameInput);

      bottom.appendChild(setsInput);
      bottom.appendChild(repsInput);
      bottom.appendChild(weightInput);
      bottom.appendChild(doneCb);
      bottom.appendChild(noteBtn);

      row.appendChild(top);
      row.appendChild(bottom);

      workoutExercisesEl.appendChild(row);
    }

    function resetCurrentWorkoutUI() {
      if (workoutNameInput) workoutNameInput.value = "";
      if (workoutNotesInput) workoutNotesInput.value = "";
      if (workoutExercisesEl) workoutExercisesEl.innerHTML = "";
      currentWorkoutStartTime = null;
      if (workoutStartLabel) workoutStartLabel.textContent = "Not started";
      if (workoutDurationLabel) workoutDurationLabel.textContent = "‚Äì";

      // default 8 rows
      for (let i = 0; i < 8; i++) {
        createExerciseRow();
      }
    }

    startWorkoutBtn?.addEventListener("click", () => {
      const now = new Date();
      currentWorkoutStartTime = now.toISOString();
      if (workoutStartLabel) {
        workoutStartLabel.textContent = now.toLocaleTimeString([], {
          hour: "2-digit",
          minute: "2-digit"
        });
      }
      if (workoutDurationLabel) workoutDurationLabel.textContent = "Running‚Ä¶";
    });

    function saveCurrentWorkout() {
      const name = workoutNameInput?.value.trim();
      if (!name) {
        alert("Please enter the workout name.");
        return;
      }
      const notes = workoutNotesInput?.value.trim() || "";

      const rows = Array.from(
        workoutExercisesEl?.querySelectorAll(".workout-row") || []
      );
      const exercises = [];
      rows.forEach((row) => {
        const n = row.querySelector(".ex-name")?.value.trim() || "";
        const setsVal = row.querySelector(".ex-sets")?.value;
        const repsVal = row.querySelector(".ex-reps")?.value;
        const weightVal = row.querySelector(".ex-weight")?.value;
        const done = row.querySelector(".workout-done")?.checked || false;
        const note = row.dataset.note || "";

        if (!n && !setsVal && !repsVal && !weightVal && !note) return;

        exercises.push({
          name: n,
          sets: setsVal ? parseInt(setsVal, 10) : null,
          reps: repsVal ? parseInt(repsVal, 10) : null,
          weight: weightVal ? parseFloat(weightVal) : null,
          done,
          note
        });
      });

      const nowIso = new Date().toISOString();
      const start = currentWorkoutStartTime || nowIso;
      const end = nowIso;

      const workout = {
        id: "w-" + Date.now(),
        name,
        notes,
        date: new Date().toISOString(),
        startTime: start,
        endTime: end,
        exercises
      };

      state.workouts.unshift(workout);
      saveState();
      renderWorkouts();
      resetCurrentWorkoutUI();
    }

    saveWorkoutBtn?.addEventListener("click", saveCurrentWorkout);
    addExerciseRowBtn?.addEventListener("click", () => createExerciseRow());

    function deleteWorkout(id) {
      if (!confirmDelete()) return;
      state.workouts = state.workouts.filter((w) => w.id !== id);
      saveState();
      renderWorkouts();
    }

    function renderWorkouts() {
      if (!workoutListEl) return;
      if (!state.workouts.length) {
        workoutListEl.innerHTML = "";
        if (noWorkoutMsg) noWorkoutMsg.style.display = "block";
        return;
      }
      if (noWorkoutMsg) noWorkoutMsg.style.display = "none";

      workoutListEl.innerHTML = "";
      state.workouts.forEach((w) => {
        const item = document.createElement("div");
        item.className = "item";

        const main = document.createElement("div");
        main.className = "item-main";

        const textWrap = document.createElement("div");
        textWrap.className = "item-text";

        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = w.name;

        const meta = document.createElement("div");
        meta.className = "item-meta";

        const d = document.createElement("span");
        d.className = "tag";
        d.textContent = formatDate(w.date);
        meta.appendChild(d);

        const durationMin = calcDurationMinutes(w.startTime, w.endTime);
        if (durationMin != null) {
          const durTag = document.createElement("span");
          durTag.className = "tag";
          durTag.textContent = `Duration: ${durationMin} min`;
          meta.appendChild(durTag);
        }

        const exCount = w.exercises ? w.exercises.length : 0;
        if (exCount > 0) {
          const exTag = document.createElement("span");
          exTag.className = "tag";
          exTag.textContent = `Exercises: ${exCount}`;
          meta.appendChild(exTag);
        }

        if (w.notes) {
          const n = document.createElement("span");
          n.className = "tag";
          n.textContent = "Notes";
          meta.appendChild(n);
        }

        textWrap.appendChild(title);
        textWrap.appendChild(meta);
        main.appendChild(textWrap);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete workout";
        delBtn.addEventListener("click", () => deleteWorkout(w.id));

        actions.appendChild(delBtn);

        item.appendChild(main);
        item.appendChild(actions);
        workoutListEl.appendChild(item);
      });
    }

    // ---------- Finance ----------
    const accountsListEl = $("accountsList");
    const noAccountsMsg = $("noAccountsMsg");
    const financeListEl = $("financeList");
    const noFinanceMsg = $("noFinanceMsg");
    const financeAccountSelect = $("financeAccount");
    const financeSummaryEl = $("financeSummary");
    const financeFilterCategory = $("financeFilterCategory");

    function renderAccounts() {
      if (!accountsListEl || !financeAccountSelect) return;

      const accounts = state.accounts;
      accountsListEl.innerHTML = "";
      financeAccountSelect.innerHTML = "";

      if (!accounts.length) {
        if (noAccountsMsg) noAccountsMsg.style.display = "block";
        state.activeFinanceAccountId = null;
      } else {
        if (noAccountsMsg) noAccountsMsg.style.display = "none";
        if (!state.activeFinanceAccountId) {
          state.activeFinanceAccountId = accounts[0].id;
        }
      }

      accounts.forEach((acc) => {
        const balance = state.finance
          .filter((tx) => tx.accountId === acc.id)
          .reduce((sum, tx) => {
            return sum + (tx.type === "income" ? tx.amount : -tx.amount);
          }, 0);

        const row = document.createElement("div");
        row.className = "item";
        if (state.activeFinanceAccountId === acc.id) {
          row.classList.add("selected-account");
        }

        const main = document.createElement("div");
        main.className = "item-main";

        const textWrap = document.createElement("div");
        textWrap.className = "item-text";

        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = acc.name;

        const meta = document.createElement("div");
        meta.className = "item-meta";

        const balTag = document.createElement("span");
        balTag.className = "tag";
        balTag.textContent = `Balance: ${balance.toFixed(2)}`;
        meta.appendChild(balTag);

        textWrap.appendChild(title);
        textWrap.appendChild(meta);
        main.appendChild(textWrap);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete account";
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          deleteAccount(acc.id);
        });

        actions.appendChild(delBtn);

        row.appendChild(main);
        row.appendChild(actions);

        row.addEventListener("click", () => {
          state.activeFinanceAccountId = acc.id;
          saveState();
          renderAccounts();
          renderFinance();
        });

        accountsListEl.appendChild(row);

        const opt = document.createElement("option");
        opt.value = acc.id;
        opt.textContent = acc.name;
        financeAccountSelect.appendChild(opt);
      });

      if (accounts.length) {
        financeAccountSelect.value =
          state.activeFinanceAccountId || accounts[0].id;
      }
    }

    function addAccount() {
      const name = prompt("Account name (e.g. THB main, BRL savings):");
      if (!name) return;
      const acc = {
        id: "acc-" + Date.now(),
        name: name.trim()
      };
      state.accounts.push(acc);
      saveState();
      renderAccounts();
    }

    $("addAccountBtn")?.addEventListener("click", addAccount);

    function deleteAccount(id) {
      const used = state.finance.some((tx) => tx.accountId === id);
      if (used) {
        alert("This account has transactions and can't be deleted yet.");
        return;
      }
      if (!confirmDelete()) return;
      state.accounts = state.accounts.filter((a) => a.id !== id);
      if (state.activeFinanceAccountId === id) {
        state.activeFinanceAccountId =
          state.accounts[0]?.id || null;
      }
      saveState();
      renderAccounts();
      renderFinance();
    }

    function addFinance() {
      const type = $("financeType")?.value || "expense";
      const amountVal = $("financeAmount")?.value;
      const amount = parseFloat(amountVal);
      if (!amount || Number.isNaN(amount)) return;

      const accountId =
        $("financeAccount")?.value ||
        state.activeFinanceAccountId ||
        (state.accounts[0] && state.accounts[0].id);

      if (!accountId) {
        alert("Please create an account first.");
        return;
      }

      const category = $("financeCategory")?.value.trim() || "";
      const method = $("financeMethod")?.value.trim() || "";

      let dateIso;
      const dateStr = $("financeDate")?.value;
      if (!dateStr) {
        dateIso = new Date().toISOString();
      } else {
        dateIso = new Date(dateStr + "T00:00:00").toISOString();
      }

      const note = $("financeNote")?.value.trim() || "";

      const tx = {
        id: "tx-" + Date.now(),
        type,
        amount,
        accountId,
        category,
        method,
        date: dateIso,
        note
      };

      state.finance.unshift(tx);

      $("financeAmount").value = "";
      $("financeCategory").value = "";
      $("financeMethod").value = "";
      $("financeDate").value = "";
      $("financeNote").value = "";

      saveState();
      renderAccounts();
      renderFinance();
    }

    $("addFinanceBtn")?.addEventListener("click", addFinance);
    $("financeAmount")?.addEventListener("keydown", (e) => {
      if (e.key === "Enter") {
        e.preventDefault();
        addFinance();
      }
    });

    financeAccountSelect?.addEventListener("change", () => {
      state.activeFinanceAccountId = financeAccountSelect.value;
      saveState();
      renderAccounts();
      renderFinance();
    });

    financeFilterCategory?.addEventListener("change", renderFinance);

    function deleteFinance(id) {
      if (!confirmDelete()) return;
      state.finance = state.finance.filter((tx) => tx.id !== id);
      saveState();
      renderAccounts();
      renderFinance();
    }

    function getMonthlySummary(accountId) {
      const now = new Date();
      const m = now.getMonth();
      const y = now.getFullYear();
      let income = 0;
      let expense = 0;

      state.finance.forEach((tx) => {
        if (accountId && tx.accountId !== accountId) return;
        const d = new Date(tx.date);
        if (d.getMonth() === m && d.getFullYear() === y) {
          if (tx.type === "income") income += tx.amount;
          else expense += tx.amount;
        }
      });

      return {
        income,
        expense,
        balance: income - expense
      };
    }

    function renderFinance() {
      if (!financeListEl) return;

      let txs = state.finance;
      if (state.activeFinanceAccountId) {
        txs = txs.filter(
          (tx) => tx.accountId === state.activeFinanceAccountId
        );
      }

      const catFilter = financeFilterCategory?.value || "all";
      if (catFilter !== "all") {
        txs = txs.filter((tx) => (tx.category || "") === catFilter);
      }

      if (financeSummaryEl) {
        const summary = getMonthlySummary(state.activeFinanceAccountId);
        if (state.activeFinanceAccountId && (summary.income || summary.expense)) {
          financeSummaryEl.textContent =
            `This month ‚Äì Income: +${summary.income.toFixed(2)} ` +
            `/ Expenses: -${summary.expense.toFixed(2)} ` +
            `/ Balance: ${(summary.balance >= 0 ? "+" : "")}${summary.balance.toFixed(2)}`;
        } else if (state.activeFinanceAccountId) {
          financeSummaryEl.textContent = "This month ‚Äì no transactions yet.";
        } else {
          financeSummaryEl.textContent = "Create an account to see the monthly summary.";
        }
      }

      if (!txs.length) {
        financeListEl.innerHTML = "";
        if (noFinanceMsg) noFinanceMsg.style.display = "block";
        return;
      }
      if (noFinanceMsg) noFinanceMsg.style.display = "none";

      const accountMap = {};
      state.accounts.forEach((a) => {
        accountMap[a.id] = a.name;
      });

      financeListEl.innerHTML = "";

      txs.forEach((tx) => {
        const item = document.createElement("div");
        item.className = "item";

        const main = document.createElement("div");
        main.className = "item-main";

        const textWrap = document.createElement("div");
        textWrap.className = "item-text";

        const title = document.createElement("div");
        title.className = "item-title";
        const sign = tx.type === "income" ? "+" : "-";
        title.textContent = `${sign}${tx.amount.toFixed(2)} (${tx.category || "No category"})`;

        const meta = document.createElement("div");
        meta.className = "item-meta";

        const typeTag = document.createElement("span");
        typeTag.className =
          "tag " + (tx.type === "income" ? "tag-income" : "tag-expense");
        typeTag.textContent = tx.type === "income" ? "Income" : "Expense";
        meta.appendChild(typeTag);

        const accTag = document.createElement("span");
        accTag.className = "tag";
        accTag.textContent = accountMap[tx.accountId] || "Unknown account";
        meta.appendChild(accTag);

        const methodTag = document.createElement("span");
        methodTag.className = "tag";
        methodTag.textContent = tx.method || "Method ?";
        meta.appendChild(methodTag);

        const dateTag = document.createElement("span");
        dateTag.className = "tag";
        dateTag.textContent = formatDate(tx.date);
        meta.appendChild(dateTag);

        if (tx.note) {
          const noteTag = document.createElement("span");
          noteTag.className = "tag";
          noteTag.textContent = "Note";
          meta.appendChild(noteTag);
        }

        textWrap.appendChild(title);
        textWrap.appendChild(meta);
        main.appendChild(textWrap);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete transaction";
        delBtn.addEventListener("click", () => deleteFinance(tx.id));

        actions.appendChild(delBtn);

        item.appendChild(main);
        item.appendChild(actions);
        financeListEl.appendChild(item);
      });
    }

    // ---------- Init ----------
    function init() {
      loadState();

      const verEl = $("appVersion");
      if (verEl) verEl.textContent = "0.7.1";

      setupNav();

      renderTodoListOptions();
      renderTodos();

      renderShoppingListOptions();
      renderShopping();

      renderWorkouts();
      renderAccounts();
      renderFinance();

      resetCurrentWorkoutUI();

      setPage(state.currentPage || "home");
    }

    window.addEventListener("load", init);
  </script>
</body>
</html>
