<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MyHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" /><!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MyHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-elevated: #11131b;
      --bg-elevated-soft: #151826;
      --accent: #4caf50;
      --accent-soft: rgba(76, 175, 80, 0.18);
      --accent-alt: #00bcd4;
      --danger: #f44336;
      --text: #f5f5f5;
      --text-muted: #a0a4b8;
      --border-subtle: #26293a;
      --radius-lg: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #151827 0, #050608 45%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      display: flex;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }

    /*linha ref*/
    .sidebar {
      width: 70px;
      background: linear-gradient(180deg, #11131b 0%, #050608 100%);
      border-right: 1px solid var(--border-subtle);
      padding: 16px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      transition: width 0.2s ease;
      position: sticky;
      top: 0;
      align-self: flex-start;
      height: 100vh;
    }

    /* Slight expansion only, not huge */
    .sidebar.expanded {
      width: 110px;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(circle at 20% 0, #00e676, #00bcd4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #020308;
      box-shadow: 0 0 20px rgba(0, 188, 212, 0.6);
    }

    .nav-toggle {
      border: none;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      margin-top: 4px;
      transition: 0.18s ease;
    }

    .nav-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--accent-alt);
    }

    .nav {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      width: 100%;
    }

    .nav-item {
      width: 100%;
      border-radius: 999px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-muted);
      display: flex;
      flex-direction: column; /* icon + label vertical by default too */
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: 0.18s ease;
      padding: 8px 0;
      gap: 4px;
    }

    .nav-emoji {
      flex-shrink: 0;
    }

    .nav-label {
      display: none;
      font-size: 11px;
      white-space: nowrap;
    }

    /* When expanded, show labels under icons */
    .sidebar.expanded .nav-item {
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding-inline: 0;
    }

    .sidebar.expanded .nav-label {
      display: block;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.03);
      color: var(--accent-alt);
      transform: translateY(-1px);
    }

    .nav-item.nav-active {
      background: var(--accent-soft);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(76, 175, 80, 0.4);
    }

    .version {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
    }

    .main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: var(--radius-lg);
      background: linear-gradient(90deg, #141827, #0b0d14);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    }

    #pageTitle {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.03em;
    }

    .page {
      flex: 1;
      border-radius: var(--radius-lg);
      background: rgba(8, 10, 18, 0.96);
      border: 1px solid var(--border-subtle);
      padding: 16px;
      display: none;
      overflow-y: auto;
    }

    .page.active {
      display: block;
    }

    .hidden {
      display: none !important;
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
    }

    .card {
      border-radius: var(--radius-lg);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #151826;
      border: 1px solid #26293a;
      color: var(--text-muted);
    }

    .chip-highlight {
      background: rgba(0, 188, 212, 0.12);
      color: #e0f7fa;
      border-color: rgba(0, 188, 212, 0.5);
    }

    .input-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-row-inline {
      display: flex;
      gap: 8px;
    }

    .input-row-inline > * {
      flex: 1;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: 0.16s ease;
    }

    textarea {
      border-radius: 10px;
      resize: vertical;
      min-height: 70px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.4);
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      transition: 0.16s ease;
    }

    .btn:hover {
      background: rgba(76, 175, 80, 0.32);
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    .btn-secondary {
      background: rgba(0, 188, 212, 0.12);
      color: #b2ebf2;
    }

    .btn-secondary:hover {
      background: rgba(0, 188, 212, 0.24);
    }

    .btn-icon {
      padding-inline: 10px;
      font-size: 16px;
    }

    .btn-danger {
      background: rgba(244, 67, 54, 0.14);
      color: #ffcdd2;
    }

    .btn-danger:hover {
      background: rgba(244, 67, 54, 0.25);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .empty-msg {
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    .item {
      border-radius: 12px;
      padding: 8px 9px;
      background: var(--bg-elevated-soft);
      border: 1px solid #25283a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .item-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .item-checkbox {
      flex-shrink: 0;
    }

    .item-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .item-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .item-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      cursor: pointer;
    }

    .item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .item-actions {
      display: flex;
      flex-shrink: 0;
      gap: 4px;
    }

    .icon-btn {
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-muted);
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.07);
      color: var(--accent-alt);
    }

    .icon-btn.danger {
      color: #ff8a80;
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #181b2a;
      color: var(--text-muted);
    }

    .tag-income {
      background: rgba(76, 175, 80, 0.16);
      color: #c8e6c9;
    }

    .tag-expense {
      background: rgba(244, 67, 54, 0.16);
      color: #ffcdd2;
    }

    .selected-account {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.6);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .filter-pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #121622;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .filter-pill label {
      font-size: 11px;
    }

    .filter-pill select,
    .filter-pill input {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
    }

    /* Workout rows */
    .workout-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      border-radius: 10px;
      padding: 6px 8px;
      background: #101320;
    }

    .workout-row-top {
      width: 100%;
    }

    .workout-row-bottom {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    
    .workout-lines {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin: 4px 0;
    }

    .workout-setline {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workout-setline input[type="number"] {
      flex: 1;
      min-width: 0;
    }
.workout-row-bottom input[type="number"] {
      padding: 6px 7px;
      font-size: 12px;
    }

    .workout-row-bottom .workout-done {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .workout-row-bottom .icon-btn {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
      font-size: 14px;
    }

    /* Workout favorites grid */
    .favorites-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .favorite-card {
      flex: 1 1 calc(50% - 8px);
      min-width: 110px;
      height: 70px;
      border-radius: 14px;
      border: 1px solid #273041;
      background: radial-gradient(circle at top, rgba(0, 188, 212, 0.25), #101320);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 13px;
      color: #e0f7fa;
      cursor: pointer;
      padding: 4px;
      box-shadow: 0 0 12px rgba(0, 188, 212, 0.3);
      transition: 0.16s ease;
    }

    .notes-tabs {
      display: flex;
      gap: 6px;
    }
    
    .notes-tab {
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text-muted);
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      transition: 0.16s ease;
    }
    
    .notes-tab-active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: rgba(76, 175, 80, 0.6);
    }
    
    #notesTextArea {
      width: 100%;
      min-height: 200px;
      border-radius: 10px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text);
      font-size: 13px;
      padding: 8px 9px;
      resize: vertical;
    }
    
    .notes-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .notes-canvas-wrapper {
      border-radius: 12px;
      border: 1px solid #26293a;
      background: #000;
      overflow: hidden;
      position: relative;
      height: 260px; /* fits on mobile; canvas will auto-resize */
    }
    
    #notesCanvas {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none; /* important for drawing on mobile */
    }

    
    .favorite-card:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 0 18px rgba(0, 188, 212, 0.6);
    }

    @media (min-width: 600px) {
      .favorite-card {
        flex-basis: calc(33.33% - 8px);
      }
    }

    .favorites-empty {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-bottom: 8px;
    }

    @media (min-width: 900px) {
      .sidebar.expanded {
        width: 120px;
      }
    }
  

    /* MOBILE COMPACT */
    @media (max-width: 520px) {
      /* remove the 'middle frame' look: cards become flat sections */
      .card {
        background: transparent;
        border: none;
        padding: 0;
        margin-bottom: 10px;
      }

      .card-header {
        padding: 0;
        margin-bottom: 6px;
      }

      .section-title {
        font-size: 13px;
        margin-bottom: 6px;
      }

      .card-title {
        font-size: 13px;
      }

      .input-grid {
        gap: 8px;
      }

      .input-row label {
        font-size: 11px;
      }

      .input-row-inline {
        display: grid;
        grid-template-columns: 1fr 1fr;
        gap: 8px;
      }

      /* for rows with many fields, allow wrap */
      .input-row-inline > .input-row {
        min-width: 0;
      }

      input, select, textarea {
        padding: 7px 8px;
        font-size: 12px;
      }

      .btn {
        padding: 9px 10px;
        font-size: 12px;
      }

      .icon-btn {
        width: 32px;
        height: 32px;
      }
    }
</style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">H</div>
      <button id="navToggle" class="nav-toggle" title="Expand menu">‚ò∞</button>
      <nav class="nav">
        <button class="nav-item nav-active" data-page="home" title="Home">
          <span class="nav-emoji">üè†</span><span class="nav-label">Home</span>
        </button>
        <button class="nav-item" data-page="todo" title="To-Do">
          <span class="nav-emoji">‚úÖ</span><span class="nav-label">To-Do</span>
        </button>
        <button class="nav-item" data-page="shopping" title="Shopping">
          <span class="nav-emoji">üõí</span><span class="nav-label">Shopping</span>
        </button>
        <button class="nav-item" data-page="workouts" title="Workouts">
          <span class="nav-emoji">üèãÔ∏è</span><span class="nav-label">Workouts</span>
        </button>
        <button class="nav-item" data-page="finance" title="Finances">
          <span class="nav-emoji">üí∞</span><span class="nav-label">Finances</span>
        </button>
        <button class="nav-item" data-page="notes" title="Notes">
          <span class="nav-emoji">üìù</span><span class="nav-label">Notes</span>
        </button>
        <button class="nav-item" data-page="meals" title="Meals">
          <span class="nav-emoji">üçΩÔ∏è</span><span class="nav-label">Meals</span>
        </button>
        <button class="nav-item" data-page="calendar" title="Calendar">
          <span class="nav-emoji">üìÖ</span><span class="nav-label">Calendar</span>
        </button>
        <button class="nav-item" data-page="analytics" title="Analytics">
          <span class="nav-emoji">üìä</span><span class="nav-label">Analytics</span>
        </button>
      </nav>
      <div class="version">v<span id="appVersion">0.8.0</span></div>
    </aside>

    <main class="main">
      <header class="header">
        <h1 id="pageTitle">Home</h1>
      </header>

      <!-- HOME -->
      <section class="page active" data-page="home">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Quick task</div>
          </div>
          <div class="input-grid">
            <div class="input-row">
              <label for="homeQuickTaskInput">Task</label>
              <input id="homeQuickTaskInput" type="text" placeholder="e.g. Buy vegetables, send email‚Ä¶" />
            </div>
          </div>
          <button id="homeQuickTaskBtn" class="btn">
            ‚ûï Add quick task
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Overview</div>
          </div>
          <div class="chip-row">
            <span class="chip">‚úÖ To-do</span>
            <span class="chip">üõí Shopping</span>
            <span class="chip">üèãÔ∏è Workouts</span>
            <span class="chip">üí∞ Finance</span>
            <span class="chip chip-highlight">More coming soon‚Ä¶</span>
          </div>
        </div>
      </section>

      <!-- TO-DO -->
      <section class="page hidden" data-page="todo">
        <h2 class="section-title">To-do lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- Row 1: list dropdown -->
            <div class="input-row">
              <label for="todoListSelect">List</label>
              <select id="todoListSelect"></select>
            </div>

            <!-- Row 2: new list name + + button -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoListName">New list</label>
                <input id="todoListName" type="text" placeholder="e.g. Work, Personal‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="todoNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Row 3: Task title -->
            <div class="input-row">
              <label for="todoTitleInput">Task</label>
              <input id="todoTitleInput" type="text" placeholder="What do you need to do?" />
            </div>

            <!-- Row 4: Priority + due date -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoPrioritySelect">Priority</label>
                <select id="todoPrioritySelect">
                  <option value="high">High</option>
                  <option value="medium" selected>Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="input-row">
                <label for="todoDueDate">Due date</label>
                <input id="todoDueDate" type="date" />
              </div>
            </div>
          <!-- x -->
          <!-- Row 5: Filters + Add button on same line -->
          <!-- Row 5: Filters + Add button on the same line -->
          <div class="input-row-inline" style="margin-bottom: 8px; align-items: flex-end; flex-wrap:nowrap;">
          <button id="todoFiltersToggle"
                  class="btn btn-secondary btn-icon"
                  style="flex:0 0 auto; width:42px; padding:8px 0;">
              ‚öôÔ∏è
          </button>
          <button id="addTodoBtn" class="btn" style="flex:1 1 auto;">
              ‚ûï Add task
          </button>
          </div>

          <!-- Filters panel (hidden by default) -->
          <div id="todoFiltersPanel" style="display: none;">
            <div class="pill-row">
              <div class="filter-pill">
                <label for="todoSearchInput">Search</label>
                <input id="todoSearchInput" type="text" placeholder="Text‚Ä¶" />
              </div>
              <div class="filter-pill">
                <label for="todoFilterPriority">Priority</label>
                <select id="todoFilterPriority">
                  <option value="all">All</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="filter-pill">
                <label for="todoFilterStatus">Status</label>
                <select id="todoFilterStatus">
                  <option value="all">All</option>
                  <option value="open">Open</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Done</option>
                </select>
              </div>
              <div class="filter-pill">
                <label for="todoFilterList">List</label>
                <select id="todoFilterList">
                  <option value="all">All</option>
                </select>
              </div>
            </div>
          </div>

          <div id="noTodosMsg" class="empty-msg">
            No tasks yet. Add your first one above.
          </div>
          <div id="todoList" class="list"></div>
        </div>
      </section>

      <!-- SHOPPING -->
      <section class="page hidden" data-page="shopping">
        <h2 class="section-title">Shopping lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- Row 1: list dropdown -->
            <div class="input-row">
              <label for="shoppingListSelect">List</label>
              <select id="shoppingListSelect"></select>
            </div>

            <!-- Row 2: new list name + + button -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="shoppingListName">New list</label>
                <input id="shoppingListName" type="text" placeholder="e.g. Weekly, Work‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="shoppingNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Row 3: item -->
            <div class="input-row">
              <label for="shoppingItemInput">Item</label>
              <input id="shoppingItemInput" type="text" placeholder="e.g. Chicken, yogurt, vegetables‚Ä¶" />
            </div>

            <!-- Row 4: Add button -->
            <div class="input-row" style="align-items: flex-end;">
              <button id="addShoppingBtn" class="btn">‚ûï Add item</button>
            </div>
          </div>

          <div id="shoppingEmptyMsg" class="empty-msg">
            No items yet. Add something above.
          </div>
          <div id="shoppingList" class="list"></div>
        </div>
      </section>

      <!-- WORKOUTS -->
      <section class="page hidden" data-page="workouts">
        <h2 class="section-title">Workouts</h2>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Current workout</div>
          </div>

          <!-- Favorite workouts grid -->
          <div id="workoutFavoritesContainer">
            <div id="workoutFavoritesEmpty" class="favorites-empty">
              No favorites yet. Tap ‚òÖ on a logged workout to save it here.
            </div>
            <div id="workoutFavorites" class="favorites-grid"></div>
          </div>

          <div class="input-grid">
            <div class="input-row">
              <label for="workoutName">Workout name</label>
              <input id="workoutName" type="text" placeholder="e.g. Push day, Legs B‚Ä¶" />
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label>Start</label>
                <div id="workoutStartLabel" class="empty-msg">Not started</div>
              </div>
              <div class="input-row">
                <label>Duration</label>
                <div id="workoutDurationLabel" class="empty-msg">‚Äì</div>
              </div>
            </div>
          </div>

          <div class="input-row-inline" style="margin-bottom: 8px;">
            <button id="startWorkoutBtn" class="btn btn-secondary">‚ñ∂ Start workout</button>
            <button id="saveWorkoutBtn" class="btn">üíæ Finish & save</button>
</div>

          <div id="workoutExercises" class="list"></div>
          
          
          <div style="display:flex; justify-content:center; margin:10px 0 6px;">
            <button id="addExerciseRowBtn" class="btn btn-secondary">‚ûï Add exercise row</button>
          </div>
<!-- Rest timer -->
          <div id="restTimerWrap" style="display:flex; justify-content:center; margin-top:12px;">
            <div style="width:180px; border-radius:18px; border:1px solid #26293a; background:#101320; padding:10px; position:relative;">

              <button id="timerMode0" class="icon-btn" title="Count up (0)"
                style="position:absolute; top:8px; left:8px; width:28px; height:28px;">0</button>

              <button id="timerMode30" class="icon-btn" title="Countdown (+30s)"
                style="position:absolute; top:8px; right:8px; width:34px; height:28px;">30</button>

              <div id="timerCircle"
                style="width:140px; height:140px; margin:18px auto 8px; border-radius:999px;
                      border:2px solid rgba(0,188,212,0.35); display:flex; flex-direction:column;
                      align-items:center; justify-content:center; gap:4px;">
                <div id="timerDisplay" style="font-size:22px; font-weight:700;">00:00</div>
                <div id="timerModeLabel" style="font-size:11px; color:#a0a4b8;">0 mode</div>
              </div>

              <div style="display:flex; gap:8px; justify-content:center;">
                <button id="timerPlayPause" class="btn btn-secondary btn-icon" title="Play / Pause">‚ñ∂</button>
                <button id="timerReset" class="btn btn-secondary btn-icon" title="Reset">‚ü≤</button>
              </div>
            </div>
          </div>

          <!-- Notes moved to bottom -->
          <div class="input-grid">
            <div class="input-row">
              <label for="workoutNotes">Notes</label>
              <textarea id="workoutNotes" placeholder="Extra notes for this workout‚Ä¶"></textarea>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Logged workouts</div>
          </div>
          <div id="noWorkoutMsg" class="empty-msg">
            No workouts logged yet.
          </div>
          <div id="workoutList" class="list"></div>
        </div>
      </section>

      <!-- FINANCE -->
      <section class="page hidden" data-page="finance">
        <h2 class="section-title">Finances</h2>

        <!-- New transaction card FIRST -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">New transaction</div>
          </div>

          <div class="input-grid">
            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAccount">Account</label>
                <select id="financeAccount"></select>
              </div>
              <div class="input-row">
                <label for="financeType">Type</label>
                <select id="financeType">
                  <option value="expense" selected>Expense</option>
                  <option value="income">Income</option>
                </select>
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAmount">Amount</label>
                <input id="financeAmount" type="number" step="0.01" min="0" placeholder="0.00" />
              </div>
              <div class="input-row">
                <label for="financeDate">Date</label>
                <input id="financeDate" type="date" />
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeCategory">Category</label>
                <input id="financeCategory" type="text" placeholder="e.g. Food, Transport‚Ä¶" />
              </div>
              <div class="input-row">
                <label for="financeMethod">Method</label>
                <input id="financeMethod" type="text" placeholder="Cash, card, scan‚Ä¶" />
              </div>
            </div>

            <div class="input-row">
              <label for="financeNote">Note</label>
              <input id="financeNote" type="text" placeholder="Optional note‚Ä¶" />
            </div>

            <div class="input-row" style="align-items: flex-end;">
              <button id="addFinanceBtn" class="btn">
                ‚ûï Add transaction
              </button>
            </div>
          </div>

          <div class="pill-row">
            <div class="filter-pill">
              <label for="financeFilterCategory">Category filter</label>
              <select id="financeFilterCategory">
                <option value="all">All</option>
                <option value="Food">Food</option>
                <option value="Transport">Transport</option>
                <option value="Rent">Rent</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <!--REMOVE
          <div id="financeSummary" class="empty-msg"></div>-->

          <div id="noFinanceMsg" class="empty-msg">
            No transactions yet.
          </div>
          <div id="financeList" class="list"></div>
        </div>

        <!-- Accounts card moved to bottom -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Accounts</div>
            <button id="addAccountBtn" class="btn btn-secondary btn-icon">
              ‚ûï
            </button>
          </div>
          <div id="noAccountsMsg" class="empty-msg">
            No accounts yet. Add one above (e.g. THB main, BRL savings, USD).
          </div>
          <div id="accountsList" class="list"></div>
        </div>
      </section>

      <!-- NOTES (placeholder) -->
      <section class="page hidden" data-page="notes">
        <h2 class="section-title">Notes</h2>
      
        <div class="card">
          <div class="card-header">
            <div class="card-title">Notes</div>
            <div class="notes-tabs">
              <button id="notesTabText" class="notes-tab notes-tab-active">Text</button>
              <button id="notesTabCanvas" class="notes-tab">Canvas</button>
            </div>
          </div>
      
          <!-- TEXT MODE -->
          <div id="notesTextPane">
            <textarea id="notesTextArea" placeholder="Write your notes here‚Ä¶"></textarea>
          </div>
      
          <!-- CANVAS MODE -->
          <div id="notesCanvasPane" class="hidden">
            <div class="notes-toolbar">
              <button id="notesBoardDark" class="btn btn-secondary btn-icon" title="Dark board">
                ‚¨õ
              </button>
              <button id="notesBoardLight" class="btn btn-secondary btn-icon" title="Light board">
                ‚¨ú
              </button>
              <button id="notesCanvasClear" class="btn btn-secondary btn-icon" title="Clear">
                üßπ
              </button>
              <button id="notesCanvasSave" class="btn btn-secondary btn-icon" title="Save image">
                üíæ
              </button>
            </div>
            <div class="notes-canvas-wrapper">
              <canvas id="notesCanvas"></canvas>
            </div>
          </div>
        </div>
      </section>


      <!-- MEALS (placeholder) -->
      <section class="page hidden" data-page="meals">
        <h2 class="section-title">Meals</h2>
      </section>

      <!-- CALENDAR (placeholder) -->
      <section class="page hidden" data-page="calendar">
        <h2 class="section-title">Calendar</h2>
      </section>

      <!-- ANALYTICS (placeholder) -->
      <section class="page hidden" data-page="analytics">
        <h2 class="section-title">Analytics</h2>
      </section>
    </main>
  </div>
  <script>
  // ==============================
  // MyHub v0.9.3 - script.js
   // script.js ‚Äì MyHub v0.9.3
  
  document.addEventListener("DOMContentLoaded", () => {
    // -----------------------------
    // GLOBAL STATE & STORAGE
    // -----------------------------
    const STORAGE_KEY = "myhub_state_v1";
  
    const defaultState = {
      todos: [], // {id, title, priority, dueDate, status, listId, createdAt, link}
      todoLists: [{ id: "default", name: "Personal" }],
      shoppingLists: [
        {
          id: "default",
          name: "General",
          items: [], // {id, text, checked, note}
        },
      ],
      workouts: [], // logged workouts
      workoutFavorites: [], // {id, name, exercises}
      financeAccounts: [], // {id, name}
      financeTransactions: [], // {id, accountId, type, amount, date, category, method, note}
      notesText: "",
      meals: [], // {id, date, food, amount, unit, protein, carbs, fat}
      foodLibrary: [], // {id, name, baseAmount, baseUnit, kcal, protein, carbs, fat}
      calendarEvents: [], // {id, date, text}
      workoutTimer: {
        mode: "up",          // "up" or "down"
        baseDownSeconds: 30, // 30, 60, 90...
        running: false,
        elapsedMs: 0,        // para mode "up"
        remainingMs: 30000,  // para mode "down"
        lastTick: null
      },
    };
  
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return {
          ...structuredClone(defaultState),
          ...parsed,
        };
      } catch (e) {
        console.error("Error loading state", e);
        return structuredClone(defaultState);
      }
    }
  
    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }
  
    function makeId(prefix) {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
    }
  
    let state = loadState();


    // ---- Seed food library (only if it's empty) ----
    if (!state.foodLibrary || !Array.isArray(state.foodLibrary) || state.foodLibrary.length === 0) {
      state.foodLibrary = [
        {
          id: "food_1",
          name: "Bread slice",
          baseAmount: 1,
          baseUnit: "slice",
          kcal: 70,
          protein: 2,
          carbs: 12.5,
          fat: 1,
          fiber: 1,
          category: "Grains",
          notes: "standard Thai toast size"
        },
        {
          id: "food_2",
          name: "Peanut butter sachet",
          baseAmount: 1,
          baseUnit: "sachet",
          kcal: 110,
          protein: 4,
          carbs: 3,
          fat: 9,
          fiber: 1,
          category: "Fat",
          notes: "label you provided"
        },
        {
          id: "food_3",
          name: "Honey protein shake",
          baseAmount: 1,
          baseUnit: "bottle",
          kcal: 190,
          protein: 30,
          carbs: 16,
          fat: 0.5,
          fiber: 0,
          category: "Supplement",
          notes: "your honey protein drink"
        },
        {
          id: "food_4",
          name: "Yogurt drink",
          baseAmount: 1,
          baseUnit: "bottle",
          kcal: 120,
          protein: 12,
          carbs: 14,
          fat: 2,
          fiber: 0,
          category: "Dairy",
          notes: "label you provided"
        },
        {
          id: "food_5",
          name: "Yogurt cup",
          baseAmount: 1,
          baseUnit: "cup",
          kcal: 140,
          protein: 10,
          carbs: 19,
          fat: 2,
          fiber: 0,
          category: "Dairy",
          notes: "label you provided"
        },
        {
          id: "food_6",
          name: "Banana",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 89,
          protein: 1,
          carbs: 23,
          fat: 0.3,
          fiber: 2.6,
          category: "Fruit",
          notes: "medium banana ‚âà 118g"
        },
        {
          id: "food_7",
          name: "Mixed berries",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 57,
          protein: 0.7,
          carbs: 14,
          fat: 0.3,
          fiber: 3.1,
          category: "Fruit",
          notes: ""
        },
        {
          id: "food_8",
          name: "Kiwi",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 61,
          protein: 1.1,
          carbs: 15,
          fat: 0.5,
          fiber: 3,
          category: "Fruit",
          notes: ""
        },
        {
          id: "food_9",
          name: "Tangerine juice",
          baseAmount: 150,
          baseUnit: "ml",
          kcal: 60,
          protein: 0,
          carbs: 15,
          fat: 0,
          fiber: 0,
          category: "Drink",
          notes: "combined with coffee in morning"
        },
        {
          id: "food_10",
          name: "Coffee",
          baseAmount: 50,
          baseUnit: "ml",
          kcal: 2,
          protein: 0,
          carbs: 0,
          fat: 0,
          fiber: 0,
          category: "Drink",
          notes: "black coffee"
        },
        {
          id: "food_11",
          name: "Chicken breast",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 165,
          protein: 31,
          carbs: 0,
          fat: 3.5,
          fiber: 0,
          category: "Meat",
          notes: "cooked"
        },
        {
          id: "food_12",
          name: "Chicken minced",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 189,
          protein: 23,
          carbs: 0,
          fat: 10,
          fiber: 0,
          category: "Meat",
          notes: "cooked 85% lean estimate"
        },
        {
          id: "food_13",
          name: "Chicken skewer fillet",
          baseAmount: 1,
          baseUnit: "skewer",
          kcal: 99,
          protein: 18,
          carbs: 0,
          fat: 2,
          fiber: 0,
          category: "Meat",
          notes: "your morning skewers (3 per breakfast)"
        },
        {
          id: "food_14",
          name: "Tilapia (grilled)",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 96,
          protein: 20,
          carbs: 0,
          fat: 2,
          fiber: 0,
          category: "Fish",
          notes: ""
        },
        {
          id: "food_15",
          name: "Pork loin",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 160,
          protein: 29,
          carbs: 0,
          fat: 5,
          fiber: 0,
          category: "Meat",
          notes: "lean pork"
        },
        {
          id: "food_16",
          name: "Salami",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 336,
          protein: 22,
          carbs: 2,
          fat: 26,
          fiber: 0,
          category: "Fat",
          notes: "cured"
        },
        {
          id: "food_17",
          name: "Sticky rice",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 200,
          protein: 3.5,
          carbs: 45,
          fat: 0.5,
          fiber: 0.5,
          category: "Grains",
          notes: ""
        },
        {
          id: "food_18",
          name: "Jasmine rice (purple)",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 130,
          protein: 2.4,
          carbs: 28,
          fat: 0.3,
          fiber: 0.4,
          category: "Grains",
          notes: ""
        },
        {
          id: "food_19",
          name: "Pasta (plain cooked)",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 158,
          protein: 5.8,
          carbs: 31,
          fat: 0.9,
          fiber: 1.8,
          category: "Grains",
          notes: ""
        },
        {
          id: "food_20",
          name: "Broccoli",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 35,
          protein: 2.8,
          carbs: 7,
          fat: 0.4,
          fiber: 3.3,
          category: "Vegetable",
          notes: ""
        },
        {
          id: "food_21",
          name: "Pumpkin",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 26,
          protein: 1,
          carbs: 7,
          fat: 0.1,
          fiber: 0.5,
          category: "Vegetable",
          notes: "you eat peel as well"
        },
        {
          id: "food_22",
          name: "Carrot",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 41,
          protein: 1,
          carbs: 10,
          fat: 0.2,
          fiber: 2.8,
          category: "Vegetable",
          notes: ""
        },
        {
          id: "food_23",
          name: "Potato",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 77,
          protein: 2,
          carbs: 17,
          fat: 0.1,
          fiber: 2.2,
          category: "Vegetable",
          notes: ""
        },
        {
          id: "food_24",
          name: "Olive oil",
          baseAmount: 1,
          baseUnit: "g",
          kcal: 9,
          protein: 0,
          carbs: 0,
          fat: 1,
          fiber: 0,
          category: "Fat",
          notes: ""
        },
        {
          id: "food_25",
          name: "Olives",
          baseAmount: 10,
          baseUnit: "g",
          kcal: 14,
          protein: 0.1,
          carbs: 0.8,
          fat: 1.3,
          fiber: 0.3,
          category: "Fat",
          notes: "your typical handful ‚âà 20 olives = 40g"
        },
        {
          id: "food_26",
          name: "Cottage cheese",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 98,
          protein: 11,
          carbs: 3.6,
          fat: 4.3,
          fiber: 0,
          category: "Dairy",
          notes: ""
        },
        {
          id: "food_27",
          name: "Parmesan",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 431,
          protein: 38,
          carbs: 4,
          fat: 29,
          fiber: 0,
          category: "Dairy",
          notes: ""
        },
        {
          id: "food_28",
          name: "Mozzarella",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 280,
          protein: 28,
          carbs: 3,
          fat: 17,
          fiber: 0,
          category: "Dairy",
          notes: ""
        },
        {
          id: "food_29",
          name: "Gouda",
          baseAmount: 100,
          baseUnit: "g",
          kcal: 356,
          protein: 25,
          carbs: 2,
          fat: 27,
          fiber: 0,
          category: "Dairy",
          notes: ""
        },
        {
          id: "food_30",
          name: "Milk powder",
          baseAmount: 20,
          baseUnit: "g",
          kcal: 75,
          protein: 2.5,
          carbs: 12,
          fat: 2.5,
          fiber: 0,
          category: "Dairy",
          notes: "¬Ω scoop"
        },
        {
          id: "food_31",
          name: "Whey protein (dark chocolate)",
          baseAmount: 30,
          baseUnit: "g",
          kcal: 130,
          protein: 25,
          carbs: 3,
          fat: 2.5,
          fiber: 0,
          category: "Supplement",
          notes: "label you sent"
        },
        {
          id: "food_32",
          name: "Cocoa powder",
          baseAmount: 10,
          baseUnit: "g",
          kcal: 12,
          protein: 1,
          carbs: 2,
          fat: 0.5,
          fiber: 0,
          category: "Fat",
          notes: "100% cacao"
        },
        {
          id: "food_33",
          name: "Gelatin",
          baseAmount: 5,
          baseUnit: "g",
          kcal: 12,
          protein: 3,
          carbs: 0,
          fat: 0,
          fiber: 0,
          category: "Protein",
          notes: ""
        },
        {
          id: "food_34",
          name: "Bang Bang chocolate",
          baseAmount: 1,
          baseUnit: "bar",
          kcal: 100,
          protein: 1,
          carbs: 13,
          fat: 5,
          fiber: 0,
          category: "Snack",
          notes: "your label"
        },
        {
          id: "food_35",
          name: "Snickers small",
          baseAmount: 1,
          baseUnit: "bar",
          kcal: 90,
          protein: 1.5,
          carbs: 12,
          fat: 4.5,
          fiber: 0,
          category: "Snack",
          notes: ""
        },
        {
          id: "food_36",
          name: "Chips (small bag)",
          baseAmount: 1,
          baseUnit: "bag",
          kcal: 150,
          protein: 2,
          carbs: 15,
          fat: 9,
          fiber: 1,
          category: "Snack",
          notes: "typical Thai small pack"
        },
        {
          id: "food_37",
          name: "Roadside grilled chicken (no skin)",
          baseAmount: 280,
          baseUnit: "g",
          kcal: 462,
          protein: 60,
          carbs: 0,
          fat: 18,
          fiber: 0,
          category: "Meat",
          notes: "half chicken without skin"
        },
        {
          id: "food_38",
          name: "Khao Soi soup (small ladle)",
          baseAmount: 1,
          baseUnit: "ladle",
          kcal: 80,
          protein: 4,
          carbs: 6,
          fat: 4,
          fiber: 0,
          category: "Soup",
          notes: "estimate from Thai nutrition data"
        }
      ];

      // Persist immediately so it survives refresh
      saveState();
    }

  
    if (!state.todoLists || state.todoLists.length === 0) {
      state.todoLists = structuredClone(defaultState.todoLists);
    }
    if (!state.shoppingLists || state.shoppingLists.length === 0) {
      state.shoppingLists = structuredClone(defaultState.shoppingLists);
    }
  
    // Bump version label
    const appVersionSpan = document.getElementById("appVersion");
    if (appVersionSpan) appVersionSpan.textContent = "0.9.3";
  
    // -----------------------------
    // BASIC ELEMENTS & EXTRA STYLES
    // -----------------------------
    const sidebar = document.querySelector(".sidebar");
    const navToggle = document.getElementById("navToggle");
    const navItems = document.querySelectorAll(".nav-item");
    const pages = document.querySelectorAll(".page");
    const pageTitle = document.getElementById("pageTitle");
  
    // Extra styles for collapsed sidebar & handle
    const extraStyle = document.createElement("style");
    extraStyle.textContent = `
      .sidebar.collapsed {
        width: 8px;
        padding: 6px 2px;
        overflow: hidden;
      }
      .sidebar.collapsed .logo,
      .sidebar.collapsed .nav-toggle,
      .sidebar.collapsed .nav,
      .sidebar.collapsed .version {
        opacity: 0;
        pointer-events: none;
      }
      #sidebarHandle {
        position: fixed;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 10px;
        height: 70px;
        border-radius: 0 10px 10px 0;
        background: rgba(0, 188, 212, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 999;
        font-size: 10px;
        color: #020308;
        box-shadow: 0 0 12px rgba(0, 188, 212, 0.7);
      }
    `;
    document.head.appendChild(extraStyle);
  
    const sidebarHandle = document.createElement("div");
    sidebarHandle.id = "sidebarHandle";
    sidebarHandle.textContent = "‚ñ∂";
    document.body.appendChild(sidebarHandle);
  
    let canvasSidebarModeActive = false;
    let navExpandTimer = null;
  
    function setSidebarCollapsed(collapsed) {
      if (!sidebar) return;
      if (collapsed) {
        sidebar.classList.add("collapsed");
        sidebar.classList.remove("expanded");
      } else {
        sidebar.classList.remove("collapsed");
      }
    }
  
    function enableCanvasSidebarMode() {
      canvasSidebarModeActive = true;
      setSidebarCollapsed(true);
      sidebarHandle.style.display = "flex";
    }
  
    function disableCanvasSidebarMode() {
      canvasSidebarModeActive = false;
      setSidebarCollapsed(false);
      sidebarHandle.style.display = "none";
    }
  
    sidebarHandle.addEventListener("click", () => {
      setSidebarCollapsed(false);
      // auto-collapse again after a few seconds in canvas mode
      if (canvasSidebarModeActive) {
        setTimeout(() => {
          if (canvasSidebarModeActive) {
            setSidebarCollapsed(true);
          }
        }, 4000);
      }
    });
  
    // -----------------------------
    // NAVIGATION
    // -----------------------------
    if (navToggle) {
      navToggle.addEventListener("click", () => {
        if (sidebar.classList.contains("expanded")) {
          sidebar.classList.remove("expanded");
          if (navExpandTimer) clearTimeout(navExpandTimer);
        } else {
          sidebar.classList.add("expanded");
          if (navExpandTimer) clearTimeout(navExpandTimer);
          // auto-collapse name expansion after a few seconds
          navExpandTimer = setTimeout(() => {
            sidebar.classList.remove("expanded");
          }, 3500);
        }
      });
    }
  
    function showPage(pageId) {
      pages.forEach((p) => {
        if (p.dataset.page === pageId) {
          p.classList.remove("hidden");
          p.classList.add("active");
        } else {
          p.classList.add("hidden");
          p.classList.remove("active");
        }
      });
  
      navItems.forEach((btn) => {
        if (btn.dataset.page === pageId) {
          btn.classList.add("nav-active");
        } else {
          btn.classList.remove("nav-active");
        }
      });
  
      if (pageTitle) {
        const item = [...navItems].find((b) => b.dataset.page === pageId);
        pageTitle.textContent = item ? item.title || "MyHub" : "MyHub";
      }
  
      // Leaving notes canvas mode
      if (pageId !== "notes") {
        disableCanvasSidebarMode();
      }
    }
  
    navItems.forEach((btn) => {
      btn.addEventListener("click", () => {
        showPage(btn.dataset.page);
      });
    });
  
    // -----------------------------
    // HOME ‚Äì QUICK TASK
    // -----------------------------
    const homeQuickTaskInput = document.getElementById("homeQuickTaskInput");
    const homeQuickTaskBtn = document.getElementById("homeQuickTaskBtn");
  
    function getDefaultTodoListId() {
      if (state.todoLists.length === 0) {
        const def = { id: "default", name: "Personal" };
        state.todoLists.push(def);
        saveState();
        return def.id;
      }
      return state.todoLists[0].id;
    }
  
    if (homeQuickTaskBtn && homeQuickTaskInput) {
      homeQuickTaskBtn.addEventListener("click", () => {
        const text = homeQuickTaskInput.value.trim();
        if (!text) return;
        const listId = getDefaultTodoListId();
        const newTodo = {
          id: makeId("todo"),
          title: text,
          priority: "medium",
          dueDate: "",
          status: "open",
          listId,
          createdAt: Date.now(),
          link: "",
        };
        state.todos.push(newTodo);
        saveState();
        homeQuickTaskInput.value = "";
        if (currentTodoListId === listId) {
          renderTodos();
        }
      });
    }
  
    // -----------------------------
    // TO-DO
    // -----------------------------
    const todoListSelect = document.getElementById("todoListSelect");
    const todoListNameInput = document.getElementById("todoListName");
    const todoTitleInput = document.getElementById("todoTitleInput");
    const todoPrioritySelect = document.getElementById("todoPrioritySelect");
    const todoDueDateInput = document.getElementById("todoDueDate");
    const addTodoBtn = document.getElementById("addTodoBtn");
    const todoFiltersToggle = document.getElementById("todoFiltersToggle");
    const todoFiltersPanel = document.getElementById("todoFiltersPanel");
    const todoSearchInput = document.getElementById("todoSearchInput");
    const todoFilterPriority = document.getElementById("todoFilterPriority");
    const todoFilterStatus = document.getElementById("todoFilterStatus");
    const todoFilterList = document.getElementById("todoFilterList");
    const noTodosMsg = document.getElementById("noTodosMsg");
    const todoListContainer = document.getElementById("todoList");
  
    let currentTodoListId = getDefaultTodoListId();
  
    // Layout tweaks: remove direct "new list" field, add + button with popup
    (function adaptTodoListRow() {
      if (!todoListSelect) return;
      if (todoListNameInput) {
        const rowInline = todoListNameInput.closest(".input-row-inline");
        if (rowInline) rowInline.style.display = "none";
      }
      const selectRow = todoListSelect.closest(".input-row");
      if (!selectRow) return;
      selectRow.style.display = "flex";
      selectRow.style.flexDirection = "row";
      selectRow.style.alignItems = "flex-end";
      selectRow.style.gap = "8px";
  
      const label = selectRow.querySelector("label");
      if (label) {
        label.style.marginRight = "4px";
        label.style.whiteSpace = "nowrap";
      }
  
      const newListBtn = document.createElement("button");
      newListBtn.className = "btn btn-secondary btn-icon";
      newListBtn.textContent = "‚ûï";
      newListBtn.title = "New list";
  
      newListBtn.addEventListener("click", () => {
        const name = prompt("New to-do list name:");
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        const id = makeId("tlist");
        state.todoLists.push({ id, name: trimmed });
        currentTodoListId = id;
        saveState();
        refreshTodoListsUI();
        renderTodos();
      });
  
      selectRow.appendChild(newListBtn);
    })();
  
    function refreshTodoListsUI() {
      if (!todoListSelect || !todoFilterList) return;
      todoListSelect.innerHTML = "";
      state.todoLists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        todoListSelect.appendChild(opt);
      });
      if (!state.todoLists.find((l) => l.id === currentTodoListId)) {
        currentTodoListId = getDefaultTodoListId();
      }
      todoListSelect.value = currentTodoListId;
  
      todoFilterList.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "All";
      todoFilterList.appendChild(allOpt);
      state.todoLists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        todoFilterList.appendChild(opt);
      });
      todoFilterList.value = "all";
    }
  
    function triStateNext(status) {
      if (status === "open") return "inprogress";
      if (status === "inprogress") return "done";
      return "open";
    }
  
    function applyTodoFilters(task) {
      const search = (todoSearchInput?.value || "").toLowerCase();
      const fp = todoFilterPriority?.value || "all";
      const fs = todoFilterStatus?.value || "all";
      const fl = todoFilterList?.value || "all";
      const effectiveListId =
        fl !== "all" ? fl : (todoListSelect?.value || currentTodoListId);
  
      if (search) {
        const hay = task.title.toLowerCase();
        if (!hay.includes(search)) return false;
      }
      if (fp !== "all" && task.priority !== fp) return false;
      if (fs !== "all" && task.status !== fs) return false;
      if (fl !== "all" && task.listId !== fl) return false;
      if (effectiveListId && task.listId !== effectiveListId) return false;
      return true;
    }
  
    function sortTodos(a, b) {
      const statusRank = { open: 0, inprogress: 1, done: 2 };
      const prRank = { high: 0, medium: 1, low: 2 };
      const sa = statusRank[a.status] ?? 1;
      const sb = statusRank[b.status] ?? 1;
      if (sa !== sb) return sa - sb;
      const pa = prRank[a.priority] ?? 1;
      const pb = prRank[b.priority] ?? 1;
      if (pa !== pb) return pa - pb;
  
      const da = a.dueDate || "";
      const db = b.dueDate || "";
      if (da && db && da !== db) return da.localeCompare(db);
      if (da && !db) return -1;
      if (!da && db) return 1;
      return (a.createdAt || 0) - (b.createdAt || 0);
    }
  
    function renderTodos() {
      if (!todoListContainer || !noTodosMsg) return;
      todoListContainer.innerHTML = "";
      const tasks = state.todos.filter(applyTodoFilters).sort(sortTodos);
  
      if (tasks.length === 0) {
        noTodosMsg.style.display = "block";
        return;
      }
      noTodosMsg.style.display = "none";
  
      tasks.forEach((task) => {
        const item = document.createElement("div");
        item.className = "item";
        item.draggable = true;
  
        const main = document.createElement("div");
        main.className = "item-main";
  
        const checkboxWrap = document.createElement("div");
        checkboxWrap.className = "item-checkbox";
        const cb = document.createElement("input");
        cb.type = "checkbox";
  
        if (task.status === "done") cb.checked = true;
        else cb.checked = false;
        cb.indeterminate = task.status === "inprogress";
  
        cb.addEventListener("click", (e) => {
          e.stopPropagation();
          task.status = triStateNext(task.status);
          saveState();
          renderTodos();
        });
  
        checkboxWrap.appendChild(cb);
  
        const textWrap = document.createElement("div");
        textWrap.className = "item-text";
  
        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = task.title || "(no title)";
  
        if (task.status === "done") {
          title.style.textDecoration = "line-through";
          title.style.color = "#777a90";
        } else if (task.status === "inprogress") {
          title.style.fontStyle = "italic";
        }
  
        title.addEventListener("click", () => {
          const newTitle = prompt("Edit task title:", task.title || "");
          if (newTitle === null) return;
          task.title = newTitle.trim() || task.title;
  
          const newDue = prompt(
            "Edit due date (YYYY-MM-DD, leave blank to clear):",
            task.dueDate || ""
          );
          if (newDue !== null) {
            const trimmed = newDue.trim();
            task.dueDate = trimmed || "";
          }
  
          const newPriority = prompt(
            "Priority (high / medium / low):",
            task.priority || "medium"
          );
          if (newPriority) {
            const p = newPriority.toLowerCase();
            if (["high", "medium", "low"].includes(p)) {
              task.priority = p;
            }
          }
          saveState();
          renderTodos();
        });
  
        const meta = document.createElement("div");
        meta.className = "item-meta";
  
        if (task.priority) {
          const pTag = document.createElement("span");
          pTag.className = "tag";
          pTag.textContent =
            task.priority === "high"
              ? "High"
              : task.priority === "low"
              ? "Low"
              : "Medium";
          meta.appendChild(pTag);
        }
        if (task.dueDate) {
          const dTag = document.createElement("span");
          dTag.className = "tag";
          dTag.textContent = `Due ${task.dueDate}`;
          meta.appendChild(dTag);
        }
        if (task.listId) {
          const list = state.todoLists.find((l) => l.id === task.listId);
          if (list) {
            const lTag = document.createElement("span");
            lTag.className = "tag";
            lTag.textContent = list.name;
            meta.appendChild(lTag);
          }
        }
        if (task.link) {
          const linkTag = document.createElement("span");
          linkTag.className = "tag";
          linkTag.textContent = `üîó ${task.link}`;
          meta.appendChild(linkTag);
        }
  
        textWrap.appendChild(title);
        if (meta.childNodes.length > 0) textWrap.appendChild(meta);
  
        main.appendChild(checkboxWrap);
        main.appendChild(textWrap);
  
        const actions = document.createElement("div");
        actions.className = "item-actions";
  
        const linkBtn = document.createElement("button");
        linkBtn.className = "icon-btn";
        linkBtn.textContent = "üîó";
        linkBtn.title = "Set / edit link";
  
        linkBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const current = task.link || "";
          const newLink = prompt(
            "Link this task to something (e.g. 'Shopping: Weekly list')",
            current
          );
          if (newLink === null) return;
          task.link = newLink.trim();
          saveState();
          renderTodos();
        });
  
        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete task";
  
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (!confirm("Delete this task?")) return;
          state.todos = state.todos.filter((t) => t.id !== task.id);
          saveState();
          renderTodos();
        });
  
        actions.appendChild(linkBtn);
        actions.appendChild(delBtn);
  
        item.appendChild(main);
        item.appendChild(actions);
  
        item.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", task.id);
        });
        item.addEventListener("dragover", (e) => e.preventDefault());
        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const fromId = e.dataTransfer.getData("text/plain");
          if (!fromId || fromId === task.id) return;
          const arr = state.todos;
          const fromIndex = arr.findIndex((t) => t.id === fromId);
          const toIndex = arr.findIndex((t) => t.id === task.id);
          if (fromIndex === -1 || toIndex === -1) return;
          const [moved] = arr.splice(fromIndex, 1);
          arr.splice(toIndex, 0, moved);
          saveState();
          renderTodos();
        });
  
        todoListContainer.appendChild(item);
      });
    }
    
    if (todoListSelect) {
      todoListSelect.addEventListener("change", () => {
        currentTodoListId = todoListSelect.value;
    
        // keep the "List" filter in sync with the dropdown on top
        if (todoFilterList) {
          todoFilterList.value = currentTodoListId;
        }
    
        saveState();
        renderTodos();
      });
    }
    
    if (addTodoBtn) {
      addTodoBtn.addEventListener("click", () => {
        const title = (todoTitleInput?.value || "").trim();
        if (!title) return;
        const priority = todoPrioritySelect?.value || "medium";
        const dueDate = todoDueDateInput?.value || "";
        const newTodo = {
          id: makeId("todo"),
          title,
          priority,
          dueDate,
          status: "open",
          listId: currentTodoListId,
          createdAt: Date.now(),
          link: "",
        };
        state.todos.push(newTodo);
        saveState();
  
        if (todoTitleInput) todoTitleInput.value = "";
        if (todoDueDateInput) todoDueDateInput.value = "";
        renderTodos();
      });
    }
  
    if (todoFiltersToggle && todoFiltersPanel) {
      todoFiltersToggle.addEventListener("click", () => {
        const visible = todoFiltersPanel.style.display === "block";
        todoFiltersPanel.style.display = visible ? "none" : "block";
      });
    }
  
    [todoSearchInput, todoFilterPriority, todoFilterStatus, todoFilterList].forEach(
      (el) => {
        if (!el) return;
        el.addEventListener("input", renderTodos);
        el.addEventListener("change", renderTodos);
      }
    );
  
    refreshTodoListsUI();
  
    // *** To-do small Filters button on same line as Add task ***
    (function compactTodoFiltersButton() {
      if (!todoFiltersToggle || !addTodoBtn) return;
      const filterRow = todoFiltersToggle.closest(".input-row");
      const addRow = addTodoBtn.closest(".input-row");
      if (!filterRow || !addRow) return;
  
      // Only icon for filters to make it small
      todoFiltersToggle.textContent = "‚öôÔ∏è";
      todoFiltersToggle.title = "Filters";
      // Move filter button into same row as Add task
      filterRow.style.display = "none";
      addRow.style.display = "flex";
      addRow.style.alignItems = "flex-end";
      addRow.style.gap = "8px";
  
      // Put filter button before Add task
      addRow.insertBefore(todoFiltersToggle, addTodoBtn);
      todoFiltersToggle.style.flex = "0 0 auto";
      addTodoBtn.style.flex = "1 1 auto";
    })();
  
    // -----------------------------
    // SHOPPING
    // -----------------------------
    const shoppingListSelect = document.getElementById("shoppingListSelect");
    const shoppingListNameInput = document.getElementById("shoppingListName");
    const shoppingNewListBtn = document.getElementById("shoppingNewListBtn");
    const shoppingItemInput = document.getElementById("shoppingItemInput");
    const addShoppingBtn = document.getElementById("addShoppingBtn");
    const shoppingEmptyMsg = document.getElementById("shoppingEmptyMsg");
    const shoppingListContainer = document.getElementById("shoppingList");
  
    let currentShoppingListId =
      state.shoppingLists.length > 0 ? state.shoppingLists[0].id : "default";
  
    (function adaptShoppingListRow() {
      if (!shoppingListSelect) return;
      if (shoppingListNameInput) {
        const rowInline = shoppingListNameInput.closest(".input-row-inline");
        if (rowInline) rowInline.style.display = "none";
      }
      const selectRow = shoppingListSelect.closest(".input-row");
      if (!selectRow) return;
  
      selectRow.style.display = "flex";
      selectRow.style.flexDirection = "row";
      selectRow.style.alignItems = "flex-end";
      selectRow.style.gap = "8px";
  
      const label = selectRow.querySelector("label");
      if (label) {
        label.style.marginRight = "4px";
        label.style.whiteSpace = "nowrap";
      }
  
      const newListBtn = document.createElement("button");
      newListBtn.className = "btn btn-secondary btn-icon";
      newListBtn.textContent = "‚ûï";
      newListBtn.title = "New shopping list";
  
      newListBtn.addEventListener("click", () => {
        const name = prompt("New shopping list name:");
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        const id = makeId("slist");
        state.shoppingLists.push({ id, name: trimmed, items: [] });
        currentShoppingListId = id;
        saveState();
        refreshShoppingListsUI();
        renderShopping();
      });
  
      selectRow.appendChild(newListBtn);
    })();
  
    function refreshShoppingListsUI() {
      if (!shoppingListSelect) return;
      shoppingListSelect.innerHTML = "";
      state.shoppingLists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        shoppingListSelect.appendChild(opt);
      });
      if (!state.shoppingLists.find((l) => l.id === currentShoppingListId)) {
        currentShoppingListId =
          state.shoppingLists.length > 0 ? state.shoppingLists[0].id : "default";
      }
      shoppingListSelect.value = currentShoppingListId;
    }
  
    function getCurrentShoppingList() {
      let list = state.shoppingLists.find((l) => l.id === currentShoppingListId);
      if (!list && state.shoppingLists.length > 0) {
        list = state.shoppingLists[0];
        currentShoppingListId = list.id;
      }
      if (!list) {
        list = { id: "default", name: "General", items: [] };
        state.shoppingLists.push(list);
      }
      return list;
    }
  
    function renderShopping() {
      if (!shoppingListContainer || !shoppingEmptyMsg) return;
      shoppingListContainer.innerHTML = "";
      const list = getCurrentShoppingList();
      if (!list.items || list.items.length === 0) {
        shoppingEmptyMsg.style.display = "block";
        return;
      }
      shoppingEmptyMsg.style.display = "none";
  
      list.items.forEach((itemObj) => {
        const item = document.createElement("div");
        item.className = "item";
        item.draggable = true;
  
        const main = document.createElement("div");
        main.className = "item-main";
  
        const checkboxWrap = document.createElement("div");
        checkboxWrap.className = "item-checkbox";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!itemObj.checked;
        cb.addEventListener("click", (e) => {
          e.stopPropagation();
          itemObj.checked = cb.checked;
          saveState();
          renderShopping();
        });
        checkboxWrap.appendChild(cb);
  
        const textWrap = document.createElement("div");
        textWrap.className = "item-text";
  
        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = itemObj.text || "(no name)";
  
        if (itemObj.checked) {
          title.style.textDecoration = "line-through";
          title.style.color = "#777a90";
        }
  
        title.addEventListener("click", () => {
          const newName = prompt("Edit item name:", itemObj.text || "");
          if (newName === null) return;
          itemObj.text = newName.trim() || itemObj.text;
          saveState();
          renderShopping();
        });
  
        const meta = document.createElement("div");
        meta.className = "item-meta";
        if (itemObj.note) {
          const noteTag = document.createElement("span");
          noteTag.className = "tag";
          noteTag.textContent = `üìù ${itemObj.note}`;
          meta.appendChild(noteTag);
        }
  
        textWrap.appendChild(title);
        if (meta.childNodes.length > 0) textWrap.appendChild(meta);
  
        main.appendChild(checkboxWrap);
        main.appendChild(textWrap);
  
        const actions = document.createElement("div");
        actions.className = "item-actions";
  
        const noteBtn = document.createElement("button");
        noteBtn.className = "icon-btn";
        noteBtn.textContent = "üìù";
        noteBtn.title = "Add note";
  
        noteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const newNote = prompt("Note for this item:", itemObj.note || "");
          if (newNote === null) return;
          itemObj.note = newNote.trim();
          saveState();
          renderShopping();
        });
  
        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete item";
  
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (!confirm("Delete this item?")) return;
          list.items = list.items.filter((i) => i.id !== itemObj.id);
          saveState();
          renderShopping();
        });
  
        actions.appendChild(noteBtn);
        actions.appendChild(delBtn);
  
        item.appendChild(main);
        item.appendChild(actions);
  
        item.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", itemObj.id);
        });
        item.addEventListener("dragover", (e) => e.preventDefault());
        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const fromId = e.dataTransfer.getData("text/plain");
          if (!fromId || fromId === itemObj.id) return;
          const arr = list.items;
          const fromIndex = arr.findIndex((i) => i.id === fromId);
          const toIndex = arr.findIndex((i) => i.id === itemObj.id);
          if (fromIndex === -1 || toIndex === -1) return;
          const [moved] = arr.splice(fromIndex, 1);
          arr.splice(toIndex, 0, moved);
          saveState();
          renderShopping();
        });
  
        shoppingListContainer.appendChild(item);
      });
    }
  
    if (shoppingListSelect) {
      shoppingListSelect.addEventListener("change", () => {
        currentShoppingListId = shoppingListSelect.value;
        renderShopping();
      });
    }
  
    if (addShoppingBtn) {
      addShoppingBtn.addEventListener("click", () => {
        const text = (shoppingItemInput?.value || "").trim();
        if (!text) return;
        const list = getCurrentShoppingList();
        list.items.push({
          id: makeId("sitem"),
          text,
          checked: false,
          note: "",
        });
        saveState();
        if (shoppingItemInput) shoppingItemInput.value = "";
        renderShopping();
      });
    }
  
    refreshShoppingListsUI();
    renderShopping();
  
    // -----------------------------
    // WORKOUTS
    // -----------------------------
    const workoutNameInput = document.getElementById("workoutName");
    const workoutStartLabel = document.getElementById("workoutStartLabel");
    const workoutDurationLabel = document.getElementById("workoutDurationLabel");
    const startWorkoutBtn = document.getElementById("startWorkoutBtn");
    const saveWorkoutBtn = document.getElementById("saveWorkoutBtn");
    const addExerciseRowBtn = document.getElementById("addExerciseRowBtn");
    const workoutExercisesContainer = document.getElementById("workoutExercises");
    const workoutNotesInput = document.getElementById("workoutNotes");
    const workoutFavoritesEmpty = document.getElementById("workoutFavoritesEmpty");
    const workoutFavoritesGrid = document.getElementById("workoutFavorites");
    const noWorkoutMsg = document.getElementById("noWorkoutMsg");
    const workoutListContainer = document.getElementById("workoutList");
  
    let currentWorkout = {
      name: "",
      startTime: null,
      durationMs: 0,
      notes: "",
      exercises: [],
    };
    let workoutTimer = null;
  
    function formatDuration(ms) {
      if (!ms || ms <= 0) return "‚Äì";
      const totalSec = Math.floor(ms / 1000);
      const mins = Math.floor(totalSec / 60);
      const secs = totalSec % 60;
      if (mins === 0) return `${secs}s`;
      return `${mins}m ${secs}s`;
    }
  
    function updateWorkoutDurationLabel() {
      if (!currentWorkout.startTime) return;
      const now = Date.now();
      const ms = now - currentWorkout.startTime;
      currentWorkout.durationMs = ms;
      if (workoutDurationLabel) {
        workoutDurationLabel.textContent = formatDuration(ms);
      }
    }
  
    function startWorkoutTimer() {
      if (workoutTimer) clearInterval(workoutTimer);
      workoutTimer = setInterval(updateWorkoutDurationLabel, 1000);
    }
  
    function stopWorkoutTimer() {
      if (workoutTimer) clearInterval(workoutTimer);
      workoutTimer = null;
    }

    function fmtMMSS(ms) {
      ms = Math.max(0, ms | 0);
      const total = Math.floor(ms / 1000);
      const m = String(Math.floor(total / 60)).padStart(2, "0");
      const s = String(total % 60).padStart(2, "0");
      return `${m}:${s}`;
    }

    function initWorkoutRestTimerUI() {
      const mode0 = document.getElementById("timerMode0");
      const mode30 = document.getElementById("timerMode30");
      const play = document.getElementById("timerPlayPause");
      const reset = document.getElementById("timerReset");
      const disp = document.getElementById("timerDisplay");
      const label = document.getElementById("timerModeLabel");
      const circle = document.getElementById("timerCircle");

      if (!mode0 || !mode30 || !play || !reset || !disp || !label || !circle) return;

      // Ensure state exists (and is migrated safely)
      state.workoutTimer = state.workoutTimer || {
        mode: "up",
        baseDownSeconds: 30,
        running: false,
        elapsedMs: 0,
        remainingMs: 30000,
        lastTick: null
      };

      function renderTimerUI() {
        const isUp = state.workoutTimer.mode === "up";

        mode0.style.border = isUp ? "1px solid rgba(0,188,212,0.85)" : "";
        mode30.style.border = !isUp ? "1px solid rgba(0,188,212,0.85)" : "";

        if (isUp) {
          disp.textContent = fmtMMSS(state.workoutTimer.elapsedMs);
          label.textContent = "0 mode";
        } else {
          disp.textContent = fmtMMSS(state.workoutTimer.remainingMs);
          label.textContent = `${state.workoutTimer.baseDownSeconds}s mode`;
        }

        play.textContent = state.workoutTimer.running ? "‚è∏" : "‚ñ∂";
        circle.style.boxShadow = state.workoutTimer.running
          ? "0 0 14px rgba(0,188,212,0.35)"
          : "none";
      }

      function setModeUp() {
        state.workoutTimer.mode = "up";
        state.workoutTimer.running = false;
        state.workoutTimer.lastTick = null;
        saveState();
        renderTimerUI();
      }

      function add30Countdown() {
        const prevMode = state.workoutTimer.mode;
        state.workoutTimer.mode = "down";
        // If switching from count-up to countdown, start fresh from 0 before adding 30s
        if (prevMode !== "down") state.workoutTimer.baseDownSeconds = 0;
        state.workoutTimer.baseDownSeconds = (state.workoutTimer.baseDownSeconds || 0) + 30;

        const baseMs = state.workoutTimer.baseDownSeconds * 1000;

        // By default (not running), set to base time.
        // If running, add +30s to remaining.
        if (!state.workoutTimer.running) {
          state.workoutTimer.remainingMs = baseMs;
        } else {
          state.workoutTimer.remainingMs += 30000;
        }

        state.workoutTimer.lastTick = null;
        saveState();
        renderTimerUI();
      }

      function tick() {
        if (!state.workoutTimer.running) return;

        const now = Date.now();
        const last = state.workoutTimer.lastTick || now;
        const dt = now - last;
        state.workoutTimer.lastTick = now;

        if (state.workoutTimer.mode === "up") {
          state.workoutTimer.elapsedMs += dt;
        } else {
          state.workoutTimer.remainingMs -= dt;
          if (state.workoutTimer.remainingMs <= 0) {
            state.workoutTimer.remainingMs = 0;
            state.workoutTimer.running = false;
            state.workoutTimer.lastTick = null;
          }
        }

        saveState();
        renderTimerUI();
        requestAnimationFrame(tick);
      }

      function togglePlay() {
        state.workoutTimer.running = !state.workoutTimer.running;

        if (state.workoutTimer.running) {
          state.workoutTimer.lastTick = Date.now();
          requestAnimationFrame(tick);
        } else {
          state.workoutTimer.lastTick = null;
        }

        saveState();
        renderTimerUI();
      }

      function doReset() {
        state.workoutTimer.running = false;
        state.workoutTimer.lastTick = null;

        if (state.workoutTimer.mode === "up") {
          state.workoutTimer.elapsedMs = 0;
        } else {
          state.workoutTimer.baseDownSeconds = 30;
          state.workoutTimer.remainingMs = 30000;
        }

        saveState();
        renderTimerUI();
      }

      mode0.addEventListener("click", setModeUp);
      mode30.addEventListener("click", add30Countdown);
      play.addEventListener("click", togglePlay);
      reset.addEventListener("click", doReset);

      renderTimerUI();
    }

  
    function createExerciseRow(data) {
      const row = document.createElement("div");
      row.className = "workout-row";
      const id = data?.id || makeId("ex");

      // --- Top (exercise name) ---
      const top = document.createElement("div");
      top.className = "workout-row-top";

      const exNameInput = document.createElement("input");
      exNameInput.type = "text";
      exNameInput.placeholder = "Exercise name";
      exNameInput.value = data?.name || "";
      top.appendChild(exNameInput);

      // --- Lines (set / reps / weight) ---
      const linesWrap = document.createElement("div");
      linesWrap.className = "workout-lines";

      // Normalize input data (backward compatible)
      const initialLines = Array.isArray(data?.lines) && data.lines.length
        ? data.lines
        : ((data?.sets ?? data?.reps ?? data?.weight) != null
            ? [{ set: data?.sets ?? "", reps: data?.reps ?? "", weight: data?.weight ?? "" }]
            : [{ set: "", reps: "", weight: "" }]);

      // --- Footer controls (done / add line / delete) ---
      const footer = document.createElement("div");
      footer.className = "workout-row-bottom";

      const doneCheckbox = document.createElement("input");
      doneCheckbox.type = "checkbox";
      doneCheckbox.className = "workout-done";
      doneCheckbox.checked = !!data?.done;

      const addLineBtn = document.createElement("button");
      addLineBtn.className = "icon-btn";
      addLineBtn.textContent = "‚ûï";
      addLineBtn.title = "Add set line";

      const deleteBtn = document.createElement("button");
      deleteBtn.className = "icon-btn danger";
      deleteBtn.textContent = "üóë";
      deleteBtn.title = "Remove exercise";

      footer.appendChild(doneCheckbox);
      footer.appendChild(addLineBtn);
      footer.appendChild(deleteBtn);

      row.appendChild(top);
      row.appendChild(linesWrap);
      row.appendChild(footer);
      workoutExercisesContainer.appendChild(row);

      // Ensure exercise exists in state
      const exObj = {
        id,
        name: (data?.name || "").trim(),
        done: !!data?.done,
        lines: []
      };
      currentWorkout.exercises.push(exObj);

      function syncNameDone() {
        const ex = currentWorkout.exercises.find((e) => e.id === id);
        if (!ex) return;
        ex.name = exNameInput.value.trim();
        ex.done = doneCheckbox.checked;
      }

      function rebuildLinesFromDOM() {
        const ex = currentWorkout.exercises.find((e) => e.id === id);
        if (!ex) return;

        const rows = Array.from(linesWrap.querySelectorAll("[data-line-row='1']"));
        ex.lines = rows.map((r) => {
          const setEl = r.querySelector("[data-k='set']");
          const repsEl = r.querySelector("[data-k='reps']");
          const weightEl = r.querySelector("[data-k='weight']");
          return {
            set: setEl?.value ? parseInt(setEl.value, 10) : null,
            reps: repsEl?.value ? parseInt(repsEl.value, 10) : null,
            weight: weightEl?.value ? parseFloat(weightEl.value) : null,
          };
        });
      }

      function addLine(lineData) {
        const lineRow = document.createElement("div");
        lineRow.className = "workout-setline";
        lineRow.setAttribute("data-line-row", "1");

        const setInput = document.createElement("input");
        setInput.type = "number";
        setInput.min = "0";
        setInput.placeholder = "Set";
        setInput.value = (lineData?.set ?? "") === null ? "" : (lineData?.set ?? "");
        setInput.setAttribute("data-k", "set");

        const repsInput = document.createElement("input");
        repsInput.type = "number";
        repsInput.min = "0";
        repsInput.placeholder = "Reps";
        repsInput.value = (lineData?.reps ?? "") === null ? "" : (lineData?.reps ?? "");
        repsInput.setAttribute("data-k", "reps");

        const weightInput = document.createElement("input");
        weightInput.type = "number";
        weightInput.min = "0";
        weightInput.placeholder = "Weight";
        weightInput.value = (lineData?.weight ?? "") === null ? "" : (lineData?.weight ?? "");
        weightInput.setAttribute("data-k", "weight");

        const removeLineBtn = document.createElement("button");
        removeLineBtn.className = "icon-btn danger";
        removeLineBtn.textContent = "‚úï";
        removeLineBtn.title = "Remove set line";
        removeLineBtn.addEventListener("click", () => {
          // Keep at least 1 line
          const rows = linesWrap.querySelectorAll("[data-line-row='1']");
          if (rows.length <= 1) return;
          lineRow.remove();
          rebuildLinesFromDOM();
        });

        [setInput, repsInput, weightInput].forEach((el) => {
          el.addEventListener("input", () => {
            rebuildLinesFromDOM();
          });
        });

        lineRow.appendChild(setInput);
        lineRow.appendChild(repsInput);
        lineRow.appendChild(weightInput);
        lineRow.appendChild(removeLineBtn);

        linesWrap.appendChild(lineRow);
      }

      // Render initial lines
      initialLines.forEach((ln) => addLine(ln));
      rebuildLinesFromDOM();

      // Events
      exNameInput.addEventListener("input", syncNameDone);
      doneCheckbox.addEventListener("change", syncNameDone);

      addLineBtn.addEventListener("click", () => {
        addLine({ set: "", reps: "", weight: "" });
        rebuildLinesFromDOM();
      });

      deleteBtn.addEventListener("click", () => {
        row.remove();
        currentWorkout.exercises = currentWorkout.exercises.filter((e) => e.id !== id);
      });
    }
  
    function clearCurrentWorkoutUI() {
      currentWorkout = {
        name: "",
        startTime: null,
        durationMs: 0,
        notes: "",
        exercises: [],
      };
      if (workoutNameInput) workoutNameInput.value = "";
      if (workoutStartLabel) workoutStartLabel.textContent = "Not started";
      if (workoutDurationLabel) workoutDurationLabel.textContent = "‚Äì";
      if (workoutNotesInput) workoutNotesInput.value = "";
      if (workoutExercisesContainer) workoutExercisesContainer.innerHTML = "";
      stopWorkoutTimer();
    }
  
    function renderWorkoutFavorites() {
      if (!workoutFavoritesGrid || !workoutFavoritesEmpty) return;
      workoutFavoritesGrid.innerHTML = "";
      const favs = state.workoutFavorites || [];
      if (favs.length === 0) {
        workoutFavoritesEmpty.style.display = "block";
        return;
      }
      workoutFavoritesEmpty.style.display = "none";
      favs.slice(0, 6).forEach((fav) => {
        const card = document.createElement("div");
        card.className = "favorite-card";
        card.textContent = fav.name || "Workout";
        card.addEventListener("click", () => {
          clearCurrentWorkoutUI();
          currentWorkout.name = fav.name || "";
          if (workoutNameInput) workoutNameInput.value = currentWorkout.name;
          fav.exercises.forEach((ex) => {
            createExerciseRow({
              name: ex.name,
              lines: Array.isArray(ex.lines) && ex.lines.length ? ex.lines : [{ set: ex.sets, reps: ex.reps, weight: ex.weight }],
              done: false,
            });
          });
        });
        workoutFavoritesGrid.appendChild(card);
      });
    }
  
    function renderWorkoutsList() {
      if (!workoutListContainer || !noWorkoutMsg) return;
      workoutListContainer.innerHTML = "";
      const ws = state.workouts || [];
      if (ws.length === 0) {
        noWorkoutMsg.style.display = "block";
        return;
      }
      noWorkoutMsg.style.display = "none";
  
      ws
        .slice()
        .sort((a, b) => (b.startTime || 0) - (a.startTime || 0))
        .forEach((w) => {
          const item = document.createElement("div");
          item.className = "item";
  
          const main = document.createElement("div");
          main.className = "item-main";
  
          const titleWrap = document.createElement("div");
          titleWrap.className = "item-text";
  
          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = w.name || "Workout";
  
          const meta = document.createElement("div");
          meta.className = "item-meta";
  
          const date = new Date(w.startTime || Date.now());
          const dTag = document.createElement("span");
          dTag.className = "tag";
          dTag.textContent = date.toLocaleString();
          meta.appendChild(dTag);
  
          const durTag = document.createElement("span");
          durTag.className = "tag";
          durTag.textContent = formatDuration(w.durationMs || 0);
          meta.appendChild(durTag);
  
          const exTag = document.createElement("span");
          exTag.className = "tag";
          exTag.textContent = `${(w.exercises || []).length} exercises`;
          meta.appendChild(exTag);
  
          titleWrap.appendChild(title);
          titleWrap.appendChild(meta);
          main.appendChild(titleWrap);
  
          const actions = document.createElement("div");
          actions.className = "item-actions";
  
          const favBtn = document.createElement("button");
          favBtn.className = "icon-btn";
          const isFav = state.workoutFavorites?.some((f) => f.id === w.id);
          favBtn.textContent = isFav ? "‚òÖ" : "‚òÜ";
          favBtn.title = "Toggle favorite (max 6)";
  
          favBtn.addEventListener("click", () => {
            const favIndex = state.workoutFavorites.findIndex(
              (f) => f.id === w.id
            );
            if (favIndex >= 0) {
              state.workoutFavorites.splice(favIndex, 1);
            } else {
              if ((state.workoutFavorites || []).length >= 6) {
                alert("You already have 6 favorite workouts.");
                return;
              }
              state.workoutFavorites.push({
                id: w.id,
                name: w.name,
                exercises: w.exercises || [],
              });
            }
            saveState();
            renderWorkoutFavorites();
            renderWorkoutsList();
          });
  
          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóë";
          delBtn.title = "Delete workout";
  
          delBtn.addEventListener("click", () => {
            if (!confirm("Delete this workout?")) return;
            state.workouts = state.workouts.filter((wk) => wk.id !== w.id);
            state.workoutFavorites = state.workoutFavorites.filter(
              (f) => f.id !== w.id
            );
            saveState();
            renderWorkoutFavorites();
            renderWorkoutsList();
          });
  
          actions.appendChild(favBtn);
          actions.appendChild(delBtn);
  
          item.appendChild(main);
          item.appendChild(actions);
  
          workoutListContainer.appendChild(item);
        });
    }
  
    if (startWorkoutBtn) {
      startWorkoutBtn.addEventListener("click", () => {
        if (!currentWorkout.startTime) {
          currentWorkout.startTime = Date.now();
          if (workoutStartLabel) {
            const d = new Date(currentWorkout.startTime);
            workoutStartLabel.textContent = d.toLocaleTimeString();
          }
          startWorkoutTimer();
        }
        if (!currentWorkout.exercises || currentWorkout.exercises.length === 0) {
          createExerciseRow();
        }
      });
    }
  
    if (addExerciseRowBtn && workoutExercisesContainer) {
      addExerciseRowBtn.addEventListener("click", () => {
        createExerciseRow();
      });
    }
  
    if (saveWorkoutBtn) {
      saveWorkoutBtn.addEventListener("click", () => {
        const name = (workoutNameInput?.value || "").trim();
        const notes = workoutNotesInput?.value || "";
        const exs = currentWorkout.exercises || [];
        if (exs.length === 0) {
          if (!confirm("No exercises added. Save anyway?")) return;
        }
  
        const now = Date.now();
        let startTime = currentWorkout.startTime || now;
        let durationMs = currentWorkout.durationMs || 0;
        if (!durationMs && currentWorkout.startTime) {
          durationMs = now - currentWorkout.startTime;
        }
  
        const workout = {
          id: makeId("workout"),
          name: name || "Workout",
          notes,
          exercises: exs.map((e) => ({
            id: e.id,
            name: e.name,
            sets: e.sets,
            reps: e.reps,
            weight: e.weight,
            done: e.done,
          })),
          startTime,
          durationMs,
        };
  
        state.workouts.push(workout);
        saveState();
        clearCurrentWorkoutUI();
        renderWorkoutsList();
      });
    }
  
    if (workoutNotesInput) {
      workoutNotesInput.addEventListener("input", () => {
        currentWorkout.notes = workoutNotesInput.value;
      });
    }
  
    // *** Workout: manual start/end time editing ***
    function parseDateTimeLocal(str) {
      if (!str) return null;
      const parts = str.trim().split(" ");
      const datePart = parts[0];
      if (!datePart) return null;
      const [y, m, d] = datePart.split("-").map(Number);
      let hh = 0,
        mm = 0;
      if (parts[1]) {
        const [hStr, mStr] = parts[1].split(":");
        hh = parseInt(hStr || "0", 10) || 0;
        mm = parseInt(mStr || "0", 10) || 0;
      }
      const dt = new Date(y, (m || 1) - 1, d || 1, hh, mm);
      if (isNaN(dt.getTime())) return null;
      return dt;
    }
  
    (function addManualWorkoutTimeButton() {
      if (!workoutStartLabel) return;
      const startRow = workoutStartLabel.closest(".input-row");
      if (!startRow) return;
      const btn = document.createElement("button");
      btn.className = "btn btn-secondary btn-icon";
      btn.textContent = "üïí";
      btn.title = "Set start/end time manually";
      startRow.appendChild(btn);
  
      btn.addEventListener("click", () => {
        const currentStart =
          currentWorkout.startTime || Date.now();
        const defStart = new Date(currentStart)
          .toISOString()
          .slice(0, 16)
          .replace("T", " ");
  
        const startStr = prompt(
          "Start (YYYY-MM-DD HH:MM):",
          defStart
        );
        if (!startStr) return;
        const startDt = parseDateTimeLocal(startStr);
        if (!startDt) {
          alert("Invalid start date/time.");
          return;
        }
  
        const defEndDt = new Date(startDt.getTime() + 60 * 60 * 1000);
        const defEnd = defEndDt
          .toISOString()
          .slice(0, 16)
          .replace("T", " ");
  
        const endStr = prompt(
          "End (YYYY-MM-DD HH:MM):",
          defEnd
        );
        if (!endStr) return;
        const endDt = parseDateTimeLocal(endStr);
        if (!endDt || endDt <= startDt) {
          alert("End must be after start.");
          return;
        }
  
        currentWorkout.startTime = startDt.getTime();
        currentWorkout.durationMs = endDt.getTime() - startDt.getTime();
        stopWorkoutTimer();
  
        if (workoutStartLabel) {
          workoutStartLabel.textContent = startDt.toLocaleString();
        }
        if (workoutDurationLabel) {
          workoutDurationLabel.textContent = formatDuration(
            currentWorkout.durationMs
          );
        }
      });
    })();
  
    renderWorkoutFavorites();
    renderWorkoutsList();
    initWorkoutRestTimerUI();
  
    // -----------------------------
    // FINANCE
    // -----------------------------
    const financeAccountSelect = document.getElementById("financeAccount");
    const financeTypeSelect = document.getElementById("financeType");
    const financeAmountInput = document.getElementById("financeAmount");
    const financeDateInput = document.getElementById("financeDate");
    const financeCategoryInput = document.getElementById("financeCategory");
    const financeMethodInput = document.getElementById("financeMethod");
    const financeNoteInput = document.getElementById("financeNote");
    const addFinanceBtn = document.getElementById("addFinanceBtn");
    const financeFilterCategory = document.getElementById(
      "financeFilterCategory"
    );
    const financeSummary = document.getElementById("financeSummary");
    const noFinanceMsg = document.getElementById("noFinanceMsg");
    const financeListContainer = document.getElementById("financeList");
  
    const addAccountBtn = document.getElementById("addAccountBtn");
    const noAccountsMsg = document.getElementById("noAccountsMsg");
    const accountsListContainer = document.getElementById("accountsList");
  
    function refreshAccountsUI() {
      if (!financeAccountSelect || !accountsListContainer || !noAccountsMsg)
        return;
  
      financeAccountSelect.innerHTML = "";
      state.financeAccounts.forEach((acc, idx) => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        opt.textContent = acc.name || `Account ${idx + 1}`;
        financeAccountSelect.appendChild(opt);
      });
  
      accountsListContainer.innerHTML = "";
      if (state.financeAccounts.length === 0) {
        noAccountsMsg.style.display = "block";
      } else {
        noAccountsMsg.style.display = "none";
        state.financeAccounts.forEach((acc) => {
          const item = document.createElement("div");
          item.className = "item";
  
          const main = document.createElement("div");
          main.className = "item-main";
  
          const titleWrap = document.createElement("div");
          titleWrap.className = "item-text";
  
          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = acc.name;
  
          const meta = document.createElement("div");
          meta.className = "item-meta";
  
          const sum = state.financeTransactions
            .filter((t) => t.accountId === acc.id)
            .reduce(
              (total, t) =>
                t.type === "income" ? total + t.amount : total - t.amount,
              0
            );
  
          const balTag = document.createElement("span");
          balTag.className = "tag";
          balTag.textContent = `Balance: ${sum.toFixed(2)}`;
          meta.appendChild(balTag);
  
          titleWrap.appendChild(title);
          titleWrap.appendChild(meta);
          main.appendChild(titleWrap);
  
          const actions = document.createElement("div");
          actions.className = "item-actions";
  
          const editBtn = document.createElement("button");
          editBtn.className = "icon-btn";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "Rename account";
  
          editBtn.addEventListener("click", () => {
            const newName = prompt("New account name:", acc.name);
            if (newName === null) return;
            acc.name = newName.trim() || acc.name;
            saveState();
            refreshAccountsUI();
          });
  
          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóë";
          delBtn.title = "Delete account";
  
          delBtn.addEventListener("click", () => {
            if (
              !confirm(
                "Delete this account? (Transactions will remain but may become 'orphaned')"
              )
            )
              return;
            state.financeAccounts = state.financeAccounts.filter(
              (a) => a.id !== acc.id
            );
            saveState();
            refreshAccountsUI();
            renderFinance();
          });
  
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
  
          item.appendChild(main);
          item.appendChild(actions);
  
          accountsListContainer.appendChild(item);
        });
      }
    }
  
    if (addAccountBtn) {
      addAccountBtn.addEventListener("click", () => {
        const name = prompt(
          "Account name (e.g. THB main, BRL, USD):",
          "New account"
        );
        if (!name) return;
        state.financeAccounts.push({
          id: makeId("acc"),
          name: name.trim(),
        });
        saveState();
        refreshAccountsUI();
      });
    }
  
    function renderFinance() {
      if (!financeListContainer || !noFinanceMsg || !financeSummary) return;
  
      financeListContainer.innerHTML = "";
  
      const catFilter = financeFilterCategory?.value || "all";
      const txs = state.financeTransactions || [];
  
      const filtered = txs.filter((t) => {
        if (catFilter === "all") return true;
        return (t.category || "").toLowerCase() === catFilter.toLowerCase();
      });
  
      if (filtered.length === 0) {
        noFinanceMsg.style.display = "block";
      } else {
        noFinanceMsg.style.display = "none";
      }
  
      let totalIncome = 0;
      let totalExpense = 0;
  
      filtered
        .slice()
        .sort((a, b) => (b.date || "").localeCompare(a.date || ""))
        .forEach((t) => {
          if (t.type === "income") totalIncome += t.amount;
          else totalExpense += t.amount;
  
          const item = document.createElement("div");
          item.className = "item";
  
          const main = document.createElement("div");
          main.className = "item-main";
  
          const textWrap = document.createElement("div");
          textWrap.className = "item-text";
  
          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = `${t.type === "income" ? "+" : "-"}${t.amount.toFixed(
            2
          )} ${t.category || ""}`;
  
          const meta = document.createElement("div");
          meta.className = "item-meta";
  
          const dateTag = document.createElement("span");
          dateTag.className = "tag";
          dateTag.textContent = t.date || "";
          meta.appendChild(dateTag);
  
          const acc = state.financeAccounts.find((a) => a.id === t.accountId);
          if (acc) {
            const accTag = document.createElement("span");
            accTag.className = "tag";
            accTag.textContent = acc.name;
            meta.appendChild(accTag);
          }
  
          if (t.method) {
            const mTag = document.createElement("span");
            mTag.className = "tag";
            mTag.textContent = t.method;
            meta.appendChild(mTag);
          }
  
          if (t.note) {
            const nTag = document.createElement("span");
            nTag.className = "tag";
            nTag.textContent = `üìù ${t.note}`;
            meta.appendChild(nTag);
          }
  
          const typeTag = document.createElement("span");
          typeTag.className =
            "tag " + (t.type === "income" ? "tag-income" : "tag-expense");
          typeTag.textContent = t.type === "income" ? "Income" : "Expense";
          meta.appendChild(typeTag);
  
          textWrap.appendChild(title);
          textWrap.appendChild(meta);
          main.appendChild(textWrap);
  
          const actions = document.createElement("div");
          actions.className = "item-actions";
  
          const editBtn = document.createElement("button");
          editBtn.className = "icon-btn";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "Edit transaction";
  
          editBtn.addEventListener("click", () => {
            const newAmountStr = prompt(
              "Edit amount:",
              t.amount != null ? String(t.amount) : ""
            );
            if (newAmountStr === null) return;
            const newAmt = parseFloat(newAmountStr);
            if (!isNaN(newAmt) && newAmt >= 0) t.amount = newAmt;
  
            const newCat = prompt(
              "Edit category:",
              t.category != null ? t.category : ""
            );
            if (newCat !== null) t.category = newCat.trim();
  
            const newMethod = prompt(
              "Edit method (cash, card...):",
              t.method != null ? t.method : ""
            );
            if (newMethod !== null) t.method = newMethod.trim();
  
            const newNote = prompt(
              "Edit note:",
              t.note != null ? t.note : ""
            );
            if (newNote !== null) t.note = newNote.trim();
  
            saveState();
            renderFinance();
            refreshAccountsUI();
          });
  
          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóë";
          delBtn.title = "Delete transaction";
  
          delBtn.addEventListener("click", () => {
            if (!confirm("Delete this transaction?")) return;
            state.financeTransactions = state.financeTransactions.filter(
              (x) => x.id !== t.id
            );
            saveState();
            renderFinance();
            refreshAccountsUI();
          });
  
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
  
          item.appendChild(main);
          item.appendChild(actions);
  
          financeListContainer.appendChild(item);
        });
  
      const net = totalIncome - totalExpense;
      financeSummary.textContent = `Income: ${totalIncome.toFixed(
        2
      )}  |  Expense: ${totalExpense.toFixed(
        2
      )}  |  Net: ${net.toFixed(2)}`;
    }
  
    if (addFinanceBtn) {
      addFinanceBtn.addEventListener("click", () => {
        if (!financeAccountSelect || state.financeAccounts.length === 0) {
          alert("Please add an account first.");
          return;
        }
        const accountId = financeAccountSelect.value;
        const type = financeTypeSelect?.value || "expense";
        const amountStr = financeAmountInput?.value || "";
        const amount = parseFloat(amountStr);
        if (isNaN(amount) || amount <= 0) return;
        const date =
          financeDateInput?.value || new Date().toISOString().slice(0, 10);
        const category = (financeCategoryInput?.value || "").trim();
        const method = (financeMethodInput?.value || "").trim();
        const note = (financeNoteInput?.value || "").trim();
  
        state.financeTransactions.push({
          id: makeId("tx"),
          accountId,
          type,
          amount,
          date,
          category,
          method,
          note,
        });
        saveState();
  
        if (financeAmountInput) financeAmountInput.value = "";
        if (financeNoteInput) financeNoteInput.value = "";
        renderFinance();
        refreshAccountsUI();
      });
    }
  
    if (financeFilterCategory) {
      financeFilterCategory.addEventListener("change", renderFinance);
    }
  
    refreshAccountsUI();
    renderFinance();
  
    // -----------------------------
    // NOTES (tabs: Text + Canvas)
    // -----------------------------
    const notesPage = document.querySelector('.page[data-page="notes"]');
    if (notesPage) {
      notesPage.innerHTML = `
        <h2 class="section-title">Notes</h2>
        <div class="card">
          <div class="card-header" style="justify-content:space-between; align-items:center;">
            <div class="card-title">Notes</div>
            <div style="display:flex; gap:6px;">
              <button id="notesTabText" class="btn btn-secondary btn-icon" title="Text notes">üìù</button>
              <button id="notesTabCanvas" class="btn btn-secondary btn-icon" title="Canvas">‚úèÔ∏è</button>
            </div>
          </div>
    
          <!-- TEXT NOTES -->
          <div id="notesTextSection" class="input-grid">
            <div class="input-row">
              <textarea id="notesText"
                        placeholder="Write anything you don't want to forget..."
                        style="min-height:200px;"></textarea>
            </div>
            <div class="input-row" style="display:flex; justify-content:space-between; align-items:center;">
              <span id="notesSavedMsg" class="empty-msg" style="display:none;">Saved ‚úì</span>
              <button id="saveNotesTextBtn" class="btn">üíæ Save notes</button>
            </div>
          </div>
    
          <!-- CANVAS NOTES -->
          <div id="notesCanvasSection" class="input-grid" style="display:none;">
            <div class="input-row-inline">
              <!-- Pen color palette -->
              <div class="input-row">
                <label>Pen color</label>
                <div id="notesColorPalette" style="display:flex; gap:6px; flex-wrap:wrap;">
                  <button data-color="#ffffff" class="icon-btn" title="White pen">‚¨ú</button>
                  <button data-color="#000000" class="icon-btn" title="Black pen">‚¨õ</button>
                  <button data-color="#f44336" class="icon-btn" title="Red pen">üü•</button>
                  <button data-color="#2196f3" class="icon-btn" title="Blue pen">üü¶</button>
                  <button data-color="#4caf50" class="icon-btn" title="Green pen">üü©</button>
                  <button data-color="erase" class="icon-btn" title="Eraser">üßΩ</button>
                </div>
              </div>
    
              <!-- Board controls -->
              <div class="input-row" style="display:flex; gap:6px; align-items:flex-end;">
                <div style="display:flex; gap:4px;">
                  <button id="notesBoardDark" class="icon-btn" title="Black board">‚¨õ</button>
                  <button id="notesBoardLight" class="icon-btn" title="White board">‚¨ú</button>
                </div>
                <button id="notesClearCanvas" class="btn btn-secondary" title="Clear canvas">üßπ</button>
                <!-- Expand / shrink icon-only button -->
                <button id="notesToggleCanvasSize"
                        class="btn btn-secondary btn-icon"
                        title="Expand canvas">‚§¢</button>
                <!-- Save canvas as image -->
                <button id="notesSaveCanvas"
                        class="btn btn-secondary btn-icon"
                        title="Save canvas as image">üíæ</button>
              </div>
            </div>
    
            <div class="input-row">
              <div id="notesCanvasWrapper" style="width:100%; max-height:400px; overflow:hidden;">
                <canvas id="notesCanvas"
                        style="border-radius:12px; background:#050608; border:1px solid #26293a; display:block;"></canvas>
              </div>
            </div>
          </div>
        </div>
      `;
    
      const notesTabText = document.getElementById("notesTabText");
      const notesTabCanvas = document.getElementById("notesTabCanvas");
      const notesTextSection = document.getElementById("notesTextSection");
      const notesCanvasSection = document.getElementById("notesCanvasSection");
    
      const notesText = document.getElementById("notesText");
      const saveNotesTextBtn = document.getElementById("saveNotesTextBtn");
      const notesSavedMsg = document.getElementById("notesSavedMsg");
    
      const notesCanvas = document.getElementById("notesCanvas");
      const notesCanvasWrapper = document.getElementById("notesCanvasWrapper");
      const notesColorPalette = document.getElementById("notesColorPalette");
      const notesClearCanvas = document.getElementById("notesClearCanvas");
      const notesToggleCanvasSize = document.getElementById("notesToggleCanvasSize");
      const notesSaveCanvas = document.getElementById("notesSaveCanvas");
      const notesBoardDark = document.getElementById("notesBoardDark");
      const notesBoardLight = document.getElementById("notesBoardLight");
    
      // Restore text notes
      if (notesText) {
        notesText.value = state.notesText || "";
      }
    
      if (saveNotesTextBtn && notesText) {
        saveNotesTextBtn.addEventListener("click", () => {
          state.notesText = notesText.value;
          saveState();
          if (notesSavedMsg) {
            notesSavedMsg.style.display = "inline";
            setTimeout(() => {
              notesSavedMsg.style.display = "none";
            }, 1500);
          }
        });
      }
    
      function activateNotesTab(tab) {
        if (tab === "text") {
          notesTextSection.style.display = "block";
          notesCanvasSection.style.display = "none";
          // canvas mode off ‚Üí sidebar normal
          if (typeof disableCanvasSidebarMode === "function") {
            disableCanvasSidebarMode();
          }
        } else {
          notesTextSection.style.display = "none";
          notesCanvasSection.style.display = "block";
          // just opening canvas doesn't collapse sidebar;
          // collapse only when user presses expand button
        }
      }
    
      if (notesTabText) {
        notesTabText.addEventListener("click", () => activateNotesTab("text"));
      }
      if (notesTabCanvas) {
        notesTabCanvas.addEventListener("click", () => activateNotesTab("canvas"));
      }
    
      // Default tab
      activateNotesTab("text");
    
      // CANVAS LOGIC
      if (notesCanvas && notesCanvasWrapper) {
        const ctx = notesCanvas.getContext("2d");
        let drawing = false;
        let lastX = 0;
        let lastY = 0;
        let strokeColor = "#ffffff"; // default pen color
        let expanded = false;
        let boardBg = "#050608"; // default black-ish board
    
        function fillBoardBackground() {
          ctx.save();
          ctx.globalCompositeOperation = "source-over";
          ctx.fillStyle = boardBg;
          ctx.fillRect(0, 0, notesCanvas.width, notesCanvas.height);
          ctx.restore();
        }
    
        function resizeCanvas() {
          const rect = notesCanvasWrapper.getBoundingClientRect();
          notesCanvas.width = Math.floor(rect.width - 4);
          const maxHeight = Math.min(380, window.innerHeight - 200);
          notesCanvas.height = expanded
            ? Math.min(380, maxHeight)
            : Math.min(240, maxHeight);
    
          // Whenever we resize, refill the board background
          fillBoardBackground();
        }
    
        resizeCanvas();
        window.addEventListener("resize", resizeCanvas);
    
        function startDraw(x, y) {
          drawing = true;
          lastX = x;
          lastY = y;
        }
    
        function drawTo(x, y) {
          if (!drawing) return;
          ctx.lineJoin = "round";
          ctx.lineCap = "round";
          if (strokeColor === "erase") {
            ctx.globalCompositeOperation = "destination-out";
            ctx.strokeStyle = "rgba(0,0,0,1)";
            ctx.lineWidth = 12;
          } else {
            ctx.globalCompositeOperation = "source-over";
            ctx.strokeStyle = strokeColor;
            ctx.lineWidth = 3;
          }
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
          lastX = x;
          lastY = y;
        }
    
        function endDraw() {
          drawing = false;
        }
    
        // Mouse
        notesCanvas.addEventListener("mousedown", (e) => {
          const rect = notesCanvas.getBoundingClientRect();
          startDraw(e.clientX - rect.left, e.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("mousemove", (e) => {
          const rect = notesCanvas.getBoundingClientRect();
          drawTo(e.clientX - rect.left, e.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("mouseup", endDraw);
        notesCanvas.addEventListener("mouseleave", endDraw);
    
        // Touch
        notesCanvas.addEventListener("touchstart", (e) => {
          e.preventDefault();
          const t = e.touches[0];
          const rect = notesCanvas.getBoundingClientRect();
          startDraw(t.clientX - rect.left, t.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("touchmove", (e) => {
          e.preventDefault();
          const t = e.touches[0];
          const rect = notesCanvas.getBoundingClientRect();
          drawTo(t.clientX - rect.left, t.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("touchend", endDraw);
        notesCanvas.addEventListener("touchcancel", endDraw);
    
        // Pen colors
        if (notesColorPalette) {
          notesColorPalette.querySelectorAll("button").forEach((btn) => {
            btn.addEventListener("click", () => {
              const color = btn.getAttribute("data-color");
              strokeColor = color;
            });
          });
        }
    
        // Board background black
        if (notesBoardDark) {
          notesBoardDark.addEventListener("click", () => {
            boardBg = "#050608";
            resizeCanvas(); // refills background
            // default pen to white on dark board
            strokeColor = "#ffffff";
          });
        }
    
        // Board background white
        if (notesBoardLight) {
          notesBoardLight.addEventListener("click", () => {
            boardBg = "#ffffff";
            resizeCanvas(); // refills background
            // default pen to black on light board
            strokeColor = "#000000";
          });
        }
    
        // Clear canvas
        if (notesClearCanvas) {
          notesClearCanvas.addEventListener("click", () => {
            ctx.clearRect(0, 0, notesCanvas.width, notesCanvas.height);
            fillBoardBackground();
          });
        }
    
        // Expand / shrink canvas (icon only) + collapse sidebar only in expanded mode
        if (notesToggleCanvasSize) {
          notesToggleCanvasSize.addEventListener("click", () => {
            expanded = !expanded;
            notesToggleCanvasSize.textContent = expanded ? "‚§°" : "‚§¢";
            if (expanded && typeof enableCanvasSidebarMode === "function") {
              enableCanvasSidebarMode();
            } else if (!expanded && typeof disableCanvasSidebarMode === "function") {
              disableCanvasSidebarMode();
            }
            resizeCanvas();
          });
        }
    
        // Save canvas as PNG
        if (notesSaveCanvas) {
          notesSaveCanvas.addEventListener("click", () => {
            const dataURL = notesCanvas.toDataURL("image/png");
            const link = document.createElement("a");
            link.href = dataURL;
            link.download = "notes_canvas.png";
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
          });
        }
      }
    }

  
    // -----------------------------
    // MEALS ‚Äì basic macros per day
    // -----------------------------
    const mealsPage = document.querySelector('.page[data-page="meals"]');
    if (mealsPage) {
      mealsPage.innerHTML = `
        <h2 class="section-title">Meals</h2>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Add meal (from library)</div>
          </div>
          <div class="input-grid">
            <div class="input-row-inline">
              <div class="input-row">
                <label for="mealDate">Date</label>
                <input id="mealDate" type="date" />
              </div>
              <div class="input-row">
                <label for="mealFood">Food</label>
                <input id="mealFood" type="text" placeholder="Type and pick from library‚Ä¶" list="foodSuggestions" />
                <datalist id="foodSuggestions"></datalist>
                <div id="mealFoodHint" class="muted" style="margin-top:6px; font-size:12px;">
                  Pick a food.
                </div>
                <button id="quickAddFoodBtn" class="btn btn-secondary" style="margin-top:10px; display:none;">‚ûï Add this food to library</button>

                <div id="quickAddFoodPanel" class="card" style="margin-top:10px; display:none;">
                  <div class="card-header">
                    <div class="card-title">Add food to library</div>
                  </div>
                  <div class="input-grid">
                    <div class="input-row-inline">
                      <div class="input-row">
                        <label for="quickBaseAmount">Base amount</label>
                        <input id="quickBaseAmount" type="number" step="0.01" min="0" value="1" />
                      </div>
                      <div class="input-row">
                        <label for="quickBaseUnit">Base unit</label>
                        <select id="quickBaseUnit">
                          <option value="g">g</option>
                          <option value="ml">ml</option>
                          <option value="piece">piece</option>
                          <option value="scoop">scoop</option>
                          <option value="sachet">sachet</option>
                          <option value="cup">cup</option>
                          <option value="slice">slice</option>
                          <option value="bottle">bottle</option>
                          <option value="bar">bar</option>
                          <option value="bag">bag</option>
                          <option value="skewer">skewer</option>
                          <option value="ladle">ladle</option>
                          <option value="other">other</option>
                        </select>
                      </div>
                    </div>

                    <div class="input-row-inline">
                      <div class="input-row">
                        <label for="quickKcal">Kcal (per base)</label>
                        <input id="quickKcal" type="number" step="0.1" min="0" />
                      </div>
                      <div class="input-row">
                        <label for="quickProtein">Protein (g)</label>
                        <input id="quickProtein" type="number" step="0.1" min="0" />
                      </div>
                      <div class="input-row">
                        <label for="quickCarbs">Carbs (g)</label>
                        <input id="quickCarbs" type="number" step="0.1" min="0" />
                      </div>
                      <div class="input-row">
                        <label for="quickFat">Fat (g)</label>
                        <input id="quickFat" type="number" step="0.1" min="0" />
                      </div>
                    </div>

                    <div class="input-row-inline">
                      <button id="quickSaveFoodBtn" class="btn" style="flex:1;">‚úÖ Save to library</button>
                      <button id="quickCancelFoodBtn" class="btn btn-secondary" style="flex:1;">‚úñ Cancel</button>
                    </div>
                  </div>
                </div>

              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="mealAmount">Amount</label>
                <input id="mealAmount" type="number" step="0.01" min="0" placeholder="0" />
              </div>
              <div class="input-row">
                <label for="mealUnit">Unit</label>
                <select id="mealUnit">
                  <option value="g">g</option>
                  <option value="ml">ml</option>
                  <option value="piece">piece</option>
                  <option value="scoop">scoop</option>
                  <option value="sachet">sachet</option>
                  <option value="cup">cup</option>
                  <option value="slice">slice</option>
                  <option value="bottle">bottle</option>
                  <option value="bar">bar</option>
                  <option value="bag">bag</option>
                  <option value="skewer">skewer</option>
                  <option value="ladle">ladle</option>
                  <option value="other">other</option>
                </select>
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="mealKcal">Kcal</label>
                <input id="mealKcal" type="number" step="0.1" min="0" disabled />
              </div>
              <div class="input-row">
                <label for="mealProtein">Protein (g)</label>
                <input id="mealProtein" type="number" step="0.1" min="0" disabled />
              </div>
              <div class="input-row">
                <label for="mealCarbs">Carbs (g)</label>
                <input id="mealCarbs" type="number" step="0.1" min="0" disabled />
              </div>
              <div class="input-row">
                <label for="mealFat">Fat (g)</label>
                <input id="mealFat" type="number" step="0.1" min="0" disabled />
              </div>
            </div>

            <div class="input-row" style="align-items:flex-end;">
              <button id="addMealBtn" class="btn">‚ûï Add meal</button>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Daily log</div>
          </div>
          <div class="input-grid">
            <div class="input-row">
              <label for="mealViewDate">View date</label>
              <input id="mealViewDate" type="date" />
            </div>
          </div>
          <div id="mealsEmptyMsg" class="empty-msg">No meals yet.</div>
          <div id="mealsList" class="list"></div>
          <div id="mealsTotals" class="empty-msg" style="margin-top:8px;"></div>
        </div>
`;

      const mealDateInput = document.getElementById("mealDate");
      const mealFoodInput = document.getElementById("mealFood");
      const mealAmountInput = document.getElementById("mealAmount");
      const mealUnitSelect = document.getElementById("mealUnit");
      const mealKcalInput = document.getElementById("mealKcal");
      const mealProteinInput = document.getElementById("mealProtein");
      const mealCarbsInput = document.getElementById("mealCarbs");
      const mealFatInput = document.getElementById("mealFat");
      const mealFoodHint = document.getElementById("mealFoodHint");

      const quickAddFoodBtn = document.getElementById("quickAddFoodBtn");
      const quickAddFoodPanel = document.getElementById("quickAddFoodPanel");
      const quickBaseAmount = document.getElementById("quickBaseAmount");
      const quickBaseUnit = document.getElementById("quickBaseUnit");
      const quickKcal = document.getElementById("quickKcal");
      const quickProtein = document.getElementById("quickProtein");
      const quickCarbs = document.getElementById("quickCarbs");
      const quickFat = document.getElementById("quickFat");
      const quickSaveFoodBtn = document.getElementById("quickSaveFoodBtn");
      const quickCancelFoodBtn = document.getElementById("quickCancelFoodBtn");

      const foodSuggestions = document.getElementById("foodSuggestions");
      const addMealBtn = document.getElementById("addMealBtn");

      const mealViewDateInput = document.getElementById("mealViewDate");
      const mealsEmptyMsg = document.getElementById("mealsEmptyMsg");
      const mealsListContainer = document.getElementById("mealsList");
      const mealsTotals = document.getElementById("mealsTotals");

      // Library controls
      const libFoodName = document.getElementById("libFoodName");
      const libBaseAmount = document.getElementById("libBaseAmount");
      const libBaseUnit = document.getElementById("libBaseUnit");
      const libKcal = document.getElementById("libKcal");
      const libProtein = document.getElementById("libProtein");
      const libCarbs = document.getElementById("libCarbs");
      const libFat = document.getElementById("libFat");
      const addFoodBtn = document.getElementById("addFoodBtn");
      const updateFoodBtn = document.getElementById("updateFoodBtn");
      const cancelEditFoodBtn = document.getElementById("cancelEditFoodBtn");
      const foodLibraryEmptyMsg = document.getElementById("foodLibraryEmptyMsg");
      const foodLibraryList = document.getElementById("foodLibraryList");

      const todayStr = new Date().toISOString().slice(0, 10);
      if (mealDateInput) mealDateInput.value = todayStr;
      if (mealViewDateInput) mealViewDateInput.value = todayStr;

      state.foodLibrary = state.foodLibrary || [];
      state.meals = state.meals || [];

      let editingFoodId = null;
      let selectedFoodId = null;

      function normName(s) {
        return String(s || "").trim().toLowerCase();
      }

      function findFoodByName(name) {
        const n = normName(name);
        if (!n) return null;
        return (state.foodLibrary || []).find(f => normName(f.name) === n) || null;
      }

      function foodMultiplier(food, amount, unit) {
        const baseAmt = parseFloat(food.baseAmount || 0);
        if (!baseAmt || baseAmt <= 0) return 0;

        const baseUnit = food.baseUnit || "g";
        if (unit !== baseUnit) {
          // For now, require matching units (simple + safe)
          return null;
        }
        return (amount || 0) / baseAmt;
      }

      function setMealMacrosFromFood(food) {
        const amt = parseFloat(mealAmountInput?.value || "0") || 0;
        const unit = mealUnitSelect?.value || (food?.baseUnit || "g");

        if (!food) {
          selectedFoodId = null;
          if (mealKcalInput) mealKcalInput.value = "";
          if (mealProteinInput) mealProteinInput.value = "";
          if (mealCarbsInput) mealCarbsInput.value = "";
          if (mealFatInput) mealFatInput.value = "";
          if (mealFoodHint) mealFoodHint.textContent = "Pick a food.";
          if (quickAddFoodBtn) quickAddFoodBtn.style.display = "none";
          if (quickAddFoodPanel) quickAddFoodPanel.style.display = "none";
          return;
        }

        selectedFoodId = food.id;

        // Align unit with food's base unit
        if (mealUnitSelect) mealUnitSelect.value = food.baseUnit || "g";

        const mult = foodMultiplier(food, amt, mealUnitSelect?.value || "g");
        if (mult === null) {
          if (quickAddFoodBtn) quickAddFoodBtn.style.display = "none";
          if (quickAddFoodPanel) quickAddFoodPanel.style.display = "none";
          if (mealFoodHint) mealFoodHint.textContent = `Unit mismatch: this food is stored per ${food.baseAmount}${food.baseUnit}.`;
          if (mealKcalInput) mealKcalInput.value = "";
          if (mealProteinInput) mealProteinInput.value = "";
          if (mealCarbsInput) mealCarbsInput.value = "";
          if (mealFatInput) mealFatInput.value = "";
          return;
        }

        const kcal = (parseFloat(food.kcal || 0) * mult);
        const p = (parseFloat(food.protein || 0) * mult);
        const c = (parseFloat(food.carbs || 0) * mult);
        const f = (parseFloat(food.fat || 0) * mult);

        if (mealKcalInput) mealKcalInput.value = kcal ? kcal.toFixed(0) : "0";
        if (mealProteinInput) mealProteinInput.value = p ? p.toFixed(1) : "0";
        if (mealCarbsInput) mealCarbsInput.value = c ? c.toFixed(1) : "0";
        if (mealFatInput) mealFatInput.value = f ? f.toFixed(1) : "0";

        if (mealFoodHint) mealFoodHint.textContent = `Library: ${food.name} (${food.kcal} kcal / ${food.baseAmount}${food.baseUnit})`;
        if (quickAddFoodBtn) quickAddFoodBtn.style.display = "none";
        if (quickAddFoodPanel) quickAddFoodPanel.style.display = "none";
      }

      function renderFoodSuggestions() {
        if (!foodSuggestions) return;
        foodSuggestions.innerHTML = "";
        const foods = (state.foodLibrary || []).slice().sort((a,b) => normName(a.name).localeCompare(normName(b.name)));
        foods.forEach(f => {
          const opt = document.createElement("option");
          opt.value = f.name;
          foodSuggestions.appendChild(opt);
        });
      }

      function clearFoodForm() {
        editingFoodId = null;
        if (libFoodName) libFoodName.value = "";
        if (libBaseAmount) libBaseAmount.value = "100";
        if (libBaseUnit) libBaseUnit.value = "g";
        if (libKcal) libKcal.value = "";
        if (libProtein) libProtein.value = "";
        if (libCarbs) libCarbs.value = "";
        if (libFat) libFat.value = "";

        if (addFoodBtn) addFoodBtn.style.display = "";
        if (updateFoodBtn) updateFoodBtn.style.display = "none";
        if (cancelEditFoodBtn) cancelEditFoodBtn.style.display = "none";
      }

      function renderFoodLibrary() {
        if (!foodLibraryList || !foodLibraryEmptyMsg) return;
        const foods = (state.foodLibrary || []);
        foodLibraryList.innerHTML = "";

        if (foods.length === 0) {
          foodLibraryEmptyMsg.style.display = "block";
          return;
        }
        foodLibraryEmptyMsg.style.display = "none";

        foods
          .slice()
          .sort((a,b) => normName(a.name).localeCompare(normName(b.name)))
          .forEach(food => {
            const item = document.createElement("div");
            item.className = "item";

            const main = document.createElement("div");
            main.className = "item-main";

            const title = document.createElement("div");
            title.className = "item-title";
            title.textContent = food.name;

            const meta = document.createElement("div");
            meta.className = "item-meta";
            meta.textContent = `${food.kcal} kcal | P ${food.protein}g | C ${food.carbs}g | F ${food.fat}g (per ${food.baseAmount}${food.baseUnit})`;

            main.appendChild(title);
            main.appendChild(meta);

            const actions = document.createElement("div");
            actions.className = "item-actions";

            const useBtn = document.createElement("button");
            useBtn.className = "icon-btn";
            useBtn.textContent = "‚ûï";
            useBtn.title = "Use this food";
            useBtn.addEventListener("click", () => {
              if (mealFoodInput) mealFoodInput.value = food.name;
              selectedFoodId = food.id;
              if (mealUnitSelect) mealUnitSelect.value = food.baseUnit || "g";
              setMealMacrosFromFood(food);
            });

            const editBtn = document.createElement("button");
            editBtn.className = "icon-btn";
            editBtn.textContent = "‚úèÔ∏è";
            editBtn.title = "Edit food";
            editBtn.addEventListener("click", () => {
              editingFoodId = food.id;
              if (libFoodName) libFoodName.value = food.name || "";
              if (libBaseAmount) libBaseAmount.value = food.baseAmount != null ? String(food.baseAmount) : "100";
              if (libBaseUnit) libBaseUnit.value = food.baseUnit || "g";
              if (libKcal) libKcal.value = food.kcal != null ? String(food.kcal) : "";
              if (libProtein) libProtein.value = food.protein != null ? String(food.protein) : "";
              if (libCarbs) libCarbs.value = food.carbs != null ? String(food.carbs) : "";
              if (libFat) libFat.value = food.fat != null ? String(food.fat) : "";

              if (addFoodBtn) addFoodBtn.style.display = "none";
              if (updateFoodBtn) updateFoodBtn.style.display = "";
              if (cancelEditFoodBtn) cancelEditFoodBtn.style.display = "";
            });

            const delBtn = document.createElement("button");
            delBtn.className = "icon-btn danger";
            delBtn.textContent = "üóëÔ∏è";
            delBtn.title = "Delete food";
            delBtn.addEventListener("click", () => {
              if (!confirm(`Delete "${food.name}" from library?`)) return;
              state.foodLibrary = (state.foodLibrary || []).filter(f => f.id !== food.id);
              // Unselect if it was selected
              if (selectedFoodId === food.id) {
                selectedFoodId = null;
                if (mealFoodInput) mealFoodInput.value = "";
                setMealMacrosFromFood(null);
              }
              saveState();
              renderFoodSuggestions();
              renderFoodLibrary();
              renderMeals();
            });

            actions.appendChild(useBtn);
            actions.appendChild(editBtn);
            actions.appendChild(delBtn);

            item.appendChild(main);
            item.appendChild(actions);
            foodLibraryList.appendChild(item);
          });
      }

      function renderMeals() {
        if (!mealsListContainer || !mealsEmptyMsg || !mealsTotals) return;
        const date = mealViewDateInput?.value || todayStr;
        mealsListContainer.innerHTML = "";

        const entries = (state.meals || []).filter((m) => m.date === date);
        if (entries.length === 0) {
          mealsEmptyMsg.style.display = "block";
          mealsTotals.textContent = "";
          return;
        }
        mealsEmptyMsg.style.display = "none";

        const totals = { kcal: 0, protein: 0, carbs: 0, fat: 0 };

        entries.forEach((m) => {
          totals.kcal += (m.kcal || 0);
          totals.protein += (m.protein || 0);
          totals.carbs += (m.carbs || 0);
          totals.fat += (m.fat || 0);

          const item = document.createElement("div");
          item.className = "item";

          const main = document.createElement("div");
          main.className = "item-main";

          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = `${m.foodName || m.food || "Meal"} ‚Äì ${m.amount || 0}${m.unit || ""}`;

          const meta = document.createElement("div");
          meta.className = "item-meta";
          meta.textContent = `${(m.kcal || 0).toFixed(0)} kcal | P ${(m.protein || 0).toFixed(1)}g | C ${(m.carbs || 0).toFixed(1)}g | F ${(m.fat || 0).toFixed(1)}g`;

          main.appendChild(title);
          main.appendChild(meta);

          const actions = document.createElement("div");
          actions.className = "item-actions";

          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóëÔ∏è";
          delBtn.title = "Delete meal";
          delBtn.addEventListener("click", () => {
            state.meals = (state.meals || []).filter((x) => x.id !== m.id);
            saveState();
            renderMeals();
          });

          actions.appendChild(delBtn);
          item.appendChild(main);
          item.appendChild(actions);
          mealsListContainer.appendChild(item);
        });

        mealsTotals.textContent = `Totals ‚Äì ${(totals.kcal).toFixed(0)} kcal | Protein: ${totals.protein.toFixed(
          1
        )}g | Carbs: ${totals.carbs.toFixed(1)}g | Fat: ${totals.fat.toFixed(1)}g`;
      }

      function readFoodForm() {
        const name = (libFoodName?.value || "").trim();
        const baseAmount = parseFloat(libBaseAmount?.value || "0") || 0;
        const baseUnit = libBaseUnit?.value || "g";
        const kcal = parseFloat(libKcal?.value || "0") || 0;
        const protein = parseFloat(libProtein?.value || "0") || 0;
        const carbs = parseFloat(libCarbs?.value || "0") || 0;
        const fat = parseFloat(libFat?.value || "0") || 0;

        if (!name) return { error: "Name is required." };
        if (!baseAmount || baseAmount <= 0) return { error: "Base amount must be > 0." };
        return { name, baseAmount, baseUnit, kcal, protein, carbs, fat };
      }

      if (addFoodBtn) {
        addFoodBtn.addEventListener("click", () => {
          const data = readFoodForm();
          if (data.error) return alert(data.error);

          const exists = findFoodByName(data.name);
          if (exists) {
            if (!confirm(`"${data.name}" already exists. Update it?`)) return;
            exists.baseAmount = data.baseAmount;
            exists.baseUnit = data.baseUnit;
            exists.kcal = data.kcal;
            exists.protein = data.protein;
            exists.carbs = data.carbs;
            exists.fat = data.fat;
          } else {
            state.foodLibrary.push({
              id: makeId("food"),
              ...data
            });
          }

          saveState();
          renderFoodSuggestions();
          renderFoodLibrary();
          clearFoodForm();
        });
      }

      if (updateFoodBtn) {
        updateFoodBtn.addEventListener("click", () => {
          const data = readFoodForm();
          if (data.error) return alert(data.error);
          const idx = (state.foodLibrary || []).findIndex(f => f.id === editingFoodId);
          if (idx < 0) return alert("Food not found.");
          state.foodLibrary[idx] = { ...state.foodLibrary[idx], ...data };
          saveState();
          renderFoodSuggestions();
          renderFoodLibrary();
          clearFoodForm();
        });
      }

      if (cancelEditFoodBtn) {
        cancelEditFoodBtn.addEventListener("click", () => clearFoodForm());
      }

      
      function openQuickAddFood() {
        if (!quickAddFoodPanel) return;
        const name = (mealFoodInput?.value || "").trim();
        if (!name) return;

        // Prefill base unit from current selection (or default)
        const unit = mealUnitSelect?.value || "g";
        if (quickBaseUnit) quickBaseUnit.value = unit;
        if (quickBaseAmount) quickBaseAmount.value = (unit === "g" || unit === "ml") ? "100" : "1";

        // If user already has calculated fields (manual), prefill from them
        if (quickKcal && mealKcalInput?.value) quickKcal.value = mealKcalInput.value;
        if (quickProtein && mealProteinInput?.value) quickProtein.value = mealProteinInput.value;
        if (quickCarbs && mealCarbsInput?.value) quickCarbs.value = mealCarbsInput.value;
        if (quickFat && mealFatInput?.value) quickFat.value = mealFatInput.value;

        quickAddFoodPanel.style.display = "block";
        if (quickAddFoodBtn) quickAddFoodBtn.style.display = "none";
      }

      function closeQuickAddFood() {
        if (quickAddFoodPanel) quickAddFoodPanel.style.display = "none";
        // keep button visible if name typed and still not found
        const food = resolveSelectedFood();
        const name = (mealFoodInput?.value || "").trim();
        if (!food && name) {
          if (quickAddFoodBtn) quickAddFoodBtn.style.display = "";
        }
      }

      function saveQuickFood() {
        const name = (mealFoodInput?.value || "").trim();
        if (!name) return;

        const baseAmount = parseFloat(quickBaseAmount?.value || "0") || 0;
        const baseUnit = quickBaseUnit?.value || "g";
        const kcal = parseFloat(quickKcal?.value || "0") || 0;
        const protein = parseFloat(quickProtein?.value || "0") || 0;
        const carbs = parseFloat(quickCarbs?.value || "0") || 0;
        const fat = parseFloat(quickFat?.value || "0") || 0;

        if (!baseAmount || baseAmount <= 0) return alert("Base amount must be > 0.");
        // Prevent duplicates by exact name match
        const exists = findFoodByName(name);
        if (exists) {
          // update existing
          exists.baseAmount = baseAmount;
          exists.baseUnit = baseUnit;
          exists.kcal = kcal;
          exists.protein = protein;
          exists.carbs = carbs;
          exists.fat = fat;
        } else {
          state.foodLibrary.push({
            id: makeId("food"),
            name,
            baseAmount,
            baseUnit,
            kcal,
            protein,
            carbs,
            fat
          });
        }

        saveState();
        renderFoodSuggestions();

        // Select and calculate now
        if (mealUnitSelect) mealUnitSelect.value = baseUnit;
        setMealMacrosFromFood(findFoodByName(name));
        closeQuickAddFood();
      }

      if (quickAddFoodBtn) quickAddFoodBtn.addEventListener("click", openQuickAddFood);
      if (quickCancelFoodBtn) quickCancelFoodBtn.addEventListener("click", closeQuickAddFood);
      if (quickSaveFoodBtn) quickSaveFoodBtn.addEventListener("click", saveQuickFood);

function resolveSelectedFood() {
        const foodName = (mealFoodInput?.value || "").trim();
        if (!foodName) return null;
        const food = findFoodByName(foodName);
        return food;
      }

      if (mealFoodInput) {
        mealFoodInput.addEventListener("input", () => {
          const food = resolveSelectedFood();
          if (food) {
            setMealMacrosFromFood(food);
          } else {
            // If user typed a name that is not in the library yet, offer quick add
            const name = (mealFoodInput.value || "").trim();
            if (name) {
              if (quickAddFoodBtn) quickAddFoodBtn.style.display = "";
              if (mealFoodHint) mealFoodHint.textContent = "Not in library yet. You can add it to calculate macros.";
            } else {
              if (quickAddFoodBtn) quickAddFoodBtn.style.display = "none";
              if (quickAddFoodPanel) quickAddFoodPanel.style.display = "none";
              if (mealFoodHint) mealFoodHint.textContent = "Pick a food.";
            }
            // clear calculated fields
            if (mealKcalInput) mealKcalInput.value = "";
            if (mealProteinInput) mealProteinInput.value = "";
            if (mealCarbsInput) mealCarbsInput.value = "";
            if (mealFatInput) mealFatInput.value = "";
          }
        });
        mealFoodInput.addEventListener("change", () => {
          const food = resolveSelectedFood();
          setMealMacrosFromFood(food);
        });
        mealFoodInput.addEventListener("blur", () => {
          const food = resolveSelectedFood();
          setMealMacrosFromFood(food);
        });
      }

      if (mealAmountInput) {
        mealAmountInput.addEventListener("input", () => {
          const food = resolveSelectedFood();
          setMealMacrosFromFood(food);
        });
      }

      if (mealUnitSelect) {
        mealUnitSelect.addEventListener("change", () => {
          const food = resolveSelectedFood();
          setMealMacrosFromFood(food);
        });
      }

      if (addMealBtn) {
        addMealBtn.addEventListener("click", () => {
          const date = mealDateInput?.value || todayStr;
          const foodName = (mealFoodInput?.value || "").trim();
          if (!foodName) return;

          const food = findFoodByName(foodName);
          if (!food) {
            alert("This food is not in your library yet. Add it in the Food library section first.");
            return;
          }

          const amount = parseFloat(mealAmountInput?.value || "0") || 0;
          const unit = mealUnitSelect?.value || (food.baseUnit || "g");

          const mult = foodMultiplier(food, amount, unit);
          if (mult === null) {
          if (quickAddFoodBtn) quickAddFoodBtn.style.display = "none";
          if (quickAddFoodPanel) quickAddFoodPanel.style.display = "none";
            alert(`Unit mismatch. This food is stored per ${food.baseAmount}${food.baseUnit}. Please use the same unit.`);
            return;
          }

          const kcal = parseFloat(food.kcal || 0) * mult;
          const p = parseFloat(food.protein || 0) * mult;
          const c = parseFloat(food.carbs || 0) * mult;
          const f = parseFloat(food.fat || 0) * mult;

          state.meals.push({
            id: makeId("meal"),
            date,
            foodId: food.id,
            foodName: food.name,
            amount,
            unit,
            kcal,
            protein: p,
            carbs: c,
            fat: f,
            createdAt: Date.now(),
          });

          saveState();

          // clear inputs (keep date)
          if (mealFoodInput) mealFoodInput.value = "";
          if (mealAmountInput) mealAmountInput.value = "";
          selectedFoodId = null;
          setMealMacrosFromFood(null);

          if (mealViewDateInput) mealViewDateInput.value = date;
          renderMeals();
        });
      }

      if (mealViewDateInput) {
        mealViewDateInput.addEventListener("change", renderMeals);
      }

      // Defaults
      if (libBaseAmount && !libBaseAmount.value) libBaseAmount.value = "100";
      renderFoodSuggestions();
      renderFoodLibrary();
      clearFoodForm();
      renderMeals();
    }
  
    // -----------------------------
    // CALENDAR ‚Äì Month / Week / Day + To-do linking
    // -----------------------------
    const calendarPage = document.querySelector('.page[data-page="calendar"]');
    if (calendarPage) {
    // Ensure state buckets exist
    state.calendarEvents = state.calendarEvents || [];   // [{id,date,text}]
    state.calendarLinks  = state.calendarLinks  || {};   // {"YYYY-MM-DD":[todoId,...]}
    state.weekFocus      = state.weekFocus      || { Mon:"", Tue:"", Wed:"", Thu:"", Fri:"", Sat:"", Sun:"" };

    calendarPage.innerHTML = `
        <h2 class="section-title">Calendar</h2>

        <div class="card">
        <div class="card-header" style="justify-content:space-between; align-items:center; gap:10px;">
            <div class="card-title" id="calTitle">Monthly view</div>

            <div style="display:flex; gap:6px; flex-wrap:wrap; justify-content:flex-end;">
            <button id="calViewMonth" class="btn btn-secondary btn-icon" title="Month">üóìÔ∏è</button>
            <button id="calViewWeek"  class="btn btn-secondary btn-icon" title="Week">üìÜ</button>
            <button id="calViewDay"   class="btn btn-secondary btn-icon" title="Day">üìã</button>
            </div>
        </div>

        <div class="input-grid" style="margin-top:6px;">
            <div class="input-row-inline" style="align-items:center;">
            <button id="calPrev" class="btn btn-secondary btn-icon">‚óÄ</button>

            <div class="input-row" style="flex:1; text-align:center;">
                <label id="calLabel" style="display:block;"></label>
            </div>

            <button id="calNext" class="btn btn-secondary btn-icon">‚ñ∂</button>
            </div>
        </div>

        <div id="calendarBody" style="margin-top:10px;"></div>
        </div>
    `;

    const calTitle = document.getElementById("calTitle");
    const calViewMonthBtn = document.getElementById("calViewMonth");
    const calViewWeekBtn  = document.getElementById("calViewWeek");
    const calViewDayBtn   = document.getElementById("calViewDay");

    const calPrevBtn = document.getElementById("calPrev");
    const calNextBtn = document.getElementById("calNext");
    const calLabel   = document.getElementById("calLabel");
    const calBody    = document.getElementById("calendarBody");

    // Calendar cursor
    const today = new Date();
    let viewMode = "month"; // "month" | "week" | "day"
    let cursor = new Date(today.getFullYear(), today.getMonth(), today.getDate()); // current selected date
    let monthCursorYear  = cursor.getFullYear();
    let monthCursorMonth = cursor.getMonth();

    const WEEKDAYS = ["Mon","Tue","Wed","Thu","Fri","Sat","Sun"];

    function pad2(n){ return String(n).padStart(2,"0"); }

    function toDateStr(d){
        // local date -> YYYY-MM-DD (avoid timezone weirdness)
        const y = d.getFullYear();
        const m = pad2(d.getMonth()+1);
        const day = pad2(d.getDate());
        return `${y}-${m}-${day}`;
    }

    function fromDateStr(s){
        // YYYY-MM-DD -> Date (local)
        const [y,m,d] = s.split("-").map(Number);
        return new Date(y, (m-1), d);
    }

    function isTodayStr(dateStr){
        return dateStr === toDateStr(new Date());
    }

    function getEventsForDate(dateStr){
        return (state.calendarEvents || []).filter(e => e.date === dateStr);
    }

    function getLinkedTodoIds(dateStr){
        const arr = state.calendarLinks?.[dateStr];
        return Array.isArray(arr) ? arr : [];
    }

    function ensureTodoLinkedToDueDate(todo){
        // If todo has dueDate, keep it linked in calendarLinks as well (id-based)
        if (!todo?.id) return;
        const due = todo.dueDate || "";
        if (!due) return;
        state.calendarLinks[due] = state.calendarLinks[due] || [];
        if (!state.calendarLinks[due].includes(todo.id)) {
        state.calendarLinks[due].push(todo.id);
        }
    }

    function getTodosForDate(dateStr){
        const all = state.todos || [];

        // 1) linked by id
        const linkedIds = new Set(getLinkedTodoIds(dateStr));
        const linkedTodos = all.filter(t => linkedIds.has(t.id));

        // 2) also include todos whose dueDate matches (compat)
        const dueTodos = all.filter(t => (t.dueDate || "") === dateStr);

        // merge unique by id
        const map = new Map();
        [...linkedTodos, ...dueTodos].forEach(t => map.set(t.id, t));

        // keep links consistent
        map.forEach(t => ensureTodoLinkedToDueDate(t));

        return Array.from(map.values());
    }

    function countHasStuff(dateStr){
        const ev = getEventsForDate(dateStr).length;
        const td = getTodosForDate(dateStr).length;
        return (ev + td) > 0;
    }

    function setActiveViewButtons(){
        const on = (btn, active) => {
        if (!btn) return;
        btn.classList.toggle("nav-active", active);
        };
        on(calViewMonthBtn, viewMode==="month");
        on(calViewWeekBtn,  viewMode==="week");
        on(calViewDayBtn,   viewMode==="day");
    }

    function setHeaderLabel(){
        if (!calLabel || !calTitle) return;

        if (viewMode === "month") {
        const d = new Date(monthCursorYear, monthCursorMonth, 1);
        calTitle.textContent = "Monthly view";
        calLabel.textContent = d.toLocaleString(undefined, { month:"long", year:"numeric" });
        }

        if (viewMode === "week") {
        calTitle.textContent = "Weekly view";
        const monday = getMonday(cursor);
        const sunday = new Date(monday); sunday.setDate(monday.getDate()+6);
        calLabel.textContent =
            `${monday.toLocaleDateString(undefined,{month:"short",day:"numeric"})} ‚Äì ${sunday.toLocaleDateString(undefined,{month:"short",day:"numeric", year:"numeric"})}`;
        }

        if (viewMode === "day") {
        calTitle.textContent = "Daily view";
        calLabel.textContent = cursor.toLocaleDateString(undefined, { weekday:"long", year:"numeric", month:"long", day:"numeric" });
        }
    }

    function getMonday(d){
        // Monday as first day
        const x = new Date(d.getFullYear(), d.getMonth(), d.getDate());
        const day = x.getDay(); // Sun=0..Sat=6
        const mondayOffset = (day + 6) % 7; // Mon=0
        x.setDate(x.getDate() - mondayOffset);
        return x;
    }

    function renderMonth(){
        if (!calBody) return;

        const firstOfMonth = new Date(monthCursorYear, monthCursorMonth, 1);
        const startDay = (firstOfMonth.getDay() + 6) % 7; // Monday=0
        const daysInMonth = new Date(monthCursorYear, monthCursorMonth + 1, 0).getDate();

        const weeks = [];
        let currentDay = 1;

        for (let row=0; row<6; row++){
        const week = [];
        for (let col=0; col<7; col++){
            if (row===0 && col<startDay) week.push(null);
            else if (currentDay>daysInMonth) week.push(null);
            else { week.push(currentDay); currentDay++; }
        }
        weeks.push(week);
        }

        let html = `
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:11px; color:#a0a4b8;">
            ${WEEKDAYS.map(w=>`<div style="text-align:center; padding:4px 0;">${w}</div>`).join("")}
        </div>
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-top:4px;">
        `;

        weeks.forEach(week=>{
        week.forEach(day=>{
            if (!day){
            html += `<div style="height:40px; border-radius:10px; background:#0b0d14;"></div>`;
            } else {
            const dateStr = toDateStr(new Date(monthCursorYear, monthCursorMonth, day));
            const has = countHasStuff(dateStr);
            const todayStyle = isTodayStr(dateStr)
                ? "border:1px solid rgba(0,188,212,0.9); box-shadow:0 0 0 1px rgba(0,188,212,0.35);"
                : `border:1px solid ${has ? "rgba(0,188,212,0.6)" : "#26293a"};`;

            html += `
                <div data-date="${dateStr}"
                style="
                    height:40px;
                    border-radius:10px;
                    background:#101320;
                    ${todayStyle}
                    display:flex;
                    flex-direction:column;
                    align-items:center;
                    justify-content:center;
                    font-size:12px;
                    cursor:pointer;
                    position:relative;
                ">
                <span>${day}</span>
                ${has ? `<span style="width:6px;height:6px;border-radius:999px;background:#00bcd4;position:absolute;bottom:5px;"></span>` : ""}
                </div>
            `;
            }
        });
        });

        html += `</div>`;
        calBody.innerHTML = html;

        calBody.querySelectorAll("[data-date]").forEach(cell=>{
        cell.addEventListener("click", ()=>{
            const dateStr = cell.getAttribute("data-date");
            cursor = fromDateStr(dateStr);
            viewMode = "day";
            setActiveViewButtons();
            setHeaderLabel();
            renderCalendar();
        });
        });
    }

    function renderWeek(){
        if (!calBody) return;
        const monday = getMonday(cursor);

        let html = `
        <div style="display:grid; grid-template-columns:repeat(7,1fr); gap:6px;">
        `;

        for (let i=0; i<7; i++){
        const d = new Date(monday); d.setDate(monday.getDate()+i);
        const dateStr = toDateStr(d);
        const todos = getTodosForDate(dateStr);
        const evts  = getEventsForDate(dateStr);

        const header = `${WEEKDAYS[i]} ${pad2(d.getDate())}`;
        const isT = isTodayStr(dateStr);

        const focusKey = WEEKDAYS[i];
        const focusVal = state.weekFocus?.[focusKey] || "";

        html += `
            <div data-date="${dateStr}"
            style="
                border-radius:14px;
                border:1px solid ${isT ? "rgba(0,188,212,0.85)" : "#26293a"};
                background:#101320;
                padding:8px;
                min-height:120px;
                cursor:pointer;
                position:relative;
            ">
            <div style="display:flex; align-items:center; justify-content:space-between; gap:6px; margin-bottom:6px;">
                <div style="font-size:12px; font-weight:600; color:#f5f5f5;">${header}</div>
                ${(todos.length+evts.length)>0 ? `<span style="width:6px;height:6px;border-radius:999px;background:#00bcd4;"></span>` : ``}
            </div>

            <div style="font-size:11px; color:#a0a4b8; margin-bottom:6px;">
                Focus:
            </div>
            <input data-focus="${focusKey}" type="text"
                value="${escapeHtml(focusVal)}"
                placeholder="e.g. Study / Gym / Rest‚Ä¶"
                style="width:100%; padding:7px 9px; border-radius:999px; border:1px solid #26293a; background:#0f1220; color:#f5f5f5; font-size:12px; outline:none;"
            />

            <div style="margin-top:8px; font-size:11px; color:#a0a4b8;">
                ${todos.length ? `‚úÖ ${Math.min(2,todos.length)} todo(s)` : `‚úÖ 0 todo`}
                ${evts.length ? ` ‚Ä¢ üìå ${Math.min(2,evts.length)} event(s)` : ``}
            </div>
            </div>
        `;
        }

        html += `</div>`;
        calBody.innerHTML = html;

        // Focus inputs save
        calBody.querySelectorAll("input[data-focus]").forEach(inp=>{
        inp.addEventListener("input", ()=>{
            const k = inp.getAttribute("data-focus");
            state.weekFocus[k] = inp.value;
            saveState();
        });
        // Prevent click bubbling to day open while typing
        inp.addEventListener("click", (e)=> e.stopPropagation());
        });

        // Clicking a day -> day view
        calBody.querySelectorAll("[data-date]").forEach(cell=>{
        cell.addEventListener("click", ()=>{
            const dateStr = cell.getAttribute("data-date");
            cursor = fromDateStr(dateStr);
            viewMode = "day";
            setActiveViewButtons();
            setHeaderLabel();
            renderCalendar();
        });
        });
    }

    function renderDay(){
        if (!calBody) return;
        const dateStr = toDateStr(cursor);
        const todos = getTodosForDate(dateStr);
        const evts  = getEventsForDate(dateStr);

        // list of open/inprogress todos without dueDate (for linking)
        const linkCandidates = (state.todos || [])
        .filter(t => (!t.dueDate || t.dueDate==="") && (t.status !== "done"))
        .slice(0, 100);

        let html = `
        <div style="display:flex; flex-direction:column; gap:10px;">

            <div style="display:flex; gap:8px; flex-wrap:wrap;">
            <button id="dayAddEvent" class="btn btn-secondary">‚ûï Add event</button>

            <div style="flex:1; min-width:200px;">
                <label style="display:block; font-size:11px; color:#a0a4b8; margin-bottom:4px;">Link a To-do to this day</label>
                <div style="display:flex; gap:6px;">
                <select id="dayTodoSelect" style="flex:1;">
                    <option value="">Select a task‚Ä¶</option>
                    ${linkCandidates.map(t=>`<option value="${t.id}">${escapeHtml(t.title)}</option>`).join("")}
                </select>
                <button id="dayLinkTodoBtn" class="btn">üîó</button>
                </div>
            </div>
            </div>

            <div style="border:1px solid #26293a; border-radius:14px; background:#101320; padding:10px;">
            <div style="font-size:13px; font-weight:600; margin-bottom:6px;">‚úÖ To-dos</div>
            ${
                todos.length === 0
                ? `<div style="font-size:12px; color:#a0a4b8; font-style:italic;">No linked tasks for this day.</div>`
                : `<div style="display:flex; flex-direction:column; gap:6px;">
                    ${todos.map(t=>{
                        const status = t.status || "open";
                        const statusIcon = status==="done" ? "‚úÖ" : (status==="inprogress" ? "üü®" : "‚¨ú");
                        return `
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:12px; border:1px solid #25283a; background:#151826;">
                            <div style="min-width:0;">
                            <div style="font-size:12px; font-weight:600; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">
                                ${statusIcon} ${escapeHtml(t.title)}
                            </div>
                            <div style="font-size:11px; color:#a0a4b8;">
                                ${t.priority ? `Priority: ${escapeHtml(t.priority)}` : "" }
                            </div>
                            </div>
                            <button class="icon-btn danger" data-unlink="${t.id}" title="Unlink from day">‚úñ</button>
                        </div>
                        `;
                    }).join("")}
                    </div>`
            }
            </div>

            <div style="border:1px solid #26293a; border-radius:14px; background:#101320; padding:10px;">
            <div style="font-size:13px; font-weight:600; margin-bottom:6px;">üìå Events</div>
            ${
                evts.length === 0
                ? `<div style="font-size:12px; color:#a0a4b8; font-style:italic;">No events yet.</div>`
                : `<div style="display:flex; flex-direction:column; gap:6px;">
                    ${evts.map(e=>`
                        <div style="display:flex; justify-content:space-between; align-items:center; gap:8px; padding:8px; border-radius:12px; border:1px solid #25283a; background:#151826;">
                        <div style="font-size:12px; min-width:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis;">${escapeHtml(e.text)}</div>
                        <button class="icon-btn danger" data-del-event="${e.id}" title="Delete event">üóë</button>
                        </div>
                    `).join("")}
                    </div>`
            }
            </div>

        </div>
        `;

        calBody.innerHTML = html;

        // Add event
        const dayAddEvent = document.getElementById("dayAddEvent");
        if (dayAddEvent) {
        dayAddEvent.addEventListener("click", ()=>{
            const text = prompt(`Add event for ${dateStr}:`);
            if (!text) return;
            state.calendarEvents.push({ id: makeId("event"), date: dateStr, text: text.trim() });
            saveState();
            renderCalendar();
        });
        }

        // Link todo
        const dayTodoSelect = document.getElementById("dayTodoSelect");
        const dayLinkTodoBtn = document.getElementById("dayLinkTodoBtn");
        if (dayLinkTodoBtn && dayTodoSelect) {
        dayLinkTodoBtn.addEventListener("click", ()=>{
            const todoId = dayTodoSelect.value;
            if (!todoId) return;

            state.calendarLinks[dateStr] = state.calendarLinks[dateStr] || [];
            if (!state.calendarLinks[dateStr].includes(todoId)) {
            state.calendarLinks[dateStr].push(todoId);
            }

            // also set dueDate on todo for consistency
            const t = (state.todos || []).find(x=>x.id===todoId);
            if (t) t.dueDate = dateStr;

            saveState();
            renderCalendar();
        });
        }

        // Unlink todo from day
        calBody.querySelectorAll("[data-unlink]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
            const todoId = btn.getAttribute("data-unlink");
            state.calendarLinks[dateStr] = (state.calendarLinks[dateStr] || []).filter(id=>id!==todoId);

            // optional: do NOT clear dueDate automatically (safer)
            saveState();
            renderCalendar();
        });
        });

        // Delete event
        calBody.querySelectorAll("[data-del-event]").forEach(btn=>{
        btn.addEventListener("click", ()=>{
            const id = btn.getAttribute("data-del-event");
            if (!confirm("Delete this event?")) return;
            state.calendarEvents = (state.calendarEvents || []).filter(e=>e.id!==id);
            saveState();
            renderCalendar();
        });
        });
    }

    function escapeHtml(str){
        return String(str || "")
        .replaceAll("&","&amp;")
        .replaceAll("<","&lt;")
        .replaceAll(">","&gt;")
        .replaceAll('"',"&quot;")
        .replaceAll("'","&#039;");
    }

    function renderCalendar(){
        setActiveViewButtons();
        setHeaderLabel();

        if (viewMode === "month") renderMonth();
        if (viewMode === "week")  renderWeek();
        if (viewMode === "day")   renderDay();
    }

    // View buttons
    if (calViewMonthBtn) calViewMonthBtn.addEventListener("click", ()=>{
        viewMode = "month";
        monthCursorYear = cursor.getFullYear();
        monthCursorMonth = cursor.getMonth();
        renderCalendar();
    });

    if (calViewWeekBtn) calViewWeekBtn.addEventListener("click", ()=>{
        viewMode = "week";
        renderCalendar();
    });

    if (calViewDayBtn) calViewDayBtn.addEventListener("click", ()=>{
        viewMode = "day";
        renderCalendar();
    });

    // Prev/Next logic based on view
    if (calPrevBtn) calPrevBtn.addEventListener("click", ()=>{
        if (viewMode === "month") {
        monthCursorMonth--;
        if (monthCursorMonth < 0) { monthCursorMonth = 11; monthCursorYear--; }
        cursor = new Date(monthCursorYear, monthCursorMonth, 1);
        } else if (viewMode === "week") {
        cursor.setDate(cursor.getDate() - 7);
        } else {
        cursor.setDate(cursor.getDate() - 1);
        }
        renderCalendar();
    });

    if (calNextBtn) calNextBtn.addEventListener("click", ()=>{
        if (viewMode === "month") {
        monthCursorMonth++;
        if (monthCursorMonth > 11) { monthCursorMonth = 0; monthCursorYear++; }
        cursor = new Date(monthCursorYear, monthCursorMonth, 1);
        } else if (viewMode === "week") {
        cursor.setDate(cursor.getDate() + 7);
        } else {
        cursor.setDate(cursor.getDate() + 1);
        }
        renderCalendar();
    });

    // Initial
    renderCalendar();
    }

  
    // Initial renders
    renderTodos();
    renderShopping();
  });
  </script>
</body>
</html>

