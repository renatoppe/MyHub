<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <title>MyHub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --bg: #050608;
      --bg-elevated: #11131b;
      --bg-elevated-soft: #151826;
      --accent: #4caf50;
      --accent-soft: rgba(76, 175, 80, 0.18);
      --accent-alt: #00bcd4;
      --danger: #f44336;
      --text: #f5f5f5;
      --text-muted: #a0a4b8;
      --border-subtle: #26293a;
      --radius-lg: 16px;
      --radius-sm: 8px;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #151827 0, #050608 45%);
      color: var(--text);
      min-height: 100vh;
    }

    .app {
      display: flex;
      min-height: 100vh;
      max-width: 1400px;
      margin: 0 auto;
    }

    /*linha ref*/
    .sidebar {
      width: 70px;
      background: linear-gradient(180deg, #11131b 0%, #050608 100%);
      border-right: 1px solid var(--border-subtle);
      padding: 16px 10px;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 10px;
      transition: width 0.2s ease;
      position: sticky;
      top: 0;
      align-self: flex-start;
      height: 100vh;
    }

    /* Slight expansion only, not huge */
    .sidebar.expanded {
      width: 110px;
    }

    .logo {
      width: 42px;
      height: 42px;
      border-radius: 16px;
      background: radial-gradient(circle at 20% 0, #00e676, #00bcd4);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 20px;
      color: #020308;
      box-shadow: 0 0 20px rgba(0, 188, 212, 0.6);
    }

    .nav-toggle {
      border: none;
      background: rgba(255, 255, 255, 0.04);
      color: var(--text-muted);
      width: 32px;
      height: 32px;
      border-radius: 999px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      cursor: pointer;
      margin-top: 4px;
      transition: 0.18s ease;
    }

    .nav-toggle:hover {
      background: rgba(255, 255, 255, 0.08);
      color: var(--accent-alt);
    }

    .nav {
      margin-top: 6px;
      display: flex;
      flex-direction: column;
      gap: 8px;
      flex: 1;
      width: 100%;
    }

    .nav-item {
      width: 100%;
      border-radius: 999px;
      border: none;
      outline: none;
      background: transparent;
      color: var(--text-muted);
      display: flex;
      flex-direction: column; /* icon + label vertical by default too */
      align-items: center;
      justify-content: center;
      font-size: 20px;
      cursor: pointer;
      transition: 0.18s ease;
      padding: 8px 0;
      gap: 4px;
    }

    .nav-emoji {
      flex-shrink: 0;
    }

    .nav-label {
      display: none;
      font-size: 11px;
      white-space: nowrap;
    }

    /* When expanded, show labels under icons */
    .sidebar.expanded .nav-item {
      flex-direction: column;
      justify-content: center;
      align-items: center;
      padding-inline: 0;
    }

    .sidebar.expanded .nav-label {
      display: block;
    }

    .nav-item:hover {
      background: rgba(255, 255, 255, 0.03);
      color: var(--accent-alt);
      transform: translateY(-1px);
    }

    .nav-item.nav-active {
      background: var(--accent-soft);
      color: var(--accent);
      box-shadow: 0 0 12px rgba(76, 175, 80, 0.4);
    }

    .version {
      font-size: 11px;
      color: var(--text-muted);
      opacity: 0.7;
    }

    .main {
      flex: 1;
      padding: 16px;
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 8px 12px;
      border-radius: var(--radius-lg);
      background: linear-gradient(90deg, #141827, #0b0d14);
      box-shadow: 0 0 30px rgba(0, 0, 0, 0.4);
    }

    #pageTitle {
      margin: 0;
      font-size: 20px;
      letter-spacing: 0.03em;
    }

    .page {
      flex: 1;
      border-radius: var(--radius-lg);
      background: rgba(8, 10, 18, 0.96);
      border: 1px solid var(--border-subtle);
      padding: 16px;
      display: none;
      overflow-y: auto;
    }

    .page.active {
      display: block;
    }

    .hidden {
      display: none !important;
    }

    .section-title {
      margin: 0 0 10px;
      font-size: 15px;
      font-weight: 600;
    }

    .card {
      border-radius: var(--radius-lg);
      background: var(--bg-elevated);
      border: 1px solid var(--border-subtle);
      padding: 12px;
      margin-bottom: 12px;
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 14px;
      font-weight: 600;
    }

    .chip-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .chip {
      font-size: 11px;
      padding: 3px 8px;
      border-radius: 999px;
      background: #151826;
      border: 1px solid #26293a;
      color: var(--text-muted);
    }

    .chip-highlight {
      background: rgba(0, 188, 212, 0.12);
      color: #e0f7fa;
      border-color: rgba(0, 188, 212, 0.5);
    }

    .input-grid {
      display: flex;
      flex-direction: column;
      gap: 8px;
      margin-bottom: 10px;
    }

    .input-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .input-row-inline {
      display: flex;
      gap: 8px;
    }

    .input-row-inline > * {
      flex: 1;
    }

    label {
      font-size: 11px;
      color: var(--text-muted);
    }

    input[type="text"],
    input[type="number"],
    input[type="date"],
    select,
    textarea {
      width: 100%;
      padding: 8px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text);
      font-size: 13px;
      outline: none;
      transition: 0.16s ease;
    }

    textarea {
      border-radius: 10px;
      resize: vertical;
      min-height: 70px;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.4);
    }

    .btn {
      border-radius: 999px;
      padding: 8px 14px;
      border: none;
      font-size: 13px;
      font-weight: 500;
      cursor: pointer;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      background: var(--accent-soft);
      color: var(--accent);
      transition: 0.16s ease;
    }

    .btn:hover {
      background: rgba(76, 175, 80, 0.32);
      transform: translateY(-1px);
      box-shadow: 0 0 10px rgba(76, 175, 80, 0.5);
    }

    .btn-secondary {
      background: rgba(0, 188, 212, 0.12);
      color: #b2ebf2;
    }

    .btn-secondary:hover {
      background: rgba(0, 188, 212, 0.24);
    }

    .btn-icon {
      padding-inline: 10px;
      font-size: 16px;
    }

    .btn-danger {
      background: rgba(244, 67, 54, 0.14);
      color: #ffcdd2;
    }

    .btn-danger:hover {
      background: rgba(244, 67, 54, 0.25);
    }

    .list {
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .empty-msg {
      font-size: 12px;
      color: var(--text-muted);
      font-style: italic;
      margin-top: 4px;
    }

    .item {
      border-radius: 12px;
      padding: 8px 9px;
      background: var(--bg-elevated-soft);
      border: 1px solid #25283a;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 8px;
    }

    .item-main {
      display: flex;
      align-items: center;
      gap: 8px;
      flex: 1;
      min-width: 0;
    }

    .item-checkbox {
      flex-shrink: 0;
    }

    .item-checkbox input[type="checkbox"] {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .item-text {
      display: flex;
      flex-direction: column;
      gap: 2px;
      min-width: 0;
    }

    .item-title {
      font-size: 13px;
      font-weight: 500;
      white-space: nowrap;
      text-overflow: ellipsis;
      overflow: hidden;
      cursor: pointer;
    }

    .item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
    }

    .item-actions {
      display: flex;
      flex-shrink: 0;
      gap: 4px;
    }

    .icon-btn {
      border-radius: 999px;
      border: none;
      background: rgba(255, 255, 255, 0.03);
      color: var(--text-muted);
      width: 26px;
      height: 26px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 15px;
      cursor: pointer;
      transition: 0.15s ease;
    }

    .icon-btn:hover {
      background: rgba(255, 255, 255, 0.07);
      color: var(--accent-alt);
    }

    .icon-btn.danger {
      color: #ff8a80;
    }

    .tag {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #181b2a;
      color: var(--text-muted);
    }

    .tag-income {
      background: rgba(76, 175, 80, 0.16);
      color: #c8e6c9;
    }

    .tag-expense {
      background: rgba(244, 67, 54, 0.16);
      color: #ffcdd2;
    }

    .selected-account {
      border-color: var(--accent-alt);
      box-shadow: 0 0 0 1px rgba(0, 188, 212, 0.6);
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 8px;
    }

    .filter-pill {
      font-size: 11px;
      padding: 3px 9px;
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #121622;
      color: var(--text-muted);
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .filter-pill label {
      font-size: 11px;
    }

    .filter-pill select,
    .filter-pill input {
      font-size: 11px;
      padding: 3px 6px;
      border-radius: 999px;
    }

    /* Workout rows */
    .workout-row {
      display: flex;
      flex-direction: column;
      gap: 4px;
      margin-bottom: 8px;
      border-radius: 10px;
      padding: 6px 8px;
      background: #101320;
    }

    .workout-row-top {
      width: 100%;
    }

    .workout-row-bottom {
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .workout-row-bottom input[type="number"] {
      padding: 6px 7px;
      font-size: 12px;
    }

    .workout-row-bottom .workout-done {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
    }

    .workout-row-bottom .icon-btn {
      width: 26px;
      height: 26px;
      flex-shrink: 0;
      font-size: 14px;
    }

    /* Workout favorites grid */
    .favorites-grid {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-bottom: 10px;
    }

    .favorite-card {
      flex: 1 1 calc(50% - 8px);
      min-width: 110px;
      height: 70px;
      border-radius: 14px;
      border: 1px solid #273041;
      background: radial-gradient(circle at top, rgba(0, 188, 212, 0.25), #101320);
      display: flex;
      align-items: center;
      justify-content: center;
      text-align: center;
      font-size: 13px;
      color: #e0f7fa;
      cursor: pointer;
      padding: 4px;
      box-shadow: 0 0 12px rgba(0, 188, 212, 0.3);
      transition: 0.16s ease;
    }

    .notes-tabs {
      display: flex;
      gap: 6px;
    }
    
    .notes-tab {
      border-radius: 999px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text-muted);
      font-size: 11px;
      padding: 4px 10px;
      cursor: pointer;
      transition: 0.16s ease;
    }
    
    .notes-tab-active {
      background: var(--accent-soft);
      color: var(--accent);
      border-color: rgba(76, 175, 80, 0.6);
    }
    
    #notesTextArea {
      width: 100%;
      min-height: 200px;
      border-radius: 10px;
      border: 1px solid #26293a;
      background: #101320;
      color: var(--text);
      font-size: 13px;
      padding: 8px 9px;
      resize: vertical;
    }
    
    .notes-toolbar {
      display: flex;
      gap: 6px;
      margin-bottom: 8px;
    }
    
    .notes-canvas-wrapper {
      border-radius: 12px;
      border: 1px solid #26293a;
      background: #000;
      overflow: hidden;
      position: relative;
      height: 260px; /* fits on mobile; canvas will auto-resize */
    }
    
    #notesCanvas {
      width: 100%;
      height: 100%;
      display: block;
      touch-action: none; /* important for drawing on mobile */
    }

    
    .favorite-card:hover {
      transform: translateY(-2px) scale(1.02);
      box-shadow: 0 0 18px rgba(0, 188, 212, 0.6);
    }

    @media (min-width: 600px) {
      .favorite-card {
        flex-basis: calc(33.33% - 8px);
      }
    }

    .favorites-empty {
      font-size: 11px;
      color: var(--text-muted);
      font-style: italic;
      margin-bottom: 8px;
    }

    @media (min-width: 900px) {
      .sidebar.expanded {
        width: 120px;
      }
    }
  </style>
</head>
<body>
  <div class="app">
    <aside class="sidebar">
      <div class="logo">H</div>
      <button id="navToggle" class="nav-toggle" title="Expand menu">‚ò∞</button>
      <nav class="nav">
        <button class="nav-item nav-active" data-page="home" title="Home">
          <span class="nav-emoji">üè†</span><span class="nav-label">Home</span>
        </button>
        <button class="nav-item" data-page="todo" title="To-Do">
          <span class="nav-emoji">‚úÖ</span><span class="nav-label">To-Do</span>
        </button>
        <button class="nav-item" data-page="shopping" title="Shopping">
          <span class="nav-emoji">üõí</span><span class="nav-label">Shopping</span>
        </button>
        <button class="nav-item" data-page="workouts" title="Workouts">
          <span class="nav-emoji">üèãÔ∏è</span><span class="nav-label">Workouts</span>
        </button>
        <button class="nav-item" data-page="finance" title="Finances">
          <span class="nav-emoji">üí∞</span><span class="nav-label">Finances</span>
        </button>
        <button class="nav-item" data-page="notes" title="Notes">
          <span class="nav-emoji">üìù</span><span class="nav-label">Notes</span>
        </button>
        <button class="nav-item" data-page="meals" title="Meals">
          <span class="nav-emoji">üçΩÔ∏è</span><span class="nav-label">Meals</span>
        </button>
        <button class="nav-item" data-page="calendar" title="Calendar">
          <span class="nav-emoji">üìÖ</span><span class="nav-label">Calendar</span>
        </button>
        <button class="nav-item" data-page="analytics" title="Analytics">
          <span class="nav-emoji">üìä</span><span class="nav-label">Analytics</span>
        </button>
      </nav>
      <div class="version">v<span id="appVersion">0.8.0</span></div>
    </aside>

    <main class="main">
      <header class="header">
        <h1 id="pageTitle">Home</h1>
      </header>

      <!-- HOME -->
      <section class="page active" data-page="home">
        <div class="card">
          <div class="card-header">
            <div class="card-title">Quick task</div>
          </div>
          <div class="input-grid">
            <div class="input-row">
              <label for="homeQuickTaskInput">Task</label>
              <input id="homeQuickTaskInput" type="text" placeholder="e.g. Buy vegetables, send email‚Ä¶" />
            </div>
          </div>
          <button id="homeQuickTaskBtn" class="btn">
            ‚ûï Add quick task
          </button>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Overview</div>
          </div>
          <div class="chip-row">
            <span class="chip">‚úÖ To-do</span>
            <span class="chip">üõí Shopping</span>
            <span class="chip">üèãÔ∏è Workouts</span>
            <span class="chip">üí∞ Finance</span>
            <span class="chip chip-highlight">More coming soon‚Ä¶</span>
          </div>
        </div>
      </section>

      <!-- TO-DO -->
      <section class="page hidden" data-page="todo">
        <h2 class="section-title">To-do lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- Row 1: list dropdown -->
            <div class="input-row">
              <label for="todoListSelect">List</label>
              <select id="todoListSelect"></select>
            </div>

            <!-- Row 2: new list name + + button -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoListName">New list</label>
                <input id="todoListName" type="text" placeholder="e.g. Work, Personal‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="todoNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Row 3: Task title -->
            <div class="input-row">
              <label for="todoTitleInput">Task</label>
              <input id="todoTitleInput" type="text" placeholder="What do you need to do?" />
            </div>

            <!-- Row 4: Priority + due date -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="todoPrioritySelect">Priority</label>
                <select id="todoPrioritySelect">
                  <option value="high">High</option>
                  <option value="medium" selected>Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="input-row">
                <label for="todoDueDate">Due date</label>
                <input id="todoDueDate" type="date" />
              </div>
            </div>

          <!-- Row 5: Filters + Add button on same line -->
          <div class="input-row-inline" style="align-items: flex-end; margin-bottom: 8px;">
            <div class="input-row" style="flex: 0 0 auto;">
              <button id="todoFiltersToggle" class="btn btn-secondary btn-icon" title="Filters">
                ‚öôÔ∏è
              </button>
              <!--testline-->
              <button id="addTodoBtn" class="btn">‚ûï Add task</button>
            </div>
            
            <!--test
            <div class="input-row" style="flex: 1; display: flex; justify-content: flex-end;">
              <button id="addTodoBtn" class="btn">‚ûï Add task</button>
            </div> -->
          </div>

          <!-- Filters panel (hidden by default) -->
          <div id="todoFiltersPanel" style="display: none;">
            <div class="pill-row">
              <div class="filter-pill">
                <label for="todoSearchInput">Search</label>
                <input id="todoSearchInput" type="text" placeholder="Text‚Ä¶" />
              </div>
              <div class="filter-pill">
                <label for="todoFilterPriority">Priority</label>
                <select id="todoFilterPriority">
                  <option value="all">All</option>
                  <option value="high">High</option>
                  <option value="medium">Medium</option>
                  <option value="low">Low</option>
                </select>
              </div>
              <div class="filter-pill">
                <label for="todoFilterStatus">Status</label>
                <select id="todoFilterStatus">
                  <option value="all">All</option>
                  <option value="open">Open</option>
                  <option value="inprogress">In progress</option>
                  <option value="done">Done</option>
                </select>
              </div>
              <div class="filter-pill">
                <label for="todoFilterList">List</label>
                <select id="todoFilterList">
                  <option value="all">All</option>
                </select>
              </div>
            </div>
          </div>

          <div id="noTodosMsg" class="empty-msg">
            No tasks yet. Add your first one above.
          </div>
          <div id="todoList" class="list"></div>
        </div>
      </section>

      <!-- SHOPPING -->
      <section class="page hidden" data-page="shopping">
        <h2 class="section-title">Shopping lists</h2>

        <div class="card">
          <div class="input-grid">
            <!-- Row 1: list dropdown -->
            <div class="input-row">
              <label for="shoppingListSelect">List</label>
              <select id="shoppingListSelect"></select>
            </div>

            <!-- Row 2: new list name + + button -->
            <div class="input-row-inline">
              <div class="input-row">
                <label for="shoppingListName">New list</label>
                <input id="shoppingListName" type="text" placeholder="e.g. Weekly, Work‚Ä¶" />
              </div>
              <div class="input-row" style="align-self: flex-end;">
                <button id="shoppingNewListBtn" class="btn btn-secondary btn-icon">‚ûï</button>
              </div>
            </div>

            <!-- Row 3: item -->
            <div class="input-row">
              <label for="shoppingItemInput">Item</label>
              <input id="shoppingItemInput" type="text" placeholder="e.g. Chicken, yogurt, vegetables‚Ä¶" />
            </div>

            <!-- Row 4: Add button -->
            <div class="input-row" style="align-items: flex-end;">
              <button id="addShoppingBtn" class="btn">‚ûï Add item</button>
            </div>
          </div>

          <div id="shoppingEmptyMsg" class="empty-msg">
            No items yet. Add something above.
          </div>
          <div id="shoppingList" class="list"></div>
        </div>
      </section>

      <!-- WORKOUTS -->
      <section class="page hidden" data-page="workouts">
        <h2 class="section-title">Workouts</h2>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Current workout</div>
          </div>

          <!-- Favorite workouts grid -->
          <div id="workoutFavoritesContainer">
            <div id="workoutFavoritesEmpty" class="favorites-empty">
              No favorites yet. Tap ‚òÖ on a logged workout to save it here.
            </div>
            <div id="workoutFavorites" class="favorites-grid"></div>
          </div>

          <div class="input-grid">
            <div class="input-row">
              <label for="workoutName">Workout name</label>
              <input id="workoutName" type="text" placeholder="e.g. Push day, Legs B‚Ä¶" />
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label>Start</label>
                <div id="workoutStartLabel" class="empty-msg">Not started</div>
              </div>
              <div class="input-row">
                <label>Duration</label>
                <div id="workoutDurationLabel" class="empty-msg">‚Äì</div>
              </div>
            </div>
          </div>

          <div class="input-row-inline" style="margin-bottom: 8px;">
            <button id="startWorkoutBtn" class="btn btn-secondary">‚ñ∂ Start workout</button>
            <button id="saveWorkoutBtn" class="btn">üíæ Finish & save</button>
            <button id="addExerciseRowBtn" class="btn btn-secondary">‚ûï Add exercise row</button>
          </div>

          <div id="workoutExercises" class="list"></div>

          <!-- Notes moved to bottom -->
          <div class="input-grid">
            <div class="input-row">
              <label for="workoutNotes">Notes</label>
              <textarea id="workoutNotes" placeholder="Extra notes for this workout‚Ä¶"></textarea>
            </div>
          </div>
        </div>

        <div class="card">
          <div class="card-header">
            <div class="card-title">Logged workouts</div>
          </div>
          <div id="noWorkoutMsg" class="empty-msg">
            No workouts logged yet.
          </div>
          <div id="workoutList" class="list"></div>
        </div>
      </section>

      <!-- FINANCE -->
      <section class="page hidden" data-page="finance">
        <h2 class="section-title">Finances</h2>

        <!-- New transaction card FIRST -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">New transaction</div>
          </div>

          <div class="input-grid">
            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAccount">Account</label>
                <select id="financeAccount"></select>
              </div>
              <div class="input-row">
                <label for="financeType">Type</label>
                <select id="financeType">
                  <option value="expense" selected>Expense</option>
                  <option value="income">Income</option>
                </select>
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeAmount">Amount</label>
                <input id="financeAmount" type="number" step="0.01" min="0" placeholder="0.00" />
              </div>
              <div class="input-row">
                <label for="financeDate">Date</label>
                <input id="financeDate" type="date" />
              </div>
            </div>

            <div class="input-row-inline">
              <div class="input-row">
                <label for="financeCategory">Category</label>
                <input id="financeCategory" type="text" placeholder="e.g. Food, Transport‚Ä¶" />
              </div>
              <div class="input-row">
                <label for="financeMethod">Method</label>
                <input id="financeMethod" type="text" placeholder="Cash, card, scan‚Ä¶" />
              </div>
            </div>

            <div class="input-row">
              <label for="financeNote">Note</label>
              <input id="financeNote" type="text" placeholder="Optional note‚Ä¶" />
            </div>

            <div class="input-row" style="align-items: flex-end;">
              <button id="addFinanceBtn" class="btn">
                ‚ûï Add transaction
              </button>
            </div>
          </div>

          <div class="pill-row">
            <div class="filter-pill">
              <label for="financeFilterCategory">Category filter</label>
              <select id="financeFilterCategory">
                <option value="all">All</option>
                <option value="Food">Food</option>
                <option value="Transport">Transport</option>
                <option value="Rent">Rent</option>
                <option value="Other">Other</option>
              </select>
            </div>
          </div>

          <div id="financeSummary" class="empty-msg"></div>

          <div id="noFinanceMsg" class="empty-msg">
            No transactions yet.
          </div>
          <div id="financeList" class="list"></div>
        </div>

        <!-- Accounts card moved to bottom -->
        <div class="card">
          <div class="card-header">
            <div class="card-title">Accounts</div>
            <button id="addAccountBtn" class="btn btn-secondary btn-icon">
              ‚ûï
            </button>
          </div>
          <div id="noAccountsMsg" class="empty-msg">
            No accounts yet. Add one above (e.g. THB main, BRL savings, USD).
          </div>
          <div id="accountsList" class="list"></div>
        </div>
      </section>

      <!-- NOTES (placeholder) -->
      <section class="page hidden" data-page="notes">
        <h2 class="section-title">Notes</h2>
      
        <div class="card">
          <div class="card-header">
            <div class="card-title">Notes</div>
            <div class="notes-tabs">
              <button id="notesTabText" class="notes-tab notes-tab-active">Text</button>
              <button id="notesTabCanvas" class="notes-tab">Canvas</button>
            </div>
          </div>
      
          <!-- TEXT MODE -->
          <div id="notesTextPane">
            <textarea id="notesTextArea" placeholder="Write your notes here‚Ä¶"></textarea>
          </div>
      
          <!-- CANVAS MODE -->
          <div id="notesCanvasPane" class="hidden">
            <div class="notes-toolbar">
              <button id="notesBoardDark" class="btn btn-secondary btn-icon" title="Dark board">
                ‚¨õ
              </button>
              <button id="notesBoardLight" class="btn btn-secondary btn-icon" title="Light board">
                ‚¨ú
              </button>
              <button id="notesCanvasClear" class="btn btn-secondary btn-icon" title="Clear">
                üßπ
              </button>
              <button id="notesCanvasSave" class="btn btn-secondary btn-icon" title="Save image">
                üíæ
              </button>
            </div>
            <div class="notes-canvas-wrapper">
              <canvas id="notesCanvas"></canvas>
            </div>
          </div>
        </div>
      </section>


      <!-- MEALS (placeholder) -->
      <section class="page hidden" data-page="meals">
        <h2 class="section-title">Meals</h2>
      </section>

      <!-- CALENDAR (placeholder) -->
      <section class="page hidden" data-page="calendar">
        <h2 class="section-title">Calendar</h2>
      </section>

      <!-- ANALYTICS (placeholder) -->
      <section class="page hidden" data-page="analytics">
        <h2 class="section-title">Analytics</h2>
      </section>
    </main>
  </div>
  <script>
   // script.js ‚Äì MyHub v0.9.3
  
  document.addEventListener("DOMContentLoaded", () => {
    // -----------------------------
    // GLOBAL STATE & STORAGE
    // -----------------------------
    const STORAGE_KEY = "myhub_state_v1";
  
    const defaultState = {
      todos: [], // {id, title, priority, dueDate, status, listId, createdAt, link}
      todoLists: [{ id: "default", name: "Personal" }],
      shoppingLists: [
        {
          id: "default",
          name: "General",
          items: [], // {id, text, checked, note}
        },
      ],
      workouts: [], // logged workouts
      workoutFavorites: [], // {id, name, exercises}
      financeAccounts: [], // {id, name}
      financeTransactions: [], // {id, accountId, type, amount, date, category, method, note}
      notesText: "",
      meals: [], // {id, date, food, amount, unit, protein, carbs, fat}
      calendarEvents: [], // {id, date, text}
    };
  
    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return {
          ...structuredClone(defaultState),
          ...parsed,
        };
      } catch (e) {
        console.error("Error loading state", e);
        return structuredClone(defaultState);
      }
    }
  
    function saveState() {
      try {
        localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      } catch (e) {
        console.error("Error saving state", e);
      }
    }
  
    function makeId(prefix) {
      return `${prefix}_${Date.now()}_${Math.random().toString(36).slice(2, 8)}`;
    }
  
    let state = loadState();
  
    if (!state.todoLists || state.todoLists.length === 0) {
      state.todoLists = structuredClone(defaultState.todoLists);
    }
    if (!state.shoppingLists || state.shoppingLists.length === 0) {
      state.shoppingLists = structuredClone(defaultState.shoppingLists);
    }
  
    // Bump version label
    const appVersionSpan = document.getElementById("appVersion");
    if (appVersionSpan) appVersionSpan.textContent = "0.9.3";
  
    // -----------------------------
    // BASIC ELEMENTS & EXTRA STYLES
    // -----------------------------
    const sidebar = document.querySelector(".sidebar");
    const navToggle = document.getElementById("navToggle");
    const navItems = document.querySelectorAll(".nav-item");
    const pages = document.querySelectorAll(".page");
    const pageTitle = document.getElementById("pageTitle");
  
    // Extra styles for collapsed sidebar & handle
    const extraStyle = document.createElement("style");
    extraStyle.textContent = `
      .sidebar.collapsed {
        width: 8px;
        padding: 6px 2px;
        overflow: hidden;
      }
      .sidebar.collapsed .logo,
      .sidebar.collapsed .nav-toggle,
      .sidebar.collapsed .nav,
      .sidebar.collapsed .version {
        opacity: 0;
        pointer-events: none;
      }
      #sidebarHandle {
        position: fixed;
        left: 0;
        top: 50%;
        transform: translateY(-50%);
        width: 10px;
        height: 70px;
        border-radius: 0 10px 10px 0;
        background: rgba(0, 188, 212, 0.8);
        display: none;
        align-items: center;
        justify-content: center;
        cursor: pointer;
        z-index: 999;
        font-size: 10px;
        color: #020308;
        box-shadow: 0 0 12px rgba(0, 188, 212, 0.7);
      }
    `;
    document.head.appendChild(extraStyle);
  
    const sidebarHandle = document.createElement("div");
    sidebarHandle.id = "sidebarHandle";
    sidebarHandle.textContent = "‚ñ∂";
    document.body.appendChild(sidebarHandle);
  
    let canvasSidebarModeActive = false;
    let navExpandTimer = null;
  
    function setSidebarCollapsed(collapsed) {
      if (!sidebar) return;
      if (collapsed) {
        sidebar.classList.add("collapsed");
        sidebar.classList.remove("expanded");
      } else {
        sidebar.classList.remove("collapsed");
      }
    }
  
    function enableCanvasSidebarMode() {
      canvasSidebarModeActive = true;
      setSidebarCollapsed(true);
      sidebarHandle.style.display = "flex";
    }
  
    function disableCanvasSidebarMode() {
      canvasSidebarModeActive = false;
      setSidebarCollapsed(false);
      sidebarHandle.style.display = "none";
    }
  
    sidebarHandle.addEventListener("click", () => {
      setSidebarCollapsed(false);
      // auto-collapse again after a few seconds in canvas mode
      if (canvasSidebarModeActive) {
        setTimeout(() => {
          if (canvasSidebarModeActive) {
            setSidebarCollapsed(true);
          }
        }, 4000);
      }
    });
  
    // -----------------------------
    // NAVIGATION
    // -----------------------------
    if (navToggle) {
      navToggle.addEventListener("click", () => {
        if (sidebar.classList.contains("expanded")) {
          sidebar.classList.remove("expanded");
          if (navExpandTimer) clearTimeout(navExpandTimer);
        } else {
          sidebar.classList.add("expanded");
          if (navExpandTimer) clearTimeout(navExpandTimer);
          // auto-collapse name expansion after a few seconds
          navExpandTimer = setTimeout(() => {
            sidebar.classList.remove("expanded");
          }, 3500);
        }
      });
    }
  
    function showPage(pageId) {
      pages.forEach((p) => {
        if (p.dataset.page === pageId) {
          p.classList.remove("hidden");
          p.classList.add("active");
        } else {
          p.classList.add("hidden");
          p.classList.remove("active");
        }
      });
  
      navItems.forEach((btn) => {
        if (btn.dataset.page === pageId) {
          btn.classList.add("nav-active");
        } else {
          btn.classList.remove("nav-active");
        }
      });
  
      if (pageTitle) {
        const item = [...navItems].find((b) => b.dataset.page === pageId);
        pageTitle.textContent = item ? item.title || "MyHub" : "MyHub";
      }
  
      // Leaving notes canvas mode
      if (pageId !== "notes") {
        disableCanvasSidebarMode();
      }
    }
  
    navItems.forEach((btn) => {
      btn.addEventListener("click", () => {
        showPage(btn.dataset.page);
      });
    });
  
    // -----------------------------
    // HOME ‚Äì QUICK TASK
    // -----------------------------
    const homeQuickTaskInput = document.getElementById("homeQuickTaskInput");
    const homeQuickTaskBtn = document.getElementById("homeQuickTaskBtn");
  
    function getDefaultTodoListId() {
      if (state.todoLists.length === 0) {
        const def = { id: "default", name: "Personal" };
        state.todoLists.push(def);
        saveState();
        return def.id;
      }
      return state.todoLists[0].id;
    }
  
    if (homeQuickTaskBtn && homeQuickTaskInput) {
      homeQuickTaskBtn.addEventListener("click", () => {
        const text = homeQuickTaskInput.value.trim();
        if (!text) return;
        const listId = getDefaultTodoListId();
        const newTodo = {
          id: makeId("todo"),
          title: text,
          priority: "medium",
          dueDate: "",
          status: "open",
          listId,
          createdAt: Date.now(),
          link: "",
        };
        state.todos.push(newTodo);
        saveState();
        homeQuickTaskInput.value = "";
        if (currentTodoListId === listId) {
          renderTodos();
        }
      });
    }
  
    // -----------------------------
    // TO-DO
    // -----------------------------
    const todoListSelect = document.getElementById("todoListSelect");
    const todoListNameInput = document.getElementById("todoListName");
    const todoTitleInput = document.getElementById("todoTitleInput");
    const todoPrioritySelect = document.getElementById("todoPrioritySelect");
    const todoDueDateInput = document.getElementById("todoDueDate");
    const addTodoBtn = document.getElementById("addTodoBtn");
    const todoFiltersToggle = document.getElementById("todoFiltersToggle");
    const todoFiltersPanel = document.getElementById("todoFiltersPanel");
    const todoSearchInput = document.getElementById("todoSearchInput");
    const todoFilterPriority = document.getElementById("todoFilterPriority");
    const todoFilterStatus = document.getElementById("todoFilterStatus");
    const todoFilterList = document.getElementById("todoFilterList");
    const noTodosMsg = document.getElementById("noTodosMsg");
    const todoListContainer = document.getElementById("todoList");
  
    let currentTodoListId = getDefaultTodoListId();
  
    // Layout tweaks: remove direct "new list" field, add + button with popup
    (function adaptTodoListRow() {
      if (!todoListSelect) return;
      if (todoListNameInput) {
        const rowInline = todoListNameInput.closest(".input-row-inline");
        if (rowInline) rowInline.style.display = "none";
      }
      const selectRow = todoListSelect.closest(".input-row");
      if (!selectRow) return;
      selectRow.style.display = "flex";
      selectRow.style.flexDirection = "row";
      selectRow.style.alignItems = "flex-end";
      selectRow.style.gap = "8px";
  
      const label = selectRow.querySelector("label");
      if (label) {
        label.style.marginRight = "4px";
        label.style.whiteSpace = "nowrap";
      }
  
      const newListBtn = document.createElement("button");
      newListBtn.className = "btn btn-secondary btn-icon";
      newListBtn.textContent = "‚ûï";
      newListBtn.title = "New list";
  
      newListBtn.addEventListener("click", () => {
        const name = prompt("New to-do list name:");
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        const id = makeId("tlist");
        state.todoLists.push({ id, name: trimmed });
        currentTodoListId = id;
        saveState();
        refreshTodoListsUI();
        renderTodos();
      });
  
      selectRow.appendChild(newListBtn);
    })();
  
    function refreshTodoListsUI() {
      if (!todoListSelect || !todoFilterList) return;
      todoListSelect.innerHTML = "";
      state.todoLists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        todoListSelect.appendChild(opt);
      });
      if (!state.todoLists.find((l) => l.id === currentTodoListId)) {
        currentTodoListId = getDefaultTodoListId();
      }
      todoListSelect.value = currentTodoListId;
  
      todoFilterList.innerHTML = "";
      const allOpt = document.createElement("option");
      allOpt.value = "all";
      allOpt.textContent = "All";
      todoFilterList.appendChild(allOpt);
      state.todoLists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        todoFilterList.appendChild(opt);
      });
      todoFilterList.value = "all";
    }
  
    function triStateNext(status) {
      if (status === "open") return "inprogress";
      if (status === "inprogress") return "done";
      return "open";
    }
  
    function applyTodoFilters(task) {
      const search = (todoSearchInput?.value || "").toLowerCase();
      const fp = todoFilterPriority?.value || "all";
      const fs = todoFilterStatus?.value || "all";
      const fl = todoFilterList?.value || "all";
  
      if (search) {
        const hay = task.title.toLowerCase();
        if (!hay.includes(search)) return false;
      }
      if (fp !== "all" && task.priority !== fp) return false;
      if (fs !== "all" && task.status !== fs) return false;
      if (fl !== "all" && task.listId !== fl) return false;
      return true;
    }
  
    function sortTodos(a, b) {
      const statusRank = { open: 0, inprogress: 1, done: 2 };
      const prRank = { high: 0, medium: 1, low: 2 };
      const sa = statusRank[a.status] ?? 1;
      const sb = statusRank[b.status] ?? 1;
      if (sa !== sb) return sa - sb;
      const pa = prRank[a.priority] ?? 1;
      const pb = prRank[b.priority] ?? 1;
      if (pa !== pb) return pa - pb;
  
      const da = a.dueDate || "";
      const db = b.dueDate || "";
      if (da && db && da !== db) return da.localeCompare(db);
      if (da && !db) return -1;
      if (!da && db) return 1;
      return (a.createdAt || 0) - (b.createdAt || 0);
    }
  
    function renderTodos() {
      if (!todoListContainer || !noTodosMsg) return;
      todoListContainer.innerHTML = "";
      const tasks = state.todos.filter(applyTodoFilters).sort(sortTodos);
  
      if (tasks.length === 0) {
        noTodosMsg.style.display = "block";
        return;
      }
      noTodosMsg.style.display = "none";
  
      tasks.forEach((task) => {
        const item = document.createElement("div");
        item.className = "item";
        item.draggable = true;
  
        const main = document.createElement("div");
        main.className = "item-main";
  
        const checkboxWrap = document.createElement("div");
        checkboxWrap.className = "item-checkbox";
        const cb = document.createElement("input");
        cb.type = "checkbox";
  
        if (task.status === "done") cb.checked = true;
        else cb.checked = false;
        cb.indeterminate = task.status === "inprogress";
  
        cb.addEventListener("click", (e) => {
          e.stopPropagation();
          task.status = triStateNext(task.status);
          saveState();
          renderTodos();
        });
  
        checkboxWrap.appendChild(cb);
  
        const textWrap = document.createElement("div");
        textWrap.className = "item-text";
  
        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = task.title || "(no title)";
  
        if (task.status === "done") {
          title.style.textDecoration = "line-through";
          title.style.color = "#777a90";
        } else if (task.status === "inprogress") {
          title.style.fontStyle = "italic";
        }
  
        title.addEventListener("click", () => {
          const newTitle = prompt("Edit task title:", task.title || "");
          if (newTitle === null) return;
          task.title = newTitle.trim() || task.title;
  
          const newDue = prompt(
            "Edit due date (YYYY-MM-DD, leave blank to clear):",
            task.dueDate || ""
          );
          if (newDue !== null) {
            const trimmed = newDue.trim();
            task.dueDate = trimmed || "";
          }
  
          const newPriority = prompt(
            "Priority (high / medium / low):",
            task.priority || "medium"
          );
          if (newPriority) {
            const p = newPriority.toLowerCase();
            if (["high", "medium", "low"].includes(p)) {
              task.priority = p;
            }
          }
          saveState();
          renderTodos();
        });
  
        const meta = document.createElement("div");
        meta.className = "item-meta";
  
        if (task.priority) {
          const pTag = document.createElement("span");
          pTag.className = "tag";
          pTag.textContent =
            task.priority === "high"
              ? "High"
              : task.priority === "low"
              ? "Low"
              : "Medium";
          meta.appendChild(pTag);
        }
        if (task.dueDate) {
          const dTag = document.createElement("span");
          dTag.className = "tag";
          dTag.textContent = `Due ${task.dueDate}`;
          meta.appendChild(dTag);
        }
        if (task.listId) {
          const list = state.todoLists.find((l) => l.id === task.listId);
          if (list) {
            const lTag = document.createElement("span");
            lTag.className = "tag";
            lTag.textContent = list.name;
            meta.appendChild(lTag);
          }
        }
        if (task.link) {
          const linkTag = document.createElement("span");
          linkTag.className = "tag";
          linkTag.textContent = `üîó ${task.link}`;
          meta.appendChild(linkTag);
        }
  
        textWrap.appendChild(title);
        if (meta.childNodes.length > 0) textWrap.appendChild(meta);
  
        main.appendChild(checkboxWrap);
        main.appendChild(textWrap);
  
        const actions = document.createElement("div");
        actions.className = "item-actions";
  
        const linkBtn = document.createElement("button");
        linkBtn.className = "icon-btn";
        linkBtn.textContent = "üîó";
        linkBtn.title = "Set / edit link";
  
        linkBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const current = task.link || "";
          const newLink = prompt(
            "Link this task to something (e.g. 'Shopping: Weekly list')",
            current
          );
          if (newLink === null) return;
          task.link = newLink.trim();
          saveState();
          renderTodos();
        });
  
        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete task";
  
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (!confirm("Delete this task?")) return;
          state.todos = state.todos.filter((t) => t.id !== task.id);
          saveState();
          renderTodos();
        });
  
        actions.appendChild(linkBtn);
        actions.appendChild(delBtn);
  
        item.appendChild(main);
        item.appendChild(actions);
  
        item.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", task.id);
        });
        item.addEventListener("dragover", (e) => e.preventDefault());
        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const fromId = e.dataTransfer.getData("text/plain");
          if (!fromId || fromId === task.id) return;
          const arr = state.todos;
          const fromIndex = arr.findIndex((t) => t.id === fromId);
          const toIndex = arr.findIndex((t) => t.id === task.id);
          if (fromIndex === -1 || toIndex === -1) return;
          const [moved] = arr.splice(fromIndex, 1);
          arr.splice(toIndex, 0, moved);
          saveState();
          renderTodos();
        });
  
        todoListContainer.appendChild(item);
      });
    }
  
    if (todoListSelect) {
      todoListSelect.addEventListener("change", () => {
        currentTodoListId = todoListSelect.value;
        renderTodos();
      });
    }
  
    if (addTodoBtn) {
      addTodoBtn.addEventListener("click", () => {
        const title = (todoTitleInput?.value || "").trim();
        if (!title) return;
        const priority = todoPrioritySelect?.value || "medium";
        const dueDate = todoDueDateInput?.value || "";
        const newTodo = {
          id: makeId("todo"),
          title,
          priority,
          dueDate,
          status: "open",
          listId: currentTodoListId,
          createdAt: Date.now(),
          link: "",
        };
        state.todos.push(newTodo);
        saveState();
  
        if (todoTitleInput) todoTitleInput.value = "";
        if (todoDueDateInput) todoDueDateInput.value = "";
        renderTodos();
      });
    }
  
    if (todoFiltersToggle && todoFiltersPanel) {
      todoFiltersToggle.addEventListener("click", () => {
        const visible = todoFiltersPanel.style.display === "block";
        todoFiltersPanel.style.display = visible ? "none" : "block";
      });
    }
  
    [todoSearchInput, todoFilterPriority, todoFilterStatus, todoFilterList].forEach(
      (el) => {
        if (!el) return;
        el.addEventListener("input", renderTodos);
        el.addEventListener("change", renderTodos);
      }
    );
  
    refreshTodoListsUI();
  
    // *** To-do small Filters button on same line as Add task ***
    (function compactTodoFiltersButton() {
      if (!todoFiltersToggle || !addTodoBtn) return;
      const filterRow = todoFiltersToggle.closest(".input-row");
      const addRow = addTodoBtn.closest(".input-row");
      if (!filterRow || !addRow) return;
  
      // Only icon for filters to make it small
      todoFiltersToggle.textContent = "‚öôÔ∏è";
      todoFiltersToggle.title = "Filters";
      // Move filter button into same row as Add task
      filterRow.style.display = "none";
      addRow.style.display = "flex";
      addRow.style.alignItems = "flex-end";
      addRow.style.gap = "8px";
  
      // Put filter button before Add task
      addRow.insertBefore(todoFiltersToggle, addTodoBtn);
      todoFiltersToggle.style.flex = "0 0 auto";
      addTodoBtn.style.flex = "1 1 auto";
    })();
  
    // -----------------------------
    // SHOPPING
    // -----------------------------
    const shoppingListSelect = document.getElementById("shoppingListSelect");
    const shoppingListNameInput = document.getElementById("shoppingListName");
    const shoppingNewListBtn = document.getElementById("shoppingNewListBtn");
    const shoppingItemInput = document.getElementById("shoppingItemInput");
    const addShoppingBtn = document.getElementById("addShoppingBtn");
    const shoppingEmptyMsg = document.getElementById("shoppingEmptyMsg");
    const shoppingListContainer = document.getElementById("shoppingList");
  
    let currentShoppingListId =
      state.shoppingLists.length > 0 ? state.shoppingLists[0].id : "default";
  
    (function adaptShoppingListRow() {
      if (!shoppingListSelect) return;
      if (shoppingListNameInput) {
        const rowInline = shoppingListNameInput.closest(".input-row-inline");
        if (rowInline) rowInline.style.display = "none";
      }
      const selectRow = shoppingListSelect.closest(".input-row");
      if (!selectRow) return;
  
      selectRow.style.display = "flex";
      selectRow.style.flexDirection = "row";
      selectRow.style.alignItems = "flex-end";
      selectRow.style.gap = "8px";
  
      const label = selectRow.querySelector("label");
      if (label) {
        label.style.marginRight = "4px";
        label.style.whiteSpace = "nowrap";
      }
  
      const newListBtn = document.createElement("button");
      newListBtn.className = "btn btn-secondary btn-icon";
      newListBtn.textContent = "‚ûï";
      newListBtn.title = "New shopping list";
  
      newListBtn.addEventListener("click", () => {
        const name = prompt("New shopping list name:");
        if (!name) return;
        const trimmed = name.trim();
        if (!trimmed) return;
        const id = makeId("slist");
        state.shoppingLists.push({ id, name: trimmed, items: [] });
        currentShoppingListId = id;
        saveState();
        refreshShoppingListsUI();
        renderShopping();
      });
  
      selectRow.appendChild(newListBtn);
    })();
  
    function refreshShoppingListsUI() {
      if (!shoppingListSelect) return;
      shoppingListSelect.innerHTML = "";
      state.shoppingLists.forEach((list) => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        shoppingListSelect.appendChild(opt);
      });
      if (!state.shoppingLists.find((l) => l.id === currentShoppingListId)) {
        currentShoppingListId =
          state.shoppingLists.length > 0 ? state.shoppingLists[0].id : "default";
      }
      shoppingListSelect.value = currentShoppingListId;
    }
  
    function getCurrentShoppingList() {
      let list = state.shoppingLists.find((l) => l.id === currentShoppingListId);
      if (!list && state.shoppingLists.length > 0) {
        list = state.shoppingLists[0];
        currentShoppingListId = list.id;
      }
      if (!list) {
        list = { id: "default", name: "General", items: [] };
        state.shoppingLists.push(list);
      }
      return list;
    }
  
    function renderShopping() {
      if (!shoppingListContainer || !shoppingEmptyMsg) return;
      shoppingListContainer.innerHTML = "";
      const list = getCurrentShoppingList();
      if (!list.items || list.items.length === 0) {
        shoppingEmptyMsg.style.display = "block";
        return;
      }
      shoppingEmptyMsg.style.display = "none";
  
      list.items.forEach((itemObj) => {
        const item = document.createElement("div");
        item.className = "item";
        item.draggable = true;
  
        const main = document.createElement("div");
        main.className = "item-main";
  
        const checkboxWrap = document.createElement("div");
        checkboxWrap.className = "item-checkbox";
        const cb = document.createElement("input");
        cb.type = "checkbox";
        cb.checked = !!itemObj.checked;
        cb.addEventListener("click", (e) => {
          e.stopPropagation();
          itemObj.checked = cb.checked;
          saveState();
          renderShopping();
        });
        checkboxWrap.appendChild(cb);
  
        const textWrap = document.createElement("div");
        textWrap.className = "item-text";
  
        const title = document.createElement("div");
        title.className = "item-title";
        title.textContent = itemObj.text || "(no name)";
  
        if (itemObj.checked) {
          title.style.textDecoration = "line-through";
          title.style.color = "#777a90";
        }
  
        title.addEventListener("click", () => {
          const newName = prompt("Edit item name:", itemObj.text || "");
          if (newName === null) return;
          itemObj.text = newName.trim() || itemObj.text;
          saveState();
          renderShopping();
        });
  
        const meta = document.createElement("div");
        meta.className = "item-meta";
        if (itemObj.note) {
          const noteTag = document.createElement("span");
          noteTag.className = "tag";
          noteTag.textContent = `üìù ${itemObj.note}`;
          meta.appendChild(noteTag);
        }
  
        textWrap.appendChild(title);
        if (meta.childNodes.length > 0) textWrap.appendChild(meta);
  
        main.appendChild(checkboxWrap);
        main.appendChild(textWrap);
  
        const actions = document.createElement("div");
        actions.className = "item-actions";
  
        const noteBtn = document.createElement("button");
        noteBtn.className = "icon-btn";
        noteBtn.textContent = "üìù";
        noteBtn.title = "Add note";
  
        noteBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          const newNote = prompt("Note for this item:", itemObj.note || "");
          if (newNote === null) return;
          itemObj.note = newNote.trim();
          saveState();
          renderShopping();
        });
  
        const delBtn = document.createElement("button");
        delBtn.className = "icon-btn danger";
        delBtn.textContent = "üóë";
        delBtn.title = "Delete item";
  
        delBtn.addEventListener("click", (e) => {
          e.stopPropagation();
          if (!confirm("Delete this item?")) return;
          list.items = list.items.filter((i) => i.id !== itemObj.id);
          saveState();
          renderShopping();
        });
  
        actions.appendChild(noteBtn);
        actions.appendChild(delBtn);
  
        item.appendChild(main);
        item.appendChild(actions);
  
        item.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", itemObj.id);
        });
        item.addEventListener("dragover", (e) => e.preventDefault());
        item.addEventListener("drop", (e) => {
          e.preventDefault();
          const fromId = e.dataTransfer.getData("text/plain");
          if (!fromId || fromId === itemObj.id) return;
          const arr = list.items;
          const fromIndex = arr.findIndex((i) => i.id === fromId);
          const toIndex = arr.findIndex((i) => i.id === itemObj.id);
          if (fromIndex === -1 || toIndex === -1) return;
          const [moved] = arr.splice(fromIndex, 1);
          arr.splice(toIndex, 0, moved);
          saveState();
          renderShopping();
        });
  
        shoppingListContainer.appendChild(item);
      });
    }
  
    if (shoppingListSelect) {
      shoppingListSelect.addEventListener("change", () => {
        currentShoppingListId = shoppingListSelect.value;
        renderShopping();
      });
    }
  
    if (addShoppingBtn) {
      addShoppingBtn.addEventListener("click", () => {
        const text = (shoppingItemInput?.value || "").trim();
        if (!text) return;
        const list = getCurrentShoppingList();
        list.items.push({
          id: makeId("sitem"),
          text,
          checked: false,
          note: "",
        });
        saveState();
        if (shoppingItemInput) shoppingItemInput.value = "";
        renderShopping();
      });
    }
  
    refreshShoppingListsUI();
    renderShopping();
  
    // -----------------------------
    // WORKOUTS
    // -----------------------------
    const workoutNameInput = document.getElementById("workoutName");
    const workoutStartLabel = document.getElementById("workoutStartLabel");
    const workoutDurationLabel = document.getElementById("workoutDurationLabel");
    const startWorkoutBtn = document.getElementById("startWorkoutBtn");
    const saveWorkoutBtn = document.getElementById("saveWorkoutBtn");
    const addExerciseRowBtn = document.getElementById("addExerciseRowBtn");
    const workoutExercisesContainer = document.getElementById("workoutExercises");
    const workoutNotesInput = document.getElementById("workoutNotes");
    const workoutFavoritesEmpty = document.getElementById("workoutFavoritesEmpty");
    const workoutFavoritesGrid = document.getElementById("workoutFavorites");
    const noWorkoutMsg = document.getElementById("noWorkoutMsg");
    const workoutListContainer = document.getElementById("workoutList");
  
    let currentWorkout = {
      name: "",
      startTime: null,
      durationMs: 0,
      notes: "",
      exercises: [],
    };
    let workoutTimer = null;
  
    function formatDuration(ms) {
      if (!ms || ms <= 0) return "‚Äì";
      const totalSec = Math.floor(ms / 1000);
      const mins = Math.floor(totalSec / 60);
      const secs = totalSec % 60;
      if (mins === 0) return `${secs}s`;
      return `${mins}m ${secs}s`;
    }
  
    function updateWorkoutDurationLabel() {
      if (!currentWorkout.startTime) return;
      const now = Date.now();
      const ms = now - currentWorkout.startTime;
      currentWorkout.durationMs = ms;
      if (workoutDurationLabel) {
        workoutDurationLabel.textContent = formatDuration(ms);
      }
    }
  
    function startWorkoutTimer() {
      if (workoutTimer) clearInterval(workoutTimer);
      workoutTimer = setInterval(updateWorkoutDurationLabel, 1000);
    }
  
    function stopWorkoutTimer() {
      if (workoutTimer) clearInterval(workoutTimer);
      workoutTimer = null;
    }
  
    function createExerciseRow(data) {
      const row = document.createElement("div");
      row.className = "workout-row";
      const id = data?.id || makeId("ex");
  
      const top = document.createElement("div");
      top.className = "workout-row-top";
      const exNameInput = document.createElement("input");
      exNameInput.type = "text";
      exNameInput.placeholder = "Exercise name";
      exNameInput.value = data?.name || "";
      top.appendChild(exNameInput);
  
      const bottom = document.createElement("div");
      bottom.className = "workout-row-bottom";
  
      const setsInput = document.createElement("input");
      setsInput.type = "number";
      setsInput.min = "0";
      setsInput.placeholder = "Sets";
      setsInput.value = data?.sets ?? "";
  
      const repsInput = document.createElement("input");
      repsInput.type = "number";
      repsInput.min = "0";
      repsInput.placeholder = "Reps";
      repsInput.value = data?.reps ?? "";
  
      const weightInput = document.createElement("input");
      weightInput.type = "number";
      weightInput.min = "0";
      weightInput.placeholder = "Weight";
      weightInput.value = data?.weight ?? "";
  
      const doneCheckbox = document.createElement("input");
      doneCheckbox.type = "checkbox";
      doneCheckbox.className = "workout-done";
      doneCheckbox.checked = !!data?.done;
  
      const deleteBtn = document.createElement("button");
      deleteBtn.className = "icon-btn danger";
      deleteBtn.textContent = "üóë";
      deleteBtn.title = "Remove exercise";
  
      deleteBtn.addEventListener("click", () => {
        row.remove();
        currentWorkout.exercises = currentWorkout.exercises.filter(
          (e) => e.id !== id
        );
      });
  
      bottom.appendChild(setsInput);
      bottom.appendChild(repsInput);
      bottom.appendChild(weightInput);
      bottom.appendChild(doneCheckbox);
      bottom.appendChild(deleteBtn);
  
      row.appendChild(top);
      row.appendChild(bottom);
      workoutExercisesContainer.appendChild(row);
  
      const updateData = () => {
        const ex = currentWorkout.exercises.find((e) => e.id === id);
        if (!ex) return;
        ex.name = exNameInput.value.trim();
        ex.sets = setsInput.value ? parseInt(setsInput.value, 10) : null;
        ex.reps = repsInput.value ? parseInt(repsInput.value, 10) : null;
        ex.weight = weightInput.value ? parseFloat(weightInput.value) : null;
        ex.done = doneCheckbox.checked;
      };
  
      currentWorkout.exercises.push({
        id,
        name: data?.name || "",
        sets: data?.sets ?? null,
        reps: data?.reps ?? null,
        weight: data?.weight ?? null,
        done: !!data?.done,
      });
  
      [exNameInput, setsInput, repsInput, weightInput, doneCheckbox].forEach(
        (el) => {
          el.addEventListener("input", updateData);
          el.addEventListener("change", updateData);
        }
      );
    }
  
    function clearCurrentWorkoutUI() {
      currentWorkout = {
        name: "",
        startTime: null,
        durationMs: 0,
        notes: "",
        exercises: [],
      };
      if (workoutNameInput) workoutNameInput.value = "";
      if (workoutStartLabel) workoutStartLabel.textContent = "Not started";
      if (workoutDurationLabel) workoutDurationLabel.textContent = "‚Äì";
      if (workoutNotesInput) workoutNotesInput.value = "";
      if (workoutExercisesContainer) workoutExercisesContainer.innerHTML = "";
      stopWorkoutTimer();
    }
  
    function renderWorkoutFavorites() {
      if (!workoutFavoritesGrid || !workoutFavoritesEmpty) return;
      workoutFavoritesGrid.innerHTML = "";
      const favs = state.workoutFavorites || [];
      if (favs.length === 0) {
        workoutFavoritesEmpty.style.display = "block";
        return;
      }
      workoutFavoritesEmpty.style.display = "none";
      favs.slice(0, 6).forEach((fav) => {
        const card = document.createElement("div");
        card.className = "favorite-card";
        card.textContent = fav.name || "Workout";
        card.addEventListener("click", () => {
          clearCurrentWorkoutUI();
          currentWorkout.name = fav.name || "";
          if (workoutNameInput) workoutNameInput.value = currentWorkout.name;
          fav.exercises.forEach((ex) => {
            createExerciseRow({
              name: ex.name,
              sets: ex.sets,
              reps: ex.reps,
              weight: ex.weight,
              done: false,
            });
          });
        });
        workoutFavoritesGrid.appendChild(card);
      });
    }
  
    function renderWorkoutsList() {
      if (!workoutListContainer || !noWorkoutMsg) return;
      workoutListContainer.innerHTML = "";
      const ws = state.workouts || [];
      if (ws.length === 0) {
        noWorkoutMsg.style.display = "block";
        return;
      }
      noWorkoutMsg.style.display = "none";
  
      ws
        .slice()
        .sort((a, b) => (b.startTime || 0) - (a.startTime || 0))
        .forEach((w) => {
          const item = document.createElement("div");
          item.className = "item";
  
          const main = document.createElement("div");
          main.className = "item-main";
  
          const titleWrap = document.createElement("div");
          titleWrap.className = "item-text";
  
          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = w.name || "Workout";
  
          const meta = document.createElement("div");
          meta.className = "item-meta";
  
          const date = new Date(w.startTime || Date.now());
          const dTag = document.createElement("span");
          dTag.className = "tag";
          dTag.textContent = date.toLocaleString();
          meta.appendChild(dTag);
  
          const durTag = document.createElement("span");
          durTag.className = "tag";
          durTag.textContent = formatDuration(w.durationMs || 0);
          meta.appendChild(durTag);
  
          const exTag = document.createElement("span");
          exTag.className = "tag";
          exTag.textContent = `${(w.exercises || []).length} exercises`;
          meta.appendChild(exTag);
  
          titleWrap.appendChild(title);
          titleWrap.appendChild(meta);
          main.appendChild(titleWrap);
  
          const actions = document.createElement("div");
          actions.className = "item-actions";
  
          const favBtn = document.createElement("button");
          favBtn.className = "icon-btn";
          const isFav = state.workoutFavorites?.some((f) => f.id === w.id);
          favBtn.textContent = isFav ? "‚òÖ" : "‚òÜ";
          favBtn.title = "Toggle favorite (max 6)";
  
          favBtn.addEventListener("click", () => {
            const favIndex = state.workoutFavorites.findIndex(
              (f) => f.id === w.id
            );
            if (favIndex >= 0) {
              state.workoutFavorites.splice(favIndex, 1);
            } else {
              if ((state.workoutFavorites || []).length >= 6) {
                alert("You already have 6 favorite workouts.");
                return;
              }
              state.workoutFavorites.push({
                id: w.id,
                name: w.name,
                exercises: w.exercises || [],
              });
            }
            saveState();
            renderWorkoutFavorites();
            renderWorkoutsList();
          });
  
          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóë";
          delBtn.title = "Delete workout";
  
          delBtn.addEventListener("click", () => {
            if (!confirm("Delete this workout?")) return;
            state.workouts = state.workouts.filter((wk) => wk.id !== w.id);
            state.workoutFavorites = state.workoutFavorites.filter(
              (f) => f.id !== w.id
            );
            saveState();
            renderWorkoutFavorites();
            renderWorkoutsList();
          });
  
          actions.appendChild(favBtn);
          actions.appendChild(delBtn);
  
          item.appendChild(main);
          item.appendChild(actions);
  
          workoutListContainer.appendChild(item);
        });
    }
  
    if (startWorkoutBtn) {
      startWorkoutBtn.addEventListener("click", () => {
        if (!currentWorkout.startTime) {
          currentWorkout.startTime = Date.now();
          if (workoutStartLabel) {
            const d = new Date(currentWorkout.startTime);
            workoutStartLabel.textContent = d.toLocaleTimeString();
          }
          startWorkoutTimer();
        }
        if (!currentWorkout.exercises || currentWorkout.exercises.length === 0) {
          createExerciseRow();
        }
      });
    }
  
    if (addExerciseRowBtn && workoutExercisesContainer) {
      addExerciseRowBtn.addEventListener("click", () => {
        createExerciseRow();
      });
    }
  
    if (saveWorkoutBtn) {
      saveWorkoutBtn.addEventListener("click", () => {
        const name = (workoutNameInput?.value || "").trim();
        const notes = workoutNotesInput?.value || "";
        const exs = currentWorkout.exercises || [];
        if (exs.length === 0) {
          if (!confirm("No exercises added. Save anyway?")) return;
        }
  
        const now = Date.now();
        let startTime = currentWorkout.startTime || now;
        let durationMs = currentWorkout.durationMs || 0;
        if (!durationMs && currentWorkout.startTime) {
          durationMs = now - currentWorkout.startTime;
        }
  
        const workout = {
          id: makeId("workout"),
          name: name || "Workout",
          notes,
          exercises: exs.map((e) => ({
            id: e.id,
            name: e.name,
            sets: e.sets,
            reps: e.reps,
            weight: e.weight,
            done: e.done,
          })),
          startTime,
          durationMs,
        };
  
        state.workouts.push(workout);
        saveState();
        clearCurrentWorkoutUI();
        renderWorkoutsList();
      });
    }
  
    if (workoutNotesInput) {
      workoutNotesInput.addEventListener("input", () => {
        currentWorkout.notes = workoutNotesInput.value;
      });
    }
  
    // *** Workout: manual start/end time editing ***
    function parseDateTimeLocal(str) {
      if (!str) return null;
      const parts = str.trim().split(" ");
      const datePart = parts[0];
      if (!datePart) return null;
      const [y, m, d] = datePart.split("-").map(Number);
      let hh = 0,
        mm = 0;
      if (parts[1]) {
        const [hStr, mStr] = parts[1].split(":");
        hh = parseInt(hStr || "0", 10) || 0;
        mm = parseInt(mStr || "0", 10) || 0;
      }
      const dt = new Date(y, (m || 1) - 1, d || 1, hh, mm);
      if (isNaN(dt.getTime())) return null;
      return dt;
    }
  
    (function addManualWorkoutTimeButton() {
      if (!workoutStartLabel) return;
      const startRow = workoutStartLabel.closest(".input-row");
      if (!startRow) return;
      const btn = document.createElement("button");
      btn.className = "btn btn-secondary btn-icon";
      btn.textContent = "üïí";
      btn.title = "Set start/end time manually";
      startRow.appendChild(btn);
  
      btn.addEventListener("click", () => {
        const currentStart =
          currentWorkout.startTime || Date.now();
        const defStart = new Date(currentStart)
          .toISOString()
          .slice(0, 16)
          .replace("T", " ");
  
        const startStr = prompt(
          "Start (YYYY-MM-DD HH:MM):",
          defStart
        );
        if (!startStr) return;
        const startDt = parseDateTimeLocal(startStr);
        if (!startDt) {
          alert("Invalid start date/time.");
          return;
        }
  
        const defEndDt = new Date(startDt.getTime() + 60 * 60 * 1000);
        const defEnd = defEndDt
          .toISOString()
          .slice(0, 16)
          .replace("T", " ");
  
        const endStr = prompt(
          "End (YYYY-MM-DD HH:MM):",
          defEnd
        );
        if (!endStr) return;
        const endDt = parseDateTimeLocal(endStr);
        if (!endDt || endDt <= startDt) {
          alert("End must be after start.");
          return;
        }
  
        currentWorkout.startTime = startDt.getTime();
        currentWorkout.durationMs = endDt.getTime() - startDt.getTime();
        stopWorkoutTimer();
  
        if (workoutStartLabel) {
          workoutStartLabel.textContent = startDt.toLocaleString();
        }
        if (workoutDurationLabel) {
          workoutDurationLabel.textContent = formatDuration(
            currentWorkout.durationMs
          );
        }
      });
    })();
  
    renderWorkoutFavorites();
    renderWorkoutsList();
  
    // -----------------------------
    // FINANCE
    // -----------------------------
    const financeAccountSelect = document.getElementById("financeAccount");
    const financeTypeSelect = document.getElementById("financeType");
    const financeAmountInput = document.getElementById("financeAmount");
    const financeDateInput = document.getElementById("financeDate");
    const financeCategoryInput = document.getElementById("financeCategory");
    const financeMethodInput = document.getElementById("financeMethod");
    const financeNoteInput = document.getElementById("financeNote");
    const addFinanceBtn = document.getElementById("addFinanceBtn");
    const financeFilterCategory = document.getElementById(
      "financeFilterCategory"
    );
    const financeSummary = document.getElementById("financeSummary");
    const noFinanceMsg = document.getElementById("noFinanceMsg");
    const financeListContainer = document.getElementById("financeList");
  
    const addAccountBtn = document.getElementById("addAccountBtn");
    const noAccountsMsg = document.getElementById("noAccountsMsg");
    const accountsListContainer = document.getElementById("accountsList");
  
    function refreshAccountsUI() {
      if (!financeAccountSelect || !accountsListContainer || !noAccountsMsg)
        return;
  
      financeAccountSelect.innerHTML = "";
      state.financeAccounts.forEach((acc, idx) => {
        const opt = document.createElement("option");
        opt.value = acc.id;
        opt.textContent = acc.name || `Account ${idx + 1}`;
        financeAccountSelect.appendChild(opt);
      });
  
      accountsListContainer.innerHTML = "";
      if (state.financeAccounts.length === 0) {
        noAccountsMsg.style.display = "block";
      } else {
        noAccountsMsg.style.display = "none";
        state.financeAccounts.forEach((acc) => {
          const item = document.createElement("div");
          item.className = "item";
  
          const main = document.createElement("div");
          main.className = "item-main";
  
          const titleWrap = document.createElement("div");
          titleWrap.className = "item-text";
  
          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = acc.name;
  
          const meta = document.createElement("div");
          meta.className = "item-meta";
  
          const sum = state.financeTransactions
            .filter((t) => t.accountId === acc.id)
            .reduce(
              (total, t) =>
                t.type === "income" ? total + t.amount : total - t.amount,
              0
            );
  
          const balTag = document.createElement("span");
          balTag.className = "tag";
          balTag.textContent = `Balance: ${sum.toFixed(2)}`;
          meta.appendChild(balTag);
  
          titleWrap.appendChild(title);
          titleWrap.appendChild(meta);
          main.appendChild(titleWrap);
  
          const actions = document.createElement("div");
          actions.className = "item-actions";
  
          const editBtn = document.createElement("button");
          editBtn.className = "icon-btn";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "Rename account";
  
          editBtn.addEventListener("click", () => {
            const newName = prompt("New account name:", acc.name);
            if (newName === null) return;
            acc.name = newName.trim() || acc.name;
            saveState();
            refreshAccountsUI();
          });
  
          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóë";
          delBtn.title = "Delete account";
  
          delBtn.addEventListener("click", () => {
            if (
              !confirm(
                "Delete this account? (Transactions will remain but may become 'orphaned')"
              )
            )
              return;
            state.financeAccounts = state.financeAccounts.filter(
              (a) => a.id !== acc.id
            );
            saveState();
            refreshAccountsUI();
            renderFinance();
          });
  
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
  
          item.appendChild(main);
          item.appendChild(actions);
  
          accountsListContainer.appendChild(item);
        });
      }
    }
  
    if (addAccountBtn) {
      addAccountBtn.addEventListener("click", () => {
        const name = prompt(
          "Account name (e.g. THB main, BRL, USD):",
          "New account"
        );
        if (!name) return;
        state.financeAccounts.push({
          id: makeId("acc"),
          name: name.trim(),
        });
        saveState();
        refreshAccountsUI();
      });
    }
  
    function renderFinance() {
      if (!financeListContainer || !noFinanceMsg || !financeSummary) return;
  
      financeListContainer.innerHTML = "";
  
      const catFilter = financeFilterCategory?.value || "all";
      const txs = state.financeTransactions || [];
  
      const filtered = txs.filter((t) => {
        if (catFilter === "all") return true;
        return (t.category || "").toLowerCase() === catFilter.toLowerCase();
      });
  
      if (filtered.length === 0) {
        noFinanceMsg.style.display = "block";
      } else {
        noFinanceMsg.style.display = "none";
      }
  
      let totalIncome = 0;
      let totalExpense = 0;
  
      filtered
        .slice()
        .sort((a, b) => (b.date || "").localeCompare(a.date || ""))
        .forEach((t) => {
          if (t.type === "income") totalIncome += t.amount;
          else totalExpense += t.amount;
  
          const item = document.createElement("div");
          item.className = "item";
  
          const main = document.createElement("div");
          main.className = "item-main";
  
          const textWrap = document.createElement("div");
          textWrap.className = "item-text";
  
          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = `${t.type === "income" ? "+" : "-"}${t.amount.toFixed(
            2
          )} ${t.category || ""}`;
  
          const meta = document.createElement("div");
          meta.className = "item-meta";
  
          const dateTag = document.createElement("span");
          dateTag.className = "tag";
          dateTag.textContent = t.date || "";
          meta.appendChild(dateTag);
  
          const acc = state.financeAccounts.find((a) => a.id === t.accountId);
          if (acc) {
            const accTag = document.createElement("span");
            accTag.className = "tag";
            accTag.textContent = acc.name;
            meta.appendChild(accTag);
          }
  
          if (t.method) {
            const mTag = document.createElement("span");
            mTag.className = "tag";
            mTag.textContent = t.method;
            meta.appendChild(mTag);
          }
  
          if (t.note) {
            const nTag = document.createElement("span");
            nTag.className = "tag";
            nTag.textContent = `üìù ${t.note}`;
            meta.appendChild(nTag);
          }
  
          const typeTag = document.createElement("span");
          typeTag.className =
            "tag " + (t.type === "income" ? "tag-income" : "tag-expense");
          typeTag.textContent = t.type === "income" ? "Income" : "Expense";
          meta.appendChild(typeTag);
  
          textWrap.appendChild(title);
          textWrap.appendChild(meta);
          main.appendChild(textWrap);
  
          const actions = document.createElement("div");
          actions.className = "item-actions";
  
          const editBtn = document.createElement("button");
          editBtn.className = "icon-btn";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "Edit transaction";
  
          editBtn.addEventListener("click", () => {
            const newAmountStr = prompt(
              "Edit amount:",
              t.amount != null ? String(t.amount) : ""
            );
            if (newAmountStr === null) return;
            const newAmt = parseFloat(newAmountStr);
            if (!isNaN(newAmt) && newAmt >= 0) t.amount = newAmt;
  
            const newCat = prompt(
              "Edit category:",
              t.category != null ? t.category : ""
            );
            if (newCat !== null) t.category = newCat.trim();
  
            const newMethod = prompt(
              "Edit method (cash, card...):",
              t.method != null ? t.method : ""
            );
            if (newMethod !== null) t.method = newMethod.trim();
  
            const newNote = prompt(
              "Edit note:",
              t.note != null ? t.note : ""
            );
            if (newNote !== null) t.note = newNote.trim();
  
            saveState();
            renderFinance();
            refreshAccountsUI();
          });
  
          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóë";
          delBtn.title = "Delete transaction";
  
          delBtn.addEventListener("click", () => {
            if (!confirm("Delete this transaction?")) return;
            state.financeTransactions = state.financeTransactions.filter(
              (x) => x.id !== t.id
            );
            saveState();
            renderFinance();
            refreshAccountsUI();
          });
  
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
  
          item.appendChild(main);
          item.appendChild(actions);
  
          financeListContainer.appendChild(item);
        });
  
      const net = totalIncome - totalExpense;
      financeSummary.textContent = `Income: ${totalIncome.toFixed(
        2
      )}  |  Expense: ${totalExpense.toFixed(
        2
      )}  |  Net: ${net.toFixed(2)}`;
    }
  
    if (addFinanceBtn) {
      addFinanceBtn.addEventListener("click", () => {
        if (!financeAccountSelect || state.financeAccounts.length === 0) {
          alert("Please add an account first.");
          return;
        }
        const accountId = financeAccountSelect.value;
        const type = financeTypeSelect?.value || "expense";
        const amountStr = financeAmountInput?.value || "";
        const amount = parseFloat(amountStr);
        if (isNaN(amount) || amount <= 0) return;
        const date =
          financeDateInput?.value || new Date().toISOString().slice(0, 10);
        const category = (financeCategoryInput?.value || "").trim();
        const method = (financeMethodInput?.value || "").trim();
        const note = (financeNoteInput?.value || "").trim();
  
        state.financeTransactions.push({
          id: makeId("tx"),
          accountId,
          type,
          amount,
          date,
          category,
          method,
          note,
        });
        saveState();
  
        if (financeAmountInput) financeAmountInput.value = "";
        if (financeNoteInput) financeNoteInput.value = "";
        renderFinance();
        refreshAccountsUI();
      });
    }
  
    if (financeFilterCategory) {
      financeFilterCategory.addEventListener("change", renderFinance);
    }
  
    refreshAccountsUI();
    renderFinance();
  
    // -----------------------------
    // -----------------------------
    // NOTES (tabs: Text + Canvas)
    // -----------------------------
    const notesPage = document.querySelector('.page[data-page="notes"]');
    if (notesPage) {
      notesPage.innerHTML = `
        <h2 class="section-title">Notes</h2>
        <div class="card">
          <div class="card-header" style="justify-content:space-between; align-items:center;">
            <div></div>
            <div style="display:flex; gap:6px;">
              <button id="notesTabText" class="btn btn-secondary btn-icon" title="Text notes">üìù</button>
              <button id="notesTabCanvas" class="btn btn-secondary btn-icon" title="Canvas">‚úèÔ∏è</button>
            </div>
          </div>
    
          <!-- TEXT NOTES -->
          <div id="notesTextSection" class="input-grid">
            <div class="input-row">
              <textarea id="notesText" placeholder="Write anything you don't want to forget..."></textarea>
            </div>
          </div>
    
          <!-- CANVAS NOTES -->
          <div id="notesCanvasSection" class="input-grid" style="display:none;">
            <div class="input-row-inline">
              <div class="input-row">
                <label>Board</label>
                <div style="display:flex; gap:6px;">
                  <button id="notesBoardDark" class="btn btn-secondary btn-icon" title="Black board">‚¨õ</button>
                  <button id="notesBoardLight" class="btn btn-secondary btn-icon" title="White board">‚¨ú</button>
                </div>
              </div>
              <div class="input-row" style="align-items:flex-end; display:flex; gap:6px; justify-content:flex-end;">
                <button id="notesCanvasClear" class="btn btn-secondary btn-icon" title="Clear canvas">üßπ</button>
                <button id="notesCanvasSave" class="btn btn-secondary btn-icon" title="Save as image">üíæ</button>
                <button id="notesToggleCanvasSize" class="btn btn-secondary btn-icon" title="Expand / shrink canvas">‚§¢</button>
              </div>
            </div>
            <div class="input-row">
              <div id="notesCanvasWrapper" style="width:100%; max-height:400px; overflow:hidden;">
                <canvas id="notesCanvas" style="border-radius:12px; background:#050608; border:1px solid #26293a; display:block;"></canvas>
              </div>
            </div>
          </div>
        </div>
      `;
    
      // --- grab elements
      const notesTabText = document.getElementById("notesTabText");
      const notesTabCanvas = document.getElementById("notesTabCanvas");
      const notesTextSection = document.getElementById("notesTextSection");
      const notesCanvasSection = document.getElementById("notesCanvasSection");
    
      const notesText = document.getElementById("notesText");
      const notesCanvas = document.getElementById("notesCanvas");
      const notesCanvasWrapper = document.getElementById("notesCanvasWrapper");
    
      const notesBoardDark = document.getElementById("notesBoardDark");
      const notesBoardLight = document.getElementById("notesBoardLight");
      const notesCanvasClear = document.getElementById("notesCanvasClear");
      const notesCanvasSave = document.getElementById("notesCanvasSave");
      const notesToggleCanvasSize = document.getElementById("notesToggleCanvasSize");
    
      // --- load saved text from state
      if (notesText) {
        notesText.value = state.notesText || "";
        notesText.addEventListener("input", () => {
          state.notesText = notesText.value;
          saveState();
        });
      }
    
      // --- tab switching (and sidebar behavior)
      function activateNotesTab(tab) {
        if (tab === "text") {
          notesTextSection.style.display = "block";
          notesCanvasSection.style.display = "none";
          if (typeof disableCanvasSidebarMode === "function") {
            disableCanvasSidebarMode();
          }
        } else {
          notesTextSection.style.display = "none";
          notesCanvasSection.style.display = "block";
          if (typeof enableCanvasSidebarMode === "function") {
            enableCanvasSidebarMode();
          }
          resizeNotesCanvas();
        }
      }
    
      if (notesTabText) {
        notesTabText.addEventListener("click", () => activateNotesTab("text"));
      }
      if (notesTabCanvas) {
        notesTabCanvas.addEventListener("click", () => activateNotesTab("canvas"));
      }
    
      // default: text tab
      activateNotesTab("text");
    
      // --- canvas drawing logic
      if (notesCanvas && notesCanvasWrapper) {
        const ctx = notesCanvas.getContext("2d");
        let drawing = false;
        let lastX = 0;
        let lastY = 0;
        let expanded = false;
    
        let boardColor = "#000000";
        let strokeColor = "#ffffff";
    
        function resizeNotesCanvas() {
          const rect = notesCanvasWrapper.getBoundingClientRect();
          const maxHeight = Math.min(380, window.innerHeight - 200);
          notesCanvas.width = Math.floor(rect.width - 4);
          notesCanvas.height = expanded
            ? Math.min(380, maxHeight)
            : Math.min(240, maxHeight);
    
          // repaint background
          ctx.setTransform(1, 0, 0, 1, 0, 0);
          ctx.fillStyle = boardColor;
          ctx.fillRect(0, 0, notesCanvas.width, notesCanvas.height);
        }
    
        function startDraw(x, y) {
          drawing = true;
          lastX = x;
          lastY = y;
        }
    
        function drawTo(x, y) {
          if (!drawing) return;
          ctx.lineWidth = 2.5;
          ctx.lineJoin = "round";
          ctx.lineCap = "round";
          ctx.globalCompositeOperation = "source-over";
          ctx.strokeStyle = strokeColor;
    
          ctx.beginPath();
          ctx.moveTo(lastX, lastY);
          ctx.lineTo(x, y);
          ctx.stroke();
          lastX = x;
          lastY = y;
        }
    
        function endDraw() {
          drawing = false;
        }
    
        // mouse events
        notesCanvas.addEventListener("mousedown", (e) => {
          const rect = notesCanvas.getBoundingClientRect();
          startDraw(e.clientX - rect.left, e.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("mousemove", (e) => {
          const rect = notesCanvas.getBoundingClientRect();
          drawTo(e.clientX - rect.left, e.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("mouseup", endDraw);
        notesCanvas.addEventListener("mouseleave", endDraw);
    
        // touch events
        notesCanvas.addEventListener("touchstart", (e) => {
          e.preventDefault();
          const t = e.touches[0];
          const rect = notesCanvas.getBoundingClientRect();
          startDraw(t.clientX - rect.left, t.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("touchmove", (e) => {
          e.preventDefault();
          const t = e.touches[0];
          const rect = notesCanvas.getBoundingClientRect();
          drawTo(t.clientX - rect.left, t.clientY - rect.top);
        });
    
        notesCanvas.addEventListener("touchend", endDraw);
        notesCanvas.addEventListener("touchcancel", endDraw);
    
        // board color buttons
        function setDarkBoard() {
          boardColor = "#000000";
          strokeColor = "#ffffff";
          resizeNotesCanvas();
        }
        function setLightBoard() {
          boardColor = "#ffffff";
          strokeColor = "#000000";
          resizeNotesCanvas();
        }
    
        if (notesBoardDark) {
          notesBoardDark.addEventListener("click", setDarkBoard);
        }
        if (notesBoardLight) {
          notesBoardLight.addEventListener("click", setLightBoard);
        }
    
        // clear button
        if (notesCanvasClear) {
          notesCanvasClear.addEventListener("click", () => {
            ctx.fillStyle = boardColor;
            ctx.fillRect(0, 0, notesCanvas.width, notesCanvas.height);
          });
        }
    
        // save image button
        if (notesCanvasSave) {
          notesCanvasSave.addEventListener("click", () => {
            const link = document.createElement("a");
            link.download = "myhub-notes.png";
            link.href = notesCanvas.toDataURL("image/png");
            link.click();
          });
        }
    
        // expand / shrink canvas
        if (notesToggleCanvasSize) {
          notesToggleCanvasSize.addEventListener("click", () => {
            expanded = !expanded;
            notesToggleCanvasSize.textContent = expanded ? "‚§°" : "‚§¢";
            resizeNotesCanvas();
            // collapse sidebar if available (optional)
            if (typeof sidebar !== "undefined" && sidebar) {
              sidebar.classList.remove("expanded");
            }
          });
        }
    
        // initial setup
        window.addEventListener("resize", resizeNotesCanvas);
        setDarkBoard();
      }
    }
    // ---
    
    // -----------------------------
    // MEALS ‚Äì basic macros per day
    // -----------------------------
    const mealsPage = document.querySelector('.page[data-page="meals"]');
    if (mealsPage) {
      mealsPage.innerHTML = `
        <h2 class="section-title">Meals</h2>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Add meal</div>
          </div>
          <div class="input-grid">
            <div class="input-row-inline">
              <div class="input-row">
                <label for="mealDate">Date</label>
                <input id="mealDate" type="date" />
              </div>
              <div class="input-row">
                <label for="mealFood">Food</label>
                <input id="mealFood" type="text" placeholder="e.g. Chicken breast, yogurt..." />
              </div>
            </div>
            <div class="input-row-inline">
              <div class="input-row">
                <label for="mealAmount">Amount</label>
                <input id="mealAmount" type="number" step="0.01" min="0" placeholder="0" />
              </div>
              <div class="input-row">
                <label for="mealUnit">Unit</label>
                <select id="mealUnit">
                  <option value="g">g</option>
                  <option value="ml">ml</option>
                  <option value="piece">piece</option>
                  <option value="sachet">sachet</option>
                  <option value="cup">cup</option>
                  <option value="slice">slice</option>
                  <option value="other">other</option>
                </select>
              </div>
            </div>
            <div class="input-row-inline">
              <div class="input-row">
                <label for="mealProtein">Protein (g)</label>
                <input id="mealProtein" type="number" step="0.1" min="0" />
              </div>
              <div class="input-row">
                <label for="mealCarbs">Carbs (g)</label>
                <input id="mealCarbs" type="number" step="0.1" min="0" />
              </div>
              <div class="input-row">
                <label for="mealFat">Fat (g)</label>
                <input id="mealFat" type="number" step="0.1" min="0" />
              </div>
            </div>
            <div class="input-row" style="align-items:flex-end;">
              <button id="addMealBtn" class="btn">‚ûï Add meal</button>
            </div>
          </div>
        </div>
  
        <div class="card">
          <div class="card-header">
            <div class="card-title">Daily log</div>
          </div>
          <div class="input-grid">
            <div class="input-row-inline">
              <div class="input-row">
                <label for="mealViewDate">View date</label>
                <input id="mealViewDate" type="date" />
              </div>
            </div>
          </div>
          <div id="mealsEmptyMsg" class="empty-msg">No meals logged for this date.</div>
          <div id="mealsList" class="list"></div>
          <div id="mealsTotals" class="empty-msg"></div>
        </div>
      `;
  
      const mealDateInput = document.getElementById("mealDate");
      const mealFoodInput = document.getElementById("mealFood");
      const mealAmountInput = document.getElementById("mealAmount");
      const mealUnitSelect = document.getElementById("mealUnit");
      const mealProteinInput = document.getElementById("mealProtein");
      const mealCarbsInput = document.getElementById("mealCarbs");
      const mealFatInput = document.getElementById("mealFat");
      const addMealBtn = document.getElementById("addMealBtn");
  
      const mealViewDateInput = document.getElementById("mealViewDate");
      const mealsEmptyMsg = document.getElementById("mealsEmptyMsg");
      const mealsListContainer = document.getElementById("mealsList");
      const mealsTotals = document.getElementById("mealsTotals");
  
      const todayStr = new Date().toISOString().slice(0, 10);
      if (mealDateInput) mealDateInput.value = todayStr;
      if (mealViewDateInput) mealViewDateInput.value = todayStr;
  
      function renderMeals() {
        if (!mealsListContainer || !mealsEmptyMsg || !mealsTotals) return;
        const date = mealViewDateInput?.value || todayStr;
        mealsListContainer.innerHTML = "";
  
        const entries = (state.meals || []).filter((m) => m.date === date);
        if (entries.length === 0) {
          mealsEmptyMsg.style.display = "block";
          mealsTotals.textContent = "";
          return;
        }
        mealsEmptyMsg.style.display = "none";
  
        let totals = { protein: 0, carbs: 0, fat: 0 };
  
        entries.forEach((m) => {
          const item = document.createElement("div");
          item.className = "item";
  
          const main = document.createElement("div");
          main.className = "item-main";
  
          const textWrap = document.createElement("div");
          textWrap.className = "item-text";
  
          const title = document.createElement("div");
          title.className = "item-title";
          title.textContent = `${m.food} ‚Äì ${m.amount} ${m.unit}`;
  
          const meta = document.createElement("div");
          meta.className = "item-meta";
  
          if (m.protein != null) {
            const p = document.createElement("span");
            p.className = "tag";
            p.textContent = `P: ${m.protein}g`;
            meta.appendChild(p);
            totals.protein += m.protein;
          }
          if (m.carbs != null) {
            const c = document.createElement("span");
            c.className = "tag";
            c.textContent = `C: ${m.carbs}g`;
            meta.appendChild(c);
            totals.carbs += m.carbs;
          }
          if (m.fat != null) {
            const f = document.createElement("span");
            f.className = "tag";
            f.textContent = `F: ${m.fat}g`;
            meta.appendChild(f);
            totals.fat += m.fat;
          }
  
          textWrap.appendChild(title);
          if (meta.childNodes.length > 0) textWrap.appendChild(meta);
          main.appendChild(textWrap);
  
          const actions = document.createElement("div");
          actions.className = "item-actions";
  
          const editBtn = document.createElement("button");
          editBtn.className = "icon-btn";
          editBtn.textContent = "‚úèÔ∏è";
          editBtn.title = "Edit meal";
  
          editBtn.addEventListener("click", () => {
            const newFood = prompt("Food:", m.food || "");
            if (newFood === null) return;
            m.food = newFood.trim() || m.food;
  
            const newAmtStr = prompt(
              "Amount:",
              m.amount != null ? String(m.amount) : ""
            );
            if (newAmtStr !== null) {
              const val = parseFloat(newAmtStr);
              if (!isNaN(val) && val >= 0) m.amount = val;
            }
  
            const newProtStr = prompt(
              "Protein (g):",
              m.protein != null ? String(m.protein) : ""
            );
            if (newProtStr !== null) {
              const val = parseFloat(newProtStr);
              m.protein = !isNaN(val) && val >= 0 ? val : m.protein;
            }
  
            const newCarbStr = prompt(
              "Carbs (g):",
              m.carbs != null ? String(m.carbs) : ""
            );
            if (newCarbStr !== null) {
              const val = parseFloat(newCarbStr);
              m.carbs = !isNaN(val) && val >= 0 ? val : m.carbs;
            }
  
            const newFatStr = prompt(
              "Fat (g):",
              m.fat != null ? String(m.fat) : ""
            );
            if (newFatStr !== null) {
              const val = parseFloat(newFatStr);
              m.fat = !isNaN(val) && val >= 0 ? val : m.fat;
            }
  
            saveState();
            renderMeals();
          });
  
          const delBtn = document.createElement("button");
          delBtn.className = "icon-btn danger";
          delBtn.textContent = "üóë";
          delBtn.title = "Delete meal";
  
          delBtn.addEventListener("click", () => {
            if (!confirm("Delete this meal entry?")) return;
            state.meals = state.meals.filter((x) => x.id !== m.id);
            saveState();
            renderMeals();
          });
  
          actions.appendChild(editBtn);
          actions.appendChild(delBtn);
  
          item.appendChild(main);
          item.appendChild(actions);
  
          mealsListContainer.appendChild(item);
        });
  
        const kcal =
          totals.protein * 4 + totals.carbs * 4 + totals.fat * 9;
  
        mealsTotals.textContent = `Totals ‚Äì Protein: ${totals.protein.toFixed(
          1
        )}g | Carbs: ${totals.carbs.toFixed(
          1
        )}g | Fat: ${totals.fat.toFixed(1)}g | ~${kcal.toFixed(0)} kcal`;
      }
  
      if (addMealBtn) {
        addMealBtn.addEventListener("click", () => {
          const date = mealDateInput?.value || todayStr;
          const food = (mealFoodInput?.value || "").trim();
          const amtStr = mealAmountInput?.value || "";
          const unit = mealUnitSelect?.value || "g";
          if (!food) return;
          const amount = parseFloat(amtStr || "0") || 0;
          const prot = mealProteinInput?.value
            ? parseFloat(mealProteinInput.value)
            : null;
          const carbs = mealCarbsInput?.value
            ? parseFloat(mealCarbsInput.value)
            : null;
          const fat = mealFatInput?.value
            ? parseFloat(mealFatInput.value)
            : null;
  
          state.meals.push({
            id: makeId("meal"),
            date,
            food,
            amount,
            unit,
            protein: prot,
            carbs,
            fat,
          });
          saveState();
  
          if (mealFoodInput) mealFoodInput.value = "";
          if (mealAmountInput) mealAmountInput.value = "";
          if (mealProteinInput) mealProteinInput.value = "";
          if (mealCarbsInput) mealCarbsInput.value = "";
          if (mealFatInput) mealFatInput.value = "";
  
          if (mealViewDateInput) mealViewDateInput.value = date;
          renderMeals();
        });
      }
  
      if (mealViewDateInput) {
        mealViewDateInput.addEventListener("change", renderMeals);
      }
  
      renderMeals();
    }
  
    // -----------------------------
    // CALENDAR ‚Äì monthly with dots
    // -----------------------------
    const calendarPage = document.querySelector('.page[data-page="calendar"]');
    if (calendarPage) {
      calendarPage.innerHTML = `
        <h2 class="section-title">Calendar</h2>
        <div class="card">
          <div class="card-header">
            <div class="card-title">Monthly view</div>
          </div>
          <div class="input-grid">
            <div class="input-row-inline" style="align-items:center;">
              <button id="calPrevMonth" class="btn btn-secondary btn-icon">‚óÄ</button>
              <div class="input-row" style="flex:1; text-align:center;">
                <label id="calMonthLabel"></label>
              </div>
              <button id="calNextMonth" class="btn btn-secondary btn-icon">‚ñ∂</button>
            </div>
          </div>
          <div id="calendarGrid" style="margin-top:8px;"></div>
        </div>
      `;
  
      const calPrevMonthBtn = document.getElementById("calPrevMonth");
      const calNextMonthBtn = document.getElementById("calNextMonth");
      const calMonthLabel = document.getElementById("calMonthLabel");
      const calendarGrid = document.getElementById("calendarGrid");
  
      let calYear, calMonth;
      const today = new Date();
      calYear = today.getFullYear();
      calMonth = today.getMonth();
  
      function getEventsForDate(dateStr) {
        return (state.calendarEvents || []).filter((e) => e.date === dateStr);
      }
  
      function renderCalendar() {
        if (!calendarGrid || !calMonthLabel) return;
        const firstOfMonth = new Date(calYear, calMonth, 1);
        const monthName = firstOfMonth.toLocaleString(undefined, {
          month: "long",
          year: "numeric",
        });
        calMonthLabel.textContent = monthName;
  
        const startDay = (firstOfMonth.getDay() + 6) % 7; // Monday=0
        const daysInMonth = new Date(calYear, calMonth + 1, 0).getDate();
  
        const weeks = [];
        let currentDay = 1;
  
        for (let row = 0; row < 6; row++) {
          const week = [];
          for (let col = 0; col < 7; col++) {
            if (row === 0 && col < startDay) {
              week.push(null);
            } else if (currentDay > daysInMonth) {
              week.push(null);
            } else {
              week.push(currentDay);
              currentDay++;
            }
          }
          weeks.push(week);
        }
  
        const weekdays = ["Mon", "Tue", "Wed", "Thu", "Fri", "Sat", "Sun"];
        let html = `<div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; font-size:11px; color:#a0a4b8;">`;
        weekdays.forEach((w) => {
          html += `<div style="text-align:center; padding:4px 0;">${w}</div>`;
        });
        html += `</div>`;
  
        html += `<div style="display:grid; grid-template-columns:repeat(7,1fr); gap:4px; margin-top:4px;">`;
  
        weeks.forEach((week) => {
          week.forEach((day) => {
            if (!day) {
              html += `<div style="height:40px; border-radius:10px; background:#0b0d14;"></div>`;
            } else {
              const dateStr = new Date(calYear, calMonth, day)
                .toISOString()
                .slice(0, 10);
              const evts = getEventsForDate(dateStr);
              const hasEvents = evts.length > 0;
              const isToday =
                dateStr === new Date().toISOString().slice(0, 10);
  
              html += `<div
                data-date="${dateStr}"
                style="
                  height:40px;
                  border-radius:10px;
                  background:${isToday ? "#151827" : "#101320"};
                  border:1px solid ${
                    hasEvents ? "rgba(0,188,212,0.6)" : "#26293a"
                  };
                  display:flex;
                  flex-direction:column;
                  align-items:center;
                  justify-content:center;
                  font-size:12px;
                  cursor:pointer;
                  position:relative;
                "
              >
                <span>${day}</span>
                ${
                  hasEvents
                    ? `<span style="width:6px;height:6px;border-radius:999px;background:#00bcd4;position:absolute;bottom:5px;"></span>`
                    : ""
                }
              </div>`;
            }
          });
        });
  
        html += `</div>`;
  
        calendarGrid.innerHTML = html;
  
        calendarGrid.querySelectorAll("[data-date]").forEach((cell) => {
          cell.addEventListener("click", () => {
            const dateStr = cell.getAttribute("data-date");
            const existing = getEventsForDate(dateStr);
            let promptMsg = `Events on ${dateStr}:\n`;
            if (existing.length === 0) {
              promptMsg += "(none yet)\n\nAdd a new event (leave blank to cancel):";
            } else {
              existing.forEach((e, idx) => {
                promptMsg += `${idx + 1}. ${e.text}\n`;
              });
              promptMsg +=
                "\nAdd another event for this date (leave blank to cancel):";
            }
            const text = prompt(promptMsg);
            if (!text) return;
            state.calendarEvents.push({
              id: makeId("event"),
              date: dateStr,
              text: text.trim(),
            });
            saveState();
            renderCalendar();
          });
        });
      }
  
      if (calPrevMonthBtn) {
        calPrevMonthBtn.addEventListener("click", () => {
          calMonth--;
          if (calMonth < 0) {
            calMonth = 11;
            calYear--;
          }
          renderCalendar();
        });
      }
  
      if (calNextMonthBtn) {
        calNextMonthBtn.addEventListener("click", () => {
          calMonth++;
          if (calMonth > 11) {
            calMonth = 0;
            calYear++;
          }
          renderCalendar();
        });
      }
  
      renderCalendar();
    }
  
    // Initial renders
    renderTodos();
    renderShopping();
  });
  </script>
</body>
</html>




