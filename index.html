<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>MyHub v0.2</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="manifest" href="manifest.webmanifest" />
  <meta name="theme-color" content="#121212" />
  <link rel="icon" href="icon-192.png" />
  <style>
    :root {
      --bg: #0e1116;
      --bg-elevated: #161b22;
      --accent: #3b82f6;
      --accent-soft: rgba(59, 130, 246, 0.15);
      --text: #e5e7eb;
      --text-soft: #9ca3af;
      --danger: #ef4444;
      --border: #1f2933;
      --radius-lg: 14px;
      --radius-md: 10px;
      --radius-sm: 6px;
      --shadow-soft: 0 10px 25px rgba(0, 0, 0, 0.35);
    }

    * {
      box-sizing: border-box;
    }

    html,
    body {
      margin: 0;
      padding: 0;
      height: 100%;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI",
        sans-serif;
      background: radial-gradient(circle at top, #111827 0, #020617 55%);
      color: var(--text);
      overscroll-behavior-y: none;
    }

    body {
      display: flex;
      justify-content: center;
      align-items: stretch;
    }

    .app-root {
      height: 100vh;
      width: 100%;
      max-width: 720px;
      overflow-y: auto;
      -webkit-overflow-scrolling: touch;
      overscroll-behavior-y: contain;
      padding: 12px 10px 18px;
    }

    header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 10px;
    }

    .app-title {
      font-size: 1.1rem;
      font-weight: 700;
      letter-spacing: 0.04em;
      text-transform: uppercase;
      color: #f9fafb;
    }

    .app-badge {
      font-size: 0.75rem;
      padding: 3px 8px;
      border-radius: 999px;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
    }

    nav {
      display: grid;
      grid-template-columns: repeat(5, minmax(0, 1fr));
      gap: 6px;
      margin-bottom: 12px;
    }

    .nav-btn {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 6px 4px;
      font-size: 0.7rem;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
      cursor: pointer;
      transition: 0.16s ease;
    }

    .nav-btn span {
      font-size: 0.9rem;
    }

    .nav-btn.active {
      background: radial-gradient(circle at top left, #1e3a8a, #111827);
      color: #eff6ff;
      border-color: rgba(37, 99, 235, 0.7);
      box-shadow: 0 6px 18px rgba(37, 99, 235, 0.4);
      transform: translateY(-1px);
    }

    main {
      display: flex;
      flex-direction: column;
      gap: 10px;
    }

    section {
      display: none;
    }

    section.active {
      display: block;
    }

    .card {
      background: radial-gradient(circle at top, #111827, #020617);
      border-radius: var(--radius-lg);
      padding: 12px 12px 10px;
      border: 1px solid var(--border);
      box-shadow: var(--shadow-soft);
    }

    .card-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      margin-bottom: 8px;
    }

    .card-title {
      font-size: 0.95rem;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .card-title span.icon {
      display: inline-flex;
      width: 20px;
      height: 20px;
      border-radius: 999px;
      align-items: center;
      justify-content: center;
      font-size: 0.75rem;
      background: var(--accent-soft);
      color: var(--accent);
    }

    .card-subtitle {
      font-size: 0.78rem;
      color: var(--text-soft);
      margin-bottom: 6px;
    }

    .pill-row {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      margin-bottom: 6px;
    }

    .pill {
      border-radius: 999px;
      padding: 3px 8px;
      font-size: 0.68rem;
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.8);
      color: var(--text-soft);
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .pill.accent {
      border-color: rgba(59, 130, 246, 0.4);
      background: rgba(15, 23, 42, 0.96);
      color: #dbeafe;
    }

    .pill-dot {
      width: 6px;
      height: 6px;
      border-radius: 999px;
      background: var(--accent);
    }

    .btn,
    button {
      font-family: inherit;
    }

    .btn {
      border-radius: 999px;
      border: none;
      padding: 7px 10px;
      font-size: 0.75rem;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      transition: 0.16s ease;
      background: rgba(15, 23, 42, 0.9);
      color: var(--text-soft);
      border: 1px solid var(--border);
    }

    .btn.primary {
      background: linear-gradient(135deg, #2563eb, #4f46e5);
      color: #eff6ff;
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow: 0 4px 12px rgba(37, 99, 235, 0.4);
    }

    .btn.small {
      padding: 4px 8px;
      font-size: 0.7rem;
    }

    .btn.icon-only {
      padding: 5px 6px;
      width: 28px;
      height: 28px;
      justify-content: center;
    }

    .btn:hover {
      transform: translateY(-0.5px);
      box-shadow: 0 4px 12px rgba(15, 23, 42, 0.8);
    }

    .btn.primary:hover {
      box-shadow: 0 5px 14px rgba(37, 99, 235, 0.55);
    }

    input,
    select,
    textarea {
      width: 100%;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.95);
      color: var(--text);
      padding: 6px 8px;
      font-size: 0.8rem;
      outline: none;
      transition: 0.16s ease;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: rgba(59, 130, 246, 0.7);
      box-shadow: 0 0 0 1px rgba(59, 130, 246, 0.3);
    }

    textarea {
      resize: vertical;
      min-height: 60px;
    }

    .row {
      display: flex;
      gap: 6px;
    }

    .row > * {
      flex: 1;
    }

    .list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 6px;
    }

    .list-item {
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.96);
      padding: 6px 7px;
      display: flex;
      align-items: flex-start;
      gap: 7px;
      font-size: 0.78rem;
    }

    .list-item-main {
      flex: 1;
      min-width: 0;
    }

    .list-item-title {
      font-weight: 500;
      margin-bottom: 2px;
    }

    .list-item-meta {
      display: flex;
      flex-wrap: wrap;
      gap: 4px;
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .chip {
      border-radius: 999px;
      border: 1px solid var(--border);
      padding: 1px 6px;
      font-size: 0.68rem;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .chip.high {
      border-color: rgba(239, 68, 68, 0.6);
      color: #fecaca;
    }

    .chip.done {
      border-color: rgba(34, 197, 94, 0.6);
      color: #bbf7d0;
    }

    .chip.half {
      border-color: rgba(234, 179, 8, 0.6);
      color: #fef3c7;
    }

    .chip.overdue {
      border-color: rgba(248, 113, 113, 0.7);
      color: #fecaca;
    }

    .item-actions {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .btn-ghost {
      border-radius: 999px;
      border: none;
      background: transparent;
      font-size: 0.7rem;
      color: var(--text-soft);
      cursor: pointer;
      padding: 2px 4px;
    }

    .btn-ghost.danger {
      color: var(--danger);
    }

    .hidden {
      display: none !important;
    }

    .filter-toggle-row {
      display: flex;
      justify-content: flex-end;
      margin-bottom: 4px;
    }

    .filter-panel {
      margin-bottom: 6px;
      border-radius: var(--radius-md);
      border: 1px solid var(--border);
      background: rgba(15, 23, 42, 0.98);
      padding: 6px;
      font-size: 0.76rem;
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .filter-panel-row {
      display: flex;
      gap: 6px;
    }

    .filter-panel-row > * {
      flex: 1;
    }

    .filter-panel-actions {
      display: flex;
      justify-content: flex-end;
      gap: 6px;
      margin-top: 2px;
    }

    .home-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 8px;
      margin-bottom: 6px;
    }

    .home-module {
      border-radius: var(--radius-lg);
      border: 1px solid var(--border);
      background: radial-gradient(circle at top left, #111827, #020617);
      padding: 8px 8px 6px;
      cursor: pointer;
      transition: 0.16s ease;
    }

    .home-module:hover {
      transform: translateY(-1px);
      box-shadow: 0 6px 16px rgba(15, 23, 42, 0.9);
    }

    .home-module-title {
      font-size: 0.8rem;
      margin-bottom: 2px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 4px;
    }

    .home-module-count {
      font-size: 0.7rem;
      color: var(--text-soft);
    }

    .today-tasks-list {
      list-style: none;
      margin: 0;
      padding: 0;
      display: flex;
      flex-direction: column;
      gap: 4px;
      font-size: 0.76rem;
    }

    .today-tasks-item {
      display: flex;
      justify-content: space-between;
      gap: 6px;
      padding: 4px 6px;
      border-radius: var(--radius-md);
      background: rgba(15, 23, 42, 0.9);
      border: 1px solid var(--border);
    }

    .today-tasks-title {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .today-tasks-meta {
      font-size: 0.7rem;
      color: var(--text-soft);
    }
  </style>
</head>
<body>
  <div class="app-root" id="app-root">
    <header>
      <div>
        <div class="app-title">MyHub</div>
        <div class="card-subtitle">Your personal life hub ¬∑ v0.2</div>
      </div>
      <div class="app-badge">PWA ¬∑ Local only</div>
    </header>

    <nav>
      <button class="nav-btn active" data-view="home">
        <span>üè†</span>
        Home
      </button>
      <button class="nav-btn" data-view="todo">
        <span>‚úÖ</span>
        To-Do
      </button>
      <button class="nav-btn" data-view="shopping">
        <span>üõí</span>
        Shop
      </button>
      <button class="nav-btn" data-view="workouts">
        <span>üèãÔ∏è</span>
        Gym
      </button>
      <button class="nav-btn" data-view="finance">
        <span>üí∞</span>
        Money
      </button>
    </nav>

    <main>
      <!-- HOME / DASHBOARD -->
      <section id="home-section" class="active">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üìÖ</span>
              Today overview
            </div>
          </div>
          <div class="card-subtitle">
            Quick glance at your most important things today.
          </div>

          <div class="home-grid">
            <div
              class="home-module"
              data-jump="todo"
              id="home-module-todo"
            >
              <div class="home-module-title">
                <span>To-dos</span>
                <span class="home-module-count" id="home-todo-count">
                  ‚Äì
                </span>
              </div>
              <div class="card-subtitle">
                Due or overdue tasks for today.
              </div>
            </div>

            <div
              class="home-module"
              data-jump="finance"
              id="home-module-finance"
            >
              <div class="home-module-title">
                <span>Money</span>
                <span class="home-module-count" id="home-finance-count">
                  ‚Äì
                </span>
              </div>
              <div class="card-subtitle">
                Expenses logged this month.
              </div>
            </div>

            <div
              class="home-module"
              data-jump="workouts"
              id="home-module-workouts"
            >
              <div class="home-module-title">
                <span>Workout</span>
                <span class="home-module-count" id="home-workout-count">
                  ‚Äì
                </span>
              </div>
              <div class="card-subtitle">
                Last workout & quick jump to logs.
              </div>
            </div>

            <div
              class="home-module"
              data-jump="shopping"
              id="home-module-shopping"
            >
              <div class="home-module-title">
                <span>Shopping</span>
                <span class="home-module-count" id="home-shopping-count">
                  ‚Äì
                </span>
              </div>
              <div class="card-subtitle">
                Items left in your active list.
              </div>
            </div>
          </div>

          <div class="card-subtitle" style="margin-top: 4px;">
            Quick task for today:
          </div>
          <form id="quick-task-form" class="row" style="margin-bottom: 6px;">
            <input
              type="text"
              id="quick-task-text"
              placeholder="Quick task (auto due today)"
            />
            <button type="submit" class="btn primary small">
              Add
            </button>
          </form>

          <ul class="today-tasks-list" id="today-tasks-list"></ul>
        </div>
      </section>

      <!-- TO-DO SECTION -->
      <section id="todo-section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">‚úÖ</span>
              To-Do Lists (v0.2)
            </div>
            <button
              type="button"
              id="todo-filter-toggle"
              class="btn icon-only"
              title="Filters"
            >
              üîç
            </button>
          </div>

          <div class="filter-panel hidden" id="todo-filter-panel">
            <div class="filter-panel-row">
              <select id="todo-filter-status">
                <option value="all">Status: All</option>
                <option value="todo">Not done</option>
                <option value="half">Half done</option>
                <option value="done">Done</option>
              </select>
              <select id="todo-filter-priority">
                <option value="all">Priority: All</option>
                <option value="high">High only</option>
                <option value="medium">Medium</option>
                <option value="low">Low</option>
              </select>
            </div>
            <div class="filter-panel-row">
              <select id="todo-filter-sort">
                <option value="smart">Sort: Smart (priority + due)</option>
                <option value="dueAsc">Sort: Due date ‚Üë</option>
                <option value="dueDesc">Sort: Due date ‚Üì</option>
              </select>
              <input
                type="text"
                id="todo-filter-text"
                placeholder="Search text"
              />
            </div>
            <div class="filter-panel-actions">
              <button
                type="button"
                id="todo-filter-clear"
                class="btn small"
              >
                Clear
              </button>
              <button
                type="button"
                id="todo-filter-apply"
                class="btn primary small"
              >
                Apply
              </button>
            </div>
          </div>

          <div class="card-subtitle">
            Simple single to-do list for now. v0.3 will add multiple lists & more.
          </div>

          <form id="todo-form" style="margin-bottom: 8px;">
            <input
              type="text"
              id="todo-text"
              placeholder="New task..."
              required
              style="margin-bottom: 4px;"
            />
            <div class="row">
              <select id="todo-priority">
                <option value="medium">Medium priority</option>
                <option value="high">High priority</option>
                <option value="low">Low priority</option>
              </select>
              <input type="date" id="todo-due" />
            </div>
          </form>

          <ul class="list" id="todo-list"></ul>
        </div>
      </section>

      <!-- SHOPPING SECTION -->
      <section id="shopping-section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üõí</span>
              Shopping List
            </div>
          </div>
          <div class="card-subtitle">
            v0.2 keeps a single list with drag & drop. v0.3 will add multiple lists.
          </div>

          <form id="shopping-form" style="margin-bottom: 8px;">
            <input
              type="text"
              id="shopping-text"
              placeholder="New item..."
              required
            />
          </form>

          <ul class="list" id="shopping-list"></ul>
        </div>
      </section>

      <!-- WORKOUTS SECTION -->
      <section id="workouts-section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üèãÔ∏è</span>
              Workouts (basic logs)
            </div>
          </div>
          <div class="card-subtitle">
            Simple notes for now. v0.6 will add templates & detailed tracking.
          </div>

          <form id="workout-form" style="margin-bottom: 8px;">
            <input
              type="text"
              id="workout-text"
              placeholder="Workout note (e.g., Workout B - legs, 60min)"
              required
            />
          </form>

          <ul class="list" id="workout-list"></ul>
        </div>
      </section>

      <!-- FINANCE SECTION -->
      <section id="finance-section">
        <div class="card">
          <div class="card-header">
            <div class="card-title">
              <span class="icon">üí∞</span>
              Finance (basic logs)
            </div>
          </div>
          <div class="card-subtitle">
            v0.2: simple entries. v0.5 will add accounts, categories & analysis.
          </div>

          <form id="finance-form" style="margin-bottom: 8px;">
            <div class="row" style="margin-bottom: 4px;">
              <input
                type="number"
                step="0.01"
                id="finance-amount"
                placeholder="Amount"
                required
              />
              <select id="finance-type">
                <option value="expense">Expense</option>
                <option value="income">Income</option>
              </select>
            </div>
            <div class="row" style="margin-bottom: 4px;">
              <input
                type="text"
                id="finance-category"
                placeholder="Category (e.g., Food, Rent)"
              />
              <input type="date" id="finance-date" />
            </div>
            <input
              type="text"
              id="finance-note"
              placeholder="Note (optional)"
            />
          </form>

          <ul class="list" id="finance-list"></ul>
        </div>
      </section>
    </main>
  </div>

  <script>
    // =============================
    // Storage & State
    // =============================
    const STORAGE_KEY = "myhub-data-v0.2";

    const defaultState = {
      tasks: [],
      shoppingItems: [],
      workouts: [],
      finances: [],
    };

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (!raw) return structuredClone(defaultState);
        const parsed = JSON.parse(raw);
        return {
          tasks: Array.isArray(parsed.tasks) ? parsed.tasks : [],
          shoppingItems: Array.isArray(parsed.shoppingItems)
            ? parsed.shoppingItems
            : [],
          workouts: Array.isArray(parsed.workouts) ? parsed.workouts : [],
          finances: Array.isArray(parsed.finances) ? parsed.finances : [],
        };
      } catch (e) {
        console.error("Failed to parse state:", e);
        return structuredClone(defaultState);
      }
    }

    let state = loadState();

    function saveState() {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
      refreshHomeDashboard();
    }

    // =============================
    // Navigation & Back Button
    // =============================

    const navButtons = document.querySelectorAll(".nav-btn");
    const sections = {
      home: document.getElementById("home-section"),
      todo: document.getElementById("todo-section"),
      shopping: document.getElementById("shopping-section"),
      workouts: document.getElementById("workouts-section"),
      finance: document.getElementById("finance-section"),
    };

    let currentView = "home";

    function setActiveNav(view) {
      navButtons.forEach((btn) => {
        btn.classList.toggle(
          "active",
          btn.getAttribute("data-view") === view
        );
      });
    }

    function showView(view, push = true) {
      if (!sections[view]) view = "home";
      currentView = view;
      Object.entries(sections).forEach(([k, el]) => {
        el.classList.toggle("active", k === view);
      });
      setActiveNav(view);
      if (push) {
        history.pushState({ view }, "", "#" + view);
      }
    }

    navButtons.forEach((btn) => {
      btn.addEventListener("click", () => {
        const view = btn.getAttribute("data-view");
        if (view !== currentView) {
          showView(view, true);
        }
      });
    });

    // Home module quick jumps
    document.querySelectorAll(".home-module").forEach((mod) => {
      mod.addEventListener("click", () => {
        const view = mod.getAttribute("data-jump");
        showView(view, true);
      });
    });

    window.addEventListener("popstate", (event) => {
      const view = event.state && event.state.view ? event.state.view : "home";
      showView(view, false);
    });

    // On load: respect hash if exists
    window.addEventListener("DOMContentLoaded", () => {
      const hash = window.location.hash.replace("#", "");
      if (hash && sections[hash]) {
        showView(hash, true);
      } else {
        showView("home", true);
      }
      renderAll();
    });

    // =============================
    // Helpers
    // =============================
    function todayISO() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function isOverdue(task) {
      if (!task.dueDate) return false;
      if (task.status === "done") return false;
      const today = todayISO();
      return task.dueDate < today;
    }

    // =============================
    // To-Do Logic
    // =============================

    // Task shape: { id, text, priority, dueDate, status }
    const todoListEl = document.getElementById("todo-list");
    const todoForm = document.getElementById("todo-form");
    const todoTextInput = document.getElementById("todo-text");
    const todoPriorityInput = document.getElementById("todo-priority");
    const todoDueInput = document.getElementById("todo-due");

    let todoFilters = {
      status: "all",
      priority: "all",
      sort: "smart",
      text: "",
    };

    const filterToggleBtn = document.getElementById("todo-filter-toggle");
    const filterPanel = document.getElementById("todo-filter-panel");
    const filterStatusEl = document.getElementById("todo-filter-status");
    const filterPriorityEl = document.getElementById("todo-filter-priority");
    const filterSortEl = document.getElementById("todo-filter-sort");
    const filterTextEl = document.getElementById("todo-filter-text");
    const filterClearBtn = document.getElementById("todo-filter-clear");
    const filterApplyBtn = document.getElementById("todo-filter-apply");

    filterToggleBtn.addEventListener("click", () => {
      filterPanel.classList.toggle("hidden");
    });

    filterClearBtn.addEventListener("click", () => {
      todoFilters = {
        status: "all",
        priority: "all",
        sort: "smart",
        text: "",
      };
      filterStatusEl.value = "all";
      filterPriorityEl.value = "all";
      filterSortEl.value = "smart";
      filterTextEl.value = "";
      renderTasks();
    });

    filterApplyBtn.addEventListener("click", () => {
      todoFilters = {
        status: filterStatusEl.value,
        priority: filterPriorityEl.value,
        sort: filterSortEl.value,
        text: filterTextEl.value.trim().toLowerCase(),
      };
      renderTasks();
    });

    todoForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = todoTextInput.value.trim();
      if (!text) return;
      const task = {
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
        text,
        priority: todoPriorityInput.value,
        dueDate: todoDueInput.value || "",
        status: "todo", // todo | half | done
      };
      state.tasks.push(task);
      saveState();
      todoForm.reset();
      renderTasks();
    });

    function updateTaskStatus(id, status) {
      const t = state.tasks.find((t) => t.id === id);
      if (!t) return;
      t.status = status;
      saveState();
      renderTasks();
    }

    function deleteTask(id) {
      const t = state.tasks.find((x) => x.id === id);
      if (!t) return;
      const ok = confirm(`Delete this task?\n\n${t.text}`);
      if (!ok) return;
      state.tasks = state.tasks.filter((t) => t.id !== id);
      saveState();
      renderTasks();
    }

    function editTask(id) {
      const t = state.tasks.find((x) => x.id === id);
      if (!t) return;
      const newText = prompt("Edit task text:", t.text);
      if (newText === null) return;
      const trimmed = newText.trim();
      if (!trimmed) return;
      t.text = trimmed;
      saveState();
      renderTasks();
    }

    function sortedAndFilteredTasks() {
      let tasks = [...state.tasks];

      // Filter
      if (todoFilters.status !== "all") {
        tasks = tasks.filter((t) => t.status === todoFilters.status);
      }
      if (todoFilters.priority !== "all") {
        tasks = tasks.filter((t) => t.priority === todoFilters.priority);
      }
      if (todoFilters.text) {
        tasks = tasks.filter((t) =>
          t.text.toLowerCase().includes(todoFilters.text)
        );
      }

      // Sort
      const today = todayISO();
      tasks.sort((a, b) => {
        if (todoFilters.sort === "dueAsc" || todoFilters.sort === "dueDesc") {
          const ad = a.dueDate || "9999-12-31";
          const bd = b.dueDate || "9999-12-31";
          if (ad < bd) return todoFilters.sort === "dueAsc" ? -1 : 1;
          if (ad > bd) return todoFilters.sort === "dueAsc" ? 1 : -1;
          return 0;
        }

        // smart: priority first, then dueDate, then status
        const prioRank = { high: 0, medium: 1, low: 2 };
        const aPr = prioRank[a.priority] ?? 3;
        const bPr = prioRank[b.priority] ?? 3;
        if (aPr !== bPr) return aPr - bPr;

        const ad = a.dueDate || "9999-12-31";
        const bd = b.dueDate || "9999-12-31";
        if (ad < bd) return -1;
        if (ad > bd) return 1;

        const statusRank = { todo: 0, half: 1, done: 2 };
        const aSt = statusRank[a.status] ?? 3;
        const bSt = statusRank[b.status] ?? 3;
        return aSt - bSt;
      });

      return tasks;
    }

    function renderTasks() {
      todoListEl.innerHTML = "";
      const tasks = sortedAndFilteredTasks();
      if (!tasks.length) {
        const li = document.createElement("li");
        li.className = "card-subtitle";
        li.textContent = "No tasks yet. Add your first one above.";
        todoListEl.appendChild(li);
        return;
      }

      tasks.forEach((task) => {
        const li = document.createElement("li");
        li.className = "list-item";

        const main = document.createElement("div");
        main.className = "list-item-main";

        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = task.text;
        main.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "list-item-meta";

        const prChip = document.createElement("span");
        prChip.className = "chip " + (task.priority === "high" ? "high" : "");
        prChip.textContent =
          "Priority: " + task.priority.charAt(0).toUpperCase() + task.priority.slice(1);
        meta.appendChild(prChip);

        if (task.dueDate) {
          const dueChip = document.createElement("span");
          dueChip.className =
            "chip" + (isOverdue(task) ? " overdue" : "");
          dueChip.textContent =
            "Due: " + task.dueDate + (isOverdue(task) ? " (overdue)" : "");
          meta.appendChild(dueChip);
        }

        const stChip = document.createElement("span");
        stChip.className =
          "chip " +
          (task.status === "done"
            ? "done"
            : task.status === "half"
            ? "half"
            : "");
        stChip.textContent =
          task.status === "done"
            ? "Done"
            : task.status === "half"
            ? "Half done"
            : "Not done";
        meta.appendChild(stChip);

        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const btnTodo = document.createElement("button");
        btnTodo.className = "btn-ghost";
        btnTodo.textContent = "Not done";
        btnTodo.onclick = () => updateTaskStatus(task.id, "todo");

        const btnHalf = document.createElement("button");
        btnHalf.className = "btn-ghost";
        btnHalf.textContent = "Half";
        btnHalf.onclick = () => updateTaskStatus(task.id, "half");

        const btnDone = document.createElement("button");
        btnDone.className = "btn-ghost";
        btnDone.textContent = "Done";
        btnDone.onclick = () => updateTaskStatus(task.id, "done");

        const btnEdit = document.createElement("button");
        btnEdit.className = "btn-ghost";
        btnEdit.textContent = "Edit";
        btnEdit.onclick = () => editTask(task.id);

        const btnDel = document.createElement("button");
        btnDel.className = "btn-ghost danger";
        btnDel.textContent = "Delete";
        btnDel.onclick = () => deleteTask(task.id);

        actions.appendChild(btnTodo);
        actions.appendChild(btnHalf);
        actions.appendChild(btnDone);
        actions.appendChild(btnEdit);
        actions.appendChild(btnDel);

        li.appendChild(main);
        li.appendChild(actions);
        todoListEl.appendChild(li);
      });

      refreshHomeDashboard();
    }

    // =============================
    // Shopping Logic (with delete confirm)
    // =============================

    const shoppingForm = document.getElementById("shopping-form");
    const shoppingInput = document.getElementById("shopping-text");
    const shoppingListEl = document.getElementById("shopping-list");

    // item: { id, text, checked }
    shoppingForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = shoppingInput.value.trim();
      if (!text) return;
      state.shoppingItems.push({
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
        text,
        checked: false,
      });
      saveState();
      shoppingForm.reset();
      renderShopping();
    });

    function toggleShoppingItem(id) {
      const item = state.shoppingItems.find((i) => i.id === id);
      if (!item) return;
      item.checked = !item.checked;
      saveState();
      renderShopping();
    }

    function deleteShoppingItem(id) {
      const item = state.shoppingItems.find((i) => i.id === id);
      if (!item) return;
      const ok = confirm(`Delete this item?\n\n${item.text}`);
      if (!ok) return;
      state.shoppingItems = state.shoppingItems.filter((i) => i.id !== id);
      saveState();
      renderShopping();
    }

    function renderShopping() {
      shoppingListEl.innerHTML = "";
      if (!state.shoppingItems.length) {
        const li = document.createElement("li");
        li.className = "card-subtitle";
        li.textContent = "Empty list. Add items above.";
        shoppingListEl.appendChild(li);
        refreshHomeDashboard();
        return;
      }

      state.shoppingItems.forEach((item) => {
        const li = document.createElement("li");
        li.className = "list-item";
        li.draggable = true;

        li.addEventListener("dragstart", (e) => {
          e.dataTransfer.setData("text/plain", item.id);
        });

        li.addEventListener("dragover", (e) => {
          e.preventDefault();
        });

        li.addEventListener("drop", (e) => {
          e.preventDefault();
          const draggedId = e.dataTransfer.getData("text/plain");
          reorderShoppingItems(draggedId, item.id);
        });

        const main = document.createElement("div");
        main.className = "list-item-main";

        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = item.text;
        main.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        const status = document.createElement("span");
        status.className = "chip " + (item.checked ? "done" : "");
        status.textContent = item.checked ? "Got it" : "Pending";
        meta.appendChild(status);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const btnToggle = document.createElement("button");
        btnToggle.className = "btn-ghost";
        btnToggle.textContent = item.checked ? "Uncheck" : "Check";
        btnToggle.onclick = () => toggleShoppingItem(item.id);

        const btnDel = document.createElement("button");
        btnDel.className = "btn-ghost danger";
        btnDel.textContent = "Delete";
        btnDel.onclick = () => deleteShoppingItem(item.id);

        actions.appendChild(btnToggle);
        actions.appendChild(btnDel);

        li.appendChild(main);
        li.appendChild(actions);
        shoppingListEl.appendChild(li);
      });

      refreshHomeDashboard();
    }

    function reorderShoppingItems(draggedId, targetId) {
      if (draggedId === targetId) return;
      const items = state.shoppingItems;
      const fromIndex = items.findIndex((i) => i.id === draggedId);
      const toIndex = items.findIndex((i) => i.id === targetId);
      if (fromIndex === -1 || toIndex === -1) return;
      const [moved] = items.splice(fromIndex, 1);
      items.splice(toIndex, 0, moved);
      saveState();
      renderShopping();
    }

    // =============================
    // Workouts (basic)
    // =============================

    const workoutForm = document.getElementById("workout-form");
    const workoutInput = document.getElementById("workout-text");
    const workoutListEl = document.getElementById("workout-list");

    workoutForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = workoutInput.value.trim();
      if (!text) return;
      state.workouts.push({
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
        text,
        date: todayISO(),
      });
      saveState();
      workoutForm.reset();
      renderWorkouts();
    });

    function deleteWorkout(id) {
      const w = state.workouts.find((x) => x.id === id);
      if (!w) return;
      const ok = confirm(`Delete this workout log?\n\n${w.text}`);
      if (!ok) return;
      state.workouts = state.workouts.filter((w) => w.id !== id);
      saveState();
      renderWorkouts();
    }

    function renderWorkouts() {
      workoutListEl.innerHTML = "";
      if (!state.workouts.length) {
        const li = document.createElement("li");
        li.className = "card-subtitle";
        li.textContent = "No workouts logged yet.";
        workoutListEl.appendChild(li);
        refreshHomeDashboard();
        return;
      }

      const sorted = [...state.workouts].sort((a, b) =>
        a.date < b.date ? 1 : -1
      );
      sorted.forEach((w) => {
        const li = document.createElement("li");
        li.className = "list-item";

        const main = document.createElement("div");
        main.className = "list-item-main";

        const title = document.createElement("div");
        title.className = "list-item-title";
        title.textContent = w.text;
        main.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        const chip = document.createElement("span");
        chip.className = "chip";
        chip.textContent = "Date: " + (w.date || "?");
        meta.appendChild(chip);
        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const btnDel = document.createElement("button");
        btnDel.className = "btn-ghost danger";
        btnDel.textContent = "Delete";
        btnDel.onclick = () => deleteWorkout(w.id);

        actions.appendChild(btnDel);

        li.appendChild(main);
        li.appendChild(actions);
        workoutListEl.appendChild(li);
      });

      refreshHomeDashboard();
    }

    // =============================
    // Finance (basic)
    // =============================

    const financeForm = document.getElementById("finance-form");
    const financeAmount = document.getElementById("finance-amount");
    const financeType = document.getElementById("finance-type");
    const financeCategory = document.getElementById("finance-category");
    const financeDate = document.getElementById("finance-date");
    const financeNote = document.getElementById("finance-note");
    const financeListEl = document.getElementById("finance-list");

    financeForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const amount = parseFloat(financeAmount.value);
      if (isNaN(amount) || amount <= 0) return;
      const type = financeType.value;
      const cat = financeCategory.value.trim() || "Other";
      const date = financeDate.value || todayISO();
      const note = financeNote.value.trim();

      state.finances.push({
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
        amount,
        type,
        category: cat,
        date,
        note,
      });

      saveState();
      financeForm.reset();
      renderFinances();
    });

    function deleteFinance(id) {
      const f = state.finances.find((x) => x.id === id);
      if (!f) return;
      const sign = f.type === "expense" ? "-" : "+";
      const ok = confirm(
        `Delete this entry?\n\n${sign}${f.amount.toFixed(2)} ¬∑ ${
          f.category
        } ¬∑ ${f.date}`
      );
      if (!ok) return;
      state.finances = state.finances.filter((f) => f.id !== id);
      saveState();
      renderFinances();
    }

    function renderFinances() {
      financeListEl.innerHTML = "";
      if (!state.finances.length) {
        const li = document.createElement("li");
        li.className = "card-subtitle";
        li.textContent = "No entries yet.";
        financeListEl.appendChild(li);
        refreshHomeDashboard();
        return;
      }

      const sorted = [...state.finances].sort((a, b) =>
        a.date < b.date ? 1 : -1
      );
      sorted.forEach((f) => {
        const li = document.createElement("li");
        li.className = "list-item";

        const main = document.createElement("div");
        main.className = "list-item-main";

        const title = document.createElement("div");
        title.className = "list-item-title";
        const sign = f.type === "expense" ? "-" : "+";
        title.textContent = `${sign}${f.amount.toFixed(2)} ¬∑ ${f.category}`;
        main.appendChild(title);

        const meta = document.createElement("div");
        meta.className = "list-item-meta";
        const dateChip = document.createElement("span");
        dateChip.className = "chip";
        dateChip.textContent = "Date: " + f.date;
        meta.appendChild(dateChip);

        const typeChip = document.createElement("span");
        typeChip.className =
          "chip " + (f.type === "expense" ? "overdue" : "done");
        typeChip.textContent =
          f.type === "expense" ? "Expense" : "Income";
        meta.appendChild(typeChip);

        if (f.note) {
          const noteChip = document.createElement("span");
          noteChip.className = "chip";
          noteChip.textContent = f.note;
          meta.appendChild(noteChip);
        }

        main.appendChild(meta);

        const actions = document.createElement("div");
        actions.className = "item-actions";

        const btnDel = document.createElement("button");
        btnDel.className = "btn-ghost danger";
        btnDel.textContent = "Delete";
        btnDel.onclick = () => deleteFinance(f.id);

        actions.appendChild(btnDel);

        li.appendChild(main);
        li.appendChild(actions);
        financeListEl.appendChild(li);
      });

      refreshHomeDashboard();
    }

    // =============================
    // Home Dashboard
    // =============================

    const todayTasksListEl = document.getElementById("today-tasks-list");
    const homeTodoCountEl = document.getElementById("home-todo-count");
    const homeFinanceCountEl = document.getElementById("home-finance-count");
    const homeWorkoutCountEl = document.getElementById("home-workout-count");
    const homeShoppingCountEl = document.getElementById("home-shopping-count");

    const quickTaskForm = document.getElementById("quick-task-form");
    const quickTaskInput = document.getElementById("quick-task-text");

    quickTaskForm.addEventListener("submit", (e) => {
      e.preventDefault();
      const text = quickTaskInput.value.trim();
      if (!text) return;
      const task = {
        id: crypto.randomUUID ? crypto.randomUUID() : Date.now().toString(),
        text,
        priority: "medium",
        dueDate: todayISO(),
        status: "todo",
      };
      state.tasks.push(task);
      saveState();
      quickTaskForm.reset();
      renderTasks();
      showView("home", true);
    });

    function refreshHomeDashboard() {
      // Today/overdue tasks
      const today = todayISO();
      const todayTasks = state.tasks.filter((t) => {
        if (!t.dueDate) return false;
        if (t.status === "done") return false;
        return t.dueDate <= today;
      });

      homeTodoCountEl.textContent = todayTasks.length + " today";
      todayTasksListEl.innerHTML = "";

      if (!todayTasks.length) {
        const li = document.createElement("li");
        li.className = "card-subtitle";
        li.textContent = "No tasks due today. üéâ";
        todayTasksListEl.appendChild(li);
      } else {
        todayTasks
          .slice(0, 5)
          .sort((a, b) => (a.dueDate < b.dueDate ? -1 : 1))
          .forEach((t) => {
            const li = document.createElement("li");
            li.className = "today-tasks-item";
            const left = document.createElement("div");
            left.className = "today-tasks-title";
            left.textContent = t.text;
            const right = document.createElement("div");
            right.className = "today-tasks-meta";
            right.textContent =
              (t.dueDate === today ? "Today" : t.dueDate) +
              " ¬∑ " +
              (t.priority === "high"
                ? "High"
                : t.priority === "low"
                ? "Low"
                : "Medium");
            li.appendChild(left);
            li.appendChild(right);
            todayTasksListEl.appendChild(li);
          });
      }

      // Shopping count: pending items
      const pendingShopping = state.shoppingItems.filter(
        (i) => !i.checked
      ).length;
      homeShoppingCountEl.textContent =
        pendingShopping + " pending";

      // Finance: entries this month
      const now = new Date();
      const m = String(now.getMonth() + 1).padStart(2, "0");
      const y = now.getFullYear();
      const prefix = `${y}-${m}-`;
      const thisMonthFinances = state.finances.filter((f) =>
        f.date && f.date.startsWith(prefix)
      );
      homeFinanceCountEl.textContent =
        thisMonthFinances.length + " entries";

      // Workouts: last workout date
      if (!state.workouts.length) {
        homeWorkoutCountEl.textContent = "None yet";
      } else {
        const last = [...state.workouts].sort((a, b) =>
          a.date < b.date ? 1 : -1
        )[0];
        homeWorkoutCountEl.textContent = last.date || "Recent";
      }
    }

    // =============================
    // Initial render
    // =============================

    function renderAll() {
      renderTasks();
      renderShopping();
      renderWorkouts();
      renderFinances();
      refreshHomeDashboard();
    }
  </script>

  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("./service-worker.js")
          .catch(function (err) {
            console.log("Service worker registration failed:", err);
          });
      });
    }
  </script>
</body>
</html>
