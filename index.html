<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>My Personal Hub</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link rel="manifest" href="manifest.webmanifest">
  <meta name="theme-color" content="#007bff">
  <link rel="icon" href="icon-192.png">


  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #f4f4f4;
      color: #222;
      padding: 0.5rem;
      transition: background 0.2s ease, color 0.2s ease;
    }

    header {
      margin-bottom: 0.5rem;
    }

    .header-top {
      display: flex;
      justify-content: space-between;
      align-items: center;
      gap: 0.5rem;
    }

    h1 {
      font-size: 1.4rem;
      margin-bottom: 0.2rem;
    }

    .subtitle {
      font-size: 0.8rem;
      color: #777;
      margin-top: 0.1rem;
    }

    .btn-small {
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
      border: none;
      font-size: 0.75rem;
      background: #e0e0e0;
      cursor: pointer;
    }

    .btn-delete {
      background: #ffdddd;
      color: #b30000;
    }

    /* Screens */
    .screen {
      display: none;
    }
    .screen.active {
      display: block;
    }

    .back-home-row {
      margin-bottom: 0.4rem;
    }

    .back-home-btn {
      font-size: 0.8rem;
    }

    /* Home screen */
    .home-grid {
      display: grid;
      grid-template-columns: repeat(2, minmax(0, 1fr));
      gap: 0.6rem;
      margin-top: 0.3rem;
    }

    @media (min-width: 768px) {
      .home-grid {
        grid-template-columns: repeat(3, minmax(0, 1fr));
      }
    }

    .home-card {
      background: #fff;
      border-radius: 12px;
      padding: 0.8rem;
      display: flex;
      flex-direction: column;
      align-items: flex-start;
      gap: 0.2rem;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
      cursor: pointer;
      transition: transform 0.1s ease, box-shadow 0.1s ease;
      min-height: 80px;
    }

    .home-card:hover {
      transform: translateY(-1px);
      box-shadow: 0 2px 6px rgba(0,0,0,0.12);
    }

    .home-card-icon {
      font-size: 1.4rem;
    }

    .home-card-title {
      font-size: 0.95rem;
      font-weight: 600;
    }

    .home-card-desc {
      font-size: 0.75rem;
      color: #666;
    }

    .home-card-disabled {
      opacity: 0.5;
      cursor: default;
    }

    /* Add row */
    .add-row {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.3rem;
    }

    .add-row input[type="text"],
    .add-row input[type="number"] {
      flex: 1;
      padding: 0.4rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.9rem;
    }

    .add-row button {
      padding: 0.4rem 0.8rem;
      border-radius: 6px;
      border: none;
      font-size: 0.9rem;
      background: #007bff;
      color: #fff;
      cursor: pointer;
    }

    .task-extra-row {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.5rem;
      align-items: center;
      font-size: 0.8rem;
    }

    .task-extra-row select,
    .task-extra-row input[type="date"] {
      flex: 1;
      padding: 0.3rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.8rem;
    }

    /* Filters */
    .filters-row {
      display: flex;
      flex-wrap: wrap;
      gap: 0.3rem;
      margin-bottom: 0.5rem;
      font-size: 0.8rem;
    }

    .filter-group {
      display: flex;
      align-items: center;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    .filter-label {
      font-weight: 600;
      color: #555;
    }

    .filter-btn {
      padding: 0.2rem 0.5rem;
      border-radius: 999px;
      border: 1px solid #ccc;
      background: #fff;
      cursor: pointer;
      font-size: 0.75rem;
    }

    .filter-btn.active {
      background: #007bff;
      color: #fff;
      border-color: #007bff;
      font-weight: 600;
    }

    /* Lists */
    .list {
      display: flex;
      flex-direction: column;
      gap: 0.35rem;
      margin-bottom: 0.5rem;
    }

    .item {
      display: flex;
      flex-direction: column;
      background: #fff;
      padding: 0.5rem;
      border-radius: 8px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.06);
    }

    .item-main {
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }

    .status-dot {
      width: 20px;
      height: 20px;
      border-radius: 999px;
      border: 2px solid #ccc;
      flex-shrink: 0;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 0.7rem;
    }

    .status-not-done {
      border-color: #ccc;
      background: #fff;
    }

    .status-half {
      border-color: #f0ad4e;
      background: #ffe9b8;
    }

    .status-done {
      border-color: #28a745;
      background: #c9f7d3;
    }

    .item-text {
      flex: 1;
      font-size: 0.95rem;
      word-break: break-word;
    }

    .item-text.done {
      text-decoration: line-through;
      color: #999;
    }

    .item-meta-row {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.3rem;
      font-size: 0.75rem;
      gap: 0.3rem;
      flex-wrap: wrap;
    }

    /* Priority pill */
    .priority-pill {
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.75rem;
      border: 1px solid transparent;
      min-width: 55px;
      text-align: center;
    }
    .priority-low {
      border-color: #28a745;
      background: #e6f8ea;
      color: #1d7a32;
    }
    .priority-med {
      border-color: #f0ad4e;
      background: #fff3cd;
      color: #8a6d3b;
    }
    .priority-high {
      border-color: #d9534f;
      background: #fbe3e3;
      color: #a94442;
    }

    .due-label {
      font-size: 0.75rem;
      cursor: pointer;
    }
    .due-today {
      color: #d9534f;
      font-weight: 600;
    }
    .due-overdue {
      color: #b30000;
      font-weight: 600;
    }
    .due-future {
      color: #555;
    }

    .item-controls {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      margin-top: 0.35rem;
      font-size: 0.8rem;
      justify-content: flex-end;
      flex-wrap: wrap;
    }

    /* Shopping */
    .shopping-check {
      width: 18px;
      height: 18px;
      cursor: pointer;
    }

    .note {
      margin-top: 0.35rem;
      font-size: 0.8rem;
      color: #555;
    }

    .note textarea {
      width: 100%;
      min-height: 40px;
      padding: 0.3rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      resize: vertical;
      font-size: 0.8rem;
    }

    .shopping-header-row {
      display: flex;
      gap: 0.3rem;
      margin-bottom: 0.4rem;
      align-items: center;
      font-size: 0.8rem;
    }

    .shopping-header-row select {
      flex: 1;
      padding: 0.3rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.8rem;
    }

    /* Dragging */
    .dragging {
      opacity: 0.5;
    }

    /* Workouts & Finance forms */
    .section-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 0.3rem;
    }

    .section-subtitle {
      font-size: 0.8rem;
      color: #666;
      margin-bottom: 0.4rem;
    }

    .row {
      display: flex;
      gap: 0.4rem;
      margin-bottom: 0.3rem;
    }

    .row select,
    .row input[type="date"],
    .row input[type="number"],
    .row input[type="text"],
    .row textarea {
      flex: 1;
      padding: 0.35rem;
      border-radius: 6px;
      border: 1px solid #ccc;
      font-size: 0.8rem;
    }

    .row textarea {
      min-height: 60px;
      resize: vertical;
    }

    .badge {
      display: inline-block;
      padding: 0.1rem 0.4rem;
      border-radius: 999px;
      font-size: 0.7rem;
      background: #eee;
      color: #333;
    }

    /* Dark mode overrides */
    body.dark {
      background: #121212;
      color: #f1f1f1;
    }

    body.dark .subtitle {
      color: #aaa;
    }

    body.dark .home-card {
      background: #1f1f1f;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
    }

    body.dark .home-card-desc {
      color: #aaa;
    }

    body.dark input[type="text"],
    body.dark input[type="number"],
    body.dark input[type="date"],
    body.dark select,
    body.dark textarea {
      background: #1b1b1b;
      color: #eee;
      border-color: #555;
    }

    body.dark .filter-btn {
      background: #1b1b1b;
      border-color: #555;
      color: #ddd;
    }

    body.dark .filter-btn.active {
      background: #2196f3;
      border-color: #2196f3;
      color: #fff;
    }

    body.dark .item {
      background: #1f1f1f;
      box-shadow: 0 1px 3px rgba(0,0,0,0.7);
    }

    body.dark .btn-small {
      background: #444;
      color: #eee;
    }

    body.dark .btn-delete {
      background: #5c1f1f;
      color: #ffb3b3;
    }

    body.dark .note {
      color: #ccc;
    }
  </style>
</head>

<body>
  <header>
    <div class="header-top">
      <div>
        <h1>My Personal Hub</h1>
        <div class="subtitle">Tasks ‚Ä¢ Shopping ‚Ä¢ Workouts ‚Ä¢ Finances (all in one)</div>
      </div>
      <button id="theme-toggle" class="btn-small">üåô</button>
    </div>
  </header>

  <!-- HOME SCREEN -->
  <section id="home-screen" class="screen active">
    <div class="home-grid">
      <div class="home-card" data-target="tasks-screen">
        <div class="home-card-icon">‚úÖ</div>
        <div class="home-card-title">To-do list</div>
        <div class="home-card-desc">Priority, due dates, filters & calendar export.</div>
      </div>

      <div class="home-card" data-target="shopping-screen">
        <div class="home-card-icon">üõí</div>
        <div class="home-card-title">Shopping lists</div>
        <div class="home-card-desc">Multiple lists with notes and drag & drop.</div>
      </div>

      <div class="home-card" data-target="workouts-screen">
        <div class="home-card-icon">üèãÔ∏è</div>
        <div class="home-card-title">Workouts</div>
        <div class="home-card-desc">Log or plan your different workout days.</div>
      </div>

      <div class="home-card" data-target="finance-screen">
        <div class="home-card-icon">üí∞</div>
        <div class="home-card-title">Finances</div>
        <div class="home-card-desc">Quick expense log with method & category.</div>
      </div>

      <div class="home-card home-card-disabled">
        <div class="home-card-icon">üçΩ</div>
        <div class="home-card-title">Meal tracker</div>
        <div class="home-card-desc">Coming soon: quick meal & macro logs.</div>
      </div>
    </div>
  </section>

  <!-- TASKS SCREEN -->
  <section id="tasks-screen" class="screen">
    <div class="back-home-row">
      <button class="btn-small back-home-btn" onclick="showScreen('home-screen')">‚Üê Home</button>
    </div>

    <!-- Add task -->
    <div class="add-row">
      <input id="new-task-input" type="text" placeholder="New task...">
      <button id="add-task-btn">Add</button>
    </div>

    <!-- Priority + due date for new task -->
    <div class="task-extra-row">
      <select id="task-priority-select">
        <option value="med">Priority: Medium</option>
        <option value="low">Priority: Low</option>
        <option value="high">Priority: High</option>
      </select>
      <input id="task-due-date" type="date">
    </div>

    <!-- Filters -->
    <div class="filters-row">
      <div class="filter-group">
        <span class="filter-label">Status:</span>
        <button class="filter-btn status-filter-btn active" data-status="all">All</button>
        <button class="filter-btn status-filter-btn" data-status="0">Not done</button>
        <button class="filter-btn status-filter-btn" data-status="1">Half</button>
        <button class="filter-btn status-filter-btn" data-status="2">Done</button>
      </div>

      <div class="filter-group">
        <span class="filter-label">Priority:</span>
        <button class="filter-btn priority-filter-btn active" data-priority="all">All</button>
        <button class="filter-btn priority-filter-btn" data-priority="high">High</button>
        <button class="filter-btn priority-filter-btn" data-priority="med">Med</button>
        <button class="filter-btn priority-filter-btn" data-priority="low">Low</button>
      </div>

      <div class="filter-group">
        <span class="filter-label">When:</span>
        <button class="filter-btn when-filter-btn active" data-when="all">All</button>
        <button class="filter-btn when-filter-btn" data-when="today">Today</button>
        <button class="filter-btn when-filter-btn" data-when="overdue">Overdue</button>
        <button class="filter-btn when-filter-btn" data-when="future">Future</button>
      </div>
    </div>

    <!-- Tasks list -->
    <div id="tasks-list" class="list"></div>
  </section>

  <!-- SHOPPING SCREEN -->
  <section id="shopping-screen" class="screen">
    <div class="back-home-row">
      <button class="btn-small back-home-btn" onclick="showScreen('home-screen')">‚Üê Home</button>
    </div>

    <!-- Shopping lists selector -->
    <div class="shopping-header-row">
      <select id="shopping-list-select"></select>
      <button id="add-shopping-list-btn" class="btn-small">+ List</button>
      <button id="rename-shopping-list-btn" class="btn-small">Rename</button>
      <button id="delete-shopping-list-btn" class="btn-small btn-delete">Delete</button>
    </div>

    <div class="add-row">
      <input id="new-item-input" type="text" placeholder="New item...">
      <button id="add-item-btn">Add</button>
    </div>
    <div id="shopping-list" class="list"></div>
  </section>

  <!-- WORKOUTS SCREEN -->
  <section id="workouts-screen" class="screen">
    <div class="back-home-row">
      <button class="btn-small back-home-btn" onclick="showScreen('home-screen')">‚Üê Home</button>
    </div>

    <div class="section-title">Workouts</div>
    <div class="section-subtitle">
      Use this however you want: plan your next workout, or log what you actually did.
    </div>

    <div class="row">
      <input id="workout-date" type="date">
      <input id="workout-type" type="text" placeholder="Workout name (A, B, C...)">
    </div>
    <div class="row">
      <textarea id="workout-notes" placeholder="Notes: exercises, sets, reps, weight, feelings..."></textarea>
    </div>
    <div class="row">
      <button id="add-workout-btn" class="btn-small">Save workout</button>
    </div>

    <div id="workouts-list" class="list"></div>
  </section>

  <!-- FINANCE SCREEN -->
  <section id="finance-screen" class="screen">
    <div class="back-home-row">
      <button class="btn-small back-home-btn" onclick="showScreen('home-screen')">‚Üê Home</button>
    </div>

    <div class="section-title">Finances</div>
    <div class="section-subtitle">
      Quickly log how much you spent, how you paid, and what it was. Later we can add stats & filters.
    </div>

    <div class="row">
      <input id="expense-amount" type="number" step="0.01" placeholder="Amount">
      <select id="expense-method">
        <option value="cash">Cash</option>
        <option value="card">Card</option>
        <option value="scan">Scan / QR</option>
        <option value="transfer">Transfer</option>
        <option value="other">Other</option>
      </select>
    </div>
    <div class="row">
      <input id="expense-category" type="text" placeholder="Category (food, transport, rent, etc.)">
      <input id="expense-date" type="date">
    </div>
    <div class="row">
      <textarea id="expense-note" placeholder="Short note (optional)"></textarea>
    </div>
    <div class="row">
      <button id="add-expense-btn" class="btn-small">Save expense</button>
    </div>

    <div id="finance-list" class="list"></div>
  </section>

  <script>
    // --- GLOBAL NAV ---
    function showScreen(screenId) {
      const screens = document.querySelectorAll(".screen");
      screens.forEach(s => s.classList.remove("active"));
      const target = document.getElementById(screenId);
      if (target) target.classList.add("active");
    }

    // --- STORAGE KEYS ---
    const STORAGE_KEY = "simple_task_shopping_app_v3_dragshopping"; // keep same, just expanding
    const THEME_KEY = "simple_task_shopping_theme";

    // --- APP STATE ---
    let state = {
      tasks: [],
      shoppingLists: [],
      activeShoppingListId: null,
      workouts: [],
      finances: []
    };

    // Filters
    let currentStatusFilter = "all";   // "all", "0", "1", "2"
    let currentPriorityFilter = "all"; // "all", "low", "med", "high"
    let currentWhenFilter = "all";     // "all", "today", "overdue", "future"

    // Theme
    let currentTheme = "light";

    function createId() {
      return Date.now().toString(36) + Math.random().toString(36).slice(2);
    }

    function todayStr() {
      const d = new Date();
      const y = d.getFullYear();
      const m = String(d.getMonth() + 1).padStart(2, "0");
      const day = String(d.getDate()).padStart(2, "0");
      return `${y}-${m}-${day}`;
    }

    function loadState() {
      try {
        const raw = localStorage.getItem(STORAGE_KEY);
        if (raw) {
          const parsed = JSON.parse(raw);

          if (Array.isArray(parsed.tasks)) {
            state.tasks = parsed.tasks;
          }

          if (Array.isArray(parsed.shoppingLists)) {
            state.shoppingLists = parsed.shoppingLists;
            state.activeShoppingListId =
              parsed.activeShoppingListId ||
              (parsed.shoppingLists[0] && parsed.shoppingLists[0].id);
          } else if (Array.isArray(parsed.shopping)) {
            // old single shopping migration
            const oldItems = parsed.shopping;
            if (oldItems.length) {
              const id = createId();
              state.shoppingLists = [{
                id,
                name: "General",
                items: oldItems
              }];
              state.activeShoppingListId = id;
            }
          }

          if (Array.isArray(parsed.workouts)) {
            state.workouts = parsed.workouts;
          }

          if (Array.isArray(parsed.finances)) {
            state.finances = parsed.finances;
          }
        }
      } catch (e) {
        console.error("Error loading state", e);
      }

      ensureShoppingLists();
    }

    function ensureShoppingLists() {
      if (!Array.isArray(state.shoppingLists) || state.shoppingLists.length === 0) {
        const id = createId();
        state.shoppingLists = [{
          id,
          name: "General",
          items: []
        }];
        state.activeShoppingListId = id;
      } else if (
        !state.activeShoppingListId ||
        !state.shoppingLists.some(l => l.id === state.activeShoppingListId)
      ) {
        state.activeShoppingListId = state.shoppingLists[0].id;
      }
    }

    function saveState() {
      const toSave = {
        tasks: state.tasks,
        shoppingLists: state.shoppingLists,
        activeShoppingListId: state.activeShoppingListId,
        workouts: state.workouts,
        finances: state.finances
      };
      localStorage.setItem(STORAGE_KEY, JSON.stringify(toSave));
    }

    function loadTheme() {
      const saved = localStorage.getItem(THEME_KEY);
      if (saved === "dark") {
        applyTheme("dark");
      } else {
        applyTheme("light");
      }
    }

    function applyTheme(theme) {
      currentTheme = theme;
      if (theme === "dark") {
        document.body.classList.add("dark");
      } else {
        document.body.classList.remove("dark");
      }
      const btn = document.getElementById("theme-toggle");
      if (btn) {
        btn.textContent = theme === "dark" ? "‚òÄÔ∏è" : "üåô";
      }
      localStorage.setItem(THEME_KEY, theme);
    }

    // --- DUE DATE HELPERS ---
    function classifyDue(dueDateStr) {
      if (!dueDateStr) return "none";
      try {
        const due = new Date(dueDateStr + "T00:00:00");
        const today = new Date();
        due.setHours(0,0,0,0);
        today.setHours(0,0,0,0);
        const diffDays = Math.round((due - today) / 86400000);

        if (diffDays === 0) return "today";
        if (diffDays < 0) return "overdue";
        if (diffDays > 0) return "future";
        return "none";
      } catch (e) {
        return "none";
      }
    }

    function getDueInfo(dueDateStr) {
      if (!dueDateStr) {
        return { text: "", className: "", category: "none" };
      }
      const category = classifyDue(dueDateStr);
      if (category === "today") {
        return {
          text: "Due today (" + dueDateStr + ")",
          className: "due-today",
          category
        };
      } else if (category === "overdue") {
        return {
          text: "Overdue (" + dueDateStr + ")",
          className: "due-overdue",
          category
        };
      } else if (category === "future") {
        return {
          text: "Due " + dueDateStr,
          className: "due-future",
          category
        };
      }
      return { text: "Due " + dueDateStr, className: "due-future", category };
    }

    // --- TASKS LOGIC ---
    function addTask(text) {
      const trimmed = text.trim();
      if (!trimmed) return;

      const prioritySelect = document.getElementById("task-priority-select");
      const dueInput = document.getElementById("task-due-date");

      const priority = prioritySelect.value || "med";
      const dueDate = dueInput.value || "";

      state.tasks.push({
        id: createId(),
        text: trimmed,
        status: 0,        // 0 = not done, 1 = half, 2 = done
        priority,
        dueDate
      });

      saveState();
      renderTasks();
    }

    function cycleTaskStatus(id) {
      const t = state.tasks.find(t => t.id === id);
      if (!t) return;
      t.status = (t.status + 1) % 3;
      saveState();
      renderTasks();
    }

    function deleteTask(id) {
      state.tasks = state.tasks.filter(t => t.id !== id);
      saveState();
      renderTasks();
    }

    function statusClass(status) {
      if (status === 0) return "status-not-done";
      if (status === 1) return "status-half";
      return "status-done";
    }

    function statusLabel(status) {
      if (status === 0) return "";
      if (status === 1) return "¬Ω";
      return "‚úì";
    }

    // Calendar helpers
    function addToCalendar(taskId) {
      const task = state.tasks.find(t => t.id === taskId);
      if (!task) return;

      const dueStr = (task.dueDate || "").trim();
      if (!dueStr) {
        alert("Set a due date first (tap the due text to edit it).");
        return;
      }

      let startDate;
      try {
        startDate = new Date(dueStr + "T00:00:00");
      } catch (e) {
        alert("Invalid due date.");
        return;
      }

      function formatYMD(date) {
        const y = date.getFullYear();
        const m = String(date.getMonth() + 1).padStart(2, "0");
        const d = String(date.getDate()).padStart(2, "0");
        return `${y}${m}${d}`;
      }

      const startYMD = formatYMD(startDate);
      const endDate = new Date(startDate.getTime());
      endDate.setDate(endDate.getDate() + 1);
      const endYMD = formatYMD(endDate);

      const title = encodeURIComponent(task.text);
      const details = encodeURIComponent("Created from my Personal Hub app");

      const googleUrl =
        `https://calendar.google.com/calendar/render?action=TEMPLATE` +
        `&text=${title}` +
        `&details=${details}` +
        `&dates=${startYMD}/${endYMD}`;

      const useGoogle = window.confirm(
        "OK = Open in Google Calendar\nCancel = Download .ics file for other calendars."
      );

      if (useGoogle) {
        window.open(googleUrl, "_blank");
        return;
      }

      // Generate ICS file
      const icsContent =
        "BEGIN:VCALENDAR\r\n" +
        "VERSION:2.0\r\n" +
        "PRODID:-//MyPersonalHub//EN\r\n" +
        "BEGIN:VEVENT\r\n" +
        "SUMMARY:" + task.text.replace(/\r?\n/g, " ") + "\r\n" +
        "DTSTART;VALUE=DATE:" + startYMD + "\r\n" +
        "DTEND;VALUE=DATE:" + endYMD + "\r\n" +
        "DESCRIPTION:Created from my Personal Hub app\r\n" +
        "END:VEVENT\r\n" +
        "END:VCALENDAR\r\n";

      const blob = new Blob([icsContent], { type: "text/calendar" });
      const url = URL.createObjectURL(blob);
      const a = document.createElement("a");
      a.href = url;
      a.download = (task.text || "task").replace(/[^\w\-]+/g, "_") + ".ics";
      document.body.appendChild(a);
      a.click();
      setTimeout(() => {
        document.body.removeChild(a);
        URL.revokeObjectURL(url);
      }, 0);
    }

    function applyTaskOrderFromDOM() {
      const container = document.getElementById("tasks-list");
      const orderIds = Array.from(container.children)
        .map(el => el.dataset.id)
        .filter(Boolean);
      if (!orderIds.length) return;

      state.tasks.sort((a, b) => {
        const ia = orderIds.indexOf(a.id);
        const ib = orderIds.indexOf(b.id);
        if (ia === -1 && ib === -1) return 0;
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });
      saveState();
    }

    function renderTasks() {
      const container = document.getElementById("tasks-list");
      container.innerHTML = "";

      let tasksToShow = state.tasks.slice();

      // Status filter
      if (currentStatusFilter !== "all") {
        tasksToShow = tasksToShow.filter(
          t => t.status.toString() === currentStatusFilter
        );
      }

      // Priority filter
      if (currentPriorityFilter !== "all") {
        tasksToShow = tasksToShow.filter(
          t => (t.priority || "med") === currentPriorityFilter
        );
      }

      // When filter (today / overdue / future)
      if (currentWhenFilter !== "all") {
        tasksToShow = tasksToShow.filter(t => {
          const cat = classifyDue(t.dueDate || "");
          return cat === currentWhenFilter;
        });
      }

      const canDrag =
        currentStatusFilter === "all" &&
        currentPriorityFilter === "all" &&
        currentWhenFilter === "all";

      tasksToShow.forEach(task => {
        const item = document.createElement("div");
        item.className = "item";
        if (canDrag) {
          item.setAttribute("draggable", "true");
          item.dataset.id = task.id;
          item.addEventListener("dragstart", () => {
            item.classList.add("dragging");
          });
          item.addEventListener("dragend", () => {
            item.classList.remove("dragging");
            applyTaskOrderFromDOM();
          });
        }

        // Main row: status dot + text
        const main = document.createElement("div");
        main.className = "item-main";

        const dot = document.createElement("div");
        dot.className = "status-dot " + statusClass(task.status);
        dot.textContent = statusLabel(task.status);
        dot.title = "Tap to change status";
        dot.addEventListener("click", () => cycleTaskStatus(task.id));

        const textDiv = document.createElement("div");
        textDiv.className = "item-text" + (task.status === 2 ? " done" : "");
        textDiv.textContent = task.text;

        main.appendChild(dot);
        main.appendChild(textDiv);
        item.appendChild(main);

        // Meta row: priority + due date
        const metaRow = document.createElement("div");
        metaRow.className = "item-meta-row";

        // Priority pill
        const priorityPill = document.createElement("span");
        const priority = task.priority || "med";
        priorityPill.className = "priority-pill priority-" + priority;
        if (priority === "low") priorityPill.textContent = "Low priority";
        else if (priority === "high") priorityPill.textContent = "High priority";
        else priorityPill.textContent = "Medium priority";

        metaRow.appendChild(priorityPill);

        // Due label (clickable to edit)
        const dueInfo = getDueInfo(task.dueDate || "");
        const dueSpan = document.createElement("span");
        dueSpan.className = "due-label " + (dueInfo.className || "");
        dueSpan.textContent = dueInfo.text || "No due date";
        dueSpan.title = "Tap to edit due date";
        dueSpan.addEventListener("click", () => {
          const current = task.dueDate || "";
          const newDate = window.prompt(
            "Set due date (YYYY-MM-DD). Leave empty to clear.",
            current
          );
          if (newDate === null) return;
          const trimmed = newDate.trim();
          task.dueDate = trimmed;
          saveState();
          renderTasks();
        });
        metaRow.appendChild(dueSpan);

        item.appendChild(metaRow);

        // Controls: Calendar + Delete
        const controls = document.createElement("div");
        controls.className = "item-controls";

        const calBtn = document.createElement("button");
        calBtn.className = "btn-small";
        calBtn.textContent = "Calendar";
        calBtn.addEventListener("click", () => addToCalendar(task.id));

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-small btn-delete";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => deleteTask(task.id));

        controls.appendChild(calBtn);
        controls.appendChild(deleteBtn);
        item.appendChild(controls);

        container.appendChild(item);
      });
    }

    // --- TASK DRAG-AND-DROP CONTAINER ---
    function setupTaskDragAndDrop() {
      const container = document.getElementById("tasks-list");
      container.addEventListener("dragover", (e) => {
        if (
          !(currentStatusFilter === "all" &&
            currentPriorityFilter === "all" &&
            currentWhenFilter === "all")
        ) {
          return;
        }
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        const dragging = container.querySelector(".dragging");
        if (!dragging) return;
        if (afterElement == null) {
          container.appendChild(dragging);
        } else {
          container.insertBefore(dragging, afterElement);
        }
      });
    }

    function getDragAfterElement(container, y) {
      const elements = [...container.querySelectorAll(".item:not(.dragging)")];
      let closest = { offset: Number.NEGATIVE_INFINITY, element: null };

      elements.forEach(child => {
        const box = child.getBoundingClientRect();
        const offset = y - box.top - box.height / 2;
        if (offset < 0 && offset > closest.offset) {
          closest = { offset, element: child };
        }
      });

      return closest.element;
    }

    // --- SHOPPING LISTS HELPERS ---
    function getActiveShoppingList() {
      return state.shoppingLists.find(l => l.id === state.activeShoppingListId) || null;
    }

    function renderShoppingListSelector() {
      const select = document.getElementById("shopping-list-select");
      if (!select) return;
      select.innerHTML = "";
      state.shoppingLists.forEach(list => {
        const opt = document.createElement("option");
        opt.value = list.id;
        opt.textContent = list.name;
        if (list.id === state.activeShoppingListId) opt.selected = true;
        select.appendChild(opt);
      });
    }

    function addShoppingList() {
      const name = window.prompt("Name of the new list:", "New list");
      if (!name || !name.trim()) return;
      const id = createId();
      state.shoppingLists.push({
        id,
        name: name.trim(),
        items: []
      });
      state.activeShoppingListId = id;
      saveState();
      renderShoppingListSelector();
      renderShopping();
    }

    function renameShoppingList() {
      const list = getActiveShoppingList();
      if (!list) return;
      const name = window.prompt("Rename list:", list.name);
      if (name === null) return;
      if (!name.trim()) return;
      list.name = name.trim();
      saveState();
      renderShoppingListSelector();
    }

    function deleteShoppingList() {
      if (state.shoppingLists.length === 1) {
        const confirmClear = window.confirm(
          "This is your only list. Delete all items in this list?"
        );
        if (!confirmClear) return;
        const list = state.shoppingLists[0];
        list.items = [];
        saveState();
        renderShopping();
        return;
      }

      const list = getActiveShoppingList();
      if (!list) return;
      const confirmDel = window.confirm(
        `Delete list "${list.name}" and all its items?`
      );
      if (!confirmDel) return;

      state.shoppingLists = state.shoppingLists.filter(l => l.id !== list.id);
      if (!state.shoppingLists.length) {
        ensureShoppingLists();
      } else {
        state.activeShoppingListId = state.shoppingLists[0].id;
      }
      saveState();
      renderShoppingListSelector();
      renderShopping();
    }

    // --- SHOPPING DRAG ORDER ---
    function applyShoppingOrderFromDOM() {
      const list = getActiveShoppingList();
      if (!list) return;
      const container = document.getElementById("shopping-list");
      const orderIds = Array.from(container.children)
        .map(el => el.dataset.id)
        .filter(Boolean);
      if (!orderIds.length) return;

      list.items.sort((a, b) => {
        const ia = orderIds.indexOf(a.id);
        const ib = orderIds.indexOf(b.id);
        if (ia === -1 && ib === -1) return 0;
        if (ia === -1) return 1;
        if (ib === -1) return -1;
        return ia - ib;
      });
      saveState();
    }

    function setupShoppingDragAndDrop() {
      const container = document.getElementById("shopping-list");
      container.addEventListener("dragover", (e) => {
        e.preventDefault();
        const afterElement = getDragAfterElement(container, e.clientY);
        const dragging = container.querySelector(".dragging");
        if (!dragging) return;
        if (afterElement == null) {
          container.appendChild(dragging);
        } else {
          container.insertBefore(dragging, afterElement);
        }
      });
    }

    // --- SHOPPING LOGIC ---
    function addItem(text) {
      const trimmed = text.trim();
      if (!trimmed) return;
      const list = getActiveShoppingList();
      if (!list) return;
      list.items.push({
        id: createId(),
        text: trimmed,
        checked: false,
        note: ""
      });
      saveState();
      renderShopping();
    }

    function toggleItemChecked(id) {
      const list = getActiveShoppingList();
      if (!list) return;
      const it = list.items.find(i => i.id === id);
      if (!it) return;
      it.checked = !it.checked;
      saveState();
      renderShopping();
    }

    function updateItemNote(id, noteText) {
      const list = getActiveShoppingList();
      if (!list) return;
      const it = list.items.find(i => i.id === id);
      if (!it) return;
      it.note = noteText;
      saveState();
    }

    function deleteItem(id) {
      const list = getActiveShoppingList();
      if (!list) return;
      list.items = list.items.filter(i => i.id !== id);
      saveState();
      renderShopping();
    }

    function renderShopping() {
      const container = document.getElementById("shopping-list");
      container.innerHTML = "";

      const list = getActiveShoppingList();
      if (!list) return;

      // Keep unchecked on top, checked at bottom, but preserve order inside each group
      const annotated = list.items.map((it, index) => ({ it, index }));
      const sorted = annotated.sort((a, b) => {
        if (a.it.checked === b.it.checked) {
          return a.index - b.index;
        }
        return a.it.checked ? 1 : -1;
      });

      sorted.forEach(({ it }) => {
        const itemData = it;
        const item = document.createElement("div");
        item.className = "item";
        item.setAttribute("draggable", "true");
        item.dataset.id = itemData.id;

        item.addEventListener("dragstart", () => {
          item.classList.add("dragging");
        });
        item.addEventListener("dragend", () => {
          item.classList.remove("dragging");
          applyShoppingOrderFromDOM();
          renderShopping();
        });

        const main = document.createElement("div");
        main.className = "item-main";

        const check = document.createElement("input");
        check.type = "checkbox";
        check.className = "shopping-check";
        check.checked = itemData.checked;
        check.addEventListener("change", () => toggleItemChecked(itemData.id));

        const textDiv = document.createElement("div");
        textDiv.className = "item-text" + (itemData.checked ? " done" : "");
        textDiv.textContent = itemData.text;

        main.appendChild(check);
        main.appendChild(textDiv);
        item.appendChild(main);

        // Note
        const noteDiv = document.createElement("div");
        noteDiv.className = "note";
        const noteArea = document.createElement("textarea");
        noteArea.placeholder = "Note...";
        noteArea.value = itemData.note || "";
        noteArea.addEventListener("input", (e) => {
          updateItemNote(itemData.id, e.target.value);
        });
        noteDiv.appendChild(noteArea);
        item.appendChild(noteDiv);

        // Controls
        const controls = document.createElement("div");
        controls.className = "item-controls";

        const deleteBtn = document.createElement("button");
        deleteBtn.className = "btn-small btn-delete";
        deleteBtn.textContent = "Delete";
        deleteBtn.addEventListener("click", () => deleteItem(itemData.id));

        controls.appendChild(deleteBtn);
        item.appendChild(controls);

        container.appendChild(item);
      });
    }

    // --- WORKOUTS LOGIC ---
    function addWorkout() {
      const dateInput = document.getElementById("workout-date");
      const typeInput = document.getElementById("workout-type");
      const notesInput = document.getElementById("workout-notes");

      const date = (dateInput.value || todayStr()).trim();
      const type = (typeInput.value || "").trim();
      const notes = (notesInput.value || "").trim();

      if (!type && !notes) return;

      state.workouts.unshift({
        id: createId(),
        date,
        type,
        notes
      });

      saveState();
      renderWorkouts();

      // clear notes only, keep type/date for similar workouts
      notesInput.value = "";
    }

    function deleteWorkout(id) {
      state.workouts = state.workouts.filter(w => w.id !== id);
      saveState();
      renderWorkouts();
    }

    function renderWorkouts() {
      const container = document.getElementById("workouts-list");
      container.innerHTML = "";

      // Show newest first
      const workouts = state.workouts.slice();

      workouts.forEach(w => {
        const item = document.createElement("div");
        item.className = "item";

        const top = document.createElement("div");
        top.className = "item-main";

        const title = document.createElement("div");
        title.className = "item-text";
        const name = w.type || "(no name)";
        title.textContent = name;

        const badge = document.createElement("span");
        badge.className = "badge";
        badge.textContent = w.date || "";

        top.appendChild(title);
        top.appendChild(badge);
        item.appendChild(top);

        if (w.notes) {
          const notesDiv = document.createElement("div");
          notesDiv.className = "note";
          notesDiv.textContent = w.notes;
          item.appendChild(notesDiv);
        }

        const controls = document.createElement("div");
        controls.className = "item-controls";

        const delBtn = document.createElement("button");
        delBtn.className = "btn-small btn-delete";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => deleteWorkout(w.id));

        controls.appendChild(delBtn);
        item.appendChild(controls);

        container.appendChild(item);
      });
    }

    // --- FINANCE LOGIC ---
    function addExpense() {
      const amountInput = document.getElementById("expense-amount");
      const methodSelect = document.getElementById("expense-method");
      const categoryInput = document.getElementById("expense-category");
      const dateInput = document.getElementById("expense-date");
      const noteInput = document.getElementById("expense-note");

      const amount = parseFloat(amountInput.value);
      if (isNaN(amount) || amount === 0) return;

      const method = methodSelect.value || "other";
      const category = (categoryInput.value || "").trim();
      const date = (dateInput.value || todayStr()).trim();
      const note = (noteInput.value || "").trim();

      state.finances.unshift({
        id: createId(),
        amount,
        method,
        category,
        date,
        note
      });

      saveState();
      renderFinances();

      amountInput.value = "";
      noteInput.value = "";
    }

    function deleteExpense(id) {
      state.finances = state.finances.filter(f => f.id !== id);
      saveState();
      renderFinances();
    }

    function renderFinances() {
      const container = document.getElementById("finance-list");
      container.innerHTML = "";

      const finances = state.finances.slice();

      finances.forEach(f => {
        const item = document.createElement("div");
        item.className = "item";

        const main = document.createElement("div");
        main.className = "item-main";

        const text = document.createElement("div");
        text.className = "item-text";
        const category = f.category || "Uncategorized";
        text.textContent = `${category} ‚Äì ${f.amount.toFixed(2)}`;

        const right = document.createElement("div");
        right.style.display = "flex";
        right.style.flexDirection = "column";
        right.style.alignItems = "flex-end";
        right.style.fontSize = "0.75rem";

        const methodSpan = document.createElement("span");
        methodSpan.className = "badge";
        methodSpan.textContent = f.method;

        const dateSpan = document.createElement("span");
        dateSpan.textContent = f.date;

        right.appendChild(methodSpan);
        right.appendChild(dateSpan);

        main.appendChild(text);
        main.appendChild(right);
        item.appendChild(main);

        if (f.note) {
          const noteDiv = document.createElement("div");
          noteDiv.className = "note";
          noteDiv.textContent = f.note;
          item.appendChild(noteDiv);
        }

        const controls = document.createElement("div");
        controls.className = "item-controls";

        const delBtn = document.createElement("button");
        delBtn.className = "btn-small btn-delete";
        delBtn.textContent = "Delete";
        delBtn.addEventListener("click", () => deleteExpense(f.id));

        controls.appendChild(delBtn);
        item.appendChild(controls);

        container.appendChild(item);
      });
    }

    // --- FILTER SETUP ---
    function setupFilters() {
      const statusButtons = document.querySelectorAll(".status-filter-btn");
      statusButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          statusButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentStatusFilter = btn.dataset.status;
          renderTasks();
        });
      });

      const priorityButtons = document.querySelectorAll(".priority-filter-btn");
      priorityButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          priorityButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentPriorityFilter = btn.dataset.priority;
          renderTasks();
        });
      });

      const whenButtons = document.querySelectorAll(".when-filter-btn");
      whenButtons.forEach(btn => {
        btn.addEventListener("click", () => {
          whenButtons.forEach(b => b.classList.remove("active"));
          btn.classList.add("active");
          currentWhenFilter = btn.dataset.when;
          renderTasks();
        });
      });
    }

    // --- INIT ---
    document.addEventListener("DOMContentLoaded", () => {
      // Home cards navigation
      document.querySelectorAll(".home-card").forEach(card => {
        if (card.classList.contains("home-card-disabled")) return;
        const target = card.dataset.target;
        if (!target) return;
        card.addEventListener("click", () => showScreen(target));
      });

      loadState();
      loadTheme();
      setupTaskDragAndDrop();
      setupShoppingDragAndDrop();
      setupFilters();
      renderTasks();
      renderShoppingListSelector();
      renderShopping();
      renderWorkouts();
      renderFinances();

      // Theme toggle
      const themeBtn = document.getElementById("theme-toggle");
      if (themeBtn) {
        themeBtn.addEventListener("click", () => {
          applyTheme(currentTheme === "dark" ? "light" : "dark");
        });
      }

      // Prefill dates for workout & finance
      const workoutDate = document.getElementById("workout-date");
      if (workoutDate && !workoutDate.value) workoutDate.value = todayStr();
      const expenseDate = document.getElementById("expense-date");
      if (expenseDate && !expenseDate.value) expenseDate.value = todayStr();

      // Add task events
      const newTaskInput = document.getElementById("new-task-input");
      const addTaskBtn = document.getElementById("add-task-btn");

      addTaskBtn.addEventListener("click", () => {
        addTask(newTaskInput.value);
        newTaskInput.value = "";
        newTaskInput.focus();
      });

      newTaskInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          addTask(newTaskInput.value);
          newTaskInput.value = "";
        }
      });

      // Add shopping item events
      const newItemInput = document.getElementById("new-item-input");
      const addItemBtn = document.getElementById("add-item-btn");

      addItemBtn.addEventListener("click", () => {
        addItem(newItemInput.value);
        newItemInput.value = "";
        newItemInput.focus();
      });

      newItemInput.addEventListener("keypress", (e) => {
        if (e.key === "Enter") {
          addItem(newItemInput.value);
          newItemInput.value = "";
        }
      });

      // Shopping list selector + buttons
      const listSelect = document.getElementById("shopping-list-select");
      if (listSelect) {
        listSelect.addEventListener("change", (e) => {
          state.activeShoppingListId = e.target.value;
          saveState();
          renderShopping();
        });
      }

      const addListBtn = document.getElementById("add-shopping-list-btn");
      if (addListBtn) addListBtn.addEventListener("click", addShoppingList);

      const renameListBtn = document.getElementById("rename-shopping-list-btn");
      if (renameListBtn) renameListBtn.addEventListener("click", renameShoppingList);

      const deleteListBtn = document.getElementById("delete-shopping-list-btn");
      if (deleteListBtn) deleteListBtn.addEventListener("click", deleteShoppingList);

      // Workouts events
      const addWorkoutBtn = document.getElementById("add-workout-btn");
      if (addWorkoutBtn) addWorkoutBtn.addEventListener("click", addWorkout);

      // Finances events
      const addExpenseBtn = document.getElementById("add-expense-btn");
      if (addExpenseBtn) addExpenseBtn.addEventListener("click", addExpense);
    });
  </script>


  <script>
    if ("serviceWorker" in navigator) {
      window.addEventListener("load", function () {
        navigator.serviceWorker
          .register("./service-worker.js")
          .catch(function (err) {
            console.log("Service worker registration failed:", err);
          });
      });
    }
  </script>
</body>
</html>
